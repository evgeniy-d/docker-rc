{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:videobridge/lib/messageType.js","meteor://ðŸ’»app/packages/rocketchat:videobridge/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:videobridge/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:videobridge/server/methods/jitsiSetTimeout.js","meteor://ðŸ’»app/packages/rocketchat:videobridge/server/actionLink.js"],"names":["Meteor","startup","RocketChat","MessageTypes","registerType","id","system","message","TAPi18n","__","settings","addGroup","add","type","i18nLabel","alert","public","enableQuery","_id","value","models","Rooms","setJitsiTimeout","time","query","update","$set","jitsiTimeout","methods","rid","userId","Error","method","room","findOneById","currentTime","Date","getTime","Messages","createWithTypeRoomIdMessageAndUser","user","actionLinks","icon","label","method_id","params","msg","mentions","username","callbacks","run","register"],"mappings":"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","file":"/packages/rocketchat_videobridge.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.MessageTypes.registerType({\n\t\tid: 'jitsi_call_started',\n\t\tsystem: true,\n\t\tmessage: TAPi18n.__('Started_a_video_call')\n\t});\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Video Conference', function() {\n\t\tthis.add('Jitsi_Enabled', false, {\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Enabled',\n\t\t\talert: 'This Feature is currently in beta! Please report bugs to github.com/RocketChat/Rocket.Chat/issues',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_Domain', 'meet.jit.si', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'Domain',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_URL_Room_Prefix', 'RocketChat', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'URL_room_prefix',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_SSL', true, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'SSL',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_Open_New_Window', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'Always_open_in_new_window',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_Enable_Channels', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'Jitsi_Enable_Channels',\n\t\t\tpublic: true\n\t\t});\n\n\t\tthis.add('Jitsi_Chrome_Extension', 'nocfbnnmjnndkbipkabodnheejiegccf', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Jitsi_Enabled',\n\t\t\t\tvalue: true\n\t\t\t},\n\t\t\ti18nLabel: 'Jitsi_Chrome_Extension',\n\t\t\tpublic: true\n\t\t});\n\t});\n});\n","/**\n * sets jitsiTimeout to indicate a call is in progress\n * @param {string} _id - Room id\n * @parm {number} time - time to set\n */\nRocketChat.models.Rooms.setJitsiTimeout = function(_id, time) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tjitsiTimeout: time\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n","\nMeteor.methods({\n\t'jitsi:updateTimeout': (rid) => {\n\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'jitsi:updateTimeout' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\t\tconst currentTime = new Date().getTime();\n\n\t\tconst jitsiTimeout = new Date((room && room.jitsiTimeout) || currentTime).getTime();\n\n\t\tif (jitsiTimeout <= currentTime) {\n\t\t\tRocketChat.models.Rooms.setJitsiTimeout(rid, new Date(currentTime + 35*1000));\n\t\t\tconst message = RocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('jitsi_call_started', rid, '', Meteor.user(), {\n\t\t\t\tactionLinks : [\n\t\t\t\t\t{ icon: 'icon-videocam', label: TAPi18n.__('Click_to_join'), method_id: 'joinJitsiCall', params: ''}\n\t\t\t\t]\n\t\t\t});\n\t\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\t\t\tmessage.msg = TAPi18n.__('Started_a_video_call');\n\t\t\tmessage.mentions = [\n\t\t\t\t{\n\t\t\t\t\t_id:'here',\n\t\t\t\t\tusername:'here'\n\t\t\t\t}\n\t\t\t];\n\t\t\tRocketChat.callbacks.run('afterSaveMessage', message, room);\n\t\t} else if ((jitsiTimeout - currentTime) / 1000 <= 15) {\n\t\t\tRocketChat.models.Rooms.setJitsiTimeout(rid, new Date(jitsiTimeout + 25*1000));\n\t\t}\n\t}\n});\n","RocketChat.actionLinks.register('joinJitsiCall', function(/*message, params*/) {\n\n});\n"]}