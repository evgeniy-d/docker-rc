{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:otr/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:otr/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:otr/server/methods/deleteOldOTRMessages.js","meteor://ðŸ’»app/packages/rocketchat:otr/server/methods/updateOTRAck.js"],"names":["RocketChat","settings","addGroup","add","type","i18nLabel","public","models","Messages","deleteOldOTRMessages","roomId","ts","query","rid","t","$lte","remove","updateOTRAck","_id","otrAck","update","$set","Meteor","methods","userId","Error","method","now","Date","subscription","Subscriptions","findOneByRoomIdAndUserId","ack"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,WAAWC,QAAX,CAAoBC,QAApB,CAA6B,KAA7B,EAAoC,YAAW;AAC9C,OAAKC,GAAL,CAAS,YAAT,EAAuB,IAAvB,EAA6B;AAC5BC,UAAM,SADsB;AAE5BC,eAAW,SAFiB;AAG5BC,YAAQ;AAHoB,GAA7B;AAKA,CAND,E;;;;;;;;;;;ACAAN,WAAWO,MAAX,CAAkBC,QAAlB,CAA2BC,oBAA3B,GAAkD,UAASC,MAAT,EAAiBC,EAAjB,EAAqB;AACtE,QAAMC,QAAQ;AAAEC,SAAKH,MAAP;AAAeI,OAAG,KAAlB;AAAyBH,QAAI;AAAEI,YAAMJ;AAAR;AAA7B,GAAd;AACA,SAAO,KAAKK,MAAL,CAAYJ,KAAZ,CAAP;AACA,CAHD;;AAKAZ,WAAWO,MAAX,CAAkBC,QAAlB,CAA2BS,YAA3B,GAA0C,UAASC,GAAT,EAAcC,MAAd,EAAsB;AAC/D,QAAMP,QAAQ;AAAEM;AAAF,GAAd;AACA,QAAME,SAAS;AAAEC,UAAM;AAAEF;AAAF;AAAR,GAAf;AACA,SAAO,KAAKC,MAAL,CAAYR,KAAZ,EAAmBQ,MAAnB,CAAP;AACA,CAJD,C;;;;;;;;;;;ACLAE,OAAOC,OAAP,CAAe;AACdd,uBAAqBC,MAArB,EAA6B;AAC5B,QAAI,CAACY,OAAOE,MAAP,EAAL,EAAsB;AACrB,YAAM,IAAIF,OAAOG,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEC,gBAAQ;AAAV,OAAvD,CAAN;AACA;;AAED,UAAMC,MAAM,IAAIC,IAAJ,EAAZ;AACA,UAAMC,eAAe7B,WAAWO,MAAX,CAAkBuB,aAAlB,CAAgCC,wBAAhC,CAAyDrB,MAAzD,EAAiEY,OAAOE,MAAP,EAAjE,CAArB;;AACA,QAAIK,gBAAgBA,aAAaf,CAAb,KAAmB,GAAvC,EAA4C;AAC3Cd,iBAAWO,MAAX,CAAkBC,QAAlB,CAA2BC,oBAA3B,CAAgDC,MAAhD,EAAwDiB,GAAxD;AACA,KAFD,MAEO;AACN,YAAM,IAAIL,OAAOG,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEC,gBAAQ;AAAV,OAAvD,CAAN;AACA;AACD;;AAba,CAAf,E;;;;;;;;;;;ACAAJ,OAAOC,OAAP,CAAe;AACdN,eAAaC,GAAb,EAAkBc,GAAlB,EAAuB;AACtB,QAAI,CAACV,OAAOE,MAAP,EAAL,EAAsB;AACrB,YAAM,IAAIF,OAAOG,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEC,gBAAQ;AAAV,OAAvD,CAAN;AACA;;AACD1B,eAAWO,MAAX,CAAkBC,QAAlB,CAA2BS,YAA3B,CAAwCC,GAAxC,EAA6Cc,GAA7C;AACA;;AANa,CAAf,E","file":"/packages/rocketchat_otr.js","sourcesContent":["RocketChat.settings.addGroup('OTR', function() {\n\tthis.add('OTR_Enable', true, {\n\t\ttype: 'boolean',\n\t\ti18nLabel: 'Enabled',\n\t\tpublic: true\n\t});\n});\n","RocketChat.models.Messages.deleteOldOTRMessages = function(roomId, ts) {\n\tconst query = { rid: roomId, t: 'otr', ts: { $lte: ts } };\n\treturn this.remove(query);\n};\n\nRocketChat.models.Messages.updateOTRAck = function(_id, otrAck) {\n\tconst query = { _id };\n\tconst update = { $set: { otrAck } };\n\treturn this.update(query, update);\n};\n","Meteor.methods({\n\tdeleteOldOTRMessages(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'deleteOldOTRMessages' });\n\t\t}\n\n\t\tconst now = new Date();\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(roomId, Meteor.userId());\n\t\tif (subscription && subscription.t === 'd') {\n\t\t\tRocketChat.models.Messages.deleteOldOTRMessages(roomId, now);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'deleteOldOTRMessages' });\n\t\t}\n\t}\n});\n","Meteor.methods({\n\tupdateOTRAck(_id, ack) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'updateOTRAck' });\n\t\t}\n\t\tRocketChat.models.Messages.updateOTRAck(_id, ack);\n\t}\n});\n"]}