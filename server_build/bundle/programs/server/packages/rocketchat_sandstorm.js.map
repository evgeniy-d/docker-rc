{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:sandstorm/server/lib.js","meteor://ðŸ’»app/packages/rocketchat:sandstorm/server/events.js","meteor://ðŸ’»app/packages/rocketchat:sandstorm/server/powerbox.js"],"names":["Future","module","watch","require","default","v","RocketChat","Sandstorm","process","env","SANDSTORM","Capnp","SandstormHttpBridge","importSystem","capnpConnection","httpBridge","getHttpBridge","connect","restore","promiseToFuture","promise","result","then","return","bind","throw","waitPromise","wait","UploadFS","Store","prototype","getURL","path","getRelativeURL","_","notify","ACTIVITY_TYPES","message","userIds","caption","type","sessionId","sandstormSessionId","activity","notification","defaultText","users","map","userId","user","Meteor","findOne","_id","fields","identity","getSavedIdentity","services","sandstorm","id","mentioned","getSessionContext","context","offerUiView","Powerbox","Grain","token","serializedDescriptor","session","api","getSandstormApi","cap","Buffer","offer","undefined","tags","value","methods","sandstormClaimRequest","descriptor","parsePacked","PowerboxDescriptor","grainTitle","parse","UiView","PowerboxTag","title","connection","claimRequest","castAs","newToken","save","toString","viewInfo","getViewInfo","appTitle","asset","grainIcon","getUrl","appIconUrl","protocol","hostPath","sandstormOffer"],"mappings":"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","file":"/packages/rocketchat_sandstorm.js","sourcesContent":["/* globals getHttpBridge, waitPromise, UploadFS */\n/* exported getHttpBridge, waitPromise */\nimport Future from 'fibers/future';\n\nRocketChat.Sandstorm = {};\n\nif (process.env.SANDSTORM === '1') {\n\tconst Capnp = require('capnp');\n\tconst SandstormHttpBridge = Capnp.importSystem('sandstorm/sandstorm-http-bridge.capnp').SandstormHttpBridge;\n\n\tlet capnpConnection = null;\n\tlet httpBridge = null;\n\n\tgetHttpBridge = function() {\n\t\tif (!httpBridge) {\n\t\t\tcapnpConnection = Capnp.connect('unix:/tmp/sandstorm-api');\n\t\t\thttpBridge = capnpConnection.restore(null, SandstormHttpBridge);\n\t\t}\n\t\treturn httpBridge;\n\t};\n\n\tconst promiseToFuture = function(promise) {\n\t\tconst result = new Future();\n\t\tpromise.then(result.return.bind(result), result.throw.bind(result));\n\t\treturn result;\n\t};\n\n\twaitPromise = function(promise) {\n\t\treturn promiseToFuture(promise).wait();\n\t};\n\n\t// This usual implementation of this method returns an absolute URL that is invalid\n\t// under Sandstorm.\n\tUploadFS.Store.prototype.getURL = function(path) {\n\t\treturn this.getRelativeURL(path);\n\t};\n}\n","/* globals getHttpBridge, waitPromise */\n\nimport _ from 'underscore';\n\nRocketChat.Sandstorm.notify = function() {};\n\nif (process.env.SANDSTORM === '1') {\n\tconst ACTIVITY_TYPES = {\n\t\t'message': 0,\n\t\t'privateMessage': 1\n\t};\n\n\tRocketChat.Sandstorm.notify = function(message, userIds, caption, type) {\n\t\tconst sessionId = message.sandstormSessionId;\n\t\tif (!sessionId) {\n\t\t\treturn;\n\t\t}\n\t\tconst httpBridge = getHttpBridge();\n\t\tconst activity = {};\n\n\t\tif (type) {\n\t\t\tactivity.type = ACTIVITY_TYPES[type];\n\t\t}\n\n\t\tif (caption) {\n\t\t\tactivity.notification = {caption: {defaultText: caption}};\n\t\t}\n\n\t\tif (userIds) {\n\t\t\tactivity.users = _.map(userIds, function(userId) {\n\t\t\t\tconst user = Meteor.users.findOne({_id: userId}, {fields: {'services.sandstorm.id': 1}});\n\t\t\t\treturn {\n\t\t\t\t\tidentity: waitPromise(httpBridge.getSavedIdentity(user.services.sandstorm.id)).identity,\n\t\t\t\t\tmentioned: true\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\treturn waitPromise(httpBridge.getSessionContext(sessionId).context.activity(activity));\n\t};\n}\n","/* globals getHttpBridge, waitPromise */\n\nRocketChat.Sandstorm.offerUiView = function() {};\n\nif (process.env.SANDSTORM === '1') {\n\tconst Capnp = require('capnp');\n\tconst Powerbox = Capnp.importSystem('sandstorm/powerbox.capnp');\n\tconst Grain = Capnp.importSystem('sandstorm/grain.capnp');\n\n\tRocketChat.Sandstorm.offerUiView = function(token, serializedDescriptor, sessionId) {\n\t\tconst httpBridge = getHttpBridge();\n\t\tconst session = httpBridge.getSessionContext(sessionId).context;\n\t\tconst api = httpBridge.getSandstormApi(sessionId).api;\n\t\tconst cap = waitPromise(api.restore(new Buffer(token, 'base64'))).cap;\n\t\treturn waitPromise(session.offer(cap, undefined, {tags: [{\n\t\t\tid: '15831515641881813735',\n\t\t\tvalue: new Buffer(serializedDescriptor, 'base64')\n\t\t}]}));\n\t};\n\n\tMeteor.methods({\n\t\tsandstormClaimRequest(token, serializedDescriptor) {\n\t\t\tconst descriptor = Capnp.parsePacked(Powerbox.PowerboxDescriptor, new Buffer(serializedDescriptor, 'base64'));\n\t\t\tconst grainTitle = Capnp.parse(Grain.UiView.PowerboxTag, descriptor.tags[0].value).title;\n\t\t\tconst sessionId = this.connection.sandstormSessionId();\n\t\t\tconst httpBridge = getHttpBridge();\n\t\t\tconst session = httpBridge.getSessionContext(sessionId).context;\n\t\t\tconst cap = waitPromise(session.claimRequest(token)).cap.castAs(Grain.UiView);\n\t\t\tconst api = httpBridge.getSandstormApi(sessionId).api;\n\t\t\tconst newToken = waitPromise(api.save(cap)).token.toString('base64');\n\t\t\tconst viewInfo = waitPromise(cap.getViewInfo());\n\t\t\tconst appTitle = viewInfo.appTitle;\n\t\t\tconst asset = waitPromise(viewInfo.grainIcon.getUrl());\n\t\t\tconst appIconUrl = `${ asset.protocol }://${ asset.hostPath }`;\n\t\t\treturn {\n\t\t\t\ttoken: newToken,\n\t\t\t\tappTitle,\n\t\t\t\tappIconUrl,\n\t\t\t\tgrainTitle,\n\t\t\t\tdescriptor: descriptor.tags[0].value.toString('base64')\n\t\t\t};\n\t\t},\n\t\tsandstormOffer(token, serializedDescriptor) {\n\t\t\tRocketChat.Sandstorm.offerUiView(token, serializedDescriptor,\n\t\t\t\tthis.connection.sandstormSessionId());\n\t\t}\n\t});\n}\n"]}