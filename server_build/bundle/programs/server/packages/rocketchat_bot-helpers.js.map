{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:bot-helpers/server/index.js","meteor://ðŸ’»app/packages/rocketchat:bot-helpers/server/settings.js"],"names":["_","module","watch","require","default","v","BotHelpers","constructor","queries","online","$ne","users","$not","$all","setupCursors","fieldsSetting","userFields","split","forEach","n","trim","_allUsers","RocketChat","models","Users","find","fields","_onlineUsers","$and","request","prop","params","addUserToRole","userName","roleName","Meteor","call","removeUserFromRole","addUserToRoom","room","foundRoom","Rooms","findOneByIdOrName","isObject","Error","data","rid","_id","username","removeUserFromRoom","requestError","method","action","allUsers","Object","keys","length","fetch","onlineUsers","allUsernames","hasOwnProperty","map","user","onlineUsernames","allNames","name","onlineNames","allIDs","onlineIDs","botHelpers","settings","get","settingKey","settingValue","methods","botRequest","args","userID","userId","authz","hasRole","startup","addGroup","add","type","section","i18nLabel","i18nDescription"],"mappings":"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","file":"/packages/rocketchat_bot-helpers.js","sourcesContent":["import _ from 'underscore';\n\n/**\n * BotHelpers helps bots\n * \"private\" properties use meteor collection cursors, so they stay reactive\n * \"public\" properties use getters to fetch and filter collections as array\n */\nclass BotHelpers {\n\tconstructor() {\n\t\tthis.queries = {\n\t\t\tonline: { 'status': { $ne: 'offline' } },\n\t\t\tusers: { 'roles': { $not: { $all: ['bot'] } } }\n\t\t};\n\t}\n\n\t// setup collection cursors with array of fields from setting\n\tsetupCursors(fieldsSetting) {\n\t\tthis.userFields = {};\n\t\tif (typeof fieldsSetting === 'string') {\n\t\t\tfieldsSetting = fieldsSetting.split(',');\n\t\t}\n\t\tfieldsSetting.forEach((n) => {\n\t\t\tthis.userFields[n.trim()] = 1;\n\t\t});\n\t\tthis._allUsers = RocketChat.models.Users.find(this.queries.users, { fields: this.userFields });\n\t\tthis._onlineUsers = RocketChat.models.Users.find({ $and: [this.queries.users, this.queries.online] }, { fields: this.userFields });\n\t}\n\n\t// request methods or props as arguments to Meteor.call\n\trequest(prop, ...params) {\n\t\tif (typeof this[prop] === 'undefined') {\n\t\t\treturn null;\n\t\t} else if (typeof this[prop] === 'function') {\n\t\t\treturn this[prop](...params);\n\t\t} else {\n\t\t\treturn this[prop];\n\t\t}\n\t}\n\n\taddUserToRole(userName, roleName) {\n\t\tMeteor.call('authorization:addUserToRole', roleName, userName);\n\t}\n\n\tremoveUserFromRole(userName, roleName) {\n\t\tMeteor.call('authorization:removeUserFromRole', roleName, userName);\n\t}\n\n\taddUserToRoom(userName, room) {\n\t\tconst foundRoom = RocketChat.models.Rooms.findOneByIdOrName(room);\n\n\t\tif (!_.isObject(foundRoom)) {\n\t\t\tthrow new Meteor.Error('invalid-channel');\n\t\t}\n\n\t\tconst data = {};\n\t\tdata.rid = foundRoom._id;\n\t\tdata.username = userName;\n\t\tMeteor.call('addUserToRoom', data);\n\t}\n\n\tremoveUserFromRoom(userName, room) {\n\t\tconst foundRoom = RocketChat.models.Rooms.findOneByIdOrName(room);\n\n\t\tif (!_.isObject(foundRoom)) {\n\t\t\tthrow new Meteor.Error('invalid-channel');\n\t\t}\n\t\tconst data = {};\n\t\tdata.rid = foundRoom._id;\n\t\tdata.username = userName;\n\t\tMeteor.call('removeUserFromRoom', data);\n\t}\n\n\t// generic error whenever property access insufficient to fill request\n\trequestError() {\n\t\tthrow new Meteor.Error('error-not-allowed', 'Bot request not allowed', { method: 'botRequest', action: 'bot_request' });\n\t}\n\n\t// \"public\" properties accessed by getters\n\t// allUsers / onlineUsers return whichever properties are enabled by settings\n\tget allUsers() {\n\t\tif (!Object.keys(this.userFields).length) {\n\t\t\tthis.requestError();\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn this._allUsers.fetch();\n\t\t}\n\t}\n\tget onlineUsers() {\n\t\tif (!Object.keys(this.userFields).length) {\n\t\t\tthis.requestError();\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn this._onlineUsers.fetch();\n\t\t}\n\t}\n\tget allUsernames() {\n\t\tif (!this.userFields.hasOwnProperty('username')) {\n\t\t\tthis.requestError();\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn this._allUsers.fetch().map((user) => user.username);\n\t\t}\n\t}\n\tget onlineUsernames() {\n\t\tif (!this.userFields.hasOwnProperty('username')) {\n\t\t\tthis.requestError();\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn this._onlineUsers.fetch().map((user) => user.username);\n\t\t}\n\t}\n\tget allNames() {\n\t\tif (!this.userFields.hasOwnProperty('name')) {\n\t\t\tthis.requestError();\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn this._allUsers.fetch().map((user) => user.name);\n\t\t}\n\t}\n\tget onlineNames() {\n\t\tif (!this.userFields.hasOwnProperty('name')) {\n\t\t\tthis.requestError();\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn this._onlineUsers.fetch().map((user) => user.name);\n\t\t}\n\t}\n\tget allIDs() {\n\t\tif (!this.userFields.hasOwnProperty('_id') || !this.userFields.hasOwnProperty('username')) {\n\t\t\tthis.requestError();\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn this._allUsers.fetch().map((user) => {\n\t\t\t\treturn { 'id': user._id, 'name': user.username };\n\t\t\t});\n\t\t}\n\t}\n\tget onlineIDs() {\n\t\tif (!this.userFields.hasOwnProperty('_id') || !this.userFields.hasOwnProperty('username')) {\n\t\t\tthis.requestError();\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn this._onlineUsers.fetch().map((user) => {\n\t\t\t\treturn { 'id': user._id, 'name': user.username };\n\t\t\t});\n\t\t}\n\t}\n}\n\n// add class to meteor methods\nconst botHelpers = new BotHelpers();\n\n// init cursors with fields setting and update on setting change\nRocketChat.settings.get('BotHelpers_userFields', function(settingKey, settingValue) {\n\tbotHelpers.setupCursors(settingValue);\n});\n\nMeteor.methods({\n\tbotRequest: (...args) => {\n\t\tconst userID = Meteor.userId();\n\t\tif (userID && RocketChat.authz.hasRole(userID, 'bot')) {\n\t\t\treturn botHelpers.request(...args);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'botRequest' });\n\t\t}\n\t}\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Bots', function() {\n\t\tthis.add('BotHelpers_userFields', '_id, name, username, emails, language, utcOffset', {\n\t\t\ttype: 'string',\n\t\t\tsection: 'Helpers',\n\t\t\ti18nLabel: 'BotHelpers_userFields',\n\t\t\ti18nDescription: 'BotHelpers_userFields_Description'\n\t\t});\n\t});\n});\n"]}