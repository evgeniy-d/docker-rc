{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file-upload/globalFileRestrictions.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUploadBase.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/proxy.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/requests.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/_configUploadStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/AmazonS3.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/FileSystem.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GoogleStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GridFS.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/Slingshot_DEPRECATED.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/Webdav.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/sendFileMessage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/getS3FileUrl.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/AmazonS3/server.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/GoogleStorage/server.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/Webdav/server.js"],"names":["filesize","module","watch","require","default","v","slingShotConfig","authorize","file","userId","Meteor","Error","RocketChat","fileUploadIsValidContentType","type","TAPi18n","__","maxFileSize","settings","get","size","maxSize","allowedFileTypes","Slingshot","fileRestrictions","FileUpload","validateFileUpload","Match","test","rid","String","user","room","models","Rooms","findOneById","directMessageAllow","fileUploadAllowed","authz","canAccessRoom","language","reason","t","key","value","parseInt","e","Settings","packageValue","_","UploadFS","config","defaultStorePermissions","StorePermissions","insert","doc","message_id","indexOf","store","split","pop","update","hasPermission","remove","FileUploadBase","constructor","meta","id","Random","getProgress","getFileName","name","start","callback","handler","Uploader","data","onError","err","onComplete","fileData","pick","url","replace","absoluteUrl","options","onProgress","progress","stop","export","FileUploadClass","fs","stream","mime","Future","sharp","Cookies","cookie","Object","assign","handlers","configureUploadsStore","stores","getStores","defaultUploads","collection","Uploads","model","filter","Filter","onCheck","getPath","_id","onValidate","uploadsOnValidate","onRead","fileId","req","res","requestCanAccessFiles","writeHead","setHeader","encodeURIComponent","defaultAvatars","Avatars","avatarsOnValidate","onFinishUpload","avatarsOnFinishUpload","defaultUserDataFiles","UserDataFiles","tempFilePath","getTempFilePath","height","future","s","rotate","metadata","bindEnvironment","toFormat","format","jpeg","resize","Math","min","width","Infinity","pipe","background","embed","toBuffer","then","outputBuffer","writeFile","console","error","lstatSync","getCollection","direct","$set","return","wait","resizeImagePreview","addExtensionTo","image","getStore","_store","getReadStream","transformer","max","blur","result","out","toString","tmpFile","fut","identify","orientation","toFile","unlink","rename","catch","Users","oldAvatar","findOneByName","username","deleteFile","updateFileNameById","headers","query","rc_uid","rc_token","rc_rid","rc_room_type","isAuthorizedByCookies","findOneByIdAndLoginToken","isAuthorizedByHeaders","isAuthorizedByRoom","roomTypes","getConfig","canAccessUploadedFile","lookup","ext","extension","RegExp","modelName","storageType","handlerName","getStoreByName","next","end","copy","targetFile","createWriteStream","getModelFromName","delete","deleteById","deleteByName","fileName","streamOrBuffer","cb","getFilter","check","create","token","createToken","Buffer","writeFileSync","call","http","URL","logger","Logger","WebApp","connectHandlers","stack","unshift","route","handle","storesPath","debug","method","parsedUrl","parse","path","pathname","substr","length","regExp","match","exec","findOne","undefined","instanceId","InstanceStatus","instance","extraInformation","host","process","env","INSTANCE_IP","isDocker","port","hostname","originalUrl","proxy","request","proxy_res","use","public","sandstorm","configStore","debounce","log","https","fileUrl","getRedirectURL","storeType","fileRes","removeHeader","AmazonS3Uploads","AmazonS3Avatars","AmazonS3UserDataFiles","configure","Bucket","Acl","AWSAccessKeyId","AWSSecretAccessKey","URLExpiryTimeSpan","Region","SignatureVersion","ForcePathStyle","BucketURL","connection","signatureVersion","s3ForcePathStyle","params","ACL","region","accessKeyId","secretAccessKey","endpoint","FileSystemUploads","filePath","getFilePath","stat","wrapAsync","isFile","uploadedAt","toUTCString","FileSystemAvatars","FileSystemUserDataFiles","createFileSystemStore","GoogleCloudStorageUploads","GoogleCloudStorageAvatars","GoogleCloudStorageUserDataFiles","bucket","accessId","secret","credentials","client_email","private_key","zlib","util","ExtractRange","bytes_read","Transform","inherits","prototype","_transform","chunk","enc","newchunk","slice","push","getByteRange","header","matches","readFromGridFS","storeName","rs","ws","PassThrough","forEach","on","onReadError","emit","accept","transformRead","range","out_of_range","createGzip","createDeflate","copyFromGridFS","collectionName","configureSlingshot","acl","accessKey","secretKey","cdn","bucketUrl","_directives","isEmpty","metaContext","upload","AmazonS3","insertFileInit","createDirective","S3Storage","message","createGoogleStorageDirective","GoogleAccessId","GoogleSecretKey","GoogleStorage","GoogleCloud","WebdavUploads","WebdavAvatars","WebdavUserDataFiles","uploadFolderPath","server","password","methods","roomId","msgData","avatar","Optional","emoji","alias","groupable","Boolean","msg","updateFileComplete","omit","encodeURI","attachment","title","description","title_link","title_link_download","image_url","image_type","image_size","image_dimensions","image_preview","audio_url","audio_type","audio_size","video_url","video_type","video_size","ts","Date","attachments","defer","callbacks","run","protectedFiles","getS3FileUrl","addGroup","add","i18nDescription","values","i18nLabel","section","enableQuery","private","multiline","AmazonS3Store","S3","Store","extend","httpOptions","timeout","agent","classOptions","s3","Key","Expires","getSignedUrl","deleteObject","Range","getObject","createReadStream","getWriteStream","writeStream","event","listener","nextTick","removeListener","putObject","Body","ContentType","ContentDisposition","GoogleStorageStore","gcStorage","gcs","googleCloudStorage","action","responseDisposition","expires","now","gzip","contentType","contentDisposition","WebdavStore","Webdav","client","status","createDirectory","webdavStream","newListenerCallback","setTimeout"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAIA,QAAJ;AAAaC,OAAOC,KAAP,CAAaC,QAAQ,UAAR,CAAb,EAAiC;AAACC,UAAQC,CAAR,EAAU;AAACL,eAASK,CAAT;AAAW;;AAAvB,CAAjC,EAA0D,CAA1D;AAIb,MAAMC,kBAAkB;AACvBC,YAAUC;AAAI;AAAd,IAAiC;AAChC;AACA,QAAI,CAAC,KAAKC,MAAV,EAAkB;AACjB,YAAM,IAAIC,OAAOC,KAAX,CAAiB,gBAAjB,EAAmC,mCAAnC,CAAN;AACA;;AAED,QAAI,CAACC,WAAWC,4BAAX,CAAwCL,KAAKM,IAA7C,CAAL,EAAyD;AACxD,YAAM,IAAIJ,OAAOC,KAAX,CAAiBI,QAAQC,EAAR,CAAW,yBAAX,CAAjB,CAAN;AACA;;AAED,UAAMC,cAAcL,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,wBAAxB,CAApB;;AAEA,QAAIF,eAAe,CAAC,CAAhB,IAAqBA,cAAcT,KAAKY,IAA5C,EAAkD;AACjD,YAAM,IAAIV,OAAOC,KAAX,CAAiBI,QAAQC,EAAR,CAAW,oCAAX,EAAiD;AAAEI,cAAMpB,SAASiB,WAAT;AAAR,OAAjD,CAAjB,CAAN;AACA;;AAED,WAAO,IAAP;AACA,GAlBsB;;AAmBvBI,WAAS,CAnBc;AAoBvBC,oBAAkB;AApBK,CAAxB;AAuBAC,UAAUC,gBAAV,CAA2B,oBAA3B,EAAiDlB,eAAjD;AACAiB,UAAUC,gBAAV,CAA2B,uBAA3B,EAAoDlB,eAApD,E;;;;;;;;;;;AC5BA,IAAIN,QAAJ;AAAaC,OAAOC,KAAP,CAAaC,QAAQ,UAAR,CAAb,EAAiC;AAACC,UAAQC,CAAR,EAAU;AAACL,eAASK,CAAT;AAAW;;AAAvB,CAAjC,EAA0D,CAA1D;AAKb,IAAIY,cAAc,CAAlB;AAEAQ,aAAa;AACZC,qBAAmBlB,IAAnB,EAAyB;AACxB,QAAI,CAACmB,MAAMC,IAAN,CAAWpB,KAAKqB,GAAhB,EAAqBC,MAArB,CAAL,EAAmC;AAClC,aAAO,KAAP;AACA,KAHuB,CAIxB;;;AACA,UAAMC,OAAOvB,KAAKC,MAAL,GAAcC,OAAOqB,IAAP,EAAd,GAA8B,IAA3C;AACA,UAAMC,OAAOpB,WAAWqB,MAAX,CAAkBC,KAAlB,CAAwBC,WAAxB,CAAoC3B,KAAKqB,GAAzC,CAAb;AACA,UAAMO,qBAAqBxB,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,2BAAxB,CAA3B;AACA,UAAMkB,oBAAoBzB,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,oBAAxB,CAA1B;;AACA,QAAIP,WAAW0B,KAAX,CAAiBC,aAAjB,CAA+BP,IAA/B,EAAqCD,IAArC,EAA2CvB,IAA3C,MAAqD,IAAzD,EAA+D;AAC9D,aAAO,KAAP;AACA;;AACD,UAAMgC,WAAWT,OAAOA,KAAKS,QAAZ,GAAuB,IAAxC;;AACA,QAAI,CAACH,iBAAL,EAAwB;AACvB,YAAMI,SAAS1B,QAAQC,EAAR,CAAW,qBAAX,EAAkCwB,QAAlC,CAAf;;AACA,YAAM,IAAI9B,OAAOC,KAAX,CAAiB,4BAAjB,EAA+C8B,MAA/C,CAAN;AACA;;AAED,QAAI,CAACL,kBAAD,IAAuBJ,KAAKU,CAAL,KAAW,GAAtC,EAA2C;AAC1C,YAAMD,SAAS1B,QAAQC,EAAR,CAAW,kCAAX,EAA+CwB,QAA/C,CAAf;;AACA,YAAM,IAAI9B,OAAOC,KAAX,CAAiB,8CAAjB,EAAiE8B,MAAjE,CAAN;AACA,KArBuB,CAuBxB;;;AACA,QAAIxB,eAAe,CAAC,CAAhB,IAAqBT,KAAKY,IAAL,GAAYH,WAArC,EAAkD;AACjD,YAAMwB,SAAS1B,QAAQC,EAAR,CAAW,oCAAX,EAAiD;AAC/DI,cAAMpB,SAASiB,WAAT;AADyD,OAAjD,EAEZuB,QAFY,CAAf;;AAGA,YAAM,IAAI9B,OAAOC,KAAX,CAAiB,sBAAjB,EAAyC8B,MAAzC,CAAN;AACA;;AAED,QAAIxB,cAAc,CAAlB,EAAqB;AACpB,UAAIT,KAAKY,IAAL,GAAYH,WAAhB,EAA6B;AAC5B,cAAMwB,SAAS1B,QAAQC,EAAR,CAAW,oCAAX,EAAiD;AAC/DI,gBAAMpB,SAASiB,WAAT;AADyD,SAAjD,EAEZuB,QAFY,CAAf;;AAGA,cAAM,IAAI9B,OAAOC,KAAX,CAAiB,sBAAjB,EAAyC8B,MAAzC,CAAN;AACA;AACD;;AAED,QAAI,CAAC7B,WAAWC,4BAAX,CAAwCL,KAAKM,IAA7C,CAAL,EAAyD;AACxD,YAAM2B,SAAS1B,QAAQC,EAAR,CAAW,2BAAX,EAAwCwB,QAAxC,CAAf;;AACA,YAAM,IAAI9B,OAAOC,KAAX,CAAiB,yBAAjB,EAA4C8B,MAA5C,CAAN;AACA;;AAED,WAAO,IAAP;AACA;;AA/CW,CAAb;AAkDA7B,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,wBAAxB,EAAkD,UAASwB,GAAT,EAAcC,KAAd,EAAqB;AACtE,MAAI;AACH3B,kBAAc4B,SAASD,KAAT,CAAd;AACA,GAFD,CAEE,OAAOE,CAAP,EAAU;AACX7B,kBAAcL,WAAWqB,MAAX,CAAkBc,QAAlB,CAA2BZ,WAA3B,CAAuC,wBAAvC,EAAiEa,YAA/E;AACA;AACD,CAND,E;;;;;;;;;;;ACzDA,IAAIC,CAAJ;;AAAMhD,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAAC4C,QAAE5C,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAIN6C,SAASC,MAAT,CAAgBC,uBAAhB,GAA0C,IAAIF,SAASG,gBAAb,CAA8B;AACvEC,SAAO7C,MAAP,EAAe8C,GAAf,EAAoB;AACnB,QAAI9C,MAAJ,EAAY;AACX,aAAO,IAAP;AACA,KAHkB,CAKnB;;;AACA,QAAI8C,OAAOA,IAAIC,UAAX,IAAyBD,IAAIC,UAAJ,CAAeC,OAAf,CAAuB,QAAvB,MAAqC,CAAlE,EAAqE;AACpE,aAAO,IAAP;AACA,KARkB,CAUnB;;;AACA,QAAIF,OAAOA,IAAIG,KAAX,IAAoBH,IAAIG,KAAJ,CAAUC,KAAV,CAAgB,GAAhB,EAAqBC,GAArB,OAA+B,eAAvD,EAAwE;AACvE,aAAO,IAAP;AACA;;AAED,QAAIhD,WAAW0B,KAAX,CAAiBC,aAAjB,CAA+B,IAA/B,EAAqC,IAArC,EAA2CgB,GAA3C,CAAJ,EAAqD;AACpD,aAAO,IAAP;AACA;;AAED,WAAO,KAAP;AACA,GArBsE;;AAsBvEM,SAAOpD,MAAP,EAAe8C,GAAf,EAAoB;AACnB,WAAO3C,WAAW0B,KAAX,CAAiBwB,aAAjB,CAA+BpD,OAAOD,MAAP,EAA/B,EAAgD,gBAAhD,EAAkE8C,IAAI1B,GAAtE,KAA+EjB,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,uBAAxB,KAAoDV,WAAW8C,IAAI9C,MAAzJ;AACA,GAxBsE;;AAyBvEsD,SAAOtD,MAAP,EAAe8C,GAAf,EAAoB;AACnB,WAAO3C,WAAW0B,KAAX,CAAiBwB,aAAjB,CAA+BpD,OAAOD,MAAP,EAA/B,EAAgD,gBAAhD,EAAkE8C,IAAI1B,GAAtE,KAA+EjB,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,uBAAxB,KAAoDV,WAAW8C,IAAI9C,MAAzJ;AACA;;AA3BsE,CAA9B,CAA1C;AA+BAuD,iBAAiB,MAAMA,cAAN,CAAqB;AACrCC,cAAYP,KAAZ,EAAmBQ,IAAnB,EAAyB1D,IAAzB,EAA+B;AAC9B,SAAK2D,EAAL,GAAUC,OAAOD,EAAP,EAAV;AACA,SAAKD,IAAL,GAAYA,IAAZ;AACA,SAAK1D,IAAL,GAAYA,IAAZ;AACA,SAAKkD,KAAL,GAAaA,KAAb;AACA;;AAEDW,gBAAc,CAEb;;AAEDC,gBAAc;AACb,WAAO,KAAKJ,IAAL,CAAUK,IAAjB;AACA;;AAEDC,QAAMC,QAAN,EAAgB;AACf,SAAKC,OAAL,GAAe,IAAIxB,SAASyB,QAAb,CAAsB;AACpCjB,aAAO,KAAKA,KADwB;AAEpCkB,YAAM,KAAKpE,IAFyB;AAGpCA,YAAM,KAAK0D,IAHyB;AAIpCW,eAAUC,GAAD,IAAS;AACjB,eAAOL,SAASK,GAAT,CAAP;AACA,OANmC;AAOpCC,kBAAaC,QAAD,IAAc;AACzB,cAAMxE,OAAOyC,EAAEgC,IAAF,CAAOD,QAAP,EAAiB,KAAjB,EAAwB,MAAxB,EAAgC,MAAhC,EAAwC,MAAxC,EAAgD,UAAhD,EAA4D,aAA5D,CAAb;;AAEAxE,aAAK0E,GAAL,GAAWF,SAASE,GAAT,CAAaC,OAAb,CAAqBzE,OAAO0E,WAAP,EAArB,EAA2C,GAA3C,CAAX;AACA,eAAOX,SAAS,IAAT,EAAejE,IAAf,EAAqB,KAAKkD,KAAL,CAAW2B,OAAX,CAAmBd,IAAxC,CAAP;AACA;AAZmC,KAAtB,CAAf;;AAeA,SAAKG,OAAL,CAAaY,UAAb,GAA0B,CAAC9E,IAAD,EAAO+E,QAAP,KAAoB;AAC7C,WAAKD,UAAL,CAAgBC,QAAhB;AACA,KAFD;;AAIA,WAAO,KAAKb,OAAL,CAAaF,KAAb,EAAP;AACA;;AAEDc,eAAa,CAAE;;AAEfE,SAAO;AACN,WAAO,KAAKd,OAAL,CAAac,IAAb,EAAP;AACA;;AA3CoC,CAAtC,C;;;;;;;;;;;ACnCAvF,OAAOwF,MAAP,CAAc;AAACC,mBAAgB,MAAIA;AAArB,CAAd;AAAqD,IAAIC,EAAJ;AAAO1F,OAAOC,KAAP,CAAaC,QAAQ,IAAR,CAAb,EAA2B;AAACC,UAAQC,CAAR,EAAU;AAACsF,SAAGtF,CAAH;AAAK;;AAAjB,CAA3B,EAA8C,CAA9C;AAAiD,IAAIuF,MAAJ;AAAW3F,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAACC,UAAQC,CAAR,EAAU;AAACuF,aAAOvF,CAAP;AAAS;;AAArB,CAA/B,EAAsD,CAAtD;AAAyD,IAAIwF,IAAJ;AAAS5F,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACC,UAAQC,CAAR,EAAU;AAACwF,WAAKxF,CAAL;AAAO;;AAAnB,CAA1C,EAA+D,CAA/D;AAAkE,IAAIyF,MAAJ;AAAW7F,OAAOC,KAAP,CAAaC,QAAQ,eAAR,CAAb,EAAsC;AAACC,UAAQC,CAAR,EAAU;AAACyF,aAAOzF,CAAP;AAAS;;AAArB,CAAtC,EAA6D,CAA7D;AAAgE,IAAI0F,KAAJ;AAAU9F,OAAOC,KAAP,CAAaC,QAAQ,OAAR,CAAb,EAA8B;AAACC,UAAQC,CAAR,EAAU;AAAC0F,YAAM1F,CAAN;AAAQ;;AAApB,CAA9B,EAAoD,CAApD;AAAuD,IAAI2F,OAAJ;AAAY/F,OAAOC,KAAP,CAAaC,QAAQ,uBAAR,CAAb,EAA8C;AAAC6F,UAAQ3F,CAAR,EAAU;AAAC2F,cAAQ3F,CAAR;AAAU;;AAAtB,CAA9C,EAAsE,CAAtE;AASpZ,MAAM4F,SAAS,IAAID,OAAJ,EAAf;AAEAE,OAAOC,MAAP,CAAc1E,UAAd,EAA0B;AACzB2E,YAAU,EADe;;AAGzBC,wBAAsB3C,KAAtB,EAA6Ba,IAA7B,EAAmCc,OAAnC,EAA4C;AAC3C,UAAMvE,OAAOyD,KAAKZ,KAAL,CAAW,GAAX,EAAgBC,GAAhB,EAAb;AACA,UAAM0C,SAASpD,SAASqD,SAAT,EAAf;AACA,WAAOD,OAAO/B,IAAP,CAAP;AAEA,WAAO,IAAIrB,SAASQ,KAAT,CAAeA,KAAf,CAAJ,CAA0BwC,OAAOC,MAAP,CAAc;AAC9C5B;AAD8C,KAAd,EAE9Bc,OAF8B,EAErB5D,WAAY,UAAUX,IAAM,EAA5B,GAFqB,CAA1B,CAAP;AAGA,GAXwB;;AAazB0F,mBAAiB;AAChB,WAAO;AACNC,kBAAY7F,WAAWqB,MAAX,CAAkByE,OAAlB,CAA0BC,KADhC;AAENC,cAAQ,IAAI1D,SAAS2D,MAAb,CAAoB;AAC3BC,iBAASrF,WAAWC;AADO,OAApB,CAFF;;AAKNqF,cAAQvG,IAAR,EAAc;AACb,eAAQ,GAAGI,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,UAAxB,CAAqC,YAAYX,KAAKqB,GAAK,IAAIrB,KAAKC,MAAQ,IAAID,KAAKwG,GAAK,EAArG;AACA,OAPK;;AAQNC,kBAAYxF,WAAWyF,iBARjB;;AASNC,aAAOC,MAAP,EAAe5G,IAAf,EAAqB6G,GAArB,EAA0BC,GAA1B,EAA+B;AAC9B,YAAI,CAAC7F,WAAW8F,qBAAX,CAAiCF,GAAjC,CAAL,EAA4C;AAC3CC,cAAIE,SAAJ,CAAc,GAAd;AACA,iBAAO,KAAP;AACA;;AAEDF,YAAIG,SAAJ,CAAc,qBAAd,EAAsC,yBAAyBC,mBAAmBlH,KAAK+D,IAAxB,CAA+B,GAA9F;AACA,eAAO,IAAP;AACA;;AAjBK,KAAP;AAmBA,GAjCwB;;AAmCzBoD,mBAAiB;AAChB,WAAO;AACNlB,kBAAY7F,WAAWqB,MAAX,CAAkB2F,OAAlB,CAA0BjB,KADhC;;AAEN;AACA;AACA;AACAI,cAAQvG,IAAR,EAAc;AACb,eAAQ,GAAGI,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,UAAxB,CAAqC,YAAYX,KAAKC,MAAQ,EAAzE;AACA,OAPK;;AAQNwG,kBAAYxF,WAAWoG,iBARjB;AASNC,sBAAgBrG,WAAWsG;AATrB,KAAP;AAWA,GA/CwB;;AAiDzBC,yBAAuB;AACtB,WAAO;AACNvB,kBAAY7F,WAAWqB,MAAX,CAAkBgG,aAAlB,CAAgCtB,KADtC;;AAENI,cAAQvG,IAAR,EAAc;AACb,eAAQ,GAAGI,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,UAAxB,CAAqC,qBAAqBX,KAAKC,MAAQ,EAAlF;AACA,OAJK;;AAKNwG,kBAAYxF,WAAWyF,iBALjB;;AAMNC,aAAOC,MAAP,EAAe5G,IAAf,EAAqB6G,GAArB,EAA0BC,GAA1B,EAA+B;AAC9B,YAAI,CAAC7F,WAAW8F,qBAAX,CAAiCF,GAAjC,CAAL,EAA4C;AAC3CC,cAAIE,SAAJ,CAAc,GAAd;AACA,iBAAO,KAAP;AACA;;AAEDF,YAAIG,SAAJ,CAAc,qBAAd,EAAsC,yBAAyBC,mBAAmBlH,KAAK+D,IAAxB,CAA+B,GAA9F;AACA,eAAO,IAAP;AACA;;AAdK,KAAP;AAgBA,GAlEwB;;AAoEzBsD,oBAAkBrH,IAAlB,EAAwB;AACvB,QAAII,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,uBAAxB,MAAqD,IAAzD,EAA+D;AAC9D;AACA;;AAED,UAAM+G,eAAehF,SAASiF,eAAT,CAAyB3H,KAAKwG,GAA9B,CAArB;AAEA,UAAMoB,SAASxH,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,qBAAxB,CAAf;AACA,UAAMkH,SAAS,IAAIvC,MAAJ,EAAf;AAEA,UAAMwC,IAAIvC,MAAMmC,YAAN,CAAV;AACAI,MAAEC,MAAF,GAXuB,CAYvB;AACA;;AAEAD,MAAEE,QAAF,CAAW9H,OAAO+H,eAAP,CAAuB,CAAC3D,GAAD,EAAM0D,QAAN,KAAmB;AACpD,UAAI,CAACA,QAAL,EAAe;AACdA,mBAAW,EAAX;AACA;;AAEDF,QAAEI,QAAF,CAAW3C,MAAM4C,MAAN,CAAaC,IAAxB,EACEC,MADF,CACSC,KAAKC,GAAL,CAASX,UAAU,CAAnB,EAAsBI,SAASQ,KAAT,IAAkBC,QAAxC,CADT,EAC4DH,KAAKC,GAAL,CAASX,UAAU,CAAnB,EAAsBI,SAASJ,MAAT,IAAmBa,QAAzC,CAD5D,EAEEC,IAFF,CAEOnD,QACJ8C,MADI,CACGT,MADH,EACWA,MADX,EAEJe,UAFI,CAEO,SAFP,EAGJC,KAHI,EAFP,EAOC;AACA;AARD,OASEC,QATF,GAUEC,IAVF,CAUO5I,OAAO+H,eAAP,CAAuBc,gBAAgB;AAC5C5D,WAAG6D,SAAH,CAAatB,YAAb,EAA2BqB,YAA3B,EAAyC7I,OAAO+H,eAAP,CAAuB3D,OAAO;AACtE,cAAIA,OAAO,IAAX,EAAiB;AAChB2E,oBAAQC,KAAR,CAAc5E,GAAd;AACA;;AACD,gBAAM1D,OAAOuE,GAAGgE,SAAH,CAAazB,YAAb,EAA2B9G,IAAxC;AACA,eAAKwI,aAAL,GAAqBC,MAArB,CAA4BhG,MAA5B,CAAmC;AAACmD,iBAAKxG,KAAKwG;AAAX,WAAnC,EAAoD;AAAC8C,kBAAM;AAAC1I;AAAD;AAAP,WAApD;AACAiH,iBAAO0B,MAAP;AACA,SAPwC,CAAzC;AAQA,OATK,CAVP;AAoBA,KAzBU,CAAX;AA2BA,WAAO1B,OAAO2B,IAAP,EAAP;AACA,GA/GwB;;AAiHzBC,qBAAmBzJ,IAAnB,EAAyB;AACxBA,WAAOI,WAAWqB,MAAX,CAAkByE,OAAlB,CAA0BvE,WAA1B,CAAsC3B,KAAKwG,GAA3C,CAAP;AACAxG,WAAOiB,WAAWyI,cAAX,CAA0B1J,IAA1B,CAAP;;AACA,UAAM2J,QAAQ1I,WAAW2I,QAAX,CAAoB,SAApB,EAA+BC,MAA/B,CAAsCC,aAAtC,CAAoD9J,KAAKwG,GAAzD,EAA8DxG,IAA9D,CAAd;;AAEA,UAAM+J,cAAcxE,QAClB8C,MADkB,CACX,EADW,EACP,EADO,EAElB2B,GAFkB,GAGlB5B,IAHkB,GAIlB6B,IAJkB,EAApB;AAKA,UAAMC,SAASH,YAAYlB,QAAZ,GAAuBC,IAAvB,CAA6BqB,GAAD,IAASA,IAAIC,QAAJ,CAAa,QAAb,CAArC,CAAf;AACAT,UAAMjB,IAAN,CAAWqB,WAAX;AACA,WAAOG,MAAP;AACA,GA9HwB;;AAgIzBxD,oBAAkB1G,IAAlB,EAAwB;AACvB,QAAI,CAAC,yCAAyCoB,IAAzC,CAA8CpB,KAAKM,IAAnD,CAAL,EAA+D;AAC9D;AACA;;AAED,UAAM+J,UAAU3H,SAASiF,eAAT,CAAyB3H,KAAKwG,GAA9B,CAAhB;AAEA,UAAM8D,MAAM,IAAIhF,MAAJ,EAAZ;AAEA,UAAMwC,IAAIvC,MAAM8E,OAAN,CAAV;AACAvC,MAAEE,QAAF,CAAW9H,OAAO+H,eAAP,CAAuB,CAAC3D,GAAD,EAAM0D,QAAN,KAAmB;AACpD,UAAI1D,OAAO,IAAX,EAAiB;AAChB2E,gBAAQC,KAAR,CAAc5E,GAAd;AACA,eAAOgG,IAAIf,MAAJ,EAAP;AACA;;AAED,YAAMgB,WAAW;AAChBpC,gBAAQH,SAASG,MADD;AAEhBvH,cAAM;AACL4H,iBAAOR,SAASQ,KADX;AAELZ,kBAAQI,SAASJ;AAFZ;AAFU,OAAjB;;AAQA,UAAII,SAASwC,WAAT,IAAwB,IAA5B,EAAkC;AACjC,eAAOF,IAAIf,MAAJ,EAAP;AACA;;AAEDzB,QAAEC,MAAF,GACE0C,MADF,CACU,GAAGJ,OAAS,MADtB,EAEEvB,IAFF,CAEO5I,OAAO+H,eAAP,CAAuB,MAAM;AAClC9C,WAAGuF,MAAH,CAAUL,OAAV,EAAmBnK,OAAO+H,eAAP,CAAuB,MAAM;AAC/C9C,aAAGwF,MAAH,CAAW,GAAGN,OAAS,MAAvB,EAA8BA,OAA9B,EAAuCnK,OAAO+H,eAAP,CAAuB,MAAM;AACnE,kBAAMrH,OAAOuE,GAAGgE,SAAH,CAAakB,OAAb,EAAsBzJ,IAAnC;AACA,iBAAKwI,aAAL,GAAqBC,MAArB,CAA4BhG,MAA5B,CAAmC;AAACmD,mBAAKxG,KAAKwG;AAAX,aAAnC,EAAoD;AACnD8C,oBAAM;AACL1I,oBADK;AAEL2J;AAFK;AAD6C,aAApD;AAMAD,gBAAIf,MAAJ;AACA,WATsC,CAAvC;AAUA,SAXkB,CAAnB;AAYA,OAbK,CAFP,EAeKqB,KAfL,CAeYtG,GAAD,IAAS;AAClB2E,gBAAQC,KAAR,CAAc5E,GAAd;AACAgG,YAAIf,MAAJ;AACA,OAlBF;AAmBA,KArCU,CAAX;AAuCA,WAAOe,IAAId,IAAJ,EAAP;AACA,GAlLwB;;AAoLzBjC,wBAAsBvH,IAAtB,EAA4B;AAC3B;AACA,UAAMuB,OAAOnB,WAAWqB,MAAX,CAAkBoJ,KAAlB,CAAwBlJ,WAAxB,CAAoC3B,KAAKC,MAAzC,CAAb;AACA,UAAM6K,YAAY1K,WAAWqB,MAAX,CAAkB2F,OAAlB,CAA0B2D,aAA1B,CAAwCxJ,KAAKyJ,QAA7C,CAAlB;;AACA,QAAIF,SAAJ,EAAe;AACd1K,iBAAWqB,MAAX,CAAkB2F,OAAlB,CAA0B6D,UAA1B,CAAqCH,UAAUtE,GAA/C;AACA;;AACDpG,eAAWqB,MAAX,CAAkB2F,OAAlB,CAA0B8D,kBAA1B,CAA6ClL,KAAKwG,GAAlD,EAAuDjF,KAAKyJ,QAA5D,EAP2B,CAQ3B;AACA,GA7LwB;;AA+LzBjE,wBAAsB;AAAEoE,cAAU,EAAZ;AAAgBC,YAAQ;AAAxB,GAAtB,EAAoD;AACnD,QAAI,CAAChL,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,CAAL,EAAyD;AACxD,aAAO,IAAP;AACA;;AAED,QAAI;AAAE0K,YAAF;AAAUC,cAAV;AAAoBC,YAApB;AAA4BC;AAA5B,QAA6CJ,KAAjD;;AAEA,QAAI,CAACC,MAAD,IAAWF,QAAQ1F,MAAvB,EAA+B;AAC9B4F,eAAS5F,OAAO9E,GAAP,CAAW,QAAX,EAAqBwK,QAAQ1F,MAA7B,CAAT;AACA6F,iBAAW7F,OAAO9E,GAAP,CAAW,UAAX,EAAuBwK,QAAQ1F,MAA/B,CAAX;AACA8F,eAAS9F,OAAO9E,GAAP,CAAW,QAAX,EAAqBwK,QAAQ1F,MAA7B,CAAT;AACA+F,qBAAe/F,OAAO9E,GAAP,CAAW,cAAX,EAA2BwK,QAAQ1F,MAAnC,CAAf;AACA;;AAED,UAAMgG,wBAAwBJ,UAAUC,QAAV,IAAsBlL,WAAWqB,MAAX,CAAkBoJ,KAAlB,CAAwBa,wBAAxB,CAAiDL,MAAjD,EAAyDC,QAAzD,CAApD;AACA,UAAMK,wBAAwBR,QAAQ,WAAR,KAAwBA,QAAQ,cAAR,CAAxB,IAAmD/K,WAAWqB,MAAX,CAAkBoJ,KAAlB,CAAwBa,wBAAxB,CAAiDP,QAAQ,WAAR,CAAjD,EAAuEA,QAAQ,cAAR,CAAvE,CAAjF;AACA,UAAMS,qBAAqBJ,gBAAgBpL,WAAWyL,SAAX,CAAqBC,SAArB,CAA+BN,YAA/B,EAA6CO,qBAA7C,CAAmE;AAAEV,YAAF;AAAUE,YAAV;AAAkBD;AAAlB,KAAnE,CAA3C;AACA,WAAOG,yBAAyBE,qBAAzB,IAAkDC,kBAAzD;AACA,GAjNwB;;AAkNzBlC,iBAAe1J,IAAf,EAAqB;AACpB,QAAIqF,KAAK2G,MAAL,CAAYhM,KAAK+D,IAAjB,MAA2B/D,KAAKM,IAApC,EAA0C;AACzC,aAAON,IAAP;AACA;;AAED,UAAMiM,MAAM5G,KAAK6G,SAAL,CAAelM,KAAKM,IAApB,CAAZ;;AACA,QAAI2L,OAAO,UAAU,IAAIE,MAAJ,CAAY,KAAKF,GAAK,GAAtB,EAA0B,GAA1B,EAA+B7K,IAA/B,CAAoCpB,KAAK+D,IAAzC,CAArB,EAAqE;AACpE/D,WAAK+D,IAAL,GAAa,GAAG/D,KAAK+D,IAAM,IAAIkI,GAAK,EAApC;AACA;;AAED,WAAOjM,IAAP;AACA,GA7NwB;;AA+NzB4J,WAASwC,SAAT,EAAoB;AACnB,UAAMC,cAAcjM,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,CAApB;AACA,UAAM2L,cAAe,GAAGD,WAAa,IAAID,SAAW,EAApD;AAEA,WAAO,KAAKG,cAAL,CAAoBD,WAApB,CAAP;AACA,GApOwB;;AAsOzBC,iBAAeD,WAAf,EAA4B;AAC3B,QAAI,KAAK1G,QAAL,CAAc0G,WAAd,KAA8B,IAAlC,EAAwC;AACvCrD,cAAQC,KAAR,CAAe,mBAAmBoD,WAAa,mBAA/C;AACA;;AACD,WAAO,KAAK1G,QAAL,CAAc0G,WAAd,CAAP;AACA,GA3OwB;;AA6OzB3L,MAAIX,IAAJ,EAAU6G,GAAV,EAAeC,GAAf,EAAoB0F,IAApB,EAA0B;AACzB,UAAMtJ,QAAQ,KAAKqJ,cAAL,CAAoBvM,KAAKkD,KAAzB,CAAd;;AACA,QAAIA,SAASA,MAAMvC,GAAnB,EAAwB;AACvB,aAAOuC,MAAMvC,GAAN,CAAUX,IAAV,EAAgB6G,GAAhB,EAAqBC,GAArB,EAA0B0F,IAA1B,CAAP;AACA;;AACD1F,QAAIE,SAAJ,CAAc,GAAd;AACAF,QAAI2F,GAAJ;AACA,GApPwB;;AAsPzBC,OAAK1M,IAAL,EAAW2M,UAAX,EAAuB;AACtB,UAAMzJ,QAAQ,KAAKqJ,cAAL,CAAoBvM,KAAKkD,KAAzB,CAAd;AACA,UAAMiH,MAAMhF,GAAGyH,iBAAH,CAAqBD,UAArB,CAAZ;AAEA3M,WAAOiB,WAAWyI,cAAX,CAA0B1J,IAA1B,CAAP;;AAEA,QAAIkD,MAAMwJ,IAAV,EAAgB;AACfxJ,YAAMwJ,IAAN,CAAW1M,IAAX,EAAiBmK,GAAjB;AACA,aAAO,IAAP;AACA;;AAED,WAAO,KAAP;AACA;;AAlQwB,CAA1B;;AAqQO,MAAMjF,eAAN,CAAsB;AAC5BzB,cAAY;AAAEM,QAAF;AAAQoC,SAAR;AAAejD,SAAf;AAAsBvC,OAAtB;AAA2BmC,UAA3B;AAAmC8G,YAAnC;AAA6C8C;AAA7C,GAAZ,EAAiE;AAChE,SAAK3I,IAAL,GAAYA,IAAZ;AACA,SAAKoC,KAAL,GAAaA,SAAS,KAAK0G,gBAAL,EAAtB;AACA,SAAKhD,MAAL,GAAc3G,SAASR,SAASkH,QAAT,CAAkB7F,IAAlB,CAAvB;AACA,SAAKpD,GAAL,GAAWA,GAAX;AACA,SAAK+L,IAAL,GAAYA,IAAZ;;AAEA,QAAI5J,MAAJ,EAAY;AACX,WAAKA,MAAL,GAAcA,MAAd;AACA;;AAED,QAAI8G,QAAJ,EAAc;AACb,WAAKA,QAAL,GAAgBA,QAAhB;AACA;;AAED3I,eAAW2E,QAAX,CAAoB7B,IAApB,IAA4B,IAA5B;AACA;;AAED6F,aAAW;AACV,WAAO,KAAKC,MAAZ;AACA;;AAED,MAAI3G,KAAJ,GAAY;AACX,WAAO,KAAK0G,QAAL,EAAP;AACA;;AAED,MAAI1G,KAAJ,CAAUA,KAAV,EAAiB;AAChB,SAAK2G,MAAL,GAAc3G,KAAd;AACA;;AAED2J,qBAAmB;AAClB,WAAOzM,WAAWqB,MAAX,CAAkB,KAAKsC,IAAL,CAAUZ,KAAV,CAAgB,GAAhB,EAAqB,CAArB,CAAlB,CAAP;AACA;;AAED2J,SAAOlG,MAAP,EAAe;AACd,QAAI,KAAK1D,KAAL,IAAc,KAAKA,KAAL,CAAW4J,MAA7B,EAAqC;AACpC,WAAK5J,KAAL,CAAW4J,MAAX,CAAkBlG,MAAlB;AACA;;AAED,WAAO,KAAKT,KAAL,CAAW8E,UAAX,CAAsBrE,MAAtB,CAAP;AACA;;AAEDmG,aAAWnG,MAAX,EAAmB;AAClB,UAAM5G,OAAO,KAAKmG,KAAL,CAAWxE,WAAX,CAAuBiF,MAAvB,CAAb;;AAEA,QAAI,CAAC5G,IAAL,EAAW;AACV;AACA;;AAED,UAAMkD,QAAQjC,WAAWsL,cAAX,CAA0BvM,KAAKkD,KAA/B,CAAd;AAEA,WAAOA,MAAM4J,MAAN,CAAa9M,KAAKwG,GAAlB,CAAP;AACA;;AAEDwG,eAAaC,QAAb,EAAuB;AACtB,UAAMjN,OAAO,KAAKmG,KAAL,CAAW4E,aAAX,CAAyBkC,QAAzB,CAAb;;AAEA,QAAI,CAACjN,IAAL,EAAW;AACV;AACA;;AAED,UAAMkD,QAAQjC,WAAWsL,cAAX,CAA0BvM,KAAKkD,KAA/B,CAAd;AAEA,WAAOA,MAAM4J,MAAN,CAAa9M,KAAKwG,GAAlB,CAAP;AACA;;AAED1D,SAAO0B,QAAP,EAAiB0I,cAAjB,EAAiCC,EAAjC,EAAqC;AACpC3I,aAAS5D,IAAT,GAAgByB,SAASmC,SAAS5D,IAAlB,KAA2B,CAA3C,CADoC,CAGpC;;AACA,UAAMwF,SAAS,KAAKlD,KAAL,CAAWkK,SAAX,EAAf;;AACA,QAAIhH,UAAUA,OAAOiH,KAArB,EAA4B;AAC3BjH,aAAOiH,KAAP,CAAa7I,QAAb;AACA;;AAED,UAAMoC,SAAS,KAAK1D,KAAL,CAAWoK,MAAX,CAAkB9I,QAAlB,CAAf;AACA,UAAM+I,QAAQ,KAAKrK,KAAL,CAAWsK,WAAX,CAAuB5G,MAAvB,CAAd;AACA,UAAMyD,UAAU3H,SAASiF,eAAT,CAAyBf,MAAzB,CAAhB;;AAEA,QAAI;AACH,UAAIsG,0BAA0B9H,MAA9B,EAAsC;AACrC8H,uBAAexE,IAAf,CAAoBvD,GAAGyH,iBAAH,CAAqBvC,OAArB,CAApB;AACA,OAFD,MAEO,IAAI6C,0BAA0BO,MAA9B,EAAsC;AAC5CtI,WAAGuI,aAAH,CAAiBrD,OAAjB,EAA0B6C,cAA1B;AACA,OAFM,MAEA;AACN,cAAM,IAAI/M,KAAJ,CAAU,mBAAV,CAAN;AACA;;AAED,YAAMH,OAAOE,OAAOyN,IAAP,CAAY,aAAZ,EAA2B/G,MAA3B,EAAmC,KAAK7C,IAAxC,EAA8CwJ,KAA9C,CAAb;;AAEA,UAAIJ,EAAJ,EAAQ;AACPA,WAAG,IAAH,EAASnN,IAAT;AACA;;AAED,aAAOA,IAAP;AACA,KAhBD,CAgBE,OAAOsC,CAAP,EAAU;AACX,UAAI6K,EAAJ,EAAQ;AACPA,WAAG7K,CAAH;AACA,OAFD,MAEO;AACN,cAAMA,CAAN;AACA;AACD;AACD;;AAvG2B,C;;;;;;;;;;;AChR7B,IAAIsL,IAAJ;AAASnO,OAAOC,KAAP,CAAaC,QAAQ,MAAR,CAAb,EAA6B;AAACC,UAAQC,CAAR,EAAU;AAAC+N,WAAK/N,CAAL;AAAO;;AAAnB,CAA7B,EAAkD,CAAlD;AAAqD,IAAIgO,GAAJ;AAAQpO,OAAOC,KAAP,CAAaC,QAAQ,KAAR,CAAb,EAA4B;AAACC,UAAQC,CAAR,EAAU;AAACgO,UAAIhO,CAAJ;AAAM;;AAAlB,CAA5B,EAAgD,CAAhD;AAKtE,MAAMiO,SAAS,IAAIC,MAAJ,CAAW,aAAX,CAAf;AAEAC,OAAOC,eAAP,CAAuBC,KAAvB,CAA6BC,OAA7B,CAAqC;AACpCC,SAAO,EAD6B;AAEpCC,UAAQnO,OAAO+H,eAAP,CAAuB,UAASpB,GAAT,EAAcC,GAAd,EAAmB0F,IAAnB,EAAyB;AACvD;AACA,QAAI3F,IAAInC,GAAJ,CAAQzB,OAAR,CAAgBP,SAASC,MAAT,CAAgB2L,UAAhC,MAAgD,CAAC,CAArD,EAAwD;AACvD,aAAO9B,MAAP;AACA;;AAEDsB,WAAOS,KAAP,CAAa,aAAb,EAA4B1H,IAAInC,GAAhC;;AAEA,QAAImC,IAAI2H,MAAJ,KAAe,MAAnB,EAA2B;AAC1B,aAAOhC,MAAP;AACA,KAVsD,CAYvD;;;AACA,UAAMiC,YAAYZ,IAAIa,KAAJ,CAAU7H,IAAInC,GAAd,CAAlB;AACA,UAAMiK,OAAOF,UAAUG,QAAV,CAAmBC,MAAnB,CAA0BnM,SAASC,MAAT,CAAgB2L,UAAhB,CAA2BQ,MAA3B,GAAoC,CAA9D,CAAb,CAduD,CAgBvD;;AACA,UAAMC,SAAS,IAAI5C,MAAJ,CAAW,4BAAX,CAAf;AACA,UAAM6C,QAAQD,OAAOE,IAAP,CAAYN,IAAZ,CAAd,CAlBuD,CAoBvD;;AACA,QAAIK,UAAU,IAAd,EAAoB;AACnBlI,UAAIE,SAAJ,CAAc,GAAd;AACAF,UAAI2F,GAAJ;AACA;AACA,KAzBsD,CA2BvD;;;AACA,UAAMvJ,QAAQR,SAASkH,QAAT,CAAkBoF,MAAM,CAAN,CAAlB,CAAd;;AACA,QAAI,CAAC9L,KAAL,EAAY;AACX4D,UAAIE,SAAJ,CAAc,GAAd;AACAF,UAAI2F,GAAJ;AACA;AACA,KAjCsD,CAmCvD;;;AACA,UAAM7F,SAASoI,MAAM,CAAN,CAAf;AACA,UAAMhP,OAAOkD,MAAMkG,aAAN,GAAsB8F,OAAtB,CAA8B;AAAC1I,WAAKI;AAAN,KAA9B,CAAb;;AACA,QAAI5G,SAASmP,SAAb,EAAwB;AACvBrI,UAAIE,SAAJ,CAAc,GAAd;AACAF,UAAI2F,GAAJ;AACA;AACA;;AAED,QAAIzM,KAAKoP,UAAL,KAAoBC,eAAe1L,EAAf,EAAxB,EAA6C;AAC5CmK,aAAOS,KAAP,CAAa,kBAAb;AACA,aAAO/B,MAAP;AACA,KA/CsD,CAiDvD;;;AACA,UAAM8C,WAAWD,eAAejG,aAAf,GAA+B8F,OAA/B,CAAuC;AAAC1I,WAAKxG,KAAKoP;AAAX,KAAvC,CAAjB;;AAEA,QAAIE,YAAY,IAAhB,EAAsB;AACrBxI,UAAIE,SAAJ,CAAc,GAAd;AACAF,UAAI2F,GAAJ;AACA;AACA;;AAED,QAAI6C,SAASC,gBAAT,CAA0BC,IAA1B,KAAmCC,QAAQC,GAAR,CAAYC,WAA/C,IAA8DvP,WAAWwP,QAAX,OAA0B,KAA5F,EAAmG;AAClGN,eAASC,gBAAT,CAA0BC,IAA1B,GAAiC,WAAjC;AACA;;AAED1B,WAAOS,KAAP,CAAa,6BAAb,EAA6C,GAAGe,SAASC,gBAAT,CAA0BC,IAAM,IAAIF,SAASC,gBAAT,CAA0BM,IAAM,EAApH;AAEA,UAAMhL,UAAU;AACfiL,gBAAUR,SAASC,gBAAT,CAA0BC,IADrB;AAEfK,YAAMP,SAASC,gBAAT,CAA0BM,IAFjB;AAGflB,YAAM9H,IAAIkJ,WAHK;AAIfvB,cAAQ;AAJO,KAAhB;AAOA,UAAMwB,QAAQpC,KAAKqC,OAAL,CAAapL,OAAb,EAAsB,UAASqL,SAAT,EAAoB;AACvDA,gBAAUxH,IAAV,CAAe5B,GAAf,EAAoB;AACnB2F,aAAK;AADc,OAApB;AAGA,KAJa,CAAd;AAMA5F,QAAI6B,IAAJ,CAASsH,KAAT,EAAgB;AACfvD,WAAK;AADU,KAAhB;AAGA,GAhFO;AAF4B,CAArC,E;;;;;;;;;;;ACPA;AAEAuB,OAAOC,eAAP,CAAuBkC,GAAvB,CAA2B,eAA3B,EAA4C,UAAStJ,GAAT,EAAcC,GAAd,EAAmB0F,IAAnB,EAAyB;AAEpE,QAAMwC,QAAQ,oBAAoBC,IAApB,CAAyBpI,IAAInC,GAA7B,CAAd;;AAEA,MAAIsK,MAAM,CAAN,CAAJ,EAAc;AACb,UAAMhP,OAAOI,WAAWqB,MAAX,CAAkByE,OAAlB,CAA0BvE,WAA1B,CAAsCqN,MAAM,CAAN,CAAtC,CAAb;;AAEA,QAAIhP,IAAJ,EAAU;AACT,UAAI,CAACE,OAAOQ,QAAP,CAAgB0P,MAAhB,CAAuBC,SAAxB,IAAqC,CAACpP,WAAW8F,qBAAX,CAAiCF,GAAjC,CAA1C,EAAiF;AAChFC,YAAIE,SAAJ,CAAc,GAAd;AACA,eAAOF,IAAI2F,GAAJ,EAAP;AACA;;AAED3F,UAAIG,SAAJ,CAAc,yBAAd,EAAyC,sBAAzC;AACA,aAAOhG,WAAWN,GAAX,CAAeX,IAAf,EAAqB6G,GAArB,EAA0BC,GAA1B,EAA+B0F,IAA/B,CAAP;AACA;AACD;;AAED1F,MAAIE,SAAJ,CAAc,GAAd;AACAF,MAAI2F,GAAJ;AACA,CApBD,E;;;;;;;;;;;ACFA,IAAIhK,CAAJ;;AAAMhD,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAAC4C,QAAE5C,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwDJ,OAAOC,KAAP,CAAaC,QAAQ,eAAR,CAAb;AAAuCF,OAAOC,KAAP,CAAaC,QAAQ,iBAAR,CAAb;AAAyCF,OAAOC,KAAP,CAAaC,QAAQ,oBAAR,CAAb;AAA4CF,OAAOC,KAAP,CAAaC,QAAQ,aAAR,CAAb;AAAqCF,OAAOC,KAAP,CAAaC,QAAQ,aAAR,CAAb;AAAqCF,OAAOC,KAAP,CAAaC,QAAQ,2BAAR,CAAb;;AAUpQ,MAAM2Q,cAAc7N,EAAE8N,QAAF,CAAW,MAAM;AACpC,QAAMrN,QAAQ9C,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,CAAd;;AAEA,MAAIuC,KAAJ,EAAW;AACV+F,YAAQuH,GAAR,CAAY,+BAAZ,EAA6CtN,KAA7C;AACAR,aAASqD,SAAT,GAAqBqB,OAArB,GAA+B1E,SAASkH,QAAT,CAAmB,GAAG1G,KAAO,UAA7B,CAA/B;AACAR,aAASqD,SAAT,GAAqBG,OAArB,GAA+BxD,SAASkH,QAAT,CAAmB,GAAG1G,KAAO,UAA7B,CAA/B;AACAR,aAASqD,SAAT,GAAqB0B,aAArB,GAAqC/E,SAASkH,QAAT,CAAmB,GAAG1G,KAAO,gBAA7B,CAArC;AACA;AACD,CATmB,EASjB,IATiB,CAApB;;AAWA9C,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,cAAxB,EAAwC2P,WAAxC,E;;;;;;;;;;;ACrBA,IAAI7N,CAAJ;;AAAMhD,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAAC4C,QAAE5C,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIqF,eAAJ;AAAoBzF,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACuF,kBAAgBrF,CAAhB,EAAkB;AAACqF,sBAAgBrF,CAAhB;AAAkB;;AAAtC,CAA1C,EAAkF,CAAlF;AAAqFJ,OAAOC,KAAP,CAAaC,QAAQ,8BAAR,CAAb;AAAsD,IAAIiO,IAAJ;AAASnO,OAAOC,KAAP,CAAaC,QAAQ,MAAR,CAAb,EAA6B;AAACC,UAAQC,CAAR,EAAU;AAAC+N,WAAK/N,CAAL;AAAO;;AAAnB,CAA7B,EAAkD,CAAlD;AAAqD,IAAI4Q,KAAJ;AAAUhR,OAAOC,KAAP,CAAaC,QAAQ,OAAR,CAAb,EAA8B;AAACC,UAAQC,CAAR,EAAU;AAAC4Q,YAAM5Q,CAAN;AAAQ;;AAApB,CAA9B,EAAoD,CAApD;;AAQrS,MAAMc,MAAM,UAASX,IAAT,EAAe6G,GAAf,EAAoBC,GAApB,EAAyB;AACpC,QAAM4J,UAAU,KAAKxN,KAAL,CAAWyN,cAAX,CAA0B3Q,IAA1B,CAAhB;;AAEA,MAAI0Q,OAAJ,EAAa;AACZ,UAAME,YAAY5Q,KAAKkD,KAAL,CAAWC,KAAX,CAAiB,GAAjB,EAAsBC,GAAtB,EAAlB;;AACA,QAAIhD,WAAWM,QAAX,CAAoBC,GAApB,CAAyB,uBAAuBiQ,SAAW,EAA3D,CAAJ,EAAmE;AAClE,YAAMX,UAAU,UAAU7O,IAAV,CAAesP,OAAf,IAA0BD,KAA1B,GAAkC7C,IAAlD;AACAqC,cAAQtP,GAAR,CAAY+P,OAAZ,EAAqBG,WAAWA,QAAQnI,IAAR,CAAa5B,GAAb,CAAhC;AACA,KAHD,MAGO;AACNA,UAAIgK,YAAJ,CAAiB,gBAAjB;AACAhK,UAAIG,SAAJ,CAAc,UAAd,EAA0ByJ,OAA1B;AACA5J,UAAIE,SAAJ,CAAc,GAAd;AACAF,UAAI2F,GAAJ;AACA;AACD,GAXD,MAWO;AACN3F,QAAI2F,GAAJ;AACA;AACD,CAjBD;;AAmBA,MAAMC,OAAO,UAAS1M,IAAT,EAAemK,GAAf,EAAoB;AAChC,QAAMuG,UAAU,KAAKxN,KAAL,CAAWyN,cAAX,CAA0B3Q,IAA1B,CAAhB;;AAEA,MAAI0Q,OAAJ,EAAa;AACZ,UAAMT,UAAU,UAAU7O,IAAV,CAAesP,OAAf,IAA0BD,KAA1B,GAAkC7C,IAAlD;AACAqC,YAAQtP,GAAR,CAAY+P,OAAZ,EAAqBG,WAAWA,QAAQnI,IAAR,CAAayB,GAAb,CAAhC;AACA,GAHD,MAGO;AACNA,QAAIsC,GAAJ;AACA;AACD,CATD;;AAWA,MAAMsE,kBAAkB,IAAI7L,eAAJ,CAAoB;AAC3CnB,QAAM,kBADqC;AAE3CpD,KAF2C;AAG3C+L,MAH2C,CAI3C;;AAJ2C,CAApB,CAAxB;AAOA,MAAMsE,kBAAkB,IAAI9L,eAAJ,CAAoB;AAC3CnB,QAAM,kBADqC;AAE3CpD,KAF2C;AAG3C+L,MAH2C,CAI3C;;AAJ2C,CAApB,CAAxB;AAOA,MAAMuE,wBAAwB,IAAI/L,eAAJ,CAAoB;AACjDnB,QAAM,wBAD2C;AAEjDpD,KAFiD;AAGjD+L,MAHiD,CAIjD;;AAJiD,CAApB,CAA9B;;AAOA,MAAMwE,YAAYzO,EAAE8N,QAAF,CAAW,YAAW;AACvC,QAAMY,SAAS/Q,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,sBAAxB,CAAf;AACA,QAAMyQ,MAAMhR,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,mBAAxB,CAAZ;AACA,QAAM0Q,iBAAiBjR,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,8BAAxB,CAAvB;AACA,QAAM2Q,qBAAqBlR,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,kCAAxB,CAA3B;AACA,QAAM4Q,oBAAoBnR,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,iCAAxB,CAA1B;AACA,QAAM6Q,SAASpR,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,sBAAxB,CAAf;AACA,QAAM8Q,mBAAmBrR,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,gCAAxB,CAAzB;AACA,QAAM+Q,iBAAiBtR,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,8BAAxB,CAAvB,CARuC,CASvC;;AACA,QAAMgR,YAAYvR,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,CAAlB;;AAEA,MAAI,CAACwQ,MAAL,EAAa;AACZ;AACA;;AAED,QAAMxO,SAAS;AACdiP,gBAAY;AACXC,wBAAkBJ,gBADP;AAEXK,wBAAkBJ,cAFP;AAGXK,cAAQ;AACPZ,cADO;AAEPa,aAAKZ;AAFE,OAHG;AAOXa,cAAQT;AAPG,KADE;AAUdD;AAVc,GAAf;;AAaA,MAAIF,cAAJ,EAAoB;AACnB1O,WAAOiP,UAAP,CAAkBM,WAAlB,GAAgCb,cAAhC;AACA;;AAED,MAAIC,kBAAJ,EAAwB;AACvB3O,WAAOiP,UAAP,CAAkBO,eAAlB,GAAoCb,kBAApC;AACA;;AAED,MAAIK,SAAJ,EAAe;AACdhP,WAAOiP,UAAP,CAAkBQ,QAAlB,GAA6BT,SAA7B;AACA;;AAEDZ,kBAAgB7N,KAAhB,GAAwBjC,WAAW4E,qBAAX,CAAiC,UAAjC,EAA6CkL,gBAAgBhN,IAA7D,EAAmEpB,MAAnE,CAAxB;AACAqO,kBAAgB9N,KAAhB,GAAwBjC,WAAW4E,qBAAX,CAAiC,UAAjC,EAA6CmL,gBAAgBjN,IAA7D,EAAmEpB,MAAnE,CAAxB;AACAsO,wBAAsB/N,KAAtB,GAA8BjC,WAAW4E,qBAAX,CAAiC,UAAjC,EAA6CoL,sBAAsBlN,IAAnE,EAAyEpB,MAAzE,CAA9B;AACA,CA5CiB,EA4Cf,GA5Ce,CAAlB;;AA8CAvC,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,iBAAxB,EAA2CuQ,SAA3C,E;;;;;;;;;;;ACzGA,IAAIzO,CAAJ;;AAAMhD,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAAC4C,QAAE5C,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIsF,EAAJ;AAAO1F,OAAOC,KAAP,CAAaC,QAAQ,IAAR,CAAb,EAA2B;AAACC,UAAQC,CAAR,EAAU;AAACsF,SAAGtF,CAAH;AAAK;;AAAjB,CAA3B,EAA8C,CAA9C;AAAiD,IAAIqF,eAAJ;AAAoBzF,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACuF,kBAAgBrF,CAAhB,EAAkB;AAACqF,sBAAgBrF,CAAhB;AAAkB;;AAAtC,CAA1C,EAAkF,CAAlF;AAM1I,MAAMwS,oBAAoB,IAAInN,eAAJ,CAAoB;AAC7CnB,QAAM,oBADuC;;AAE7C;AAEApD,MAAIX,IAAJ,EAAU6G,GAAV,EAAeC,GAAf,EAAoB;AACnB,UAAMwL,WAAW,KAAKpP,KAAL,CAAWqP,WAAX,CAAuBvS,KAAKwG,GAA5B,EAAiCxG,IAAjC,CAAjB;;AAEA,QAAI;AACH,YAAMwS,OAAOtS,OAAOuS,SAAP,CAAiBtN,GAAGqN,IAApB,EAA0BF,QAA1B,CAAb;;AAEA,UAAIE,QAAQA,KAAKE,MAAL,EAAZ,EAA2B;AAC1B1S,eAAOiB,WAAWyI,cAAX,CAA0B1J,IAA1B,CAAP;AACA8G,YAAIG,SAAJ,CAAc,qBAAd,EAAsC,gCAAgCC,mBAAmBlH,KAAK+D,IAAxB,CAA+B,EAArG;AACA+C,YAAIG,SAAJ,CAAc,eAAd,EAA+BjH,KAAK2S,UAAL,CAAgBC,WAAhB,EAA/B;AACA9L,YAAIG,SAAJ,CAAc,cAAd,EAA8BjH,KAAKM,IAAnC;AACAwG,YAAIG,SAAJ,CAAc,gBAAd,EAAgCjH,KAAKY,IAArC;AAEA,aAAKsC,KAAL,CAAW4G,aAAX,CAAyB9J,KAAKwG,GAA9B,EAAmCxG,IAAnC,EAAyC0I,IAAzC,CAA8C5B,GAA9C;AACA;AACD,KAZD,CAYE,OAAOxE,CAAP,EAAU;AACXwE,UAAIE,SAAJ,CAAc,GAAd;AACAF,UAAI2F,GAAJ;AACA;AACA;AACD,GAxB4C;;AA0B7CC,OAAK1M,IAAL,EAAWmK,GAAX,EAAgB;AACf,UAAMmI,WAAW,KAAKpP,KAAL,CAAWqP,WAAX,CAAuBvS,KAAKwG,GAA5B,EAAiCxG,IAAjC,CAAjB;;AACA,QAAI;AACH,YAAMwS,OAAOtS,OAAOuS,SAAP,CAAiBtN,GAAGqN,IAApB,EAA0BF,QAA1B,CAAb;;AAEA,UAAIE,QAAQA,KAAKE,MAAL,EAAZ,EAA2B;AAC1B1S,eAAOiB,WAAWyI,cAAX,CAA0B1J,IAA1B,CAAP;AAEA,aAAKkD,KAAL,CAAW4G,aAAX,CAAyB9J,KAAKwG,GAA9B,EAAmCxG,IAAnC,EAAyC0I,IAAzC,CAA8CyB,GAA9C;AACA;AACD,KARD,CAQE,OAAO7H,CAAP,EAAU;AACX6H,UAAIsC,GAAJ;AACA;AACA;AACD;;AAxC4C,CAApB,CAA1B;AA2CA,MAAMoG,oBAAoB,IAAI3N,eAAJ,CAAoB;AAC7CnB,QAAM,oBADuC;;AAE7C;AAEApD,MAAIX,IAAJ,EAAU6G,GAAV,EAAeC,GAAf,EAAoB;AACnB,UAAMwL,WAAW,KAAKpP,KAAL,CAAWqP,WAAX,CAAuBvS,KAAKwG,GAA5B,EAAiCxG,IAAjC,CAAjB;;AAEA,QAAI;AACH,YAAMwS,OAAOtS,OAAOuS,SAAP,CAAiBtN,GAAGqN,IAApB,EAA0BF,QAA1B,CAAb;;AAEA,UAAIE,QAAQA,KAAKE,MAAL,EAAZ,EAA2B;AAC1B1S,eAAOiB,WAAWyI,cAAX,CAA0B1J,IAA1B,CAAP;AAEA,aAAKkD,KAAL,CAAW4G,aAAX,CAAyB9J,KAAKwG,GAA9B,EAAmCxG,IAAnC,EAAyC0I,IAAzC,CAA8C5B,GAA9C;AACA;AACD,KARD,CAQE,OAAOxE,CAAP,EAAU;AACXwE,UAAIE,SAAJ,CAAc,GAAd;AACAF,UAAI2F,GAAJ;AACA;AACA;AACD;;AApB4C,CAApB,CAA1B;AAuBA,MAAMqG,0BAA0B,IAAI5N,eAAJ,CAAoB;AACnDnB,QAAM,0BAD6C;;AAGnDpD,MAAIX,IAAJ,EAAU6G,GAAV,EAAeC,GAAf,EAAoB;AACnB,UAAMwL,WAAW,KAAKpP,KAAL,CAAWqP,WAAX,CAAuBvS,KAAKwG,GAA5B,EAAiCxG,IAAjC,CAAjB;;AAEA,QAAI;AACH,YAAMwS,OAAOtS,OAAOuS,SAAP,CAAiBtN,GAAGqN,IAApB,EAA0BF,QAA1B,CAAb;;AAEA,UAAIE,QAAQA,KAAKE,MAAL,EAAZ,EAA2B;AAC1B1S,eAAOiB,WAAWyI,cAAX,CAA0B1J,IAA1B,CAAP;AACA8G,YAAIG,SAAJ,CAAc,qBAAd,EAAsC,gCAAgCC,mBAAmBlH,KAAK+D,IAAxB,CAA+B,EAArG;AACA+C,YAAIG,SAAJ,CAAc,eAAd,EAA+BjH,KAAK2S,UAAL,CAAgBC,WAAhB,EAA/B;AACA9L,YAAIG,SAAJ,CAAc,cAAd,EAA8BjH,KAAKM,IAAnC;AACAwG,YAAIG,SAAJ,CAAc,gBAAd,EAAgCjH,KAAKY,IAArC;AAEA,aAAKsC,KAAL,CAAW4G,aAAX,CAAyB9J,KAAKwG,GAA9B,EAAmCxG,IAAnC,EAAyC0I,IAAzC,CAA8C5B,GAA9C;AACA;AACD,KAZD,CAYE,OAAOxE,CAAP,EAAU;AACXwE,UAAIE,SAAJ,CAAc,GAAd;AACAF,UAAI2F,GAAJ;AACA;AACA;AACD;;AAvBkD,CAApB,CAAhC;;AA0BA,MAAMsG,wBAAwBtQ,EAAE8N,QAAF,CAAW,YAAW;AACnD,QAAM1L,UAAU;AACf8J,UAAMvO,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,2BAAxB,CADS,CAC4C;;AAD5C,GAAhB;AAIA0R,oBAAkBnP,KAAlB,GAA0BjC,WAAW4E,qBAAX,CAAiC,OAAjC,EAA0CwM,kBAAkBtO,IAA5D,EAAkEc,OAAlE,CAA1B;AACAgO,oBAAkB3P,KAAlB,GAA0BjC,WAAW4E,qBAAX,CAAiC,OAAjC,EAA0CgN,kBAAkB9O,IAA5D,EAAkEc,OAAlE,CAA1B;AACAiO,0BAAwB5P,KAAxB,GAAgCjC,WAAW4E,qBAAX,CAAiC,OAAjC,EAA0CiN,wBAAwB/O,IAAlE,EAAwEc,OAAxE,CAAhC,CAPmD,CASnD;;AACAnC,WAASqD,SAAT,GAAqB,YAArB,IAAqCrD,SAASqD,SAAT,GAAqBsM,kBAAkBtO,IAAvC,CAArC;AACA,CAX6B,EAW3B,GAX2B,CAA9B;;AAaA3D,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,2BAAxB,EAAqDoS,qBAArD,E;;;;;;;;;;;AC/GA,IAAItQ,CAAJ;;AAAMhD,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAAC4C,QAAE5C,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIqF,eAAJ;AAAoBzF,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACuF,kBAAgBrF,CAAhB,EAAkB;AAACqF,sBAAgBrF,CAAhB;AAAkB;;AAAtC,CAA1C,EAAkF,CAAlF;AAAqFJ,OAAOC,KAAP,CAAaC,QAAQ,mCAAR,CAAb;AAA2D,IAAIiO,IAAJ;AAASnO,OAAOC,KAAP,CAAaC,QAAQ,MAAR,CAAb,EAA6B;AAACC,UAAQC,CAAR,EAAU;AAAC+N,WAAK/N,CAAL;AAAO;;AAAnB,CAA7B,EAAkD,CAAlD;AAAqD,IAAI4Q,KAAJ;AAAUhR,OAAOC,KAAP,CAAaC,QAAQ,OAAR,CAAb,EAA8B;AAACC,UAAQC,CAAR,EAAU;AAAC4Q,YAAM5Q,CAAN;AAAQ;;AAApB,CAA9B,EAAoD,CAApD;;AAQ1S,MAAMc,MAAM,UAASX,IAAT,EAAe6G,GAAf,EAAoBC,GAApB,EAAyB;AACpC,OAAK5D,KAAL,CAAWyN,cAAX,CAA0B3Q,IAA1B,EAAgC,CAACsE,GAAD,EAAMoM,OAAN,KAAkB;AACjD,QAAIpM,GAAJ,EAAS;AACR2E,cAAQC,KAAR,CAAc5E,GAAd;AACA;;AAED,QAAIoM,OAAJ,EAAa;AACZ,YAAME,YAAY5Q,KAAKkD,KAAL,CAAWC,KAAX,CAAiB,GAAjB,EAAsBC,GAAtB,EAAlB;;AACA,UAAIhD,WAAWM,QAAX,CAAoBC,GAApB,CAAyB,kCAAkCiQ,SAAW,EAAtE,CAAJ,EAA8E;AAC7E,cAAMX,UAAU,UAAU7O,IAAV,CAAesP,OAAf,IAA0BD,KAA1B,GAAkC7C,IAAlD;AACAqC,gBAAQtP,GAAR,CAAY+P,OAAZ,EAAqBG,WAAWA,QAAQnI,IAAR,CAAa5B,GAAb,CAAhC;AACA,OAHD,MAGO;AACNA,YAAIgK,YAAJ,CAAiB,gBAAjB;AACAhK,YAAIG,SAAJ,CAAc,UAAd,EAA0ByJ,OAA1B;AACA5J,YAAIE,SAAJ,CAAc,GAAd;AACAF,YAAI2F,GAAJ;AACA;AACD,KAXD,MAWO;AACN3F,UAAI2F,GAAJ;AACA;AACD,GAnBD;AAoBA,CArBD;;AAuBA,MAAMC,OAAO,UAAS1M,IAAT,EAAemK,GAAf,EAAoB;AAChC,OAAKjH,KAAL,CAAWyN,cAAX,CAA0B3Q,IAA1B,EAAgC,CAACsE,GAAD,EAAMoM,OAAN,KAAkB;AACjD,QAAIpM,GAAJ,EAAS;AACR2E,cAAQC,KAAR,CAAc5E,GAAd;AACA;;AAED,QAAIoM,OAAJ,EAAa;AACZ,YAAMT,UAAU,UAAU7O,IAAV,CAAesP,OAAf,IAA0BD,KAA1B,GAAkC7C,IAAlD;AACAqC,cAAQtP,GAAR,CAAY+P,OAAZ,EAAqBG,WAAWA,QAAQnI,IAAR,CAAayB,GAAb,CAAhC;AACA,KAHD,MAGO;AACNA,UAAIsC,GAAJ;AACA;AACD,GAXD;AAYA,CAbD;;AAeA,MAAMuG,4BAA4B,IAAI9N,eAAJ,CAAoB;AACrDnB,QAAM,4BAD+C;AAErDpD,KAFqD;AAGrD+L,MAHqD,CAIrD;;AAJqD,CAApB,CAAlC;AAOA,MAAMuG,4BAA4B,IAAI/N,eAAJ,CAAoB;AACrDnB,QAAM,4BAD+C;AAErDpD,KAFqD;AAGrD+L,MAHqD,CAIrD;;AAJqD,CAApB,CAAlC;AAOA,MAAMwG,kCAAkC,IAAIhO,eAAJ,CAAoB;AAC3DnB,QAAM,kCADqD;AAE3DpD,KAF2D;AAG3D+L,MAH2D,CAI3D;;AAJ2D,CAApB,CAAxC;;AAOA,MAAMwE,YAAYzO,EAAE8N,QAAF,CAAW,YAAW;AACvC,QAAM4C,SAAS/S,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,iCAAxB,CAAf;AACA,QAAMyS,WAAWhT,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,mCAAxB,CAAjB;AACA,QAAM0S,SAASjT,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,iCAAxB,CAAf;AACA,QAAM4Q,oBAAoBnR,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,iCAAxB,CAA1B;;AAEA,MAAI,CAACwS,MAAD,IAAW,CAACC,QAAZ,IAAwB,CAACC,MAA7B,EAAqC;AACpC;AACA;;AAED,QAAM1Q,SAAS;AACdiP,gBAAY;AACX0B,mBAAa;AACZC,sBAAcH,QADF;AAEZI,qBAAaH;AAFD;AADF,KADE;AAOdF,UAPc;AAQd5B;AARc,GAAf;AAWAyB,4BAA0B9P,KAA1B,GAAkCjC,WAAW4E,qBAAX,CAAiC,eAAjC,EAAkDmN,0BAA0BjP,IAA5E,EAAkFpB,MAAlF,CAAlC;AACAsQ,4BAA0B/P,KAA1B,GAAkCjC,WAAW4E,qBAAX,CAAiC,eAAjC,EAAkDoN,0BAA0BlP,IAA5E,EAAkFpB,MAAlF,CAAlC;AACAuQ,kCAAgChQ,KAAhC,GAAwCjC,WAAW4E,qBAAX,CAAiC,eAAjC,EAAkDqN,gCAAgCnP,IAAlF,EAAwFpB,MAAxF,CAAxC;AACA,CAxBiB,EAwBf,GAxBe,CAAlB;;AA0BAvC,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,4BAAxB,EAAsDuQ,SAAtD,E;;;;;;;;;;;AC7FA,IAAI9L,MAAJ;AAAW3F,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAACC,UAAQC,CAAR,EAAU;AAACuF,aAAOvF,CAAP;AAAS;;AAArB,CAA/B,EAAsD,CAAtD;AAAyD,IAAI4T,IAAJ;AAAShU,OAAOC,KAAP,CAAaC,QAAQ,MAAR,CAAb,EAA6B;AAACC,UAAQC,CAAR,EAAU;AAAC4T,WAAK5T,CAAL;AAAO;;AAAnB,CAA7B,EAAkD,CAAlD;AAAqD,IAAI6T,IAAJ;AAASjU,OAAOC,KAAP,CAAaC,QAAQ,MAAR,CAAb,EAA6B;AAACC,UAAQC,CAAR,EAAU;AAAC6T,WAAK7T,CAAL;AAAO;;AAAnB,CAA7B,EAAkD,CAAlD;AAAqD,IAAIqF,eAAJ;AAAoBzF,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACuF,kBAAgBrF,CAAhB,EAAkB;AAACqF,sBAAgBrF,CAAhB;AAAkB;;AAAtC,CAA1C,EAAkF,CAAlF;AAOpN,MAAMiO,SAAS,IAAIC,MAAJ,CAAW,YAAX,CAAf;;AAEA,SAAS4F,YAAT,CAAsB9O,OAAtB,EAA+B;AAC9B,MAAI,EAAE,gBAAgB8O,YAAlB,CAAJ,EAAqC;AACpC,WAAO,IAAIA,YAAJ,CAAiB9O,OAAjB,CAAP;AACA;;AAED,OAAKb,KAAL,GAAaa,QAAQb,KAArB;AACA,OAAKgB,IAAL,GAAYH,QAAQG,IAApB;AACA,OAAK4O,UAAL,GAAkB,CAAlB;AAEAxO,SAAOyO,SAAP,CAAiBlG,IAAjB,CAAsB,IAAtB,EAA4B9I,OAA5B;AACA;;AACD6O,KAAKI,QAAL,CAAcH,YAAd,EAA4BvO,OAAOyO,SAAnC;;AAGAF,aAAaI,SAAb,CAAuBC,UAAvB,GAAoC,UAASC,KAAT,EAAgBC,GAAhB,EAAqB/G,EAArB,EAAyB;AAC5D,MAAI,KAAKyG,UAAL,GAAkB,KAAK5O,IAA3B,EAAiC;AAChC;AACA,SAAKyH,GAAL;AACA,GAHD,MAGO,IAAI,KAAKmH,UAAL,GAAkBK,MAAMnF,MAAxB,GAAiC,KAAK9K,KAA1C,EAAiD,CACvD;AACA,GAFM,MAEA;AACN,QAAIA,KAAJ;AACA,QAAIgB,IAAJ;;AAEA,QAAI,KAAKhB,KAAL,IAAc,KAAK4P,UAAvB,EAAmC;AAClC5P,cAAQ,CAAR;AACA,KAFD,MAEO;AACNA,cAAQ,KAAKA,KAAL,GAAa,KAAK4P,UAA1B;AACA;;AACD,QAAK,KAAK5O,IAAL,GAAY,KAAK4O,UAAjB,GAA8B,CAA/B,GAAoCK,MAAMnF,MAA9C,EAAsD;AACrD9J,aAAO,KAAKA,IAAL,GAAY,KAAK4O,UAAjB,GAA8B,CAArC;AACA,KAFD,MAEO;AACN5O,aAAOiP,MAAMnF,MAAb;AACA;;AACD,UAAMqF,WAAWF,MAAMG,KAAN,CAAYpQ,KAAZ,EAAmBgB,IAAnB,CAAjB;AACA,SAAKqP,IAAL,CAAUF,QAAV;AACA;;AACD,OAAKP,UAAL,IAAmBK,MAAMnF,MAAzB;AACA3B;AACA,CAzBD;;AA4BA,MAAMmH,eAAe,UAASC,MAAT,EAAiB;AACrC,MAAIA,MAAJ,EAAY;AACX,UAAMC,UAAUD,OAAOvF,KAAP,CAAa,aAAb,CAAhB;;AACA,QAAIwF,OAAJ,EAAa;AACZ,aAAO;AACNxQ,eAAO3B,SAASmS,QAAQ,CAAR,CAAT,EAAqB,EAArB,CADD;AAENxP,cAAM3C,SAASmS,QAAQ,CAAR,CAAT,EAAqB,EAArB;AAFA,OAAP;AAIA;AACD;;AACD,SAAO,IAAP;AACA,CAXD,C,CAaA;;;AACA,MAAMC,iBAAiB,UAASC,SAAT,EAAoB9N,MAApB,EAA4B5G,IAA5B,EAAkC6G,GAAlC,EAAuCC,GAAvC,EAA4C;AAClE,QAAM5D,QAAQR,SAASkH,QAAT,CAAkB8K,SAAlB,CAAd;AACA,QAAMC,KAAKzR,MAAM4G,aAAN,CAAoBlD,MAApB,EAA4B5G,IAA5B,CAAX;AACA,QAAM4U,KAAK,IAAIxP,OAAOyP,WAAX,EAAX;AAEA,GAACF,EAAD,EAAKC,EAAL,EAASE,OAAT,CAAiB1P,UAAUA,OAAO2P,EAAP,CAAU,OAAV,EAAmB,UAASzQ,GAAT,EAAc;AAC3DpB,UAAM8R,WAAN,CAAkBrH,IAAlB,CAAuBzK,KAAvB,EAA8BoB,GAA9B,EAAmCsC,MAAnC,EAA2C5G,IAA3C;AACA8G,QAAI2F,GAAJ;AACA,GAH0B,CAA3B;AAKAmI,KAAGG,EAAH,CAAM,OAAN,EAAe,YAAW;AACzB;AACAH,OAAGK,IAAH,CAAQ,KAAR;AACA,GAHD;AAKA,QAAMC,SAASrO,IAAIsE,OAAJ,CAAY,iBAAZ,KAAkC,EAAjD,CAfkE,CAiBlE;;AACAjI,QAAMiS,aAAN,CAAoBR,EAApB,EAAwBC,EAAxB,EAA4BhO,MAA5B,EAAoC5G,IAApC,EAA0C6G,GAA1C;AACA,QAAMuO,QAAQd,aAAazN,IAAIsE,OAAJ,CAAYiK,KAAzB,CAAd;AACA,MAAIC,eAAe,KAAnB;;AACA,MAAID,KAAJ,EAAW;AACVC,mBAAgBD,MAAMpR,KAAN,GAAchE,KAAKY,IAApB,IAA8BwU,MAAMpQ,IAAN,IAAcoQ,MAAMpR,KAAlD,IAA6DoR,MAAMpQ,IAAN,GAAahF,KAAKY,IAA9F;AACA,GAvBiE,CAyBlE;;;AACA,MAAIsU,OAAOlG,KAAP,CAAa,UAAb,KAA4BoG,UAAU,IAA1C,EAAgD;AAC/CtO,QAAIG,SAAJ,CAAc,kBAAd,EAAkC,MAAlC;AACAH,QAAIgK,YAAJ,CAAiB,gBAAjB;AACAhK,QAAIE,SAAJ,CAAc,GAAd;AACA4N,OAAGlM,IAAH,CAAQ+K,KAAK6B,UAAL,EAAR,EAA2B5M,IAA3B,CAAgC5B,GAAhC;AACA,GALD,MAKO,IAAIoO,OAAOlG,KAAP,CAAa,aAAb,KAA+BoG,UAAU,IAA7C,EAAmD;AACzD;AACAtO,QAAIG,SAAJ,CAAc,kBAAd,EAAkC,SAAlC;AACAH,QAAIgK,YAAJ,CAAiB,gBAAjB;AACAhK,QAAIE,SAAJ,CAAc,GAAd;AACA4N,OAAGlM,IAAH,CAAQ+K,KAAK8B,aAAL,EAAR,EAA8B7M,IAA9B,CAAmC5B,GAAnC;AACA,GANM,MAMA,IAAIsO,SAASC,YAAb,EAA2B;AACjC;AACAvO,QAAIgK,YAAJ,CAAiB,gBAAjB;AACAhK,QAAIgK,YAAJ,CAAiB,cAAjB;AACAhK,QAAIgK,YAAJ,CAAiB,qBAAjB;AACAhK,QAAIgK,YAAJ,CAAiB,eAAjB;AACAhK,QAAIG,SAAJ,CAAc,eAAd,EAAgC,WAAWjH,KAAKY,IAAM,EAAtD;AACAkG,QAAIE,SAAJ,CAAc,GAAd;AACAF,QAAI2F,GAAJ;AACA,GATM,MASA,IAAI2I,KAAJ,EAAW;AACjBtO,QAAIG,SAAJ,CAAc,eAAd,EAAgC,SAASmO,MAAMpR,KAAO,IAAIoR,MAAMpQ,IAAM,IAAIhF,KAAKY,IAAM,EAArF;AACAkG,QAAIgK,YAAJ,CAAiB,gBAAjB;AACAhK,QAAIG,SAAJ,CAAc,gBAAd,EAAgCmO,MAAMpQ,IAAN,GAAaoQ,MAAMpR,KAAnB,GAA2B,CAA3D;AACA8C,QAAIE,SAAJ,CAAc,GAAd;AACA8G,WAAOS,KAAP,CAAa,8BAAb;AACAqG,OAAGlM,IAAH,CAAQ,IAAIiL,YAAJ,CAAiB;AAAE3P,aAAOoR,MAAMpR,KAAf;AAAsBgB,YAAMoQ,MAAMpQ;AAAlC,KAAjB,CAAR,EAAoE0D,IAApE,CAAyE5B,GAAzE;AACA,GAPM,MAOA;AACNA,QAAIE,SAAJ,CAAc,GAAd;AACA4N,OAAGlM,IAAH,CAAQ5B,GAAR;AACA;AACD,CAzDD;;AA2DA,MAAM0O,iBAAiB,UAASd,SAAT,EAAoB9N,MAApB,EAA4B5G,IAA5B,EAAkCmK,GAAlC,EAAuC;AAC7D,QAAMjH,QAAQR,SAASkH,QAAT,CAAkB8K,SAAlB,CAAd;AACA,QAAMC,KAAKzR,MAAM4G,aAAN,CAAoBlD,MAApB,EAA4B5G,IAA5B,CAAX;AAEA,GAAC2U,EAAD,EAAKxK,GAAL,EAAU2K,OAAV,CAAkB1P,UAAUA,OAAO2P,EAAP,CAAU,OAAV,EAAmB,UAASzQ,GAAT,EAAc;AAC5DpB,UAAM8R,WAAN,CAAkBrH,IAAlB,CAAuBzK,KAAvB,EAA8BoB,GAA9B,EAAmCsC,MAAnC,EAA2C5G,IAA3C;AACAmK,QAAIsC,GAAJ;AACA,GAH2B,CAA5B;AAKAkI,KAAGjM,IAAH,CAAQyB,GAAR;AACA,CAVD;;AAYAlJ,WAAW4E,qBAAX,CAAiC,QAAjC,EAA2C,gBAA3C,EAA6D;AAC5D4P,kBAAgB;AAD4C,CAA7D;AAIAxU,WAAW4E,qBAAX,CAAiC,QAAjC,EAA2C,sBAA3C,EAAmE;AAClE4P,kBAAgB;AADkD,CAAnE,E,CAIA;;AACA/S,SAASqD,SAAT,GAAqB,oBAArB,IAA6CrD,SAASqD,SAAT,GAAqB,gBAArB,CAA7C;AAEA9E,WAAW4E,qBAAX,CAAiC,QAAjC,EAA2C,gBAA3C,EAA6D;AAC5D4P,kBAAgB;AAD4C,CAA7D;AAKA,IAAIvQ,eAAJ,CAAoB;AACnBnB,QAAM,gBADa;;AAGnBpD,MAAIX,IAAJ,EAAU6G,GAAV,EAAeC,GAAf,EAAoB;AACnB9G,WAAOiB,WAAWyI,cAAX,CAA0B1J,IAA1B,CAAP;AAEA8G,QAAIG,SAAJ,CAAc,qBAAd,EAAsC,gCAAgCC,mBAAmBlH,KAAK+D,IAAxB,CAA+B,EAArG;AACA+C,QAAIG,SAAJ,CAAc,eAAd,EAA+BjH,KAAK2S,UAAL,CAAgBC,WAAhB,EAA/B;AACA9L,QAAIG,SAAJ,CAAc,cAAd,EAA8BjH,KAAKM,IAAnC;AACAwG,QAAIG,SAAJ,CAAc,gBAAd,EAAgCjH,KAAKY,IAArC;AAEA,WAAO6T,eAAezU,KAAKkD,KAApB,EAA2BlD,KAAKwG,GAAhC,EAAqCxG,IAArC,EAA2C6G,GAA3C,EAAgDC,GAAhD,CAAP;AACA,GAZkB;;AAcnB4F,OAAK1M,IAAL,EAAWmK,GAAX,EAAgB;AACfqL,mBAAexV,KAAKkD,KAApB,EAA2BlD,KAAKwG,GAAhC,EAAqCxG,IAArC,EAA2CmK,GAA3C;AACA;;AAhBkB,CAApB;AAmBA,IAAIjF,eAAJ,CAAoB;AACnBnB,QAAM,sBADa;;AAGnBpD,MAAIX,IAAJ,EAAU6G,GAAV,EAAeC,GAAf,EAAoB;AACnB9G,WAAOiB,WAAWyI,cAAX,CAA0B1J,IAA1B,CAAP;AAEA8G,QAAIG,SAAJ,CAAc,qBAAd,EAAsC,gCAAgCC,mBAAmBlH,KAAK+D,IAAxB,CAA+B,EAArG;AACA+C,QAAIG,SAAJ,CAAc,eAAd,EAA+BjH,KAAK2S,UAAL,CAAgBC,WAAhB,EAA/B;AACA9L,QAAIG,SAAJ,CAAc,cAAd,EAA8BjH,KAAKM,IAAnC;AACAwG,QAAIG,SAAJ,CAAc,gBAAd,EAAgCjH,KAAKY,IAArC;AAEA,WAAO6T,eAAezU,KAAKkD,KAApB,EAA2BlD,KAAKwG,GAAhC,EAAqCxG,IAArC,EAA2C6G,GAA3C,EAAgDC,GAAhD,CAAP;AACA,GAZkB;;AAcnB4F,OAAK1M,IAAL,EAAWmK,GAAX,EAAgB;AACfqL,mBAAexV,KAAKkD,KAApB,EAA2BlD,KAAKwG,GAAhC,EAAqCxG,IAArC,EAA2CmK,GAA3C;AACA;;AAhBkB,CAApB;AAmBA,IAAIjF,eAAJ,CAAoB;AACnBnB,QAAM,gBADa;;AAGnBpD,MAAIX,IAAJ,EAAU6G,GAAV,EAAeC,GAAf,EAAoB;AACnB9G,WAAOiB,WAAWyI,cAAX,CAA0B1J,IAA1B,CAAP;AAEA,WAAOyU,eAAezU,KAAKkD,KAApB,EAA2BlD,KAAKwG,GAAhC,EAAqCxG,IAArC,EAA2C6G,GAA3C,EAAgDC,GAAhD,CAAP;AACA;;AAPkB,CAApB,E;;;;;;;;;;;AC9LA,IAAIrE,CAAJ;;AAAMhD,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAAC4C,QAAE5C,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;;AAGN,MAAM6V,qBAAqBjT,EAAE8N,QAAF,CAAW,MAAM;AAC3C,QAAMjQ,OAAOF,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,CAAb;AACA,QAAMwS,SAAS/S,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,sBAAxB,CAAf;AACA,QAAMgV,MAAMvV,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,mBAAxB,CAAZ;AACA,QAAMiV,YAAYxV,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,8BAAxB,CAAlB;AACA,QAAMkV,YAAYzV,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,kCAAxB,CAAlB;AACA,QAAMmV,MAAM1V,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,mBAAxB,CAAZ;AACA,QAAMsR,SAAS7R,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,sBAAxB,CAAf;AACA,QAAMoV,YAAY3V,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,CAAlB;AAEA,SAAOI,UAAUiV,WAAV,CAAsB,oBAAtB,CAAP;;AAEA,MAAI1V,SAAS,UAAT,IAAuB,CAACmC,EAAEwT,OAAF,CAAU9C,MAAV,CAAxB,IAA6C,CAAC1Q,EAAEwT,OAAF,CAAUL,SAAV,CAA9C,IAAsE,CAACnT,EAAEwT,OAAF,CAAUJ,SAAV,CAA3E,EAAiG;AAChG,QAAI9U,UAAUiV,WAAV,CAAsB,oBAAtB,CAAJ,EAAiD;AAChD,aAAOjV,UAAUiV,WAAV,CAAsB,oBAAtB,CAAP;AACA;;AACD,UAAMrT,SAAS;AACdwQ,YADc;;AAEdhR,UAAInC,IAAJ,EAAUkW,WAAV,EAAuB;AACtB,cAAMvS,KAAKC,OAAOD,EAAP,EAAX;AACA,cAAMgL,OAAQ,GAAGvO,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,UAAxB,CAAqC,YAAYuV,YAAY7U,GAAK,IAAI,KAAKpB,MAAQ,IAAI0D,EAAI,EAA5G;AAEA,cAAMwS,SAAS;AACd3P,eAAK7C,EADS;AAEdtC,eAAK6U,YAAY7U,GAFH;AAGd+U,oBAAU;AACTzH;AADS;AAHI,SAAf;AAQAvO,mBAAWqB,MAAX,CAAkByE,OAAlB,CAA0BmQ,cAA1B,CAAyC,KAAKpW,MAA9C,EAAsD,kBAAtD,EAA0ED,IAA1E,EAAgFmW,MAAhF;AAEA,eAAOxH,IAAP;AACA,OAjBa;;AAkBd0C,sBAAgBuE,SAlBF;AAmBdtE,0BAAoBuE;AAnBN,KAAf;;AAsBA,QAAI,CAACpT,EAAEwT,OAAF,CAAUN,GAAV,CAAL,EAAqB;AACpBhT,aAAOgT,GAAP,GAAaA,GAAb;AACA;;AAED,QAAI,CAAClT,EAAEwT,OAAF,CAAUH,GAAV,CAAL,EAAqB;AACpBnT,aAAOmT,GAAP,GAAaA,GAAb;AACA;;AAED,QAAI,CAACrT,EAAEwT,OAAF,CAAUhE,MAAV,CAAL,EAAwB;AACvBtP,aAAOsP,MAAP,GAAgBA,MAAhB;AACA;;AAED,QAAI,CAACxP,EAAEwT,OAAF,CAAUF,SAAV,CAAL,EAA2B;AAC1BpT,aAAOoT,SAAP,GAAmBA,SAAnB;AACA;;AAED,QAAI;AACHhV,gBAAUuV,eAAV,CAA0B,oBAA1B,EAAgDvV,UAAUwV,SAA1D,EAAqE5T,MAArE;AACA,KAFD,CAEE,OAAOL,CAAP,EAAU;AACX2G,cAAQC,KAAR,CAAc,yBAAd,EAAyC5G,EAAEkU,OAA3C;AACA;AACD;AACD,CA5D0B,EA4DxB,GA5DwB,CAA3B;;AA8DApW,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,EAAmD+U,kBAAnD;AACAtV,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,iBAAxB,EAA2C+U,kBAA3C;;AAIA,MAAMe,+BAA+BhU,EAAE8N,QAAF,CAAW,MAAM;AACrD,QAAMjQ,OAAOF,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,CAAb;AACA,QAAMwS,SAAS/S,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,iCAAxB,CAAf;AACA,QAAMyS,WAAWhT,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,mCAAxB,CAAjB;AACA,QAAM0S,SAASjT,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,iCAAxB,CAAf;AAEA,SAAOI,UAAUiV,WAAV,CAAsB,uBAAtB,CAAP;;AAEA,MAAI1V,SAAS,oBAAT,IAAiC,CAACmC,EAAEwT,OAAF,CAAU5C,MAAV,CAAlC,IAAuD,CAAC5Q,EAAEwT,OAAF,CAAU7C,QAAV,CAAxD,IAA+E,CAAC3Q,EAAEwT,OAAF,CAAU9C,MAAV,CAApF,EAAuG;AACtG,QAAIpS,UAAUiV,WAAV,CAAsB,uBAAtB,CAAJ,EAAoD;AACnD,aAAOjV,UAAUiV,WAAV,CAAsB,uBAAtB,CAAP;AACA;;AAED,UAAMrT,SAAS;AACdwQ,YADc;AAEduD,sBAAgBtD,QAFF;AAGduD,uBAAiBtD,MAHH;;AAIdlR,UAAInC,IAAJ,EAAUkW,WAAV,EAAuB;AACtB,cAAMvS,KAAKC,OAAOD,EAAP,EAAX;AACA,cAAMgL,OAAQ,GAAGvO,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,UAAxB,CAAqC,YAAYuV,YAAY7U,GAAK,IAAI,KAAKpB,MAAQ,IAAI0D,EAAI,EAA5G;AAEA,cAAMwS,SAAS;AACd3P,eAAK7C,EADS;AAEdtC,eAAK6U,YAAY7U,GAFH;AAGduV,yBAAe;AACdjI;AADc;AAHD,SAAf;AAQAvO,mBAAWqB,MAAX,CAAkByE,OAAlB,CAA0BmQ,cAA1B,CAAyC,KAAKpW,MAA9C,EAAsD,4BAAtD,EAAoFD,IAApF,EAA0FmW,MAA1F;AAEA,eAAOxH,IAAP;AACA;;AAnBa,KAAf;;AAsBA,QAAI;AACH5N,gBAAUuV,eAAV,CAA0B,uBAA1B,EAAmDvV,UAAU8V,WAA7D,EAA0ElU,MAA1E;AACA,KAFD,CAEE,OAAOL,CAAP,EAAU;AACX2G,cAAQC,KAAR,CAAc,yCAAd,EAAyD5G,EAAEkU,OAA3D;AACA;AACD;AACD,CAzCoC,EAyClC,GAzCkC,CAArC;;AA2CApW,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,EAAmD8V,4BAAnD;AACArW,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,4BAAxB,EAAsD8V,4BAAtD,E;;;;;;;;;;;AClHA,IAAIhU,CAAJ;;AAAMhD,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAAC4C,QAAE5C,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIqF,eAAJ;AAAoBzF,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACuF,kBAAgBrF,CAAhB,EAAkB;AAACqF,sBAAgBrF,CAAhB;AAAkB;;AAAtC,CAA1C,EAAkF,CAAlF;AAAqFJ,OAAOC,KAAP,CAAaC,QAAQ,4BAAR,CAAb;;AAMvK,MAAMgB,MAAM,UAASX,IAAT,EAAe6G,GAAf,EAAoBC,GAApB,EAAyB;AACpC,OAAK5D,KAAL,CAAW4G,aAAX,CAAyB9J,KAAKwG,GAA9B,EAAmCxG,IAAnC,EAAyC0I,IAAzC,CAA8C5B,GAA9C;AACA,CAFD;;AAIA,MAAM4F,OAAO,UAAS1M,IAAT,EAAemK,GAAf,EAAoB;AAChC,OAAKjH,KAAL,CAAW4G,aAAX,CAAyB9J,KAAKwG,GAA9B,EAAmCxG,IAAnC,EAAyC0I,IAAzC,CAA8CyB,GAA9C;AACA,CAFD;;AAIA,MAAM2M,gBAAgB,IAAI5R,eAAJ,CAAoB;AACzCnB,QAAM,gBADmC;AAEzCpD,KAFyC;AAGzC+L,MAHyC,CAIzC;;AAJyC,CAApB,CAAtB;AAOA,MAAMqK,gBAAgB,IAAI7R,eAAJ,CAAoB;AACzCnB,QAAM,gBADmC;AAEzCpD,KAFyC;AAGzC+L,MAHyC,CAIzC;;AAJyC,CAApB,CAAtB;AAOA,MAAMsK,sBAAsB,IAAI9R,eAAJ,CAAoB;AAC/CnB,QAAM,sBADyC;AAE/CpD,KAF+C;AAG/C+L,MAH+C,CAI/C;;AAJ+C,CAApB,CAA5B;;AAOA,MAAMwE,YAAYzO,EAAE8N,QAAF,CAAW,YAAW;AACvC,QAAM0G,mBAAmB7W,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,sCAAxB,CAAzB;AACA,QAAMuW,SAAS9W,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,8BAAxB,CAAf;AACA,QAAMqK,WAAW5K,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,4BAAxB,CAAjB;AACA,QAAMwW,WAAW/W,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,4BAAxB,CAAjB;;AAEA,MAAI,CAACuW,MAAD,IAAW,CAAClM,QAAZ,IAAwB,CAACmM,QAA7B,EAAuC;AACtC;AACA;;AAED,QAAMxU,SAAS;AACdiP,gBAAY;AACX0B,mBAAa;AACZ4D,cADY;AAEZlM,gBAFY;AAGZmM;AAHY;AADF,KADE;AAQdF;AARc,GAAf;AAWAH,gBAAc5T,KAAd,GAAsBjC,WAAW4E,qBAAX,CAAiC,QAAjC,EAA2CiR,cAAc/S,IAAzD,EAA+DpB,MAA/D,CAAtB;AACAoU,gBAAc7T,KAAd,GAAsBjC,WAAW4E,qBAAX,CAAiC,QAAjC,EAA2CkR,cAAchT,IAAzD,EAA+DpB,MAA/D,CAAtB;AACAqU,sBAAoB9T,KAApB,GAA4BjC,WAAW4E,qBAAX,CAAiC,QAAjC,EAA2CmR,oBAAoBjT,IAA/D,EAAqEpB,MAArE,CAA5B;AACA,CAxBiB,EAwBf,GAxBe,CAAlB;;AA0BAvC,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,qBAAxB,EAA+CuQ,SAA/C,E;;;;;;;;;;;AC7DA,IAAIzO,CAAJ;;AAAMhD,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAAC4C,QAAE5C,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAENK,OAAOkX,OAAP,CAAe;AACR,mBAAN,CAAwBC,MAAxB,EAAgCnU,KAAhC,EAAuClD,IAAvC,EAA6CsX,UAAU,EAAvD;AAAA,oCAA2D;AAC1D,UAAI,CAACpX,OAAOD,MAAP,EAAL,EAAsB;AACrB,cAAM,IAAIC,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEqO,kBAAQ;AAAV,SAAvD,CAAN;AACA;;AAED,YAAMhN,OAAOtB,OAAOyN,IAAP,CAAY,eAAZ,EAA6B0J,MAA7B,EAAqCnX,OAAOD,MAAP,EAArC,CAAb;;AAEA,UAAI,CAACuB,IAAL,EAAW;AACV,eAAO,KAAP;AACA;;AAED6L,YAAMiK,OAAN,EAAe;AACdC,gBAAQpW,MAAMqW,QAAN,CAAelW,MAAf,CADM;AAEdmW,eAAOtW,MAAMqW,QAAN,CAAelW,MAAf,CAFO;AAGdoW,eAAOvW,MAAMqW,QAAN,CAAelW,MAAf,CAHO;AAIdqW,mBAAWxW,MAAMqW,QAAN,CAAeI,OAAf,CAJG;AAKdC,aAAK1W,MAAMqW,QAAN,CAAelW,MAAf;AALS,OAAf;AAQAlB,iBAAWqB,MAAX,CAAkByE,OAAlB,CAA0B4R,kBAA1B,CAA6C9X,KAAKwG,GAAlD,EAAuDtG,OAAOD,MAAP,EAAvD,EAAwEwC,EAAEsV,IAAF,CAAO/X,IAAP,EAAa,KAAb,CAAxE;AAEA,YAAM0Q,UAAW,gBAAgB1Q,KAAKwG,GAAK,IAAIwR,UAAUhY,KAAK+D,IAAf,CAAsB,EAArE;AAEA,YAAMkU,aAAa;AAClBC,eAAOlY,KAAK+D,IADM;AAElBzD,cAAM,MAFY;AAGlB6X,qBAAanY,KAAKmY,WAHA;AAIlBC,oBAAY1H,OAJM;AAKlB2H,6BAAqB;AALH,OAAnB;;AAQA,UAAI,aAAajX,IAAb,CAAkBpB,KAAKM,IAAvB,CAAJ,EAAkC;AACjC2X,mBAAWK,SAAX,GAAuB5H,OAAvB;AACAuH,mBAAWM,UAAX,GAAwBvY,KAAKM,IAA7B;AACA2X,mBAAWO,UAAX,GAAwBxY,KAAKY,IAA7B;;AACA,YAAIZ,KAAKuK,QAAL,IAAiBvK,KAAKuK,QAAL,CAAc3J,IAAnC,EAAyC;AACxCqX,qBAAWQ,gBAAX,GAA8BzY,KAAKuK,QAAL,CAAc3J,IAA5C;AACA;;AACDqX,mBAAWS,aAAX,iBAAiCzX,WAAWwI,kBAAX,CAA8BzJ,IAA9B,CAAjC;AACA,OARD,MAQO,IAAI,aAAaoB,IAAb,CAAkBpB,KAAKM,IAAvB,CAAJ,EAAkC;AACxC2X,mBAAWU,SAAX,GAAuBjI,OAAvB;AACAuH,mBAAWW,UAAX,GAAwB5Y,KAAKM,IAA7B;AACA2X,mBAAWY,UAAX,GAAwB7Y,KAAKY,IAA7B;AACA,OAJM,MAIA,IAAI,aAAaQ,IAAb,CAAkBpB,KAAKM,IAAvB,CAAJ,EAAkC;AACxC2X,mBAAWa,SAAX,GAAuBpI,OAAvB;AACAuH,mBAAWc,UAAX,GAAwB/Y,KAAKM,IAA7B;AACA2X,mBAAWe,UAAX,GAAwBhZ,KAAKY,IAA7B;AACA;;AAED,YAAMW,OAAOrB,OAAOqB,IAAP,EAAb;AACA,UAAIsW,MAAMnS,OAAOC,MAAP,CAAc;AACvBa,aAAK5C,OAAOD,EAAP,EADkB;AAEvBtC,aAAKgW,MAFkB;AAGvB4B,YAAI,IAAIC,IAAJ,EAHmB;AAIvBrB,aAAK,EAJkB;AAKvB7X,cAAM;AACLwG,eAAKxG,KAAKwG,GADL;AAELzC,gBAAM/D,KAAK+D,IAFN;AAGLzD,gBAAMN,KAAKM;AAHN,SALiB;AAUvBqX,mBAAW,KAVY;AAWvBwB,qBAAa,CAAClB,UAAD;AAXU,OAAd,EAYPX,OAZO,CAAV;AAcAO,YAAM3X,OAAOyN,IAAP,CAAY,aAAZ,EAA2BkK,GAA3B,CAAN;AAEA3X,aAAOkZ,KAAP,CAAa,MAAMhZ,WAAWiZ,SAAX,CAAqBC,GAArB,CAAyB,iBAAzB,EAA4C;AAAE/X,YAAF;AAAQC,YAAR;AAAcgV,iBAASqB;AAAvB,OAA5C,CAAnB;AAEA,aAAOA,GAAP;AACA,KArED;AAAA;;AADc,CAAf,E;;;;;;;;;;;ACFA;AAEA,IAAI0B,cAAJ;AAEAnZ,WAAWM,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,EAAmD,UAASwB,GAAT,EAAcC,KAAd,EAAqB;AACvEmX,mBAAiBnX,KAAjB;AACA,CAFD;AAIAlC,OAAOkX,OAAP,CAAe;AACdoC,eAAa5S,MAAb,EAAqB;AACpB,QAAI2S,kBAAkB,CAACrZ,OAAOD,MAAP,EAAvB,EAAwC;AACvC,YAAM,IAAIC,OAAOC,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEqO,gBAAQ;AAAV,OAAvD,CAAN;AACA;;AACD,UAAMxO,OAAOI,WAAWqB,MAAX,CAAkByE,OAAlB,CAA0BvE,WAA1B,CAAsCiF,MAAtC,CAAb;AAEA,WAAOlE,SAASkH,QAAT,CAAkB,kBAAlB,EAAsC+G,cAAtC,CAAqD3Q,IAArD,CAAP;AACA;;AARa,CAAf,E;;;;;;;;;;;ACRAI,WAAWM,QAAX,CAAoB+Y,QAApB,CAA6B,YAA7B,EAA2C,YAAW;AACrD,OAAKC,GAAL,CAAS,oBAAT,EAA+B,IAA/B,EAAqC;AACpCpZ,UAAM,SAD8B;AAEpC8P,YAAQ;AAF4B,GAArC;AAKA,OAAKsJ,GAAL,CAAS,wBAAT,EAAmC,OAAnC,EAA4C;AAC3CpZ,UAAM,KADqC;AAE3C8P,YAAQ;AAFmC,GAA5C;AAKA,OAAKsJ,GAAL,CAAS,+BAAT,EAA0C,4LAA1C,EAAwO;AACvOpZ,UAAM,QADiO;AAEvO8P,YAAQ,IAF+N;AAGvOuJ,qBAAiB;AAHsN,GAAxO;AAMA,OAAKD,GAAL,CAAS,yBAAT,EAAoC,IAApC,EAA0C;AACzCpZ,UAAM,SADmC;AAEzC8P,YAAQ,IAFiC;AAGzCuJ,qBAAiB;AAHwB,GAA1C;AAMA,OAAKD,GAAL,CAAS,yBAAT,EAAoC,QAApC,EAA8C;AAC7CpZ,UAAM,QADuC;AAE7CsZ,YAAQ,CAAC;AACRzX,WAAK,QADG;AAER0X,iBAAW;AAFH,KAAD,EAGL;AACF1X,WAAK,UADH;AAEF0X,iBAAW;AAFT,KAHK,EAML;AACF1X,WAAK,oBADH;AAEF0X,iBAAW;AAFT,KANK,EASL;AACF1X,WAAK,QADH;AAEF0X,iBAAW;AAFT,KATK,EAYL;AACF1X,WAAK,YADH;AAEF0X,iBAAW;AAFT,KAZK,CAFqC;AAkB7CzJ,YAAQ;AAlBqC,GAA9C;AAqBA,OAAK0J,OAAL,CAAa,WAAb,EAA0B,YAAW;AACpC,SAAKJ,GAAL,CAAS,sBAAT,EAAiC,EAAjC,EAAqC;AACpCpZ,YAAM,QAD8B;AAEpCyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFuB,KAArC;AAOA,SAAKsX,GAAL,CAAS,mBAAT,EAA8B,EAA9B,EAAkC;AACjCpZ,YAAM,QAD2B;AAEjCyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFoB,KAAlC;AAOA,SAAKsX,GAAL,CAAS,8BAAT,EAAyC,EAAzC,EAA6C;AAC5CpZ,YAAM,QADsC;AAE5CyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAF+B,KAA7C;AAOA,SAAKsX,GAAL,CAAS,kCAAT,EAA6C,EAA7C,EAAiD;AAChDpZ,YAAM,QAD0C;AAEhDyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFmC,KAAjD;AAOA,SAAKsX,GAAL,CAAS,mBAAT,EAA8B,EAA9B,EAAkC;AACjCpZ,YAAM,QAD2B;AAEjCyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFoB,KAAlC;AAOA,SAAKsX,GAAL,CAAS,sBAAT,EAAiC,EAAjC,EAAqC;AACpCpZ,YAAM,QAD8B;AAEpCyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFuB,KAArC;AAOA,SAAKsX,GAAL,CAAS,yBAAT,EAAoC,EAApC,EAAwC;AACvCpZ,YAAM,QADiC;AAEvCyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK,OAF0B;AAMvCuX,uBAAiB;AANsB,KAAxC;AAQA,SAAKD,GAAL,CAAS,gCAAT,EAA2C,IAA3C,EAAiD;AAChDpZ,YAAM,QAD0C;AAEhDyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFmC,KAAjD;AAOA,SAAKsX,GAAL,CAAS,8BAAT,EAAyC,KAAzC,EAAgD;AAC/CpZ,YAAM,SADyC;AAE/CyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFkC,KAAhD;AAOA,SAAKsX,GAAL,CAAS,iCAAT,EAA4C,GAA5C,EAAiD;AAChDpZ,YAAM,KAD0C;AAEhDyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK,OAFmC;AAMhDuX,uBAAiB;AAN+B,KAAjD;AAQA,SAAKD,GAAL,CAAS,6BAAT,EAAwC,KAAxC,EAA+C;AAC9CpZ,YAAM,SADwC;AAE9CyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFiC,KAA/C;AAOA,SAAKsX,GAAL,CAAS,6BAAT,EAAwC,KAAxC,EAA+C;AAC9CpZ,YAAM,SADwC;AAE9CyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFiC,KAA/C;AAOA,GAvFD;AAyFA,OAAK0X,OAAL,CAAa,sBAAb,EAAqC,YAAW;AAC/C,SAAKJ,GAAL,CAAS,iCAAT,EAA4C,EAA5C,EAAgD;AAC/CpZ,YAAM,QADyC;AAE/C0Z,eAAS,IAFsC;AAG/CD,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAHkC,KAAhD;AAQA,SAAKsX,GAAL,CAAS,mCAAT,EAA8C,EAA9C,EAAkD;AACjDpZ,YAAM,QAD2C;AAEjD0Z,eAAS,IAFwC;AAGjDD,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAHoC,KAAlD;AAQA,SAAKsX,GAAL,CAAS,iCAAT,EAA4C,EAA5C,EAAgD;AAC/CpZ,YAAM,QADyC;AAE/C2Z,iBAAW,IAFoC;AAG/CD,eAAS,IAHsC;AAI/CD,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAJkC,KAAhD;AASA,SAAKsX,GAAL,CAAS,wCAAT,EAAmD,KAAnD,EAA0D;AACzDpZ,YAAM,SADmD;AAEzDyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAF4C,KAA1D;AAOA,SAAKsX,GAAL,CAAS,wCAAT,EAAmD,KAAnD,EAA0D;AACzDpZ,YAAM,SADmD;AAEzDyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAF4C,KAA1D;AAOA,GAxCD;AA0CA,OAAK0X,OAAL,CAAa,aAAb,EAA4B,YAAW;AACtC,SAAKJ,GAAL,CAAS,2BAAT,EAAsC,EAAtC,EAA0C;AACzCpZ,YAAM,QADmC;AAEzCyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAF4B,KAA1C;AAOA,GARD;AAUA,OAAK0X,OAAL,CAAa,QAAb,EAAuB,YAAW;AACjC,SAAKJ,GAAL,CAAS,sCAAT,EAAiD,EAAjD,EAAqD;AACpDpZ,YAAM,QAD8C;AAEpDyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFuC,KAArD;AAOA,SAAKsX,GAAL,CAAS,8BAAT,EAAyC,EAAzC,EAA6C;AAC5CpZ,YAAM,QADsC;AAE5CyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAF+B,KAA7C;AAOA,SAAKsX,GAAL,CAAS,4BAAT,EAAuC,EAAvC,EAA2C;AAC1CpZ,YAAM,QADoC;AAE1CyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAF6B,KAA3C;AAOA,SAAKsX,GAAL,CAAS,4BAAT,EAAuC,EAAvC,EAA2C;AAC1CpZ,YAAM,UADoC;AAE1C0Z,eAAS,IAFiC;AAG1CD,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAH6B,KAA3C;AAQA,SAAKsX,GAAL,CAAS,iCAAT,EAA4C,KAA5C,EAAmD;AAClDpZ,YAAM,SAD4C;AAElDyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFqC,KAAnD;AAOA,SAAKsX,GAAL,CAAS,iCAAT,EAA4C,KAA5C,EAAmD;AAClDpZ,YAAM,SAD4C;AAElDyZ,mBAAa;AACZvT,aAAK,yBADO;AAEZpE,eAAO;AAFK;AAFqC,KAAnD;AAOA,GA5CD;AA8CA,OAAKsX,GAAL,CAAS,2BAAT,EAAsC,IAAtC,EAA4C;AAC3CpZ,UAAM,SADqC;AAE3C8P,YAAQ;AAFmC,GAA5C;AAIA,CA3OD,E;;;;;;;;;;;ACAA3Q,OAAOwF,MAAP,CAAc;AAACiV,iBAAc,MAAIA;AAAnB,CAAd;AAAiD,IAAIxX,QAAJ;AAAajD,OAAOC,KAAP,CAAaC,QAAQ,kBAAR,CAAb,EAAyC;AAAC+C,WAAS7C,CAAT,EAAW;AAAC6C,eAAS7C,CAAT;AAAW;;AAAxB,CAAzC,EAAmE,CAAnE;;AAAsE,IAAI4C,CAAJ;;AAAMhD,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAAC4C,QAAE5C,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIsa,EAAJ;AAAO1a,OAAOC,KAAP,CAAaC,QAAQ,oBAAR,CAAb,EAA2C;AAACC,UAAQC,CAAR,EAAU;AAACsa,SAAGta,CAAH;AAAK;;AAAjB,CAA3C,EAA8D,CAA9D;AAAiE,IAAIuF,MAAJ;AAAW3F,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAACC,UAAQC,CAAR,EAAU;AAACuF,aAAOvF,CAAP;AAAS;;AAArB,CAA/B,EAAsD,CAAtD;;AAU9Q,MAAMqa,aAAN,SAA4BxX,SAAS0X,KAArC,CAA2C;AAEjD3W,cAAYoB,OAAZ,EAAqB;AACpB;AACA;AACA;AACA;AACA;AAEAA,cAAUpC,EAAE4X,MAAF,CAAS;AAClBC,mBAAa;AACZC,iBAAS,IADG;AAEZC,eAAO;AAFK;AADK,KAAT,EAKP3V,OALO,CAAV;AAOA,UAAMA,OAAN;AAEA,UAAM4V,eAAe5V,OAArB;AAEA,UAAM6V,KAAK,IAAIP,EAAJ,CAAOtV,QAAQ+M,UAAf,CAAX;;AAEA/M,YAAQ0B,OAAR,GAAkB1B,QAAQ0B,OAAR,IAAmB,UAASvG,IAAT,EAAe;AACnD,aAAOA,KAAKwG,GAAZ;AACA,KAFD;;AAIA,SAAKD,OAAL,GAAe,UAASvG,IAAT,EAAe;AAC7B,UAAIA,KAAKoW,QAAT,EAAmB;AAClB,eAAOpW,KAAKoW,QAAL,CAAczH,IAArB;AACA,OAH4B,CAI7B;AACA;;;AACA,UAAI3O,KAAK0a,EAAT,EAAa;AACZ,eAAO1a,KAAK0a,EAAL,CAAQ/L,IAAR,GAAe3O,KAAKwG,GAA3B;AACA;AACD,KATD;;AAWA,SAAKmK,cAAL,GAAsB,UAAS3Q,IAAT,EAAe;AACpC,YAAM+R,SAAS;AACd4I,aAAK,KAAKpU,OAAL,CAAavG,IAAb,CADS;AAEd4a,iBAASH,aAAalJ;AAFR,OAAf;AAKA,aAAOmJ,GAAGG,YAAH,CAAgB,WAAhB,EAA6B9I,MAA7B,CAAP;AACA,KAPD;AASA;;;;;;;;AAMA,SAAKzE,MAAL,GAAc,UAAStN,IAAT,EAAeiE,QAAf,EAAyB;AACtCoJ,YAAMrN,IAAN,EAAY0F,MAAZ;;AAEA,UAAI1F,KAAKwG,GAAL,IAAY,IAAhB,EAAsB;AACrBxG,aAAKwG,GAAL,GAAW5C,OAAOD,EAAP,EAAX;AACA;;AAED3D,WAAKoW,QAAL,GAAgB;AACfzH,cAAM,KAAK9J,OAAL,CAAa0B,OAAb,CAAqBvG,IAArB;AADS,OAAhB;AAIAA,WAAKkD,KAAL,GAAa,KAAK2B,OAAL,CAAad,IAA1B,CAXsC,CAWN;;AAChC,aAAO,KAAKqF,aAAL,GAAqBtG,MAArB,CAA4B9C,IAA5B,EAAkCiE,QAAlC,CAAP;AACA,KAbD;AAeA;;;;;;;AAKA,SAAK6I,MAAL,GAAc,UAASlG,MAAT,EAAiB3C,QAAjB,EAA2B;AACxC,YAAMjE,OAAO,KAAKoJ,aAAL,GAAqB8F,OAArB,CAA6B;AAAC1I,aAAKI;AAAN,OAA7B,CAAb;AACA,YAAMmL,SAAS;AACd4I,aAAK,KAAKpU,OAAL,CAAavG,IAAb;AADS,OAAf;AAIA0a,SAAGI,YAAH,CAAgB/I,MAAhB,EAAwB,CAACzN,GAAD,EAAMF,IAAN,KAAe;AACtC,YAAIE,GAAJ,EAAS;AACR2E,kBAAQC,KAAR,CAAc5E,GAAd;AACA;;AAEDL,oBAAYA,SAASK,GAAT,EAAcF,IAAd,CAAZ;AACA,OAND;AAOA,KAbD;AAeA;;;;;;;;;AAOA,SAAK0F,aAAL,GAAqB,UAASlD,MAAT,EAAiB5G,IAAjB,EAAuB6E,UAAU,EAAjC,EAAqC;AACzD,YAAMkN,SAAS;AACd4I,aAAK,KAAKpU,OAAL,CAAavG,IAAb;AADS,OAAf;;AAIA,UAAI6E,QAAQb,KAAR,IAAiBa,QAAQ4H,GAA7B,EAAkC;AACjCsF,eAAOgJ,KAAP,GAAgB,GAAGlW,QAAQb,KAAO,MAAMa,QAAQ4H,GAAK,EAArD;AACA;;AAED,aAAOiO,GAAGM,SAAH,CAAajJ,MAAb,EAAqBkJ,gBAArB,EAAP;AACA,KAVD;AAYA;;;;;;;;;AAOA,SAAKC,cAAL,GAAsB,UAAStU,MAAT,EAAiB5G;AAAI;AAArB,MAAoC;AACzD,YAAMmb,cAAc,IAAI/V,OAAOyP,WAAX,EAApB;AACAsG,kBAAYrM,MAAZ,GAAqB9O,KAAKY,IAA1B;AAEAua,kBAAYpG,EAAZ,CAAe,aAAf,EAA8B,CAACqG,KAAD,EAAQC,QAAR,KAAqB;AAClD,YAAID,UAAU,QAAd,EAAwB;AACvB3L,kBAAQ6L,QAAR,CAAiB,MAAM;AACtBH,wBAAYI,cAAZ,CAA2BH,KAA3B,EAAkCC,QAAlC;AACAF,wBAAYpG,EAAZ,CAAe,aAAf,EAA8BsG,QAA9B;AACA,WAHD;AAIA;AACD,OAPD;AASAX,SAAGc,SAAH,CAAa;AACZb,aAAK,KAAKpU,OAAL,CAAavG,IAAb,CADO;AAEZyb,cAAMN,WAFM;AAGZO,qBAAa1b,KAAKM,IAHN;AAIZqb,4BAAqB,qBAAqB3D,UAAUhY,KAAK+D,IAAf,CAAsB;AAJpD,OAAb,EAMImF,KAAD,IAAW;AACb,YAAIA,KAAJ,EAAW;AACVD,kBAAQC,KAAR,CAAcA,KAAd;AACA;;AAEDiS,oBAAYlG,IAAZ,CAAiB,aAAjB;AACA,OAZD;AAcA,aAAOkG,WAAP;AACA,KA5BD;AA6BA;;AA9IgD;;AAiJlD;AACAzY,SAASQ,KAAT,CAAekT,QAAf,GAA0B8D,aAA1B,C;;;;;;;;;;;AC5JAza,OAAOwF,MAAP,CAAc;AAAC2W,sBAAmB,MAAIA;AAAxB,CAAd;AAA2D,IAAIlZ,QAAJ;AAAajD,OAAOC,KAAP,CAAaC,QAAQ,kBAAR,CAAb,EAAyC;AAAC+C,WAAS7C,CAAT,EAAW;AAAC6C,eAAS7C,CAAT;AAAW;;AAAxB,CAAzC,EAAmE,CAAnE;AAAsE,IAAIgc,SAAJ;AAAcpc,OAAOC,KAAP,CAAaC,QAAQ,uBAAR,CAAb,EAA8C;AAACC,UAAQC,CAAR,EAAU;AAACgc,gBAAUhc,CAAV;AAAY;;AAAxB,CAA9C,EAAwE,CAAxE;;AAQrJ,MAAM+b,kBAAN,SAAiClZ,SAAS0X,KAA1C,CAAgD;AAEtD3W,cAAYoB,OAAZ,EAAqB;AACpB,UAAMA,OAAN;AAEA,UAAMiX,MAAMD,UAAUhX,QAAQ+M,UAAlB,CAAZ;AACA,SAAKuB,MAAL,GAAc2I,IAAI3I,MAAJ,CAAWtO,QAAQsO,MAAnB,CAAd;;AAEAtO,YAAQ0B,OAAR,GAAkB1B,QAAQ0B,OAAR,IAAmB,UAASvG,IAAT,EAAe;AACnD,aAAOA,KAAKwG,GAAZ;AACA,KAFD;;AAIA,SAAKD,OAAL,GAAe,UAASvG,IAAT,EAAe;AAC7B,UAAIA,KAAK4W,aAAT,EAAwB;AACvB,eAAO5W,KAAK4W,aAAL,CAAmBjI,IAA1B;AACA,OAH4B,CAI7B;AACA;;;AACA,UAAI3O,KAAK+b,kBAAT,EAA6B;AAC5B,eAAO/b,KAAK+b,kBAAL,CAAwBpN,IAAxB,GAA+B3O,KAAKwG,GAA3C;AACA;AACD,KATD;;AAWA,SAAKmK,cAAL,GAAsB,UAAS3Q,IAAT,EAAeiE,QAAf,EAAyB;AAC9C,YAAM8N,SAAS;AACdiK,gBAAQ,MADM;AAEdC,6BAAqB,QAFP;AAGdC,iBAAShD,KAAKiD,GAAL,KAAW,KAAKtX,OAAL,CAAa0M,iBAAb,GAA+B;AAHrC,OAAf;AAMA,WAAK4B,MAAL,CAAYnT,IAAZ,CAAiB,KAAKuG,OAAL,CAAavG,IAAb,CAAjB,EAAqC6a,YAArC,CAAkD9I,MAAlD,EAA0D9N,QAA1D;AACA,KARD;AAUA;;;;;;;;AAMA,SAAKqJ,MAAL,GAAc,UAAStN,IAAT,EAAeiE,QAAf,EAAyB;AACtCoJ,YAAMrN,IAAN,EAAY0F,MAAZ;;AAEA,UAAI1F,KAAKwG,GAAL,IAAY,IAAhB,EAAsB;AACrBxG,aAAKwG,GAAL,GAAW5C,OAAOD,EAAP,EAAX;AACA;;AAED3D,WAAK4W,aAAL,GAAqB;AACpBjI,cAAM,KAAK9J,OAAL,CAAa0B,OAAb,CAAqBvG,IAArB;AADc,OAArB;AAIAA,WAAKkD,KAAL,GAAa,KAAK2B,OAAL,CAAad,IAA1B,CAXsC,CAWN;;AAChC,aAAO,KAAKqF,aAAL,GAAqBtG,MAArB,CAA4B9C,IAA5B,EAAkCiE,QAAlC,CAAP;AACA,KAbD;AAeA;;;;;;;AAKA,SAAK6I,MAAL,GAAc,UAASlG,MAAT,EAAiB3C,QAAjB,EAA2B;AACxC,YAAMjE,OAAO,KAAKoJ,aAAL,GAAqB8F,OAArB,CAA6B;AAAC1I,aAAKI;AAAN,OAA7B,CAAb;AACA,WAAKuM,MAAL,CAAYnT,IAAZ,CAAiB,KAAKuG,OAAL,CAAavG,IAAb,CAAjB,EAAqC8M,MAArC,CAA4C,UAASxI,GAAT,EAAcF,IAAd,EAAoB;AAC/D,YAAIE,GAAJ,EAAS;AACR2E,kBAAQC,KAAR,CAAc5E,GAAd;AACA;;AAEDL,oBAAYA,SAASK,GAAT,EAAcF,IAAd,CAAZ;AACA,OAND;AAOA,KATD;AAWA;;;;;;;;;AAOA,SAAK0F,aAAL,GAAqB,UAASlD,MAAT,EAAiB5G,IAAjB,EAAuB6E,UAAU,EAAjC,EAAqC;AACzD,YAAMlC,SAAS,EAAf;;AAEA,UAAIkC,QAAQb,KAAR,IAAiB,IAArB,EAA2B;AAC1BrB,eAAOqB,KAAP,GAAea,QAAQb,KAAvB;AACA;;AAED,UAAIa,QAAQ4H,GAAR,IAAe,IAAnB,EAAyB;AACxB9J,eAAO8J,GAAP,GAAa5H,QAAQ4H,GAArB;AACA;;AAED,aAAO,KAAK0G,MAAL,CAAYnT,IAAZ,CAAiB,KAAKuG,OAAL,CAAavG,IAAb,CAAjB,EAAqCib,gBAArC,CAAsDtY,MAAtD,CAAP;AACA,KAZD;AAcA;;;;;;;;;AAOA,SAAKuY,cAAL,GAAsB,UAAStU,MAAT,EAAiB5G;AAAI;AAArB,MAAoC;AACzD,aAAO,KAAKmT,MAAL,CAAYnT,IAAZ,CAAiB,KAAKuG,OAAL,CAAavG,IAAb,CAAjB,EAAqC4M,iBAArC,CAAuD;AAC7DwP,cAAM,KADuD;AAE7DpU,kBAAU;AACTqU,uBAAarc,KAAKM,IADT;AAETgc,8BAAqB,oBAAoBtc,KAAK+D,IAAM,EAF3C,CAGT;AACA;AACA;;AALS;AAFmD,OAAvD,CAAP;AAUA,KAXD;AAYA;;AA9GqD;;AAiHvD;AACArB,SAASQ,KAAT,CAAe0T,aAAf,GAA+BgF,kBAA/B,C;;;;;;;;;;;AC1HAnc,OAAOwF,MAAP,CAAc;AAACsX,eAAY,MAAIA;AAAjB,CAAd;AAA6C,IAAI7Z,QAAJ;AAAajD,OAAOC,KAAP,CAAaC,QAAQ,kBAAR,CAAb,EAAyC;AAAC+C,WAAS7C,CAAT,EAAW;AAAC6C,eAAS7C,CAAT;AAAW;;AAAxB,CAAzC,EAAmE,CAAnE;AAAsE,IAAI2c,MAAJ;AAAW/c,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAACC,UAAQC,CAAR,EAAU;AAAC2c,aAAO3c,CAAP;AAAS;;AAArB,CAA/B,EAAsD,CAAtD;AAAyD,IAAIuF,MAAJ;AAAW3F,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAACC,UAAQC,CAAR,EAAU;AAACuF,aAAOvF,CAAP;AAAS;;AAArB,CAA/B,EAAsD,CAAtD;;AAQxM,MAAM0c,WAAN,SAA0B7Z,SAAS0X,KAAnC,CAAyC;AAE/C3W,cAAYoB,OAAZ,EAAqB;AAEpB,UAAMA,OAAN;AAGA,UAAM4X,SAAS,IAAID,MAAJ,CACd3X,QAAQ+M,UAAR,CAAmB0B,WAAnB,CAA+B4D,MADjB,EAEdrS,QAAQ+M,UAAR,CAAmB0B,WAAnB,CAA+BtI,QAFjB,EAGdnG,QAAQ+M,UAAR,CAAmB0B,WAAnB,CAA+B6D,QAHjB,CAAf;;AAMAtS,YAAQ0B,OAAR,GAAkB,UAASvG,IAAT,EAAe;AAChC,UAAI6E,QAAQoS,gBAAR,CAAyBpS,QAAQoS,gBAAR,CAAyBnI,MAAzB,GAAgC,CAAzD,MAAgE,GAApE,EAAyE;AACxEjK,gBAAQoS,gBAAR,IAA4B,GAA5B;AACA;;AACD,aAAOpS,QAAQoS,gBAAR,GAA2BjX,KAAKwG,GAAvC;AACA,KALD;;AAOAiW,WAAOjK,IAAP,CAAY3N,QAAQoS,gBAApB,EAAsCrM,KAAtC,CAA4C,UAAStG,GAAT,EAAc;AACzD,UAAIA,IAAIoY,MAAJ,KAAe,KAAnB,EAA0B;AACzBD,eAAOE,eAAP,CAAuB9X,QAAQoS,gBAA/B;AACA;AACD,KAJD;AAMA;;;;;;AAKA,SAAK1Q,OAAL,GAAe,UAASvG,IAAT,EAAe;AAC7B,UAAIA,KAAKwc,MAAT,EAAiB;AAChB,eAAOxc,KAAKwc,MAAL,CAAY7N,IAAnB;AACA;AACD,KAJD;AAMA;;;;;;;;AAMA,SAAKrB,MAAL,GAAc,UAAStN,IAAT,EAAeiE,QAAf,EAAyB;AACtCoJ,YAAMrN,IAAN,EAAY0F,MAAZ;;AAEA,UAAI1F,KAAKwG,GAAL,IAAY,IAAhB,EAAsB;AACrBxG,aAAKwG,GAAL,GAAW5C,OAAOD,EAAP,EAAX;AACA;;AAED3D,WAAKwc,MAAL,GAAc;AACb7N,cAAM9J,QAAQ0B,OAAR,CAAgBvG,IAAhB;AADO,OAAd;AAIAA,WAAKkD,KAAL,GAAa,KAAK2B,OAAL,CAAad,IAA1B;AACA,aAAO,KAAKqF,aAAL,GAAqBtG,MAArB,CAA4B9C,IAA5B,EAAkCiE,QAAlC,CAAP;AACA,KAbD;AAeA;;;;;;;AAKA,SAAK6I,MAAL,GAAc,UAASlG,MAAT,EAAiB3C,QAAjB,EAA2B;AACxC,YAAMjE,OAAO,KAAKoJ,aAAL,GAAqB8F,OAArB,CAA6B;AAAC1I,aAAKI;AAAN,OAA7B,CAAb;AACA6V,aAAOxR,UAAP,CAAkB,KAAK1E,OAAL,CAAavG,IAAb,CAAlB,EAAsC,CAACsE,GAAD,EAAMF,IAAN,KAAe;AACpD,YAAIE,GAAJ,EAAS;AACR2E,kBAAQC,KAAR,CAAc5E,GAAd;AACA;;AAEDL,oBAAYA,SAASK,GAAT,EAAcF,IAAd,CAAZ;AACA,OAND;AAOA,KATD;AAWA;;;;;;;;;AAOA,SAAK0F,aAAL,GAAqB,UAASlD,MAAT,EAAiB5G,IAAjB,EAAuB6E,UAAU,EAAjC,EAAqC;AACzD,YAAMuQ,QAAQ,EAAd;;AAEA,UAAIvQ,QAAQb,KAAR,IAAiB,IAArB,EAA2B;AAC1BoR,cAAMpR,KAAN,GAAca,QAAQb,KAAtB;AACA;;AAED,UAAIa,QAAQ4H,GAAR,IAAe,IAAnB,EAAyB;AACxB2I,cAAM3I,GAAN,GAAY5H,QAAQ4H,GAApB;AACA;;AACD,aAAOgQ,OAAOxB,gBAAP,CAAwB,KAAK1U,OAAL,CAAavG,IAAb,CAAxB,EAA4C6E,OAA5C,CAAP;AACA,KAXD;AAaA;;;;;;;;AAMA,SAAKqW,cAAL,GAAsB,UAAStU,MAAT,EAAiB5G,IAAjB,EAAuB;AAC5C,YAAMmb,cAAc,IAAI/V,OAAOyP,WAAX,EAApB;AACA,YAAM+H,eAAeH,OAAO7P,iBAAP,CAAyB,KAAKrG,OAAL,CAAavG,IAAb,CAAzB,CAArB,CAF4C,CAI5C;;AACA,YAAM6c,sBAAsB,CAACzB,KAAD,EAAQC,QAAR,KAAqB;AAChD,YAAID,UAAU,QAAd,EAAwB;AACvB3L,kBAAQ6L,QAAR,CAAiB,MAAM;AACtBH,wBAAYI,cAAZ,CAA2BH,KAA3B,EAAkCC,QAAlC;AACAF,wBAAYI,cAAZ,CAA2B,aAA3B,EAA0CsB,mBAA1C;AACA1B,wBAAYpG,EAAZ,CAAeqG,KAAf,EAAsB,YAAW;AAChC0B,yBAAWzB,QAAX,EAAqB,GAArB;AACA,aAFD;AAGA,WAND;AAOA;AACD,OAVD;;AAWAF,kBAAYpG,EAAZ,CAAe,aAAf,EAA8B8H,mBAA9B;AAEA1B,kBAAYzS,IAAZ,CAAiBkU,YAAjB;AACA,aAAOzB,WAAP;AACA,KApBD;AAsBA;;AA1H8C;;AA6HhD;AACAzY,SAASQ,KAAT,CAAesZ,MAAf,GAAwBD,WAAxB,C","file":"/packages/rocketchat_file-upload.js","sourcesContent":["/* globals Slingshot */\n\nimport filesize from 'filesize';\n\nconst slingShotConfig = {\n\tauthorize(file/*, metaContext*/) {\n\t\t//Deny uploads if user is not logged in.\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('login-required', 'Please login before posting files');\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('error-invalid-file-type'));\n\t\t}\n\n\t\tconst maxFileSize = RocketChat.settings.get('FileUpload_MaxFileSize');\n\n\t\tif (maxFileSize >= -1 && maxFileSize < file.size) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('File_exceeds_allowed_size_of_bytes', { size: filesize(maxFileSize) }));\n\t\t}\n\n\t\treturn true;\n\t},\n\tmaxSize: 0,\n\tallowedFileTypes: null\n};\n\nSlingshot.fileRestrictions('rocketchat-uploads', slingShotConfig);\nSlingshot.fileRestrictions('rocketchat-uploads-gs', slingShotConfig);\n","/* globals FileUpload:true */\n/* exported FileUpload */\n\nimport filesize from 'filesize';\n\nlet maxFileSize = 0;\n\nFileUpload = {\n\tvalidateFileUpload(file) {\n\t\tif (!Match.test(file.rid, String)) {\n\t\t\treturn false;\n\t\t}\n\t\t// livechat users can upload files but they don't have an userId\n\t\tconst user = file.userId ? Meteor.user() : null;\n\t\tconst room = RocketChat.models.Rooms.findOneById(file.rid);\n\t\tconst directMessageAllow = RocketChat.settings.get('FileUpload_Enabled_Direct');\n\t\tconst fileUploadAllowed = RocketChat.settings.get('FileUpload_Enabled');\n\t\tif (RocketChat.authz.canAccessRoom(room, user, file) !== true) {\n\t\t\treturn false;\n\t\t}\n\t\tconst language = user ? user.language : 'en';\n\t\tif (!fileUploadAllowed) {\n\t\t\tconst reason = TAPi18n.__('FileUpload_Disabled', language);\n\t\t\tthrow new Meteor.Error('error-file-upload-disabled', reason);\n\t\t}\n\n\t\tif (!directMessageAllow && room.t === 'd') {\n\t\t\tconst reason = TAPi18n.__('File_not_allowed_direct_messages', language);\n\t\t\tthrow new Meteor.Error('error-direct-message-file-upload-not-allowed', reason);\n\t\t}\n\n\t\t// -1 maxFileSize means there is no limit\n\t\tif (maxFileSize >= -1 && file.size > maxFileSize) {\n\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t}, language);\n\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t}\n\n\t\tif (maxFileSize > 0) {\n\t\t\tif (file.size > maxFileSize) {\n\t\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t\t}, language);\n\t\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t\t}\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tconst reason = TAPi18n.__('File_type_is_not_accepted', language);\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', reason);\n\t\t}\n\n\t\treturn true;\n\t}\n};\n\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\ttry {\n\t\tmaxFileSize = parseInt(value);\n\t} catch (e) {\n\t\tmaxFileSize = RocketChat.models.Settings.findOneById('FileUpload_MaxFileSize').packageValue;\n\t}\n});\n","/* globals FileUploadBase:true, UploadFS */\n/* exported FileUploadBase */\nimport _ from 'underscore';\n\nUploadFS.config.defaultStorePermissions = new UploadFS.StorePermissions({\n\tinsert(userId, doc) {\n\t\tif (userId) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// allow inserts from slackbridge (message_id = slack-timestamp-milli)\n\t\tif (doc && doc.message_id && doc.message_id.indexOf('slack-') === 0) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// allow inserts to the UserDataFiles store\n\t\tif (doc && doc.store && doc.store.split(':').pop() === 'UserDataFiles') {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (RocketChat.authz.canAccessRoom(null, null, doc)) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\tupdate(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t},\n\tremove(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t}\n});\n\n\nFileUploadBase = class FileUploadBase {\n\tconstructor(store, meta, file) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t\tthis.store = store;\n\t}\n\n\tgetProgress() {\n\n\t}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart(callback) {\n\t\tthis.handler = new UploadFS.Uploader({\n\t\t\tstore: this.store,\n\t\t\tdata: this.file,\n\t\t\tfile: this.meta,\n\t\t\tonError: (err) => {\n\t\t\t\treturn callback(err);\n\t\t\t},\n\t\t\tonComplete: (fileData) => {\n\t\t\t\tconst file = _.pick(fileData, '_id', 'type', 'size', 'name', 'identify', 'description');\n\n\t\t\t\tfile.url = fileData.url.replace(Meteor.absoluteUrl(), '/');\n\t\t\t\treturn callback(null, file, this.store.options.name);\n\t\t\t}\n\t\t});\n\n\t\tthis.handler.onProgress = (file, progress) => {\n\t\t\tthis.onProgress(progress);\n\t\t};\n\n\t\treturn this.handler.start();\n\t}\n\n\tonProgress() {}\n\n\tstop() {\n\t\treturn this.handler.stop();\n\t}\n};\n","/* globals UploadFS */\n\nimport fs from 'fs';\nimport stream from 'stream';\nimport mime from 'mime-type/with-db';\nimport Future from 'fibers/future';\nimport sharp from 'sharp';\nimport { Cookies } from 'meteor/ostrio:cookies';\n\nconst cookie = new Cookies();\n\nObject.assign(FileUpload, {\n\thandlers: {},\n\n\tconfigureUploadsStore(store, name, options) {\n\t\tconst type = name.split(':').pop();\n\t\tconst stores = UploadFS.getStores();\n\t\tdelete stores[name];\n\n\t\treturn new UploadFS.store[store](Object.assign({\n\t\t\tname\n\t\t}, options, FileUpload[`default${ type }`]()));\n\t},\n\n\tdefaultUploads() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Uploads.model,\n\t\t\tfilter: new UploadFS.Filter({\n\t\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t\t}),\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/uploads/${ file.rid }/${ file.userId }/${ file._id }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.uploadsOnValidate,\n\t\t\tonRead(fileId, file, req, res) {\n\t\t\t\tif (!FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tres.setHeader('content-disposition', `attachment; filename=\"${ encodeURIComponent(file.name) }\"`);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\t},\n\n\tdefaultAvatars() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Avatars.model,\n\t\t\t// filter: new UploadFS.Filter({\n\t\t\t// \tonCheck: FileUpload.validateFileUpload\n\t\t\t// }),\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/avatars/${ file.userId }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.avatarsOnValidate,\n\t\t\tonFinishUpload: FileUpload.avatarsOnFinishUpload\n\t\t};\n\t},\n\n\tdefaultUserDataFiles() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.UserDataFiles.model,\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/uploads/userData/${ file.userId }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.uploadsOnValidate,\n\t\t\tonRead(fileId, file, req, res) {\n\t\t\t\tif (!FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tres.setHeader('content-disposition', `attachment; filename=\"${ encodeURIComponent(file.name) }\"`);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\t},\n\n\tavatarsOnValidate(file) {\n\t\tif (RocketChat.settings.get('Accounts_AvatarResize') !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tempFilePath = UploadFS.getTempFilePath(file._id);\n\n\t\tconst height = RocketChat.settings.get('Accounts_AvatarSize');\n\t\tconst future = new Future();\n\n\t\tconst s = sharp(tempFilePath);\n\t\ts.rotate();\n\t\t// Get metadata to resize the image the first time to keep \"inside\" the dimensions\n\t\t// then resize again to create the canvas around\n\n\t\ts.metadata(Meteor.bindEnvironment((err, metadata) => {\n\t\t\tif (!metadata) {\n\t\t\t\tmetadata = {};\n\t\t\t}\n\n\t\t\ts.toFormat(sharp.format.jpeg)\n\t\t\t\t.resize(Math.min(height || 0, metadata.width || Infinity), Math.min(height || 0, metadata.height || Infinity))\n\t\t\t\t.pipe(sharp()\n\t\t\t\t\t.resize(height, height)\n\t\t\t\t\t.background('#FFFFFF')\n\t\t\t\t\t.embed()\n\t\t\t\t)\n\t\t\t\t// Use buffer to get the result in memory then replace the existing file\n\t\t\t\t// There is no option to override a file using this library\n\t\t\t\t.toBuffer()\n\t\t\t\t.then(Meteor.bindEnvironment(outputBuffer => {\n\t\t\t\t\tfs.writeFile(tempFilePath, outputBuffer, Meteor.bindEnvironment(err => {\n\t\t\t\t\t\tif (err != null) {\n\t\t\t\t\t\t\tconsole.error(err);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst size = fs.lstatSync(tempFilePath).size;\n\t\t\t\t\t\tthis.getCollection().direct.update({_id: file._id}, {$set: {size}});\n\t\t\t\t\t\tfuture.return();\n\t\t\t\t\t}));\n\t\t\t\t}));\n\t\t}));\n\n\t\treturn future.wait();\n\t},\n\n\tresizeImagePreview(file) {\n\t\tfile = RocketChat.models.Uploads.findOneById(file._id);\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst image = FileUpload.getStore('Uploads')._store.getReadStream(file._id, file);\n\n\t\tconst transformer = sharp()\n\t\t\t.resize(32, 32)\n\t\t\t.max()\n\t\t\t.jpeg()\n\t\t\t.blur();\n\t\tconst result = transformer.toBuffer().then((out) => out.toString('base64'));\n\t\timage.pipe(transformer);\n\t\treturn result;\n\t},\n\n\tuploadsOnValidate(file) {\n\t\tif (!/^image\\/((x-windows-)?bmp|p?jpeg|png)$/.test(file.type)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tmpFile = UploadFS.getTempFilePath(file._id);\n\n\t\tconst fut = new Future();\n\n\t\tconst s = sharp(tmpFile);\n\t\ts.metadata(Meteor.bindEnvironment((err, metadata) => {\n\t\t\tif (err != null) {\n\t\t\t\tconsole.error(err);\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\tconst identify = {\n\t\t\t\tformat: metadata.format,\n\t\t\t\tsize: {\n\t\t\t\t\twidth: metadata.width,\n\t\t\t\t\theight: metadata.height\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (metadata.orientation == null) {\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\ts.rotate()\n\t\t\t\t.toFile(`${ tmpFile }.tmp`)\n\t\t\t\t.then(Meteor.bindEnvironment(() => {\n\t\t\t\t\tfs.unlink(tmpFile, Meteor.bindEnvironment(() => {\n\t\t\t\t\t\tfs.rename(`${ tmpFile }.tmp`, tmpFile, Meteor.bindEnvironment(() => {\n\t\t\t\t\t\t\tconst size = fs.lstatSync(tmpFile).size;\n\t\t\t\t\t\t\tthis.getCollection().direct.update({_id: file._id}, {\n\t\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\t\tsize,\n\t\t\t\t\t\t\t\t\tidentify\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tfut.return();\n\t\t\t\t\t\t}));\n\t\t\t\t\t}));\n\t\t\t\t})).catch((err) => {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tfut.return();\n\t\t\t\t});\n\t\t}));\n\n\t\treturn fut.wait();\n\t},\n\n\tavatarsOnFinishUpload(file) {\n\t\t// update file record to match user's username\n\t\tconst user = RocketChat.models.Users.findOneById(file.userId);\n\t\tconst oldAvatar = RocketChat.models.Avatars.findOneByName(user.username);\n\t\tif (oldAvatar) {\n\t\t\tRocketChat.models.Avatars.deleteFile(oldAvatar._id);\n\t\t}\n\t\tRocketChat.models.Avatars.updateFileNameById(file._id, user.username);\n\t\t// console.log('upload finished ->', file);\n\t},\n\n\trequestCanAccessFiles({ headers = {}, query = {} }) {\n\t\tif (!RocketChat.settings.get('FileUpload_ProtectFiles')) {\n\t\t\treturn true;\n\t\t}\n\n\t\tlet { rc_uid, rc_token, rc_rid, rc_room_type } = query;\n\n\t\tif (!rc_uid && headers.cookie) {\n\t\t\trc_uid = cookie.get('rc_uid', headers.cookie);\n\t\t\trc_token = cookie.get('rc_token', headers.cookie);\n\t\t\trc_rid = cookie.get('rc_rid', headers.cookie);\n\t\t\trc_room_type = cookie.get('rc_room_type', headers.cookie);\n\t\t}\n\n\t\tconst isAuthorizedByCookies = rc_uid && rc_token && RocketChat.models.Users.findOneByIdAndLoginToken(rc_uid, rc_token);\n\t\tconst isAuthorizedByHeaders = headers['x-user-id'] && headers['x-auth-token'] && RocketChat.models.Users.findOneByIdAndLoginToken(headers['x-user-id'], headers['x-auth-token']);\n\t\tconst isAuthorizedByRoom = rc_room_type && RocketChat.roomTypes.getConfig(rc_room_type).canAccessUploadedFile({ rc_uid, rc_rid, rc_token });\n\t\treturn isAuthorizedByCookies || isAuthorizedByHeaders || isAuthorizedByRoom;\n\t},\n\taddExtensionTo(file) {\n\t\tif (mime.lookup(file.name) === file.type) {\n\t\t\treturn file;\n\t\t}\n\n\t\tconst ext = mime.extension(file.type);\n\t\tif (ext && false === new RegExp(`\\.${ ext }$`, 'i').test(file.name)) {\n\t\t\tfile.name = `${ file.name }.${ ext }`;\n\t\t}\n\n\t\treturn file;\n\t},\n\n\tgetStore(modelName) {\n\t\tconst storageType = RocketChat.settings.get('FileUpload_Storage_Type');\n\t\tconst handlerName = `${ storageType }:${ modelName }`;\n\n\t\treturn this.getStoreByName(handlerName);\n\t},\n\n\tgetStoreByName(handlerName) {\n\t\tif (this.handlers[handlerName] == null) {\n\t\t\tconsole.error(`Upload handler \"${ handlerName }\" does not exists`);\n\t\t}\n\t\treturn this.handlers[handlerName];\n\t},\n\n\tget(file, req, res, next) {\n\t\tconst store = this.getStoreByName(file.store);\n\t\tif (store && store.get) {\n\t\t\treturn store.get(file, req, res, next);\n\t\t}\n\t\tres.writeHead(404);\n\t\tres.end();\n\t},\n\n\tcopy(file, targetFile) {\n\t\tconst store = this.getStoreByName(file.store);\n\t\tconst out = fs.createWriteStream(targetFile);\n\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\tif (store.copy) {\n\t\t\tstore.copy(file, out);\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n});\n\nexport class FileUploadClass {\n\tconstructor({ name, model, store, get, insert, getStore, copy }) {\n\t\tthis.name = name;\n\t\tthis.model = model || this.getModelFromName();\n\t\tthis._store = store || UploadFS.getStore(name);\n\t\tthis.get = get;\n\t\tthis.copy = copy;\n\n\t\tif (insert) {\n\t\t\tthis.insert = insert;\n\t\t}\n\n\t\tif (getStore) {\n\t\t\tthis.getStore = getStore;\n\t\t}\n\n\t\tFileUpload.handlers[name] = this;\n\t}\n\n\tgetStore() {\n\t\treturn this._store;\n\t}\n\n\tget store() {\n\t\treturn this.getStore();\n\t}\n\n\tset store(store) {\n\t\tthis._store = store;\n\t}\n\n\tgetModelFromName() {\n\t\treturn RocketChat.models[this.name.split(':')[1]];\n\t}\n\n\tdelete(fileId) {\n\t\tif (this.store && this.store.delete) {\n\t\t\tthis.store.delete(fileId);\n\t\t}\n\n\t\treturn this.model.deleteFile(fileId);\n\t}\n\n\tdeleteById(fileId) {\n\t\tconst file = this.model.findOneById(fileId);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tdeleteByName(fileName) {\n\t\tconst file = this.model.findOneByName(fileName);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tinsert(fileData, streamOrBuffer, cb) {\n\t\tfileData.size = parseInt(fileData.size) || 0;\n\n\t\t// Check if the fileData matches store filter\n\t\tconst filter = this.store.getFilter();\n\t\tif (filter && filter.check) {\n\t\t\tfilter.check(fileData);\n\t\t}\n\n\t\tconst fileId = this.store.create(fileData);\n\t\tconst token = this.store.createToken(fileId);\n\t\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\t\ttry {\n\t\t\tif (streamOrBuffer instanceof stream) {\n\t\t\t\tstreamOrBuffer.pipe(fs.createWriteStream(tmpFile));\n\t\t\t} else if (streamOrBuffer instanceof Buffer) {\n\t\t\t\tfs.writeFileSync(tmpFile, streamOrBuffer);\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid file type');\n\t\t\t}\n\n\t\t\tconst file = Meteor.call('ufsComplete', fileId, this.name, token);\n\n\t\t\tif (cb) {\n\t\t\t\tcb(null, file);\n\t\t\t}\n\n\t\t\treturn file;\n\t\t} catch (e) {\n\t\t\tif (cb) {\n\t\t\t\tcb(e);\n\t\t\t} else {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\t}\n}\n","/* globals UploadFS, InstanceStatus */\n\nimport http from 'http';\nimport URL from 'url';\n\nconst logger = new Logger('UploadProxy');\n\nWebApp.connectHandlers.stack.unshift({\n\troute: '',\n\thandle: Meteor.bindEnvironment(function(req, res, next) {\n\t\t// Quick check to see if request should be catch\n\t\tif (req.url.indexOf(UploadFS.config.storesPath) === -1) {\n\t\t\treturn next();\n\t\t}\n\n\t\tlogger.debug('Upload URL:', req.url);\n\n\t\tif (req.method !== 'POST') {\n\t\t\treturn next();\n\t\t}\n\n\t\t// Remove store path\n\t\tconst parsedUrl = URL.parse(req.url);\n\t\tconst path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n\t\t// Get store\n\t\tconst regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get file\n\t\tconst fileId = match[2];\n\t\tconst file = store.getCollection().findOne({_id: fileId});\n\t\tif (file === undefined) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (file.instanceId === InstanceStatus.id()) {\n\t\t\tlogger.debug('Correct instance');\n\t\t\treturn next();\n\t\t}\n\n\t\t// Proxy to other instance\n\t\tconst instance = InstanceStatus.getCollection().findOne({_id: file.instanceId});\n\n\t\tif (instance == null) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (instance.extraInformation.host === process.env.INSTANCE_IP && RocketChat.isDocker() === false) {\n\t\t\tinstance.extraInformation.host = 'localhost';\n\t\t}\n\n\t\tlogger.debug('Wrong instance, proxing to:', `${ instance.extraInformation.host }:${ instance.extraInformation.port }`);\n\n\t\tconst options = {\n\t\t\thostname: instance.extraInformation.host,\n\t\t\tport: instance.extraInformation.port,\n\t\t\tpath: req.originalUrl,\n\t\t\tmethod: 'POST'\n\t\t};\n\n\t\tconst proxy = http.request(options, function(proxy_res) {\n\t\t\tproxy_res.pipe(res, {\n\t\t\t\tend: true\n\t\t\t});\n\t\t});\n\n\t\treq.pipe(proxy, {\n\t\t\tend: true\n\t\t});\n\t})\n});\n","/* globals FileUpload, WebApp */\n\nWebApp.connectHandlers.use('/file-upload/',\tfunction(req, res, next) {\n\n\tconst match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst file = RocketChat.models.Uploads.findOneById(match[1]);\n\n\t\tif (file) {\n\t\t\tif (!Meteor.settings.public.sandstorm && !FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\tres.writeHead(403);\n\t\t\t\treturn res.end();\n\t\t\t}\n\n\t\t\tres.setHeader('Content-Security-Policy', 'default-src \\'none\\'');\n\t\t\treturn FileUpload.get(file, req, res, next);\n\t\t}\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n});\n","/* globals UploadFS */\n\nimport _ from 'underscore';\nimport './AmazonS3.js';\nimport './FileSystem.js';\nimport './GoogleStorage.js';\nimport './GridFS.js';\nimport './Webdav.js';\nimport './Slingshot_DEPRECATED.js';\n\nconst configStore = _.debounce(() => {\n\tconst store = RocketChat.settings.get('FileUpload_Storage_Type');\n\n\tif (store) {\n\t\tconsole.log('Setting default file store to', store);\n\t\tUploadFS.getStores().Avatars = UploadFS.getStore(`${ store }:Avatars`);\n\t\tUploadFS.getStores().Uploads = UploadFS.getStore(`${ store }:Uploads`);\n\t\tUploadFS.getStores().UserDataFiles = UploadFS.getStore(`${ store }:UserDataFiles`);\n\t}\n}, 1000);\n\nRocketChat.settings.get(/^FileUpload_/, configStore);\n","/* globals FileUpload */\n\nimport _ from 'underscore';\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/AmazonS3/server.js';\nimport http from 'http';\nimport https from 'https';\n\nconst get = function(file, req, res) {\n\tconst fileUrl = this.store.getRedirectURL(file);\n\n\tif (fileUrl) {\n\t\tconst storeType = file.store.split(':').pop();\n\t\tif (RocketChat.settings.get(`FileUpload_S3_Proxy_${ storeType }`)) {\n\t\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\t\trequest.get(fileUrl, fileRes => fileRes.pipe(res));\n\t\t} else {\n\t\t\tres.removeHeader('Content-Length');\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t\tres.end();\n\t\t}\n\t} else {\n\t\tres.end();\n\t}\n};\n\nconst copy = function(file, out) {\n\tconst fileUrl = this.store.getRedirectURL(file);\n\n\tif (fileUrl) {\n\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\trequest.get(fileUrl, fileRes => fileRes.pipe(out));\n\t} else {\n\t\tout.end();\n\t}\n};\n\nconst AmazonS3Uploads = new FileUploadClass({\n\tname: 'AmazonS3:Uploads',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst AmazonS3Avatars = new FileUploadClass({\n\tname: 'AmazonS3:Avatars',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst AmazonS3UserDataFiles = new FileUploadClass({\n\tname: 'AmazonS3:UserDataFiles',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst Bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst Acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst AWSAccessKeyId = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst AWSSecretAccessKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\tconst Region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst SignatureVersion = RocketChat.settings.get('FileUpload_S3_SignatureVersion');\n\tconst ForcePathStyle = RocketChat.settings.get('FileUpload_S3_ForcePathStyle');\n\t// const CDN = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst BucketURL = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tif (!Bucket) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tsignatureVersion: SignatureVersion,\n\t\t\ts3ForcePathStyle: ForcePathStyle,\n\t\t\tparams: {\n\t\t\t\tBucket,\n\t\t\t\tACL: Acl\n\t\t\t},\n\t\t\tregion: Region\n\t\t},\n\t\tURLExpiryTimeSpan\n\t};\n\n\tif (AWSAccessKeyId) {\n\t\tconfig.connection.accessKeyId = AWSAccessKeyId;\n\t}\n\n\tif (AWSSecretAccessKey) {\n\t\tconfig.connection.secretAccessKey = AWSSecretAccessKey;\n\t}\n\n\tif (BucketURL) {\n\t\tconfig.connection.endpoint = BucketURL;\n\t}\n\n\tAmazonS3Uploads.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Uploads.name, config);\n\tAmazonS3Avatars.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Avatars.name, config);\n\tAmazonS3UserDataFiles.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3UserDataFiles.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_S3_/, configure);\n","/* globals FileUpload, UploadFS */\n\nimport _ from 'underscore';\nimport fs from 'fs';\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t},\n\n\tcopy(file, out) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(out);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tout.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst FileSystemUserDataFiles = new FileUploadClass({\n\tname: 'FileSystem:UserDataFiles',\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst createFileSystemStore = _.debounce(function() {\n\tconst options = {\n\t\tpath: RocketChat.settings.get('FileUpload_FileSystemPath') //'/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\tFileSystemUserDataFiles.store = FileUpload.configureUploadsStore('Local', FileSystemUserDataFiles.name, options);\n\n\t// DEPRECATED backwards compatibililty (remove)\n\tUploadFS.getStores()['fileSystem'] = UploadFS.getStores()[FileSystemUploads.name];\n}, 500);\n\nRocketChat.settings.get('FileUpload_FileSystemPath', createFileSystemStore);\n","/* globals FileUpload */\n\nimport _ from 'underscore';\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/GoogleStorage/server.js';\nimport http from 'http';\nimport https from 'https';\n\nconst get = function(file, req, res) {\n\tthis.store.getRedirectURL(file, (err, fileUrl) => {\n\t\tif (err) {\n\t\t\tconsole.error(err);\n\t\t}\n\n\t\tif (fileUrl) {\n\t\t\tconst storeType = file.store.split(':').pop();\n\t\t\tif (RocketChat.settings.get(`FileUpload_GoogleStorage_Proxy_${ storeType }`)) {\n\t\t\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\t\t\trequest.get(fileUrl, fileRes => fileRes.pipe(res));\n\t\t\t} else {\n\t\t\t\tres.removeHeader('Content-Length');\n\t\t\t\tres.setHeader('Location', fileUrl);\n\t\t\t\tres.writeHead(302);\n\t\t\t\tres.end();\n\t\t\t}\n\t\t} else {\n\t\t\tres.end();\n\t\t}\n\t});\n};\n\nconst copy = function(file, out) {\n\tthis.store.getRedirectURL(file, (err, fileUrl) => {\n\t\tif (err) {\n\t\t\tconsole.error(err);\n\t\t}\n\n\t\tif (fileUrl) {\n\t\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\t\trequest.get(fileUrl, fileRes => fileRes.pipe(out));\n\t\t} else {\n\t\t\tout.end();\n\t\t}\n\t});\n};\n\nconst GoogleCloudStorageUploads = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Uploads',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageAvatars = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Avatars',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageUserDataFiles = new FileUploadClass({\n\tname: 'GoogleCloudStorage:UserDataFiles',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\n\tif (!bucket || !accessId || !secret) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tclient_email: accessId,\n\t\t\t\tprivate_key: secret\n\t\t\t}\n\t\t},\n\t\tbucket,\n\t\tURLExpiryTimeSpan\n\t};\n\n\tGoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n\tGoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n\tGoogleCloudStorageUserDataFiles.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUserDataFiles.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, configure);\n","/* globals FileUpload, UploadFS */\nimport stream from 'stream';\nimport zlib from 'zlib';\nimport util from 'util';\n\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst logger = new Logger('FileUpload');\n\nfunction ExtractRange(options) {\n\tif (!(this instanceof ExtractRange)) {\n\t\treturn new ExtractRange(options);\n\t}\n\n\tthis.start = options.start;\n\tthis.stop = options.stop;\n\tthis.bytes_read = 0;\n\n\tstream.Transform.call(this, options);\n}\nutil.inherits(ExtractRange, stream.Transform);\n\n\nExtractRange.prototype._transform = function(chunk, enc, cb) {\n\tif (this.bytes_read > this.stop) {\n\t\t// done reading\n\t\tthis.end();\n\t} else if (this.bytes_read + chunk.length < this.start) {\n\t\t// this chunk is still before the start byte\n\t} else {\n\t\tlet start;\n\t\tlet stop;\n\n\t\tif (this.start <= this.bytes_read) {\n\t\t\tstart = 0;\n\t\t} else {\n\t\t\tstart = this.start - this.bytes_read;\n\t\t}\n\t\tif ((this.stop - this.bytes_read + 1) < chunk.length) {\n\t\t\tstop = this.stop - this.bytes_read + 1;\n\t\t} else {\n\t\t\tstop = chunk.length;\n\t\t}\n\t\tconst newchunk = chunk.slice(start, stop);\n\t\tthis.push(newchunk);\n\t}\n\tthis.bytes_read += chunk.length;\n\tcb();\n};\n\n\nconst getByteRange = function(header) {\n\tif (header) {\n\t\tconst matches = header.match(/(\\d+)-(\\d+)/);\n\t\tif (matches) {\n\t\t\treturn {\n\t\t\t\tstart: parseInt(matches[1], 10),\n\t\t\t\tstop: parseInt(matches[2], 10)\n\t\t\t};\n\t\t}\n\t}\n\treturn null;\n};\n\n// code from: https://github.com/jalik/jalik-ufs/blob/master/ufs-server.js#L310\nconst readFromGridFS = function(storeName, fileId, file, req, res) {\n\tconst store = UploadFS.getStore(storeName);\n\tconst rs = store.getReadStream(fileId, file);\n\tconst ws = new stream.PassThrough();\n\n\t[rs, ws].forEach(stream => stream.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t}));\n\n\tws.on('close', function() {\n\t\t// Close output stream at the end\n\t\tws.emit('end');\n\t});\n\n\tconst accept = req.headers['accept-encoding'] || '';\n\n\t// Transform stream\n\tstore.transformRead(rs, ws, fileId, file, req);\n\tconst range = getByteRange(req.headers.range);\n\tlet out_of_range = false;\n\tif (range) {\n\t\tout_of_range = (range.start > file.size) || (range.stop <= range.start) || (range.stop > file.size);\n\t}\n\n\t// Compress data using gzip\n\tif (accept.match(/\\bgzip\\b/) && range === null) {\n\t\tres.setHeader('Content-Encoding', 'gzip');\n\t\tres.removeHeader('Content-Length');\n\t\tres.writeHead(200);\n\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t} else if (accept.match(/\\bdeflate\\b/) && range === null) {\n\t\t// Compress data using deflate\n\t\tres.setHeader('Content-Encoding', 'deflate');\n\t\tres.removeHeader('Content-Length');\n\t\tres.writeHead(200);\n\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t} else if (range && out_of_range) {\n\t\t// out of range request, return 416\n\t\tres.removeHeader('Content-Length');\n\t\tres.removeHeader('Content-Type');\n\t\tres.removeHeader('Content-Disposition');\n\t\tres.removeHeader('Last-Modified');\n\t\tres.setHeader('Content-Range', `bytes */${ file.size }`);\n\t\tres.writeHead(416);\n\t\tres.end();\n\t} else if (range) {\n\t\tres.setHeader('Content-Range', `bytes ${ range.start }-${ range.stop }/${ file.size }`);\n\t\tres.removeHeader('Content-Length');\n\t\tres.setHeader('Content-Length', range.stop - range.start + 1);\n\t\tres.writeHead(206);\n\t\tlogger.debug('File upload extracting range');\n\t\tws.pipe(new ExtractRange({ start: range.start, stop: range.stop })).pipe(res);\n\t} else {\n\t\tres.writeHead(200);\n\t\tws.pipe(res);\n\t}\n};\n\nconst copyFromGridFS = function(storeName, fileId, file, out) {\n\tconst store = UploadFS.getStore(storeName);\n\tconst rs = store.getReadStream(fileId, file);\n\n\t[rs, out].forEach(stream => stream.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tout.end();\n\t}));\n\n\trs.pipe(out);\n};\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Uploads', {\n\tcollectionName: 'rocketchat_uploads'\n});\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:UserDataFiles', {\n\tcollectionName: 'rocketchat_userDataFiles'\n});\n\n// DEPRECATED: backwards compatibility (remove)\nUploadFS.getStores()['rocketchat_uploads'] = UploadFS.getStores()['GridFS:Uploads'];\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Avatars', {\n\tcollectionName: 'rocketchat_avatars'\n});\n\n\nnew FileUploadClass({\n\tname: 'GridFS:Uploads',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\tres.setHeader('Content-Type', file.type);\n\t\tres.setHeader('Content-Length', file.size);\n\n\t\treturn readFromGridFS(file.store, file._id, file, req, res);\n\t},\n\n\tcopy(file, out) {\n\t\tcopyFromGridFS(file.store, file._id, file, out);\n\t}\n});\n\nnew FileUploadClass({\n\tname: 'GridFS:UserDataFiles',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\tres.setHeader('Content-Type', file.type);\n\t\tres.setHeader('Content-Length', file.size);\n\n\t\treturn readFromGridFS(file.store, file._id, file, req, res);\n\t},\n\n\tcopy(file, out) {\n\t\tcopyFromGridFS(file.store, file._id, file, out);\n\t}\n});\n\nnew FileUploadClass({\n\tname: 'GridFS:Avatars',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\treturn readFromGridFS(file.store, file._id, file, req, res);\n\t}\n});\n","/* globals Slingshot, FileUpload */\nimport _ from 'underscore';\n\nconst configureSlingshot = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst accessKey = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst secretKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst cdn = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst bucketUrl = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tdelete Slingshot._directives['rocketchat-uploads'];\n\n\tif (type === 'AmazonS3' && !_.isEmpty(bucket) && !_.isEmpty(accessKey) && !_.isEmpty(secretKey)) {\n\t\tif (Slingshot._directives['rocketchat-uploads']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads'];\n\t\t}\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tAmazonS3: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'AmazonS3:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t},\n\t\t\tAWSAccessKeyId: accessKey,\n\t\t\tAWSSecretAccessKey: secretKey\n\t\t};\n\n\t\tif (!_.isEmpty(acl)) {\n\t\t\tconfig.acl = acl;\n\t\t}\n\n\t\tif (!_.isEmpty(cdn)) {\n\t\t\tconfig.cdn = cdn;\n\t\t}\n\n\t\tif (!_.isEmpty(region)) {\n\t\t\tconfig.region = region;\n\t\t}\n\n\t\tif (!_.isEmpty(bucketUrl)) {\n\t\t\tconfig.bucketUrl = bucketUrl;\n\t\t}\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads', Slingshot.S3Storage, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring S3 ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', configureSlingshot);\nRocketChat.settings.get(/^FileUpload_S3_/, configureSlingshot);\n\n\n\nconst createGoogleStorageDirective = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\n\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\n\tif (type === 'GoogleCloudStorage' && !_.isEmpty(secret) && !_.isEmpty(accessId) && !_.isEmpty(bucket)) {\n\t\tif (Slingshot._directives['rocketchat-uploads-gs']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\t\t}\n\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tGoogleAccessId: accessId,\n\t\t\tGoogleSecretKey: secret,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tGoogleStorage: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'GoogleCloudStorage:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads-gs', Slingshot.GoogleCloud, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring GoogleCloudStorage ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createGoogleStorageDirective);\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, createGoogleStorageDirective);\n","/* globals FileUpload */\n\nimport _ from 'underscore';\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/Webdav/server.js';\n\nconst get = function(file, req, res) {\n\tthis.store.getReadStream(file._id, file).pipe(res);\n};\n\nconst copy = function(file, out) {\n\tthis.store.getReadStream(file._id, file).pipe(out);\n};\n\nconst WebdavUploads = new FileUploadClass({\n\tname: 'Webdav:Uploads',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst WebdavAvatars = new FileUploadClass({\n\tname: 'Webdav:Avatars',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst WebdavUserDataFiles = new FileUploadClass({\n\tname: 'Webdav:UserDataFiles',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst uploadFolderPath = RocketChat.settings.get('FileUpload_Webdav_Upload_Folder_Path');\n\tconst server = RocketChat.settings.get('FileUpload_Webdav_Server_URL');\n\tconst username = RocketChat.settings.get('FileUpload_Webdav_Username');\n\tconst password = RocketChat.settings.get('FileUpload_Webdav_Password');\n\n\tif (!server || !username || !password) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tserver,\n\t\t\t\tusername,\n\t\t\t\tpassword\n\t\t\t}\n\t\t},\n\t\tuploadFolderPath\n\t};\n\n\tWebdavUploads.store = FileUpload.configureUploadsStore('Webdav', WebdavUploads.name, config);\n\tWebdavAvatars.store = FileUpload.configureUploadsStore('Webdav', WebdavAvatars.name, config);\n\tWebdavUserDataFiles.store = FileUpload.configureUploadsStore('Webdav', WebdavUserDataFiles.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_Webdav_/, configure);\n","import _ from 'underscore';\n\nMeteor.methods({\n\tasync 'sendFileMessage'(roomId, store, file, msgData = {}) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', roomId, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcheck(msgData, {\n\t\t\tavatar: Match.Optional(String),\n\t\t\temoji: Match.Optional(String),\n\t\t\talias: Match.Optional(String),\n\t\t\tgroupable: Match.Optional(Boolean),\n\t\t\tmsg: Match.Optional(String)\n\t\t});\n\n\t\tRocketChat.models.Uploads.updateFileComplete(file._id, Meteor.userId(), _.omit(file, '_id'));\n\n\t\tconst fileUrl = `/file-upload/${ file._id }/${ encodeURI(file.name) }`;\n\n\t\tconst attachment = {\n\t\t\ttitle: file.name,\n\t\t\ttype: 'file',\n\t\t\tdescription: file.description,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t\tattachment.image_preview = await FileUpload.resizeImagePreview(file);\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tlet msg = Object.assign({\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tts: new Date(),\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id,\n\t\t\t\tname: file.name,\n\t\t\t\ttype: file.type\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment]\n\t\t}, msgData);\n\n\t\tmsg = Meteor.call('sendMessage', msg);\n\n\t\tMeteor.defer(() => RocketChat.callbacks.run('afterFileUpload', { user, room, message: msg }));\n\n\t\treturn msg;\n\t}\n});\n","/* globals UploadFS */\n\nlet protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nMeteor.methods({\n\tgetS3FileUrl(fileId) {\n\t\tif (protectedFiles && !Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\n\t\treturn UploadFS.getStore('AmazonS3:Uploads').getRedirectURL(file);\n\t}\n});\n","RocketChat.settings.addGroup('FileUpload', function() {\n\tthis.add('FileUpload_Enabled', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MaxFileSize', 2097152, {\n\t\ttype: 'int',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MediaTypeWhiteList', 'image/*,audio/*,video/*,application/zip,application/x-rar-compressed,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_MediaTypeWhiteListDescription'\n\t});\n\n\tthis.add('FileUpload_ProtectFiles', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_ProtectFilesDescription'\n\t});\n\n\tthis.add('FileUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'AmazonS3',\n\t\t\ti18nLabel: 'AmazonS3'\n\t\t}, {\n\t\t\tkey: 'GoogleCloudStorage',\n\t\t\ti18nLabel: 'GoogleCloudStorage'\n\t\t}, {\n\t\t\tkey: 'Webdav',\n\t\t\ti18nLabel: 'WebDAV'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\tpublic: true\n\t});\n\n\tthis.section('Amazon S3', function() {\n\t\tthis.add('FileUpload_S3_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Acl', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSAccessKeyId', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSSecretAccessKey', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_CDN', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Region', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_BucketURL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'Override_URL_to_which_files_are_uploaded_This_url_also_used_for_downloads_unless_a_CDN_is_given.'\n\t\t});\n\t\tthis.add('FileUpload_S3_SignatureVersion', 'v4', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_ForcePathStyle', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_URLExpiryTimeSpan', 120, {\n\t\t\ttype: 'int',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'FileUpload_S3_URLExpiryTimeSpan_Description'\n\t\t});\n\t\tthis.add('FileUpload_S3_Proxy_Avatars', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Proxy_Uploads', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('Google Cloud Storage', function() {\n\t\tthis.add('FileUpload_GoogleStorage_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_AccessId', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Secret', '', {\n\t\t\ttype: 'string',\n\t\t\tmultiline: true,\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Proxy_Avatars', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Proxy_Uploads', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('File System', function() {\n\t\tthis.add('FileUpload_FileSystemPath', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'FileSystem'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('WebDAV', function() {\n\t\tthis.add('FileUpload_Webdav_Upload_Folder_Path', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'Webdav'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_Webdav_Server_URL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'Webdav'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_Webdav_Username', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'Webdav'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_Webdav_Password', '', {\n\t\t\ttype: 'password',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'Webdav'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_Webdav_Proxy_Avatars', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'Webdav'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_Webdav_Proxy_Uploads', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'Webdav'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.add('FileUpload_Enabled_Direct', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n});\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport _ from 'underscore';\nimport S3 from 'aws-sdk/clients/s3';\nimport stream from 'stream';\n\n/**\n * AmazonS3 store\n * @param options\n * @constructor\n */\nexport class AmazonS3Store extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\t// Default options\n\t\t// options.secretAccessKey,\n\t\t// options.accessKeyId,\n\t\t// options.region,\n\t\t// options.sslEnabled // optional\n\n\t\toptions = _.extend({\n\t\t\thttpOptions: {\n\t\t\t\ttimeout: 6000,\n\t\t\t\tagent: false\n\t\t\t}\n\t\t}, options);\n\n\t\tsuper(options);\n\n\t\tconst classOptions = options;\n\n\t\tconst s3 = new S3(options.connection);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.AmazonS3) {\n\t\t\t\treturn file.AmazonS3.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.s3) {\n\t\t\t\treturn file.s3.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tExpires: classOptions.URLExpiryTimeSpan\n\t\t\t};\n\n\t\t\treturn s3.getSignedUrl('getObject', params);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.AmazonS3 = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\ts3.deleteObject(params, (err, data) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\tif (options.start && options.end) {\n\t\t\t\tparams.Range = `${ options.start } - ${ options.end }`;\n\t\t\t}\n\n\t\t\treturn s3.getObject(params).createReadStream();\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\tconst writeStream = new stream.PassThrough();\n\t\t\twriteStream.length = file.size;\n\n\t\t\twriteStream.on('newListener', (event, listener) => {\n\t\t\t\tif (event === 'finish') {\n\t\t\t\t\tprocess.nextTick(() => {\n\t\t\t\t\t\twriteStream.removeListener(event, listener);\n\t\t\t\t\t\twriteStream.on('real_finish', listener);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\ts3.putObject({\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tBody: writeStream,\n\t\t\t\tContentType: file.type,\n\t\t\t\tContentDisposition: `inline; filename=\"${ encodeURI(file.name) }\"`\n\n\t\t\t}, (error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\tconsole.error(error);\n\t\t\t\t}\n\n\t\t\t\twriteStream.emit('real_finish');\n\t\t\t});\n\n\t\t\treturn writeStream;\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.AmazonS3 = AmazonS3Store;\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport gcStorage from '@google-cloud/storage';\n\n/**\n * GoogleStorage store\n * @param options\n * @constructor\n */\nexport class GoogleStorageStore extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\tsuper(options);\n\n\t\tconst gcs = gcStorage(options.connection);\n\t\tthis.bucket = gcs.bucket(options.bucket);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.GoogleStorage) {\n\t\t\t\treturn file.GoogleStorage.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.googleCloudStorage) {\n\t\t\t\treturn file.googleCloudStorage.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file, callback) {\n\t\t\tconst params = {\n\t\t\t\taction: 'read',\n\t\t\t\tresponseDisposition: 'inline',\n\t\t\t\texpires: Date.now()+this.options.URLExpiryTimeSpan*1000\n\t\t\t};\n\n\t\t\tthis.bucket.file(this.getPath(file)).getSignedUrl(params, callback);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.GoogleStorage = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tthis.bucket.file(this.getPath(file)).delete(function(err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst config = {};\n\n\t\t\tif (options.start != null) {\n\t\t\t\tconfig.start = options.start;\n\t\t\t}\n\n\t\t\tif (options.end != null) {\n\t\t\t\tconfig.end = options.end;\n\t\t\t}\n\n\t\t\treturn this.bucket.file(this.getPath(file)).createReadStream(config);\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\treturn this.bucket.file(this.getPath(file)).createWriteStream({\n\t\t\t\tgzip: false,\n\t\t\t\tmetadata: {\n\t\t\t\t\tcontentType: file.type,\n\t\t\t\t\tcontentDisposition: `inline; filename=${ file.name }`\n\t\t\t\t\t// metadata: {\n\t\t\t\t\t// \tcustom: 'metadata'\n\t\t\t\t\t// }\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.GoogleStorage = GoogleStorageStore;\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport Webdav from 'webdav';\nimport stream from 'stream';\n/**\n * WebDAV store\n * @param options\n * @constructor\n */\nexport class WebdavStore extends UploadFS.Store {\n\n\tconstructor(options) {\n\n\t\tsuper(options);\n\n\n\t\tconst client = new Webdav(\n\t\t\toptions.connection.credentials.server,\n\t\t\toptions.connection.credentials.username,\n\t\t\toptions.connection.credentials.password,\n\t\t);\n\n\t\toptions.getPath = function(file) {\n\t\t\tif (options.uploadFolderPath[options.uploadFolderPath.length-1] !== '/') {\n\t\t\t\toptions.uploadFolderPath += '/';\n\t\t\t}\n\t\t\treturn options.uploadFolderPath + file._id;\n\t\t};\n\n\t\tclient.stat(options.uploadFolderPath).catch(function(err) {\n\t\t\tif (err.status === '404') {\n\t\t\t\tclient.createDirectory(options.uploadFolderPath);\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Returns the file path\n\t\t * @param file\n\t\t * @return {string}\n\t\t */\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.Webdav) {\n\t\t\t\treturn file.Webdav.path;\n\t\t\t}\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the col lection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.Webdav = {\n\t\t\t\tpath: options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name;\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tclient.deleteFile(this.getPath(file), (err, data) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst range = {};\n\n\t\t\tif (options.start != null) {\n\t\t\t\trange.start = options.start;\n\t\t\t}\n\n\t\t\tif (options.end != null) {\n\t\t\t\trange.end = options.end;\n\t\t\t}\n\t\t\treturn client.createReadStream(this.getPath(file), options);\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file) {\n\t\t\tconst writeStream = new stream.PassThrough();\n\t\t\tconst webdavStream = client.createWriteStream(this.getPath(file));\n\n\t\t\t//TODO remove timeout when UploadFS bug resolved\n\t\t\tconst newListenerCallback = (event, listener) => {\n\t\t\t\tif (event === 'finish') {\n\t\t\t\t\tprocess.nextTick(() => {\n\t\t\t\t\t\twriteStream.removeListener(event, listener);\n\t\t\t\t\t\twriteStream.removeListener('newListener', newListenerCallback);\n\t\t\t\t\t\twriteStream.on(event, function() {\n\t\t\t\t\t\t\tsetTimeout(listener, 500);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\t\t\twriteStream.on('newListener', newListenerCallback);\n\n\t\t\twriteStream.pipe(webdavStream);\n\t\t\treturn writeStream;\n\t\t};\n\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.Webdav = WebdavStore;\n"]}