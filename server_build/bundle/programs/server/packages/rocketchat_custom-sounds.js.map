{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/startup/custom-sounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/startup/permissions.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/models/CustomSounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/publications/customSounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/deleteCustomSound.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/insertOrUpdateSound.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/listCustomSounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/uploadCustomSound.js"],"names":["_","module","watch","require","default","v","Meteor","startup","storeType","RocketChat","settings","get","RocketChatStore","RocketChatFile","Error","console","log","green","path","trim","RocketChatFileCustomSoundsInstance","name","absolutePath","self","WebApp","connectHandlers","use","bindEnvironment","req","res","params","sound","decodeURIComponent","url","replace","isEmpty","writeHead","write","end","file","getFileWithReadStream","setHeader","fileUploadDate","undefined","uploadDate","toUTCString","reqModifiedHeader","headers","Date","length","readStream","pipe","models","Permissions","createOrUpdate","addGroup","add","type","values","key","i18nLabel","enableQuery","_id","value","CustomSounds","_Base","constructor","tryEnsureIndex","findOneByID","options","findOne","findByName","query","find","findByNameExceptID","except","$nin","setName","update","$set","create","data","insert","removeByID","remove","s","publish","filter","limit","userId","ready","fields","extension","sort","filterReg","RegExp","escapeRegExp","methods","deleteCustomSound","authz","hasPermission","method","deleteFile","Notifications","notifyAll","soundData","insertOrUpdateSound","field","nameValidation","test","input","matchingResults","fetch","createSound","newFile","previousExtension","previousName","listCustomSounds","uploadCustomSound","binaryContent","contentType","Buffer","rs","bufferToStream","ws","createWriteStream","on","setTimeout"],"mappings":"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","file":"/packages/rocketchat_custom-sounds.js","sourcesContent":["/* globals RocketChatFileCustomSoundsInstance */\nimport _ from 'underscore';\n\nMeteor.startup(function() {\n\tlet storeType = 'GridFS';\n\n\tif (RocketChat.settings.get('CustomSounds_Storage_Type')) {\n\t\tstoreType = RocketChat.settings.get('CustomSounds_Storage_Type');\n\t}\n\n\tconst RocketChatStore = RocketChatFile[storeType];\n\n\tif (RocketChatStore == null) {\n\t\tthrow new Error(`Invalid RocketChatStore type [${ storeType }]`);\n\t}\n\n\tconsole.log(`Using ${ storeType } for custom sounds storage`.green);\n\n\tlet path = '~/uploads';\n\tif (RocketChat.settings.get('CustomSounds_FileSystemPath') != null) {\n\t\tif (RocketChat.settings.get('CustomSounds_FileSystemPath').trim() !== '') {\n\t\t\tpath = RocketChat.settings.get('CustomSounds_FileSystemPath');\n\t\t}\n\t}\n\n\tthis.RocketChatFileCustomSoundsInstance = new RocketChatStore({\n\t\tname: 'custom_sounds',\n\t\tabsolutePath: path\n\t});\n\n\tself = this;\n\n\treturn WebApp.connectHandlers.use('/custom-sounds/', Meteor.bindEnvironment(function(req, res/*, next*/) {\n\t\tconst params =\n\t\t\t{ sound: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')) };\n\n\t\tif (_.isEmpty(params.sound)) {\n\t\t\tres.writeHead(403);\n\t\t\tres.write('Forbidden');\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatFileCustomSoundsInstance.getFileWithReadStream(params.sound);\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tres.setHeader('Content-Disposition', 'inline');\n\n\t\tlet fileUploadDate = undefined;\n\t\tif (file.uploadDate != null) {\n\t\t\tfileUploadDate = file.uploadDate.toUTCString();\n\t\t}\n\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader != null) {\n\t\t\tif (reqModifiedHeader === fileUploadDate) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\tres.setHeader('Expires', '-1');\n\t\tif (fileUploadDate != null) {\n\t\t\tres.setHeader('Last-Modified', fileUploadDate);\n\t\t} else {\n\t\t\tres.setHeader('Last-Modified', new Date().toUTCString());\n\t\t}\n\t\tres.setHeader('Content-Type', 'audio/mpeg');\n\t\tres.setHeader('Content-Length', file.length);\n\n\t\tfile.readStream.pipe(res);\n\t}));\n});\n","Meteor.startup(() => {\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('manage-sounds', ['admin']);\n\t}\n});\n","RocketChat.settings.addGroup('CustomSoundsFilesystem', function() {\n\tthis.add('CustomSounds_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\ti18nLabel: 'FileUpload_Storage_Type'\n\t});\n\n\tthis.add('CustomSounds_FileSystemPath', '', {\n\t\ttype: 'string',\n\t\tenableQuery: {\n\t\t\t_id: 'CustomSounds_Storage_Type',\n\t\t\tvalue: 'FileSystem'\n\t\t},\n\t\ti18nLabel: 'FileUpload_FileSystemPath'\n\t});\n});\n","class CustomSounds extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('custom_sounds');\n\n\t\tthis.tryEnsureIndex({ 'name': 1 });\n\t}\n\n\t//find one\n\tfindOneByID(_id, options) {\n\t\treturn this.findOne(_id, options);\n\t}\n\n\t//find\n\tfindByName(name, options) {\n\t\tconst query = {\n\t\t\tname\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindByNameExceptID(name, except, options) {\n\t\tconst query = {\n\t\t\t_id: { $nin: [ except ] },\n\t\t\tname\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\t//update\n\tsetName(_id, name) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tname\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\t// INSERT\n\tcreate(data) {\n\t\treturn this.insert(data);\n\t}\n\n\n\t// REMOVE\n\tremoveByID(_id) {\n\t\treturn this.remove(_id);\n\t}\n}\n\nRocketChat.models.CustomSounds = new CustomSounds();\n","import s from 'underscore.string';\n\nMeteor.publish('customSounds', function(filter, limit) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tconst fields = {\n\t\tname: 1,\n\t\textension: 1\n\t};\n\n\tfilter = s.trim(filter);\n\n\tconst options = {\n\t\tfields,\n\t\tlimit,\n\t\tsort: { name: 1 }\n\t};\n\n\tif (filter) {\n\t\tconst filterReg = new RegExp(s.escapeRegExp(filter), 'i');\n\t\treturn RocketChat.models.CustomSounds.findByName(filterReg, options);\n\t}\n\n\treturn RocketChat.models.CustomSounds.find({}, options);\n});\n","/* globals RocketChatFileCustomSoundsInstance */\nMeteor.methods({\n\tdeleteCustomSound(_id) {\n\t\tlet sound = null;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-sounds')) {\n\t\t\tsound = RocketChat.models.CustomSounds.findOneByID(_id);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (sound == null) {\n\t\t\tthrow new Meteor.Error('Custom_Sound_Error_Invalid_Sound', 'Invalid sound', { method: 'deleteCustomSound' });\n\t\t}\n\n\t\tRocketChatFileCustomSoundsInstance.deleteFile(`${ sound._id }.${ sound.extension }`);\n\t\tRocketChat.models.CustomSounds.removeByID(_id);\n\t\tRocketChat.Notifications.notifyAll('deleteCustomSound', {soundData: sound});\n\n\t\treturn true;\n\t}\n});\n","/* globals RocketChatFileCustomSoundsInstance */\nimport s from 'underscore.string';\n\nMeteor.methods({\n\tinsertOrUpdateSound(soundData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-sounds')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (!s.trim(soundData.name)) {\n\t\t\tthrow new Meteor.Error('error-the-field-is-required', 'The field Name is required', { method: 'insertOrUpdateSound', field: 'Name' });\n\t\t}\n\n\t\t//let nameValidation = new RegExp('^[0-9a-zA-Z-_+;.]+$');\n\n\t\t//allow all characters except colon, whitespace, comma, >, <, &, \", ', /, \\, (, )\n\t\t//more practical than allowing specific sets of characters; also allows foreign languages\n\t\tconst nameValidation = /[\\s,:><&\"'\\/\\\\\\(\\)]/;\n\n\t\t//silently strip colon; this allows for uploading :soundname: as soundname\n\t\tsoundData.name = soundData.name.replace(/:/g, '');\n\n\t\tif (nameValidation.test(soundData.name)) {\n\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${ soundData.name } is not a valid name`, { method: 'insertOrUpdateSound', input: soundData.name, field: 'Name' });\n\t\t}\n\n\t\tlet matchingResults = [];\n\n\t\tif (soundData._id) {\n\t\t\tmatchingResults = RocketChat.models.CustomSounds.findByNameExceptID(soundData.name, soundData._id).fetch();\n\t\t} else {\n\t\t\tmatchingResults = RocketChat.models.CustomSounds.findByName(soundData.name).fetch();\n\t\t}\n\n\t\tif (matchingResults.length > 0) {\n\t\t\tthrow new Meteor.Error('Custom_Sound_Error_Name_Already_In_Use', 'The custom sound name is already in use', { method: 'insertOrUpdateSound' });\n\t\t}\n\n\t\tif (!soundData._id) {\n\t\t\t//insert sound\n\t\t\tconst createSound = {\n\t\t\t\tname: soundData.name,\n\t\t\t\textension: soundData.extension\n\t\t\t};\n\n\t\t\tconst _id = RocketChat.models.CustomSounds.create(createSound);\n\t\t\tcreateSound._id = _id;\n\n\t\t\treturn _id;\n\t\t} else {\n\t\t\t//update sound\n\t\t\tif (soundData.newFile) {\n\t\t\t\tRocketChatFileCustomSoundsInstance.deleteFile(`${ soundData._id }.${ soundData.previousExtension }`);\n\t\t\t}\n\n\t\t\tif (soundData.name !== soundData.previousName) {\n\t\t\t\tRocketChat.models.CustomSounds.setName(soundData._id, soundData.name);\n\t\t\t\tRocketChat.Notifications.notifyAll('updateCustomSound', {soundData});\n\t\t\t}\n\n\t\t\treturn soundData._id;\n\t\t}\n\t}\n});\n","Meteor.methods({\n\tlistCustomSounds() {\n\t\treturn RocketChat.models.CustomSounds.find({}).fetch();\n\t}\n});\n","/* globals RocketChatFileCustomSoundsInstance */\nMeteor.methods({\n\tuploadCustomSound(binaryContent, contentType, soundData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-sounds')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatFileCustomSoundsInstance.deleteFile(`${ soundData._id }.${ soundData.extension }`);\n\t\tconst ws = RocketChatFileCustomSoundsInstance.createWriteStream(`${ soundData._id }.${ soundData.extension }`, contentType);\n\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\tMeteor.setTimeout(() => RocketChat.Notifications.notifyAll('updateCustomSound', {soundData}), 500)\n\t\t));\n\n\t\trs.pipe(ws);\n\t}\n});\n"]}