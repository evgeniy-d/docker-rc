{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:assets/server/assets.js"],"names":["_","module","watch","require","default","v","sizeOf","mime","crypto","extensions","RocketChatAssetsInstance","RocketChatFile","GridFS","name","assets","logo","label","defaultUrl","constraints","type","width","undefined","height","wizard","step","order","background","favicon_ico","favicon","favicon_16","favicon_32","favicon_192","favicon_512","touchicon_180","touchicon_180_pre","tile_144","tile_150","tile_310_square","tile_310_wide","safari_pinned","RocketChat","Assets","setAsset","binaryContent","contentType","asset","Meteor","Error","function","extension","includes","errorTitle","file","Buffer","dimensions","rs","bufferToStream","deleteFile","ws","createWriteStream","on","bindEnvironment","setTimeout","key","value","url","settings","updateById","processAsset","pipe","unsetAsset","refreshClients","process","emit","refresh","settingKey","settingValue","indexOf","assetKey","replace","assetValue","cache","getFileSync","hash","createHash","update","buffer","digest","split","pop","path","cacheable","sourceMapUrl","where","content","size","length","uploadDate","addGroup","add","group","i18nLabel","addAssetToSetting","fileConstraints","public","Object","keys","models","Settings","find","observe","added","record","_id","changed","removed","startup","calculateClientHash","WebAppHashing","manifest","includeFilter","runtimeConfigOverride","WebAppInternals","staticFiles","manifestItem","findWhere","index","push","call","methods","userId","method","hasPermission","authz","action","WebApp","connectHandlers","use","req","res","next","params","decodeURIComponent","staticFilesMiddleware","writeHead","end","reqModifiedHeader","headers","toUTCString","setHeader","Date"],"mappings":"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","file":"/packages/rocketchat_assets.js","sourcesContent":["/* global WebAppHashing, WebAppInternals */\nimport _ from 'underscore';\n\nimport sizeOf from 'image-size';\nimport mime from 'mime-type/with-db';\nimport crypto from 'crypto';\n\nmime.extensions['image/vnd.microsoft.icon'] = ['ico'];\n\nconst RocketChatAssetsInstance = new RocketChatFile.GridFS({\n\tname: 'assets'\n});\n\nthis.RocketChatAssetsInstance = RocketChatAssetsInstance;\n\nconst assets = {\n\tlogo: {\n\t\tlabel: 'logo (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t},\n\t\twizard: {\n\t\t\tstep: 3,\n\t\t\torder: 2\n\t\t}\n\t},\n\tbackground: {\n\t\tlabel: 'login background (svg, png, jpg)',\n\t\tdefaultUrl: undefined,\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\tfavicon_ico: {\n\t\tlabel: 'favicon (ico)',\n\t\tdefaultUrl: 'favicon.ico',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['ico'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\tfavicon: {\n\t\tlabel: 'favicon (svg)',\n\t\tdefaultUrl: 'images/logo/icon.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\tfavicon_16: {\n\t\tlabel: 'favicon 16x16 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-16x16.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 16,\n\t\t\theight: 16\n\t\t}\n\t},\n\tfavicon_32: {\n\t\tlabel: 'favicon 32x32 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-32x32.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 32,\n\t\t\theight: 32\n\t\t}\n\t},\n\tfavicon_192: {\n\t\tlabel: 'android-chrome 192x192 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 192,\n\t\t\theight: 192\n\t\t}\n\t},\n\tfavicon_512: {\n\t\tlabel: 'android-chrome 512x512 (png)',\n\t\tdefaultUrl: 'images/logo/512x512.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 512,\n\t\t\theight: 512\n\t\t}\n\t},\n\ttouchicon_180: {\n\t\tlabel: 'apple-touch-icon 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180\n\t\t}\n\t},\n\ttouchicon_180_pre: {\n\t\tlabel: 'apple-touch-icon-precomposed 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180\n\t\t}\n\t},\n\ttile_144: {\n\t\tlabel: 'mstile 144x144 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-144x144.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 144,\n\t\t\theight: 144\n\t\t}\n\t},\n\ttile_150: {\n\t\tlabel: 'mstile 150x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-150x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 150,\n\t\t\theight: 150\n\t\t}\n\t},\n\ttile_310_square: {\n\t\tlabel: 'mstile 310x310 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x310.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 310\n\t\t}\n\t},\n\ttile_310_wide: {\n\t\tlabel: 'mstile 310x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 150\n\t\t}\n\t},\n\tsafari_pinned: {\n\t\tlabel: 'safari pinned tab (svg)',\n\t\tdefaultUrl: 'images/logo/safari-pinned-tab.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t}\n};\n\nRocketChat.Assets = new (class {\n\tget mime() {\n\t\treturn mime;\n\t}\n\n\tget assets() {\n\t\treturn assets;\n\t}\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset'\n\t\t\t});\n\t\t}\n\n\t\tconst extension = mime.extension(contentType);\n\t\tif (assets[asset].constraints.extensions.includes(extension) === false) {\n\t\t\tthrow new Meteor.Error(contentType, `Invalid file type: ${ contentType }`, {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t\terrorTitle: 'error-invalid-file-type'\n\t\t\t});\n\t\t}\n\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\t\tif (assets[asset].constraints.width || assets[asset].constraints.height) {\n\t\t\tconst dimensions = sizeOf(file);\n\t\t\tif (assets[asset].constraints.width && assets[asset].constraints.width !== dimensions.width) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n\t\t\t\t\tfunction: 'Invalid file width'\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (assets[asset].constraints.height && assets[asset].constraints.height !== dimensions.height) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-height');\n\t\t\t}\n\t\t}\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\n\t\tconst ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n\t\tws.on('end', Meteor.bindEnvironment(function() {\n\t\t\treturn Meteor.setTimeout(function() {\n\t\t\t\tconst key = `Assets_${ asset }`;\n\t\t\t\tconst value = {\n\t\t\t\t\turl: `assets/${ asset }.${ extension }`,\n\t\t\t\t\tdefaultUrl: assets[asset].defaultUrl\n\t\t\t\t};\n\n\t\t\t\tRocketChat.settings.updateById(key, value);\n\t\t\t\treturn RocketChat.Assets.processAsset(key, value);\n\t\t\t}, 200);\n\t\t}));\n\n\t\trs.pipe(ws);\n\t}\n\n\tunsetAsset(asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.unsetAsset'\n\t\t\t});\n\t\t}\n\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\t\tconst key = `Assets_${ asset }`;\n\t\tconst value = {\n\t\t\tdefaultUrl: assets[asset].defaultUrl\n\t\t};\n\n\t\tRocketChat.settings.updateById(key, value);\n\t\tRocketChat.Assets.processAsset(key, value);\n\t}\n\n\trefreshClients() {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client'\n\t\t});\n\t}\n\n\tprocessAsset(settingKey, settingValue) {\n\t\tif (settingKey.indexOf('Assets_') !== 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst assetKey = settingKey.replace(/^Assets_/, '');\n\t\tconst assetValue = assets[assetKey];\n\n\t\tif (!assetValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!settingValue || !settingValue.url) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatAssetsInstance.getFileSync(assetKey);\n\t\tif (!file) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n\t\tconst extension = settingValue.url.split('.').pop();\n\n\t\treturn assetValue.cache = {\n\t\t\tpath: `assets/${ assetKey }.${ extension }`,\n\t\t\tcacheable: false,\n\t\t\tsourceMapUrl: undefined,\n\t\t\twhere: 'client',\n\t\t\ttype: 'asset',\n\t\t\tcontent: file.buffer,\n\t\t\textension,\n\t\t\turl: `/assets/${ assetKey }.${ extension }?${ hash }`,\n\t\t\tsize: file.length,\n\t\t\tuploadDate: file.uploadDate,\n\t\t\tcontentType: file.contentType,\n\t\t\thash\n\t\t};\n\t}\n});\n\nRocketChat.settings.addGroup('Assets');\n\nRocketChat.settings.add('Assets_SvgFavicon_Enable', true, {\n\ttype: 'boolean',\n\tgroup: 'Assets',\n\ti18nLabel: 'Enable_Svg_Favicon'\n});\n\nfunction addAssetToSetting(key, value) {\n\treturn RocketChat.settings.add(`Assets_${ key }`, {\n\t\tdefaultUrl: value.defaultUrl\n\t}, {\n\t\ttype: 'asset',\n\t\tgroup: 'Assets',\n\t\tfileConstraints: value.constraints,\n\t\ti18nLabel: value.label,\n\t\tasset: key,\n\t\tpublic: true,\n\t\twizard: value.wizard\n\t});\n}\n\nfor (const key of Object.keys(assets)) {\n\tconst value = assets[key];\n\taddAssetToSetting(key, value);\n}\n\nRocketChat.models.Settings.find().observe({\n\tadded(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, record.value);\n\t},\n\n\tchanged(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, record.value);\n\t},\n\n\tremoved(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, undefined);\n\t}\n});\n\nMeteor.startup(function() {\n\treturn Meteor.setTimeout(function() {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client'\n\t\t});\n\t}, 200);\n});\n\nconst calculateClientHash = WebAppHashing.calculateClientHash;\n\nWebAppHashing.calculateClientHash = function(manifest, includeFilter, runtimeConfigOverride) {\n\tfor (const key of Object.keys(assets)) {\n\t\tconst value = assets[key];\n\t\tif (!value.cache && !value.defaultUrl) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet cache = {};\n\t\tif (value.cache) {\n\t\t\tcache = {\n\t\t\t\tpath: value.cache.path,\n\t\t\t\tcacheable: value.cache.cacheable,\n\t\t\t\tsourceMapUrl: value.cache.sourceMapUrl,\n\t\t\t\twhere: value.cache.where,\n\t\t\t\ttype: value.cache.type,\n\t\t\t\turl: value.cache.url,\n\t\t\t\tsize: value.cache.size,\n\t\t\t\thash: value.cache.hash\n\t\t\t};\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }`] = value.cache;\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }.${ value.cache.extension }`] = value.cache;\n\t\t} else {\n\t\t\tconst extension = value.defaultUrl.split('.').pop();\n\t\t\tcache = {\n\t\t\t\tpath: `assets/${ key }.${ extension }`,\n\t\t\t\tcacheable: false,\n\t\t\t\tsourceMapUrl: undefined,\n\t\t\t\twhere: 'client',\n\t\t\t\ttype: 'asset',\n\t\t\t\turl: `/assets/${ key }.${ extension }?v3`,\n\t\t\t\thash: 'v3'\n\t\t\t};\n\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }`] = WebAppInternals.staticFiles[`/__cordova/${ value.defaultUrl }`];\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }.${ extension }`] = WebAppInternals.staticFiles[`/__cordova/${ value.defaultUrl }`];\n\t\t}\n\n\t\tconst manifestItem = _.findWhere(manifest, {\n\t\t\tpath: key\n\t\t});\n\n\t\tif (manifestItem) {\n\t\t\tconst index = manifest.indexOf(manifestItem);\n\t\t\tmanifest[index] = cache;\n\t\t} else {\n\t\t\tmanifest.push(cache);\n\t\t}\n\t}\n\n\treturn calculateClientHash.call(this, manifest, includeFilter, runtimeConfigOverride);\n};\n\nMeteor.methods({\n\trefreshClients() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'refreshClients'\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'refreshClients',\n\t\t\t\taction: 'Managing_assets'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.Assets.refreshClients();\n\t},\n\n\tunsetAsset(asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'unsetAsset'\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'unsetAsset',\n\t\t\t\taction: 'Managing_assets'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.Assets.unsetAsset(asset);\n\t},\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'setAsset'\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'setAsset',\n\t\t\t\taction: 'Managing_assets'\n\t\t\t});\n\t\t}\n\n\t\tRocketChat.Assets.setAsset(binaryContent, contentType, asset);\n\t}\n});\n\nWebApp.connectHandlers.use('/assets/', Meteor.bindEnvironment(function(req, res, next) {\n\tconst params = {\n\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, '')\n\t};\n\n\tconst file = assets[params.asset] && assets[params.asset].cache;\n\n\tif (!file) {\n\t\tif (assets[params.asset] && assets[params.asset].defaultUrl) {\n\t\t\treq.url = `/${ assets[params.asset].defaultUrl }`;\n\t\t\tWebAppInternals.staticFilesMiddleware(WebAppInternals.staticFiles, req, res, next);\n\t\t} else {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\n\t\treturn;\n\t}\n\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\tif (reqModifiedHeader) {\n\t\tif (reqModifiedHeader === (file.uploadDate && file.uploadDate.toUTCString())) {\n\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\tres.writeHead(304);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n\n\tres.setHeader('Cache-Control', 'public, max-age=0');\n\tres.setHeader('Expires', '-1');\n\tres.setHeader('Last-Modified', (file.uploadDate && file.uploadDate.toUTCString()) || new Date().toUTCString());\n\tres.setHeader('Content-Type', file.contentType);\n\tres.setHeader('Content-Length', file.size);\n\tres.writeHead(200);\n\tres.end(file.content);\n}));\n"]}