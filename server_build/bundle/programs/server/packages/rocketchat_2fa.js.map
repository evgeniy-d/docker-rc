{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:2fa/server/lib/totp.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/checkCodesRemaining.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/disable.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/enable.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/regenerateCodes.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/methods/validateTempToken.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/models/users.js","meteor://ðŸ’»app/packages/rocketchat:2fa/server/loginHandler.js"],"names":["speakeasy","module","watch","require","default","v","RocketChat","TOTP","generateSecret","generateOtpauthURL","secret","username","otpauthURL","ascii","label","verify","token","backupTokens","userId","length","hashedCode","SHA256","usedCode","indexOf","splice","models","Users","update2FABackupCodesByUserId","maxDelta","settings","get","verifiedDelta","totp","verifyDelta","encoding","window","undefined","generateCodes","codes","hashedCodes","i","code","Random","id","push","Meteor","methods","Error","user","services","enabled","remaining","hashedBackup","verified","disable2FAByUserId","disable2FAAndSetTempSecretByUserId","base32","url","userToken","tempSecret","enable2FAAndSetSecretAndCodesByUserId","tempToken","update","_id","$set","backupCodes","$unset","Accounts","registerLoginHandler","options","_runLoginHandlers","login","callbacks","add","type","methodArguments"],"mappings":"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","file":"/packages/rocketchat_2fa.js","sourcesContent":["import speakeasy from 'speakeasy';\n\nRocketChat.TOTP = {\n\tgenerateSecret() {\n\t\treturn speakeasy.generateSecret();\n\t},\n\n\tgenerateOtpauthURL(secret, username) {\n\t\treturn speakeasy.otpauthURL({\n\t\t\tsecret: secret.ascii,\n\t\t\tlabel: `Rocket.Chat:${ username }`\n\t\t});\n\t},\n\n\tverify({ secret, token, backupTokens, userId }) {\n\t\t// validates a backup code\n\t\tif (token.length === 8 && backupTokens) {\n\t\t\tconst hashedCode = SHA256(token);\n\t\t\tconst usedCode = backupTokens.indexOf(hashedCode);\n\n\t\t\tif (usedCode !== -1) {\n\t\t\t\tbackupTokens.splice(usedCode, 1);\n\n\t\t\t\t// mark the code as used (remove it from the list)\n\t\t\t\tRocketChat.models.Users.update2FABackupCodesByUserId(userId, backupTokens);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}\n\n\t\tconst maxDelta = RocketChat.settings.get('Accounts_TwoFactorAuthentication_MaxDelta');\n\t\tif (maxDelta) {\n\t\t\tconst verifiedDelta = speakeasy.totp.verifyDelta({\n\t\t\t\tsecret,\n\t\t\t\tencoding: 'base32',\n\t\t\t\ttoken,\n\t\t\t\twindow: maxDelta\n\t\t\t});\n\n\t\t\treturn verifiedDelta !== undefined;\n\t\t}\n\n\t\treturn speakeasy.totp.verify({\n\t\t\tsecret,\n\t\t\tencoding: 'base32',\n\t\t\ttoken\n\t\t});\n\t},\n\n\tgenerateCodes() {\n\t\t// generate 12 backup codes\n\t\tconst codes = [];\n\t\tconst hashedCodes = [];\n\t\tfor (let i = 0; i < 12; i++) {\n\t\t\tconst code = Random.id(8);\n\t\t\tcodes.push(code);\n\t\t\thashedCodes.push(SHA256(code));\n\t\t}\n\n\t\treturn { codes, hashedCodes };\n\t}\n};\n","Meteor.methods({\n\t'2fa:checkCodesRemaining'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user.services || !user.services.totp || !user.services.totp.enabled) {\n\t\t\tthrow new Meteor.Error('invalid-totp');\n\t\t}\n\n\t\treturn {\n\t\t\tremaining: user.services.totp.hashedBackup.length\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'2fa:disable'(code) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst verified = RocketChat.TOTP.verify({\n\t\t\tsecret: user.services.totp.secret,\n\t\t\ttoken: code,\n\t\t\tuserId: Meteor.userId(),\n\t\t\tbackupTokens: user.services.totp.hashedBackup\n\t\t});\n\n\t\tif (!verified) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn RocketChat.models.Users.disable2FAByUserId(Meteor.userId());\n\t}\n});\n","Meteor.methods({\n\t'2fa:enable'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst secret = RocketChat.TOTP.generateSecret();\n\n\t\tRocketChat.models.Users.disable2FAAndSetTempSecretByUserId(Meteor.userId(), secret.base32);\n\n\t\treturn {\n\t\t\tsecret: secret.base32,\n\t\t\turl: RocketChat.TOTP.generateOtpauthURL(secret, user.username)\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'2fa:regenerateCodes'(userToken) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user.services || !user.services.totp || !user.services.totp.enabled) {\n\t\t\tthrow new Meteor.Error('invalid-totp');\n\t\t}\n\n\t\tconst verified = RocketChat.TOTP.verify({\n\t\t\tsecret: user.services.totp.secret,\n\t\t\ttoken: userToken,\n\t\t\tuserId: Meteor.userId(),\n\t\t\tbackupTokens: user.services.totp.hashedBackup\n\t\t});\n\n\t\tif (verified) {\n\t\t\tconst { codes, hashedCodes } = RocketChat.TOTP.generateCodes();\n\n\t\t\tRocketChat.models.Users.update2FABackupCodesByUserId(Meteor.userId(), hashedCodes);\n\t\t\treturn { codes };\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'2fa:validateTempToken'(userToken) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('not-authorized');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user.services || !user.services.totp || !user.services.totp.tempSecret) {\n\t\t\tthrow new Meteor.Error('invalid-totp');\n\t\t}\n\n\t\tconst verified = RocketChat.TOTP.verify({\n\t\t\tsecret: user.services.totp.tempSecret,\n\t\t\ttoken: userToken\n\t\t});\n\n\t\tif (verified) {\n\t\t\tconst { codes, hashedCodes } = RocketChat.TOTP.generateCodes();\n\n\t\t\tRocketChat.models.Users.enable2FAAndSetSecretAndCodesByUserId(Meteor.userId(), user.services.totp.tempSecret, hashedCodes);\n\t\t\treturn { codes };\n\t\t}\n\t}\n});\n","RocketChat.models.Users.disable2FAAndSetTempSecretByUserId = function(userId, tempToken) {\n\treturn this.update({\n\t\t_id: userId\n\t}, {\n\t\t$set: {\n\t\t\t'services.totp': {\n\t\t\t\tenabled: false,\n\t\t\t\ttempSecret: tempToken\n\t\t\t}\n\t\t}\n\t});\n};\n\nRocketChat.models.Users.enable2FAAndSetSecretAndCodesByUserId = function(userId, secret, backupCodes) {\n\treturn this.update({\n\t\t_id: userId\n\t}, {\n\t\t$set: {\n\t\t\t'services.totp.enabled': true,\n\t\t\t'services.totp.secret': secret,\n\t\t\t'services.totp.hashedBackup': backupCodes\n\t\t},\n\t\t$unset: {\n\t\t\t'services.totp.tempSecret': 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Users.disable2FAByUserId = function(userId) {\n\treturn this.update({\n\t\t_id: userId\n\t}, {\n\t\t$set: {\n\t\t\t'services.totp': {\n\t\t\t\tenabled: false\n\t\t\t}\n\t\t}\n\t});\n};\n\nRocketChat.models.Users.update2FABackupCodesByUserId = function(userId, backupCodes) {\n\treturn this.update({\n\t\t_id: userId\n\t}, {\n\t\t$set: {\n\t\t\t'services.totp.hashedBackup': backupCodes\n\t\t}\n\t});\n};\n","Accounts.registerLoginHandler('totp', function(options) {\n\tif (!options.totp || !options.totp.code) {\n\t\treturn;\n\t}\n\n\treturn Accounts._runLoginHandlers(this, options.totp.login);\n});\n\nRocketChat.callbacks.add('onValidateLogin', (login) => {\n\tif (login.type === 'password' && login.user.services && login.user.services.totp && login.user.services.totp.enabled === true) {\n\t\tconst { totp } = login.methodArguments[0];\n\n\t\tif (!totp || !totp.code) {\n\t\t\tthrow new Meteor.Error('totp-required', 'TOTP Required');\n\t\t}\n\n\t\tconst verified = RocketChat.TOTP.verify({\n\t\t\tsecret: login.user.services.totp.secret,\n\t\t\ttoken: totp.code,\n\t\t\tuserId: login.user._id,\n\t\t\tbackupTokens: login.user.services.totp.hashedBackup\n\t\t});\n\n\t\tif (verified !== true) {\n\t\t\tthrow new Meteor.Error('totp-invalid', 'TOTP Invalid');\n\t\t}\n\t}\n});\n"]}