{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:authorization/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Permissions.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Roles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Base.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/models/Subscriptions.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/addUserRoles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/canAccessRoom.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/getRoles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/getUsersInRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/hasPermission.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/hasRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/functions/removeUserFromRoles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/publications/permissions.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/publications/roles.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/publications/usersInRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/addUserToRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/deleteRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/removeUserFromRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/saveRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/addPermissionToRole.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/methods/removeRoleFromPermission.js","meteor://ðŸ’»app/packages/rocketchat:authorization/server/startup.js"],"names":["RocketChat","authz","ModelPermissions","models","_Base","constructor","arguments","findByRole","role","options","query","roles","find","findOneById","_id","findOne","createOrUpdate","name","upsert","$set","addRole","permission","update","$addToSet","removeRole","$pull","Permissions","ModelRoles","tryEnsureIndex","findUsersInRole","scope","roleScope","model","findUsersInRoles","isUserInRoles","userId","concat","some","roleName","isUserInRole","description","protectedRole","updateData","protected","addUserRoles","addRolesByUserId","removeUserRoles","removeRolesByUserId","Roles","_","module","watch","require","default","v","prototype","roleBaseQuery","findRolesByUserId","fields","isUndefined","$each","$pullAll","Meteor","Error","Users","$in","Subscriptions","rid","subscriptions","fetch","users","compact","map","subscription","u","roleNames","user","db","function","existingRoleNames","pluck","getRoles","invalidRoleNames","difference","isEmpty","roomAccessValidators","room","t","settings","get","hasPermission","findOneByRoomIdAndUserId","Rooms","canAccessRoom","extraData","validator","call","addRoomAccessValidator","push","getUsersInRole","atLeastOne","permissions","permissionId","all","every","strategy","hasAllPermission","hasAtLeastOnePermission","hasRole","removeUserFromRoles","methods","updatedAt","unblock","records","Date","filter","record","_updatedAt","remove","trashFindDeletedAfter","_deletedAt","on","clientAction","id","data","Notifications","notifyLoggedInThisInstance","publish","ready","limit","error","sort","username","method","action","isString","findOneByUsername","add","notifyLogged","type","existingUsers","count","adminCount","userIsAdmin","indexOf","roleData","includes","startup","defaultRoles","$setOnInsert"],"mappings":"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","file":"/packages/rocketchat_authorization.js","sourcesContent":["RocketChat.authz = {};\n","class ModelPermissions extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper(...arguments);\n\t}\n\n\t// FIND\n\tfindByRole(role, options) {\n\t\tconst query = {\n\t\t\troles: role\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindOneById(_id) {\n\t\treturn this.findOne(_id);\n\t}\n\n\tcreateOrUpdate(name, roles) {\n\t\tthis.upsert({ _id: name }, { $set: { roles } });\n\t}\n\n\taddRole(permission, role) {\n\t\tthis.update({ _id: permission }, { $addToSet: { roles: role } });\n\t}\n\n\tremoveRole(permission, role) {\n\t\tthis.update({ _id: permission }, { $pull: { roles: role } });\n\t}\n}\n\nRocketChat.models.Permissions = new ModelPermissions('permissions');\n","class ModelRoles extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper(...arguments);\n\t\tthis.tryEnsureIndex({ 'name': 1 });\n\t\tthis.tryEnsureIndex({ 'scope': 1 });\n\t}\n\n\tfindUsersInRole(name, scope, options) {\n\t\tconst role = this.findOne(name);\n\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\tconst model = RocketChat.models[roleScope];\n\n\t\treturn model && model.findUsersInRoles && model.findUsersInRoles(name, scope, options);\n\t}\n\n\tisUserInRoles(userId, roles, scope) {\n\t\troles = [].concat(roles);\n\t\treturn roles.some((roleName) => {\n\t\t\tconst role = this.findOne(roleName);\n\t\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\t\tconst model = RocketChat.models[roleScope];\n\n\t\t\treturn model && model.isUserInRole && model.isUserInRole(userId, roleName, scope);\n\t\t});\n\t}\n\n\tcreateOrUpdate(name, scope = 'Users', description, protectedRole) {\n\t\tconst updateData = {};\n\t\tupdateData.name = name;\n\t\tupdateData.scope = scope;\n\n\t\tif (description != null) {\n\t\t\tupdateData.description = description;\n\t\t}\n\n\t\tif (protectedRole) {\n\t\t\tupdateData.protected = protectedRole;\n\t\t}\n\n\t\tthis.upsert({ _id: name }, { $set: updateData });\n\t}\n\n\taddUserRoles(userId, roles, scope) {\n\t\troles = [].concat(roles);\n\t\tfor (const roleName of roles) {\n\t\t\tconst role = this.findOne(roleName);\n\t\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\t\tconst model = RocketChat.models[roleScope];\n\n\t\t\tmodel && model.addRolesByUserId && model.addRolesByUserId(userId, roleName, scope);\n\t\t}\n\t\treturn true;\n\t}\n\n\tremoveUserRoles(userId, roles, scope) {\n\t\troles = [].concat(roles);\n\t\tfor (const roleName of roles) {\n\t\t\tconst role = this.findOne(roleName);\n\t\t\tconst roleScope = (role && role.scope) || 'Users';\n\t\t\tconst model = RocketChat.models[roleScope];\n\n\t\t\tmodel && model.removeRolesByUserId && model.removeRolesByUserId(userId, roleName, scope);\n\t\t}\n\t\treturn true;\n\t}\n}\n\nRocketChat.models.Roles = new ModelRoles('roles');\n","import _ from 'underscore';\n\nRocketChat.models._Base.prototype.roleBaseQuery = function(/*userId, scope*/) {\n\treturn;\n};\n\nRocketChat.models._Base.prototype.findRolesByUserId = function(userId/*, options*/) {\n\tconst query = this.roleBaseQuery(userId);\n\treturn this.find(query, { fields: { roles: 1 } });\n};\n\nRocketChat.models._Base.prototype.isUserInRole = function(userId, roleName, scope) {\n\tconst query = this.roleBaseQuery(userId, scope);\n\n\tif (query == null) {\n\t\treturn false;\n\t}\n\n\tquery.roles = roleName;\n\treturn !_.isUndefined(this.findOne(query, {fields: {roles: 1}}));\n};\n\nRocketChat.models._Base.prototype.addRolesByUserId = function(userId, roles, scope) {\n\troles = [].concat(roles);\n\tconst query = this.roleBaseQuery(userId, scope);\n\tconst update = {\n\t\t$addToSet: {\n\t\t\troles: { $each: roles }\n\t\t}\n\t};\n\treturn this.update(query, update);\n};\n\nRocketChat.models._Base.prototype.removeRolesByUserId = function(userId, roles, scope) {\n\troles = [].concat(roles);\n\tconst query = this.roleBaseQuery(userId, scope);\n\tconst update = {\n\t\t$pullAll: {\n\t\t\troles\n\t\t}\n\t};\n\treturn this.update(query, update);\n};\n\nRocketChat.models._Base.prototype.findUsersInRoles = function() {\n\tthrow new Meteor.Error('overwrite-function', 'You must overwrite this function in the extended classes');\n};\n","RocketChat.models.Users.roleBaseQuery = function(userId) {\n\treturn { _id: userId };\n};\n\nRocketChat.models.Users.findUsersInRoles = function(roles, scope, options) {\n\troles = [].concat(roles);\n\n\tconst query = {\n\t\troles: { $in: roles }\n\t};\n\n\treturn this.find(query, options);\n};\n","import _ from 'underscore';\n\nRocketChat.models.Subscriptions.roleBaseQuery = function(userId, scope) {\n\tif (scope == null) {\n\t\treturn;\n\t}\n\n\tconst query = { 'u._id': userId };\n\tif (!_.isUndefined(scope)) {\n\t\tquery.rid = scope;\n\t}\n\treturn query;\n};\n\nRocketChat.models.Subscriptions.findUsersInRoles = function(roles, scope, options) {\n\troles = [].concat(roles);\n\n\tconst query = {\n\t\troles: { $in: roles }\n\t};\n\n\tif (scope) {\n\t\tquery.rid = scope;\n\t}\n\n\tconst subscriptions = this.find(query).fetch();\n\n\tconst users = _.compact(_.map(subscriptions, function(subscription) {\n\t\tif ('undefined' !== typeof subscription.u && 'undefined' !== typeof subscription.u._id) {\n\t\t\treturn subscription.u._id;\n\t\t}\n\t}));\n\n\treturn RocketChat.models.Users.find({ _id: { $in: users } }, options);\n};\n","import _ from 'underscore';\n\nRocketChat.authz.addUserRoles = function(userId, roleNames, scope) {\n\tif (!userId || !roleNames) {\n\t\treturn false;\n\t}\n\n\tconst user = RocketChat.models.Users.db.findOneById(userId);\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\tfunction: 'RocketChat.authz.addUserRoles'\n\t\t});\n\t}\n\n\troleNames = [].concat(roleNames);\n\tconst existingRoleNames = _.pluck(RocketChat.authz.getRoles(), '_id');\n\tconst invalidRoleNames = _.difference(roleNames, existingRoleNames);\n\n\tif (!_.isEmpty(invalidRoleNames)) {\n\t\tfor (const role of invalidRoleNames) {\n\t\t\tRocketChat.models.Roles.createOrUpdate(role);\n\t\t}\n\t}\n\n\tRocketChat.models.Roles.addUserRoles(userId, roleNames, scope);\n\n\treturn true;\n};\n","/* globals RocketChat */\nRocketChat.authz.roomAccessValidators = [\n\tfunction(room, user = {}) {\n\t\tif (room && room.t === 'c') {\n\t\t\tif (!user._id && RocketChat.settings.get('Accounts_AllowAnonymousRead') === true) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\treturn RocketChat.authz.hasPermission(user._id, 'view-c-room');\n\t\t}\n\t},\n\tfunction(room, user = {}) {\n\t\tif (!room || !user) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, user._id);\n\t\tif (subscription) {\n\t\t\treturn RocketChat.models.Rooms.findOneById(subscription.rid);\n\t\t}\n\t}\n];\n\nRocketChat.authz.canAccessRoom = function(room, user, extraData) {\n\treturn RocketChat.authz.roomAccessValidators.some((validator) => {\n\t\treturn validator.call(this, room, user, extraData);\n\t});\n};\n\nRocketChat.authz.addRoomAccessValidator = function(validator) {\n\tRocketChat.authz.roomAccessValidators.push(validator);\n};\n","RocketChat.authz.getRoles = function() {\n\treturn RocketChat.models.Roles.find().fetch();\n};\n","RocketChat.authz.getUsersInRole = function(roleName, scope, options) {\n\treturn RocketChat.models.Roles.findUsersInRole(roleName, scope, options);\n};\n","function atLeastOne(userId, permissions = [], scope) {\n\treturn permissions.some((permissionId) => {\n\t\tconst permission = RocketChat.models.Permissions.findOne(permissionId);\n\t\treturn RocketChat.models.Roles.isUserInRoles(userId, permission.roles, scope);\n\t});\n}\n\nfunction all(userId, permissions = [], scope) {\n\treturn permissions.every((permissionId) => {\n\t\tconst permission = RocketChat.models.Permissions.findOne(permissionId);\n\t\treturn RocketChat.models.Roles.isUserInRoles(userId, permission.roles, scope);\n\t});\n}\n\nfunction hasPermission(userId, permissions, scope, strategy) {\n\tif (!userId) {\n\t\treturn false;\n\t}\n\n\tpermissions = [].concat(permissions);\n\treturn strategy(userId, permissions, scope);\n}\n\nRocketChat.authz.hasAllPermission = function(userId, permissions, scope) {\n\treturn hasPermission(userId, permissions, scope, all);\n};\n\nRocketChat.authz.hasPermission = RocketChat.authz.hasAllPermission;\n\nRocketChat.authz.hasAtLeastOnePermission = function(userId, permissions, scope) {\n\treturn hasPermission(userId, permissions, scope, atLeastOne);\n};\n","RocketChat.authz.hasRole = function(userId, roleNames, scope) {\n\troleNames = [].concat(roleNames);\n\treturn RocketChat.models.Roles.isUserInRoles(userId, roleNames, scope);\n};\n","import _ from 'underscore';\n\nRocketChat.authz.removeUserFromRoles = function(userId, roleNames, scope) {\n\tif (!userId || !roleNames) {\n\t\treturn false;\n\t}\n\n\tconst user = RocketChat.models.Users.findOneById(userId);\n\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\tfunction: 'RocketChat.authz.removeUserFromRoles'\n\t\t});\n\t}\n\n\troleNames = [].concat(roleNames);\n\tconst existingRoleNames = _.pluck(RocketChat.authz.getRoles(), '_id');\n\tconst invalidRoleNames = _.difference(roleNames, existingRoleNames);\n\n\tif (!_.isEmpty(invalidRoleNames)) {\n\t\tthrow new Meteor.Error('error-invalid-role', 'Invalid role', {\n\t\t\tfunction: 'RocketChat.authz.removeUserFromRoles'\n\t\t});\n\t}\n\n\tRocketChat.models.Roles.removeUserRoles(userId, roleNames, scope);\n\n\treturn true;\n};\n","Meteor.methods({\n\t'permissions/get'(updatedAt) {\n\t\tthis.unblock();\n\t\t// TODO: should we return this for non logged users?\n\t\t// TODO: we could cache this collection\n\n\t\tconst records = RocketChat.models.Permissions.find().fetch();\n\n\t\tif (updatedAt instanceof Date) {\n\t\t\treturn {\n\t\t\t\tupdate: records.filter((record) => {\n\t\t\t\t\treturn record._updatedAt > updatedAt;\n\t\t\t\t}),\n\t\t\t\tremove: RocketChat.models.Permissions.trashFindDeletedAfter(updatedAt, {}, {fields: {_id: 1, _deletedAt: 1}}).fetch()\n\t\t\t};\n\t\t}\n\n\t\treturn records;\n\t}\n});\n\nRocketChat.models.Permissions.on('change', ({clientAction, id, data}) => {\n\tswitch (clientAction) {\n\t\tcase 'updated':\n\t\tcase 'inserted':\n\t\t\tdata = data || RocketChat.models.Permissions.findOneById(id);\n\t\t\tbreak;\n\n\t\tcase 'removed':\n\t\t\tdata = { _id: id };\n\t\t\tbreak;\n\t}\n\n\tRocketChat.Notifications.notifyLoggedInThisInstance('permissions-changed', clientAction, data);\n});\n","Meteor.publish('roles', function() {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\treturn RocketChat.models.Roles.find();\n});\n","Meteor.publish('usersInRole', function(roleName, scope, limit = 50) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'access-permissions')) {\n\t\treturn this.error(new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\tpublish: 'usersInRole'\n\t\t}));\n\t}\n\n\tconst options = {\n\t\tlimit,\n\t\tsort: {\n\t\t\tname: 1\n\t\t}\n\t};\n\n\treturn RocketChat.authz.getUsersInRole(roleName, scope, options);\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'authorization:addUserToRole'(roleName, username, scope) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:addUserToRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tif (!roleName || !_.isString(roleName) || !username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {\n\t\t\t\tmethod: 'authorization:addUserToRole'\n\t\t\t});\n\t\t}\n\n\t\tif (roleName === 'admin' && !RocketChat.authz.hasPermission(Meteor.userId(), 'assign-admin-role')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Assigning admin is not allowed', {\n\t\t\t\tmethod: 'authorization:addUserToRole',\n\t\t\t\taction: 'Assign_admin'\n\t\t\t});\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, {\n\t\t\tfields: {\n\t\t\t\t_id: 1\n\t\t\t}\n\t\t});\n\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'authorization:addUserToRole'\n\t\t\t});\n\t\t}\n\n\t\tconst add = RocketChat.models.Roles.addUserRoles(user._id, roleName, scope);\n\n\t\tif (RocketChat.settings.get('UI_DisplayRoles')) {\n\t\t\tRocketChat.Notifications.notifyLogged('roles-change', {\n\t\t\t\ttype: 'added',\n\t\t\t\t_id: roleName,\n\t\t\t\tu: {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername\n\t\t\t\t},\n\t\t\t\tscope\n\t\t\t});\n\t\t}\n\n\t\treturn add;\n\t}\n});\n","Meteor.methods({\n\t'authorization:deleteRole'(roleName) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:deleteRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tconst role = RocketChat.models.Roles.findOne(roleName);\n\t\tif (!role) {\n\t\t\tthrow new Meteor.Error('error-invalid-role', 'Invalid role', {\n\t\t\t\tmethod: 'authorization:deleteRole'\n\t\t\t});\n\t\t}\n\n\t\tif (role.protected) {\n\t\t\tthrow new Meteor.Error('error-delete-protected-role', 'Cannot delete a protected role', {\n\t\t\t\tmethod: 'authorization:deleteRole'\n\t\t\t});\n\t\t}\n\n\t\tconst roleScope = role.scope || 'Users';\n\t\tconst model = RocketChat.models[roleScope];\n\t\tconst existingUsers = model && model.findUsersInRoles && model.findUsersInRoles(roleName);\n\n\t\tif (existingUsers && existingUsers.count() > 0) {\n\t\t\tthrow new Meteor.Error('error-role-in-use', 'Cannot delete role because it\\'s in use', {\n\t\t\t\tmethod: 'authorization:deleteRole'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.models.Roles.remove(role.name);\n\t}\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'authorization:removeUserFromRole'(roleName, username, scope) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Access permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:removeUserFromRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tif (!roleName || !_.isString(roleName) || !username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {\n\t\t\t\tmethod: 'authorization:removeUserFromRole'\n\t\t\t});\n\t\t}\n\n\t\tconst user = Meteor.users.findOne({\n\t\t\tusername\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\t_id: 1,\n\t\t\t\troles: 1\n\t\t\t}\n\t\t});\n\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'authorization:removeUserFromRole'\n\t\t\t});\n\t\t}\n\n\t\t// prevent removing last user from admin role\n\t\tif (roleName === 'admin') {\n\t\t\tconst adminCount = Meteor.users.find({\n\t\t\t\troles: {\n\t\t\t\t\t$in: ['admin']\n\t\t\t\t}\n\t\t\t}).count();\n\n\t\t\tconst userIsAdmin = user.roles.indexOf('admin') > -1;\n\t\t\tif (adminCount === 1 && userIsAdmin) {\n\t\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Leaving the app without admins is not allowed', {\n\t\t\t\t\tmethod: 'removeUserFromRole',\n\t\t\t\t\taction: 'Remove_last_admin'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tconst remove = RocketChat.models.Roles.removeUserRoles(user._id, roleName, scope);\n\t\tif (RocketChat.settings.get('UI_DisplayRoles')) {\n\t\t\tRocketChat.Notifications.notifyLogged('roles-change', {\n\t\t\t\ttype: 'removed',\n\t\t\t\t_id: roleName,\n\t\t\t\tu: {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername\n\t\t\t\t},\n\t\t\t\tscope\n\t\t\t});\n\t\t}\n\n\t\treturn remove;\n\t}\n});\n","Meteor.methods({\n\t'authorization:saveRole'(roleData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:saveRole',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\tif (!roleData.name) {\n\t\t\tthrow new Meteor.Error('error-role-name-required', 'Role name is required', {\n\t\t\t\tmethod: 'authorization:saveRole'\n\t\t\t});\n\t\t}\n\n\t\tif (['Users', 'Subscriptions'].includes(roleData.scope) === false) {\n\t\t\troleData.scope = 'Users';\n\t\t}\n\n\t\tconst update = RocketChat.models.Roles.createOrUpdate(roleData.name, roleData.scope, roleData.description);\n\t\tif (RocketChat.settings.get('UI_DisplayRoles')) {\n\t\t\tRocketChat.Notifications.notifyLogged('roles-change', {\n\t\t\t\ttype: 'changed',\n\t\t\t\t_id: roleData.name\n\t\t\t});\n\t\t}\n\n\t\treturn update;\n\t}\n});\n","Meteor.methods({\n\t'authorization:addPermissionToRole'(permission, role) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Adding permission is not allowed', {\n\t\t\t\tmethod: 'authorization:addPermissionToRole',\n\t\t\t\taction: 'Adding_permission'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.models.Permissions.addRole(permission, role);\n\t}\n});\n","Meteor.methods({\n\t'authorization:removeRoleFromPermission'(permission, role) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'access-permissions')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Accessing permissions is not allowed', {\n\t\t\t\tmethod: 'authorization:removeRoleFromPermission',\n\t\t\t\taction: 'Accessing_permissions'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.models.Permissions.removeRole(permission, role);\n\t}\n});\n","/* eslint no-multi-spaces: 0 */\n\nMeteor.startup(function() {\n\t// Note:\n\t// 1.if we need to create a role that can only edit channel message, but not edit group message\n\t// then we can define edit-<type>-message instead of edit-message\n\t// 2. admin, moderator, and user roles should not be deleted as they are referened in the code.\n\tconst permissions = [\n\t\t{ _id: 'access-permissions',            roles : ['admin'] },\n\t\t{ _id: 'add-oauth-service',             roles : ['admin'] },\n\t\t{ _id: 'add-user-to-joined-room',       roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'add-user-to-any-c-room',        roles : ['admin'] },\n\t\t{ _id: 'add-user-to-any-p-room',        roles : [] },\n\t\t{ _id: 'archive-room',                  roles : ['admin', 'owner'] },\n\t\t{ _id: 'assign-admin-role',             roles : ['admin'] },\n\t\t{ _id: 'ban-user',                      roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'bulk-create-c',                 roles : ['admin'] },\n\t\t{ _id: 'bulk-register-user',            roles : ['admin'] },\n\t\t{ _id: 'create-c',                      roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'create-d',                      roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'create-p',                      roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'create-user',                   roles : ['admin'] },\n\t\t{ _id: 'clean-channel-history',         roles : ['admin'] }, // special permission to bulk delete a channel's mesages\n\t\t{ _id: 'delete-c',                      roles : ['admin', 'owner'] },\n\t\t{ _id: 'delete-d',                      roles : ['admin'] },\n\t\t{ _id: 'delete-message',                roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'delete-p',                      roles : ['admin', 'owner'] },\n\t\t{ _id: 'delete-user',                   roles : ['admin'] },\n\t\t{ _id: 'edit-message',                  roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'edit-other-user-active-status', roles : ['admin'] },\n\t\t{ _id: 'edit-other-user-info',          roles : ['admin'] },\n\t\t{ _id: 'edit-other-user-password',      roles : ['admin'] },\n\t\t{ _id: 'edit-privileged-setting',       roles : ['admin'] },\n\t\t{ _id: 'edit-room',                     roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'force-delete-message',          roles : ['admin', 'owner'] },\n\t\t{ _id: 'join-without-join-code',        roles : ['admin', 'bot'] },\n\t\t{ _id: 'leave-c',                       roles : ['admin', 'user', 'bot', 'anonymous'] },\n\t\t{ _id: 'leave-p',                       roles : ['admin', 'user', 'bot', 'anonymous'] },\n\t\t{ _id: 'manage-assets',                 roles : ['admin'] },\n\t\t{ _id: 'manage-emoji',                  roles : ['admin'] },\n\t\t{ _id: 'manage-integrations',           roles : ['admin'] },\n\t\t{ _id: 'manage-own-integrations',       roles : ['admin', 'bot'] },\n\t\t{ _id: 'manage-oauth-apps',             roles : ['admin'] },\n\t\t{ _id: 'mention-all',                   roles : ['admin', 'owner', 'moderator', 'user'] },\n\t\t{ _id: 'mention-here',                  roles : ['admin', 'owner', 'moderator', 'user'] },\n\t\t{ _id: 'mute-user',                     roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'remove-user',                   roles : ['admin', 'owner', 'moderator'] },\n\t\t{ _id: 'run-import',                    roles : ['admin'] },\n\t\t{ _id: 'run-migration',                 roles : ['admin'] },\n\t\t{ _id: 'set-moderator',                 roles : ['admin', 'owner'] },\n\t\t{ _id: 'set-owner',                     roles : ['admin', 'owner'] },\n\t\t{ _id: 'send-many-messages',            roles : ['admin', 'bot'] },\n\t\t{ _id: 'set-leader',                    roles : ['admin', 'owner'] },\n\t\t{ _id: 'unarchive-room',                roles : ['admin'] },\n\t\t{ _id: 'view-c-room',                   roles : ['admin', 'user', 'bot', 'anonymous'] },\n\t\t{ _id: 'user-generate-access-token',    roles : ['admin'] },\n\t\t{ _id: 'view-d-room',                   roles : ['admin', 'user', 'bot'] },\n\t\t{ _id: 'view-full-other-user-info',     roles : ['admin'] },\n\t\t{ _id: 'view-history',                  roles : ['admin', 'user', 'anonymous'] },\n\t\t{ _id: 'view-joined-room',              roles : ['guest', 'bot', 'anonymous'] },\n\t\t{ _id: 'view-join-code',                roles : ['admin'] },\n\t\t{ _id: 'view-logs',                     roles : ['admin'] },\n\t\t{ _id: 'view-other-user-channels',      roles : ['admin'] },\n\t\t{ _id: 'view-p-room',                   roles : ['admin', 'user', 'anonymous'] },\n\t\t{ _id: 'view-privileged-setting',       roles : ['admin'] },\n\t\t{ _id: 'view-room-administration',      roles : ['admin'] },\n\t\t{ _id: 'view-statistics',               roles : ['admin'] },\n\t\t{ _id: 'view-user-administration',      roles : ['admin'] },\n\t\t{ _id: 'preview-c-room',                roles : ['admin', 'user', 'anonymous'] },\n\t\t{ _id: 'view-outside-room',             roles : ['admin', 'owner', 'moderator', 'user'] },\n\t\t{ _id: 'view-broadcast-member-list',    roles : ['admin', 'owner', 'moderator'] }\n\t];\n\n\tfor (const permission of permissions) {\n\t\tif (!RocketChat.models.Permissions.findOneById(permission._id)) {\n\t\t\tRocketChat.models.Permissions.upsert(permission._id, {$set: permission });\n\t\t}\n\t}\n\n\tconst defaultRoles = [\n\t\t{ name: 'admin',     scope: 'Users',         description: 'Admin' },\n\t\t{ name: 'moderator', scope: 'Subscriptions', description: 'Moderator' },\n\t\t{ name: 'leader',    scope: 'Subscriptions', description: 'Leader' },\n\t\t{ name: 'owner',     scope: 'Subscriptions', description: 'Owner' },\n\t\t{ name: 'user',      scope: 'Users',         description: '' },\n\t\t{ name: 'bot',       scope: 'Users',         description: '' },\n\t\t{ name: 'guest',     scope: 'Users',         description: '' },\n\t\t{ name: 'anonymous', scope: 'Users',         description: '' }\n\t];\n\n\tfor (const role of defaultRoles) {\n\t\tRocketChat.models.Roles.upsert({ _id: role.name }, { $setOnInsert: { scope: role.scope, description: role.description || '', protected: true } });\n\t}\n});\n"]}