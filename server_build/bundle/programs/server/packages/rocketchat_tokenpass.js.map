{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:tokenpass/common.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/functions/getProtectedTokenpassBalances.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/functions/getPublicTokenpassBalances.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/functions/saveRoomTokens.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/functions/saveRoomTokensMinimumBalance.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/functions/updateUserTokenpassBalances.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/models/indexes.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/models/Subscriptions.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/methods/findTokenChannels.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/methods/getChannelTokenpass.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/cronRemoveUsers.js","meteor://ðŸ’»app/packages/rocketchat:tokenpass/server/Tokenpass.js"],"names":["config","serverURL","identityPath","authorizePath","tokenPath","scope","tokenSentVia","usernameField","mergeUsers","addAutopublishFields","forLoggedInUser","forOtherUsers","Tokenpass","CustomOAuth","Meteor","isServer","startup","RocketChat","settings","get","key","value","configure","Tracker","autorun","addGroup","section","enableQuery","_id","add","type","public","i18nDescription","readonly","force","validateTokenAccess","userData","roomData","services","tokenpass","tcaBalances","validateAccess","authz","addRoomAccessValidator","room","user","models","Users","getTokenBalancesByUserId","callbacks","Error","method","Accounts","onLogin","updateUserTokenpassBalances","userAgent","release","getProtectedTokenpassBalances","accessToken","HTTP","headers","Accept","params","oauth_token","data","error","message","getPublicTokenpassBalances","saveRoomTokenpass","rid","Match","test","String","Rooms","setTokenpassById","s","module","watch","require","default","v","saveRoomTokensMinimumBalance","roomTokensMinimumBalance","minimumTokenBalance","parseFloat","escapeHTML","setMinimumTokenBalanceById","_","tcaPublicBalances","tcaProtectedBalances","balances","uniq","union","item","asset","setTokenpassTcaBalances","tryEnsureIndex","findByTokenpass","tokens","query","$in","_db","find","fetch","setTokensById","update","$set","findAllTokenChannels","$exists","options","fields","Subscriptions","findByRoomIds","roomIds","userId","findOne","methods","findTokenChannels","forEach","token","Object","keys","filter","getChannelTokenpass","check","findOneById","removeUsersFromTokenChannels","rooms","users","sub","u","push","userInfo","roomId","valid","removeUserFromRoom","defer","SyncedCron","name","schedule","parser","cron","job","compFunc","some","userToken","balance"],"mappings":"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","file":"/packages/rocketchat_tokenpass.js","sourcesContent":["/* global CustomOAuth */\n\nconst config = {\n\tserverURL: '',\n\tidentityPath: '/oauth/user',\n\tauthorizePath: '/oauth/authorize',\n\ttokenPath: '/oauth/access-token',\n\tscope: 'user,tca,private-balances',\n\ttokenSentVia: 'payload',\n\tusernameField: 'username',\n\tmergeUsers: true,\n\taddAutopublishFields: {\n\t\tforLoggedInUser: ['services.tokenpass'],\n\t\tforOtherUsers: ['services.tokenpass.name']\n\t}\n};\n\nconst Tokenpass = new CustomOAuth('tokenpass', config);\n\nif (Meteor.isServer) {\n\tMeteor.startup(function() {\n\t\tRocketChat.settings.get('API_Tokenpass_URL', function(key, value) {\n\t\t\tconfig.serverURL = value;\n\t\t\tTokenpass.configure(config);\n\t\t});\n\t});\n} else {\n\tMeteor.startup(function() {\n\t\tTracker.autorun(function() {\n\t\t\tif (RocketChat.settings.get('API_Tokenpass_URL')) {\n\t\t\t\tconfig.serverURL = RocketChat.settings.get('API_Tokenpass_URL');\n\t\t\t\tTokenpass.configure(config);\n\t\t\t}\n\t\t});\n\t});\n}\n","RocketChat.settings.addGroup('OAuth', function() {\n\tthis.section('Tokenpass', function() {\n\t\tconst enableQuery = {\n\t\t\t_id: 'Accounts_OAuth_Tokenpass',\n\t\t\tvalue: true\n\t\t};\n\n\t\tthis.add('Accounts_OAuth_Tokenpass', false, { type: 'boolean' });\n\t\tthis.add('API_Tokenpass_URL', '', { type: 'string', public: true, enableQuery, i18nDescription: 'API_Tokenpass_URL_Description' });\n\t\tthis.add('Accounts_OAuth_Tokenpass_id', '', { type: 'string', enableQuery });\n\t\tthis.add('Accounts_OAuth_Tokenpass_secret', '', { type: 'string', enableQuery });\n\t\tthis.add('Accounts_OAuth_Tokenpass_callback_url', '_oauth/tokenpass', { type: 'relativeUrl', readonly: true, force: true, enableQuery });\n\t});\n});\n\nfunction validateTokenAccess(userData, roomData) {\n\tif (!userData || !userData.services || !userData.services.tokenpass || !userData.services.tokenpass.tcaBalances) {\n\t\treturn false;\n\t}\n\n\treturn RocketChat.Tokenpass.validateAccess(roomData.tokenpass, userData.services.tokenpass.tcaBalances);\n}\n\nMeteor.startup(function() {\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\tif (!room || !room.tokenpass || !user) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst userData = RocketChat.models.Users.getTokenBalancesByUserId(user._id);\n\n\t\treturn validateTokenAccess(userData, room);\n\t});\n\n\tRocketChat.callbacks.add('beforeJoinRoom', function(user, room) {\n\t\tif (room.tokenpass && !validateTokenAccess(user, room)) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Token required', { method: 'joinRoom' });\n\t\t}\n\n\t\treturn room;\n\t});\n});\n\nAccounts.onLogin(function({ user }) {\n\tif (user && user.services && user.services.tokenpass) {\n\t\tRocketChat.updateUserTokenpassBalances(user);\n\t}\n});\n","let userAgent = 'Meteor';\nif (Meteor.release) { userAgent += `/${ Meteor.release }`; }\n\nRocketChat.getProtectedTokenpassBalances = function(accessToken) {\n\ttry {\n\t\treturn HTTP.get(\n\t\t\t`${ RocketChat.settings.get('API_Tokenpass_URL') }/api/v1/tca/protected/balances`, {\n\t\t\t\theaders: {\n\t\t\t\t\tAccept: 'application/json',\n\t\t\t\t\t'User-Agent': userAgent\n\t\t\t\t},\n\t\t\t\tparams: {\n\t\t\t\t\toauth_token: accessToken\n\t\t\t\t}\n\t\t\t}).data;\n\t} catch (error) {\n\t\tthrow new Error(`Failed to fetch protected tokenpass balances from Tokenpass. ${ error.message }`);\n\t}\n};\n","let userAgent = 'Meteor';\nif (Meteor.release) { userAgent += `/${ Meteor.release }`; }\n\nRocketChat.getPublicTokenpassBalances = function(accessToken) {\n\ttry {\n\t\treturn HTTP.get(\n\t\t\t`${ RocketChat.settings.get('API_Tokenpass_URL') }/api/v1/tca/public/balances`, {\n\t\t\t\theaders: {\n\t\t\t\t\tAccept: 'application/json',\n\t\t\t\t\t'User-Agent': userAgent\n\t\t\t\t},\n\t\t\t\tparams: {\n\t\t\t\t\toauth_token: accessToken\n\t\t\t\t}\n\t\t\t}).data;\n\t} catch (error) {\n\t\tthrow new Error(`Failed to fetch public tokenpass balances from Tokenpass. ${ error.message }`);\n\t}\n};\n","RocketChat.saveRoomTokenpass = function(rid, tokenpass) {\n\tif (!Match.test(rid, String)) {\n\t\tthrow new Meteor.Error('invalid-room', 'Invalid room', {\n\t\t\t'function': 'RocketChat.saveRoomTokens'\n\t\t});\n\t}\n\n\treturn RocketChat.models.Rooms.setTokenpassById(rid, tokenpass);\n};\n","import s from 'underscore.string';\n\nRocketChat.saveRoomTokensMinimumBalance = function(rid, roomTokensMinimumBalance) {\n\tif (!Match.test(rid, String)) {\n\t\tthrow new Meteor.Error('invalid-room', 'Invalid room', {\n\t\t\t'function': 'RocketChat.saveRoomTokensMinimumBalance'\n\t\t});\n\t}\n\n\tconst minimumTokenBalance = parseFloat(s.escapeHTML(roomTokensMinimumBalance));\n\n\treturn RocketChat.models.Rooms.setMinimumTokenBalanceById(rid, minimumTokenBalance);\n};\n","import _ from 'underscore';\n\nRocketChat.updateUserTokenpassBalances = function(user) {\n\tif (user && user.services && user.services.tokenpass) {\n\t\tconst tcaPublicBalances = RocketChat.getPublicTokenpassBalances(user.services.tokenpass.accessToken);\n\t\tconst tcaProtectedBalances = RocketChat.getProtectedTokenpassBalances(user.services.tokenpass.accessToken);\n\n\t\tconst balances = _.uniq(_.union(tcaPublicBalances, tcaProtectedBalances), false, item => item.asset);\n\n\t\tRocketChat.models.Users.setTokenpassTcaBalances(user._id, balances);\n\n\t\treturn balances;\n\t}\n};\n","Meteor.startup(function() {\n\tRocketChat.models.Rooms.tryEnsureIndex({ 'tokenpass.tokens.token': 1 });\n});\n","RocketChat.models.Rooms.findByTokenpass = function(tokens) {\n\tconst query = {\n\t\t'tokenpass.tokens.token': {\n\t\t\t$in: tokens\n\t\t}\n\t};\n\n\treturn this._db.find(query).fetch();\n};\n\nRocketChat.models.Rooms.setTokensById = function(_id, tokens) {\n\tconst update = {\n\t\t$set: {\n\t\t\t'tokenpass.tokens.token': tokens\n\t\t}\n\t};\n\n\treturn this.update({_id}, update);\n};\n\nRocketChat.models.Rooms.setTokenpassById = function(_id, tokenpass) {\n\tconst update = {\n\t\t$set: {\n\t\t\ttokenpass\n\t\t}\n\t};\n\n\treturn this.update({ _id }, update);\n};\n\nRocketChat.models.Rooms.findAllTokenChannels = function() {\n\tconst query = {\n\t\ttokenpass: { $exists: true }\n\t};\n\tconst options = {\n\t\tfields: {\n\t\t\ttokenpass: 1\n\t\t}\n\t};\n\treturn this._db.find(query, options);\n};\n","RocketChat.models.Subscriptions.findByRoomIds = function(roomIds) {\n\tconst query = {\n\t\trid: {\n\t\t\t$in: roomIds\n\t\t}\n\t};\n\tconst options = {\n\t\tfields: {\n\t\t\t'u._id': 1,\n\t\t\trid: 1\n\t\t}\n\t};\n\n\treturn this._db.find(query, options);\n};\n","RocketChat.models.Users.setTokenpassTcaBalances = function(_id, tcaBalances) {\n\tconst update = {\n\t\t$set: {\n\t\t\t'services.tokenpass.tcaBalances': tcaBalances\n\t\t}\n\t};\n\n\treturn this.update(_id, update);\n};\n\nRocketChat.models.Users.getTokenBalancesByUserId = function(userId) {\n\tconst query = {\n\t\t_id: userId\n\t};\n\n\tconst options = {\n\t\tfields: {\n\t\t\t'services.tokenpass.tcaBalances': 1\n\t\t}\n\t};\n\n\treturn this.findOne(query, options);\n};\n","Meteor.methods({\n\tfindTokenChannels() {\n\t\tif (!Meteor.userId()) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (user.services && user.services.tokenpass && user.services.tokenpass.tcaBalances) {\n\t\t\tconst tokens = {};\n\t\t\tuser.services.tokenpass.tcaBalances.forEach(token => {\n\t\t\t\ttokens[token.asset] = 1;\n\t\t\t});\n\n\t\t\treturn RocketChat.models.Rooms.findByTokenpass(Object.keys(tokens))\n\t\t\t\t.filter(room => RocketChat.Tokenpass.validateAccess(room.tokenpass, user.services.tokenpass.tcaBalances));\n\t\t}\n\n\t\treturn [];\n\t}\n});\n","Meteor.methods({\n\tgetChannelTokenpass(rid) {\n\t\tcheck(rid, String);\n\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'getChannelTokenpass' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'getChannelTokenpass' });\n\t\t}\n\n\t\treturn room.tokenpass;\n\t}\n});\n","/* globals SyncedCron */\nfunction removeUsersFromTokenChannels() {\n\tconst rooms = {};\n\n\tRocketChat.models.Rooms.findAllTokenChannels().forEach(room => {\n\t\trooms[room._id] = room.tokenpass;\n\t});\n\n\tconst users = {};\n\n\tRocketChat.models.Subscriptions.findByRoomIds(Object.keys(rooms)).forEach(sub => {\n\t\tif (!users[sub.u._id]) {\n\t\t\tusers[sub.u._id] = [];\n\t\t}\n\t\tusers[sub.u._id].push(sub.rid);\n\t});\n\n\tObject.keys(users).forEach(user => {\n\t\tconst userInfo = RocketChat.models.Users.findOneById(user);\n\n\t\tif (userInfo && userInfo.services && userInfo.services.tokenpass) {\n\t\t\tconst balances = RocketChat.updateUserTokenpassBalances(userInfo);\n\n\t\t\tusers[user].forEach(roomId => {\n\t\t\t\tconst valid = RocketChat.Tokenpass.validateAccess(rooms[roomId], balances);\n\n\t\t\t\tif (!valid) {\n\t\t\t\t\tRocketChat.removeUserFromRoom(roomId, userInfo);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\nMeteor.startup(function() {\n\tMeteor.defer(function() {\n\t\tremoveUsersFromTokenChannels();\n\n\t\tSyncedCron.add({\n\t\t\tname: 'Remove users from Token Channels',\n\t\t\tschedule: (parser) => parser.cron('0 * * * *'),\n\t\t\tjob: removeUsersFromTokenChannels\n\t\t});\n\t});\n});\n","RocketChat.Tokenpass = {\n\tvalidateAccess(tokenpass, balances) {\n\t\tconst compFunc = tokenpass.require === 'any' ? 'some' : 'every';\n\t\treturn tokenpass.tokens[compFunc]((config) => {\n\t\t\treturn balances.some(userToken => {\n\t\t\t\treturn config.token === userToken.asset && parseFloat(config.balance) <= parseFloat(userToken.balance);\n\t\t\t});\n\t\t});\n\t}\n};\n"]}