{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:google-vision/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:google-vision/server/googlevision.js","meteor://ðŸ’»app/packages/rocketchat:google-vision/server/models/Messages.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","section","public","enableQuery","_id","value","multiline","hidden","blocked","GoogleVision","constructor","storage","require","vision","storageClient","visionClient","enabled","get","serviceAccount","key","JSON","parse","credentials","e","callbacks","blockUnsafeImages","bind","priority","MEDIUM","remove","annotate","incCallCount","count","currentMonth","Date","getMonth","maxMonthlyCalls","set","models","Settings","update","$inc","message","file","Uploads","findOne","indexOf","store","GoogleStorage","bucket","bucketFile","path","results","wrapAsync","detectSafeSearch","adult","FileUpload","getStore","deleteById","user","Users","findOneById","u","Notifications","notifyUser","Random","id","rid","ts","msg","TAPi18n","__","language","Error","console","error","visionTypes","push","length","detect","bindEnvironment","Messages","setGoogleVisionData","getAnnotations","trace","stack","visionData","_visionData","index","hasOwnProperty","concat","messageId","updateObj","$set"],"mappings":"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","file":"/packages/rocketchat_google-vision.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.add('GoogleVision_Enable', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tpublic: true,\n\t\tenableQuery: { _id: 'FileUpload_Storage_Type', value: 'GoogleCloudStorage' }\n\t});\n\tRocketChat.settings.add('GoogleVision_ServiceAccount', '', {\n\t\ttype: 'string',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tmultiline: true,\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Max_Monthly_Calls', 0, {\n\t\ttype: 'int',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Current_Month', 0, {\n\t\ttype: 'int',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\thidden: true\n\t});\n\tRocketChat.settings.add('GoogleVision_Current_Month_Calls', 0, {\n\t\ttype: 'int',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tblocked: true\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Document', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Faces', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Landmarks', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Labels', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Logos', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Properties', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_SafeSearch', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Block_Adult_Images', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: [{ _id: 'GoogleVision_Enable', value: true }, { _id: 'GoogleVision_Type_SafeSearch', value: true }]\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Similar', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n});\n","class GoogleVision {\n\tconstructor() {\n\t\tthis.storage = require('@google-cloud/storage');\n\t\tthis.vision = require('@google-cloud/vision');\n\t\tthis.storageClient = {};\n\t\tthis.visionClient = {};\n\t\tthis.enabled = RocketChat.settings.get('GoogleVision_Enable');\n\t\tthis.serviceAccount = {};\n\t\tRocketChat.settings.get('GoogleVision_Enable', (key, value) => {\n\t\t\tthis.enabled = value;\n\t\t});\n\t\tRocketChat.settings.get('GoogleVision_ServiceAccount', (key, value) => {\n\t\t\ttry {\n\t\t\t\tthis.serviceAccount = JSON.parse(value);\n\t\t\t\tthis.storageClient = this.storage({ credentials: this.serviceAccount });\n\t\t\t\tthis.visionClient = this.vision({ credentials: this.serviceAccount });\n\t\t\t} catch (e) {\n\t\t\t\tthis.serviceAccount = {};\n\t\t\t}\n\t\t});\n\t\tRocketChat.settings.get('GoogleVision_Block_Adult_Images', (key, value) => {\n\t\t\tif (value) {\n\t\t\t\tRocketChat.callbacks.add('beforeSaveMessage', this.blockUnsafeImages.bind(this), RocketChat.callbacks.priority.MEDIUM, 'googlevision-blockunsafe');\n\t\t\t} else {\n\t\t\t\tRocketChat.callbacks.remove('beforeSaveMessage', 'googlevision-blockunsafe');\n\t\t\t}\n\t\t});\n\t\tRocketChat.callbacks.add('afterFileUpload', this.annotate.bind(this));\n\t}\n\n\tincCallCount(count) {\n\t\tconst currentMonth = new Date().getMonth();\n\t\tconst maxMonthlyCalls = RocketChat.settings.get('GoogleVision_Max_Monthly_Calls') || 0;\n\t\tif (maxMonthlyCalls > 0) {\n\t\t\tif (RocketChat.settings.get('GoogleVision_Current_Month') !== currentMonth) {\n\t\t\t\tRocketChat.settings.set('GoogleVision_Current_Month', currentMonth);\n\t\t\t\tif (count > maxMonthlyCalls) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t} else if (count + (RocketChat.settings.get('GoogleVision_Current_Month_Calls') || 0) > maxMonthlyCalls) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\tRocketChat.models.Settings.update({ _id: 'GoogleVision_Current_Month_Calls' }, { $inc: { value: count } });\n\t\treturn true;\n\t}\n\n\tblockUnsafeImages(message) {\n\t\tif (this.enabled && this.serviceAccount && message && message.file && message.file._id) {\n\t\t\tconst file = RocketChat.models.Uploads.findOne({ _id: message.file._id });\n\t\t\tif (file && file.type && file.type.indexOf('image') !== -1 && file.store === 'GoogleCloudStorage:Uploads' && file.GoogleStorage) {\n\t\t\t\tif (this.incCallCount(1)) {\n\t\t\t\t\tconst bucket = this.storageClient.bucket(RocketChat.settings.get('FileUpload_GoogleStorage_Bucket'));\n\t\t\t\t\tconst bucketFile = bucket.file(file.GoogleStorage.path);\n\t\t\t\t\tconst results = Meteor.wrapAsync(this.visionClient.detectSafeSearch, this.visionClient)(bucketFile);\n\t\t\t\t\tif (results && results.adult === true) {\n\t\t\t\t\t\tFileUpload.getStore('Uploads').deleteById(file._id);\n\t\t\t\t\t\tconst user = RocketChat.models.Users.findOneById(message.u && message.u._id);\n\t\t\t\t\t\tif (user) {\n\t\t\t\t\t\t\tRocketChat.Notifications.notifyUser(user._id, 'message', {\n\t\t\t\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\t\t\t\trid: message.rid,\n\t\t\t\t\t\t\t\tts: new Date,\n\t\t\t\t\t\t\t\tmsg: TAPi18n.__('Adult_images_are_not_allowed', {}, user.language)\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthrow new Meteor.Error('GoogleVisionError: Image blocked');\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconsole.error('Google Vision: Usage limit exceeded');\n\t\t\t\t}\n\t\t\t\treturn message;\n\t\t\t}\n\t\t}\n\t}\n\n\tannotate({ message }) {\n\t\tconst visionTypes = [];\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Document')) {\n\t\t\tvisionTypes.push('document');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Faces')) {\n\t\t\tvisionTypes.push('faces');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Landmarks')) {\n\t\t\tvisionTypes.push('landmarks');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Labels')) {\n\t\t\tvisionTypes.push('labels');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Logos')) {\n\t\t\tvisionTypes.push('logos');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Properties')) {\n\t\t\tvisionTypes.push('properties');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_SafeSearch')) {\n\t\t\tvisionTypes.push('safeSearch');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Similar')) {\n\t\t\tvisionTypes.push('similar');\n\t\t}\n\t\tif (this.enabled && this.serviceAccount && visionTypes.length > 0 && message.file && message.file._id) {\n\t\t\tconst file = RocketChat.models.Uploads.findOne({ _id: message.file._id });\n\t\t\tif (file && file.type && file.type.indexOf('image') !== -1 && file.store === 'GoogleCloudStorage:Uploads' && file.GoogleStorage) {\n\t\t\t\tif (this.incCallCount(visionTypes.length)) {\n\t\t\t\t\tconst bucket = this.storageClient.bucket(RocketChat.settings.get('FileUpload_GoogleStorage_Bucket'));\n\t\t\t\t\tconst bucketFile = bucket.file(file.GoogleStorage.path);\n\t\t\t\t\tthis.visionClient.detect(bucketFile, visionTypes, Meteor.bindEnvironment((error, results) => {\n\t\t\t\t\t\tif (!error) {\n\t\t\t\t\t\t\tRocketChat.models.Messages.setGoogleVisionData(message._id, this.getAnnotations(visionTypes, results));\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconsole.trace('GoogleVision error: ', error.stack);\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t} else {\n\t\t\t\t\tconsole.error('Google Vision: Usage limit exceeded');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tgetAnnotations(visionTypes, visionData) {\n\t\tif (visionTypes.length === 1) {\n\t\t\tconst _visionData = {};\n\t\t\t_visionData[`${ visionTypes[0] }`] = visionData;\n\t\t\tvisionData = _visionData;\n\t\t}\n\t\tconst results = {};\n\t\tfor (const index in visionData) {\n\t\t\tif (visionData.hasOwnProperty(index)) {\n\t\t\t\tswitch (index) {\n\t\t\t\t\tcase 'faces':\n\t\t\t\t\tcase 'landmarks':\n\t\t\t\t\tcase 'labels':\n\t\t\t\t\tcase 'similar':\n\t\t\t\t\tcase 'logos':\n\t\t\t\t\t\tresults[index] = (results[index] || []).concat(visionData[index] || []);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'safeSearch':\n\t\t\t\t\t\tresults['safeSearch'] = visionData['safeSearch'];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'properties':\n\t\t\t\t\t\tresults['colors'] = visionData[index]['colors'];\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn results;\n\t}\n}\n\nRocketChat.GoogleVision = new GoogleVision;\n","RocketChat.models.Messages.setGoogleVisionData = function(messageId, visionData) {\n\tconst updateObj = {};\n\tfor (const index in visionData) {\n\t\tif (visionData.hasOwnProperty(index)) {\n\t\t\tupdateObj[`attachments.0.${ index }`] = visionData[index];\n\t\t}\n\t}\n\n\treturn this.update({ _id: messageId }, { $set: updateObj });\n};\n"]}