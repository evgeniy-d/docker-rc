{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:mentions/server/server.js","meteor://ðŸ’»app/packages/rocketchat:mentions/server/methods/getUserMentionsByChannel.js","meteor://ðŸ’»app/packages/rocketchat:mentions/server/Mentions.js","meteor://ðŸ’»app/packages/rocketchat:mentions/Mentions.js"],"names":["_","module","watch","require","default","v","MentionsServer","mention","pattern","RocketChat","settings","get","messageMaxAll","getUsers","usernames","Meteor","users","find","username","$in","unique","fields","_id","name","fetch","getUser","userId","models","Users","findOneById","getTotalChannelMembers","rid","Subscriptions","findByRoomId","count","getChannels","channels","Rooms","t","onMaxRoomMembersExceeded","sender","language","msg","TAPi18n","__","total","Notifications","notifyUser","Random","id","ts","Date","groupable","Error","method","action","callbacks","add","message","execute","priority","HIGH","methods","getUserMentionsByChannel","roomId","options","check","String","room","user","Messages","findVisibleByMentionAndRoomId","export","Mentions","constructor","args","getChannel","m","_getUsers","_getChannels","_getChannel","_messageMaxAll","getUsersByMentions","u","mentions","getUserMentions","mentionsAll","userMentions","forEach","trim","substr","push","length","getChannelbyMentions","getChannelMentions","map","c","s","exportDefault","useRealName","me","_me","p","_pattern","_useRealName","userMentionRegex","RegExp","channelMentionRegex","replaceUsers","str","replace","match","prefix","includes","mentionObj","temp","escapeHTML","replaceChannels","parse","html"],"mappings":"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","file":"/packages/rocketchat_mentions.js","sourcesContent":["import _ from 'underscore';\nimport MentionsServer from './Mentions';\n\nconst mention = new MentionsServer({\n\tpattern: () => RocketChat.settings.get('UTF8_Names_Validation'),\n\tmessageMaxAll: () => RocketChat.settings.get('Message_MaxAll'),\n\tgetUsers: (usernames) => Meteor.users.find({ username: {$in: _.unique(usernames)}}, { fields: {_id: true, username: true, name: 1 }}).fetch(),\n\tgetUser: (userId) => RocketChat.models.Users.findOneById(userId),\n\tgetTotalChannelMembers: (rid) => RocketChat.models.Subscriptions.findByRoomId(rid).count(),\n\tgetChannels: (channels) => RocketChat.models.Rooms.find({ name: {$in: _.unique(channels)}, t: 'c'\t}, { fields: {_id: 1, name: 1 }}).fetch(),\n\tonMaxRoomMembersExceeded({ sender, rid }) {\n\t\t// Get the language of the user for the error notification.\n\t\tconst language = this.getUser(sender._id).language;\n\t\tconst msg = TAPi18n.__('Group_mentions_disabled_x_members', { total: this.messageMaxAll }, language);\n\n\t\tRocketChat.Notifications.notifyUser(sender._id, 'message', {\n\t\t\t_id: Random.id(),\n\t\t\trid,\n\t\t\tts: new Date,\n\t\t\tmsg,\n\t\t\tgroupable: false\n\t\t});\n\n\t\t// Also throw to stop propagation of 'sendMessage'.\n\t\tthrow new Meteor.Error('error-action-not-allowed', msg, {\n\t\t\tmethod: 'filterATAllTag',\n\t\t\taction: msg\n\t\t});\n\t}\n});\nRocketChat.callbacks.add('beforeSaveMessage', (message) => mention.execute(message), RocketChat.callbacks.priority.HIGH, 'mentions');\n","Meteor.methods({\n\tgetUserMentionsByChannel({ roomId, options }) {\n\t\tcheck(roomId, String);\n\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'getUserMentionsByChannel' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'getUserMentionsByChannel' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\treturn RocketChat.models.Messages.findVisibleByMentionAndRoomId(user.username, roomId, options).fetch();\n\t}\n});\n","/*\n* Mentions is a named function that will process Mentions\n* @param {Object} message - The message object\n*/\nimport Mentions from '../Mentions';\nexport default class MentionsServer extends Mentions {\n\tconstructor(args) {\n\t\tsuper(args);\n\t\tthis.messageMaxAll = args.messageMaxAll;\n\t\tthis.getChannel = args.getChannel;\n\t\tthis.getChannels = args.getChannels;\n\t\tthis.getUsers = args.getUsers;\n\t\tthis.getUser = args.getUser;\n\t\tthis.getTotalChannelMembers = args.getTotalChannelMembers;\n\t\tthis.onMaxRoomMembersExceeded = args.onMaxRoomMembersExceeded || (() => {});\n\t}\n\tset getUsers(m) {\n\t\tthis._getUsers = m;\n\t}\n\tget getUsers() {\n\t\treturn typeof this._getUsers === 'function' ? this._getUsers : () => this._getUsers;\n\t}\n\tset getChannels(m) {\n\t\tthis._getChannels = m;\n\t}\n\tget getChannels() {\n\t\treturn typeof this._getChannels === 'function' ? this._getChannels : () => this._getChannels;\n\t}\n\tset getChannel(m) {\n\t\tthis._getChannel = m;\n\t}\n\tget getChannel() {\n\t\treturn typeof this._getChannel === 'function' ? this._getChannel : () => this._getChannel;\n\t}\n\tset messageMaxAll(m) {\n\t\tthis._messageMaxAll = m;\n\t}\n\tget messageMaxAll() {\n\t\treturn typeof this._messageMaxAll === 'function' ? this._messageMaxAll() : this._messageMaxAll;\n\t}\n\tgetUsersByMentions({msg, rid, u: sender}) {\n\t\tlet mentions = this.getUserMentions(msg);\n\t\tconst mentionsAll = [];\n\t\tconst userMentions = [];\n\n\t\tmentions.forEach((m) => {\n\t\t\tconst mention = m.trim().substr(1);\n\t\t\tif (mention !== 'all' && mention !== 'here') {\n\t\t\t\treturn userMentions.push(mention);\n\t\t\t}\n\t\t\tif (this.messageMaxAll > 0 && this.getTotalChannelMembers(rid) > this.messageMaxAll) {\n\t\t\t\treturn this.onMaxRoomMembersExceeded({ sender, rid });\n\t\t\t}\n\t\t\tmentionsAll.push({\n\t\t\t\t_id: mention,\n\t\t\t\tusername: mention\n\t\t\t});\n\t\t});\n\t\tmentions = userMentions.length ? this.getUsers(userMentions) : [];\n\t\treturn [...mentionsAll, ...mentions];\n\t}\n\tgetChannelbyMentions({msg}) {\n\t\tconst channels = this.getChannelMentions(msg);\n\t\treturn this.getChannels(channels.map(c => c.trim().substr(1)));\n\t}\n\texecute(message) {\n\t\tconst mentionsAll = this.getUsersByMentions(message);\n\t\tconst channels = this.getChannelbyMentions(message);\n\n\t\tmessage.mentions = mentionsAll;\n\t\tmessage.channels = channels;\n\n\t\treturn message;\n\t}\n}\n","/*\n* Mentions is a named function that will process Mentions\n* @param {Object} message - The message object\n*/\nimport s from 'underscore.string';\nexport default class {\n\tconstructor({pattern, useRealName, me}) {\n\t\tthis.pattern = pattern;\n\t\tthis.useRealName = useRealName;\n\t\tthis.me = me;\n\t}\n\tset me(m) {\n\t\tthis._me = m;\n\t}\n\tget me() {\n\t\treturn typeof this._me === 'function' ? this._me() : this._me;\n\t}\n\tset pattern(p) {\n\t\tthis._pattern = p;\n\t}\n\tget pattern() {\n\t\treturn typeof this._pattern === 'function' ? this._pattern() : this._pattern;\n\t}\n\tset useRealName(s) {\n\t\tthis._useRealName = s;\n\t}\n\tget useRealName() {\n\t\treturn typeof this._useRealName === 'function' ? this._useRealName() : this._useRealName;\n\t}\n\tget userMentionRegex() {\n\t\treturn new RegExp(`(^|\\\\s)@(${ this.pattern })`, 'gm');\n\t}\n\tget channelMentionRegex() {\n\t\treturn new RegExp(`(^|\\\\s)#(${ this.pattern })`, 'gm');\n\t}\n\treplaceUsers(str, message, me) {\n\t\treturn str.replace(this.userMentionRegex, (match, prefix, username) => {\n\t\t\tif (['all', 'here'].includes(username)) {\n\t\t\t\treturn `${ prefix }<a class=\"mention-link mention-link-me mention-link-all\">@${ username }</a>`;\n\t\t\t}\n\n\t\t\tconst mentionObj = message.mentions && message.mentions.find(m => m.username === username);\n\t\t\tif (message.temp == null && mentionObj == null) {\n\t\t\t\treturn match;\n\t\t\t}\n\t\t\tconst name = this.useRealName && mentionObj && s.escapeHTML(mentionObj.name);\n\n\t\t\treturn `${ prefix }<a class=\"mention-link ${ username === me ? 'mention-link-me' : '' }\" data-username=\"${ username }\" title=\"${ name ? username : '' }\">${ name || `@${ username }` }</a>`;\n\t\t});\n\t}\n\treplaceChannels(str, message) {\n\t\t//since apostrophe escaped contains # we need to unescape it\n\t\treturn str.replace(/&#39;/g, '\\'').replace(this.channelMentionRegex, (match, prefix, name) => {\n\t\t\tif (!message.temp && (message.channels && !message.channels.find(c => c.name === name))) {\n\t\t\t\treturn match;\n\t\t\t}\n\n\t\t\treturn `${ prefix }<a class=\"mention-link\" data-channel=\"${ name }\">${ `#${ name }` }</a>`;\n\t\t});\n\t}\n\tgetUserMentions(str) {\n\t\treturn (str.match(this.userMentionRegex) || []).map(match => match.trim());\n\t}\n\tgetChannelMentions(str) {\n\t\treturn (str.match(this.channelMentionRegex) || []).map(match => match.trim());\n\t}\n\tparse(message) {\n\t\tlet msg = (message && message.html) || '';\n\t\tif (!msg.trim()) {\n\t\t\treturn message;\n\t\t}\n\t\tmsg = this.replaceUsers(msg, message, this.me);\n\t\tmsg = this.replaceChannels(msg, message, this.me);\n\t\tmessage.html = msg;\n\t\treturn message;\n\t}\n}\n"]}