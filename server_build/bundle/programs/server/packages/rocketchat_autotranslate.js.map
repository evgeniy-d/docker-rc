{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/autotranslate.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/permissions.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/models/Subscriptions.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/methods/saveSettings.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/methods/translateMessage.js","meteor://ðŸ’»app/packages/rocketchat:autotranslate/server/methods/getSupportedLanguages.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","section","public","enableQuery","_id","value","_","module","watch","require","default","v","s","AutoTranslate","constructor","languages","enabled","get","apiKey","supportedLanguages","callbacks","translateMessage","bind","priority","MEDIUM","key","tokenize","message","tokens","Array","isArray","tokenizeEmojis","tokenizeCode","tokenizeURLs","tokenizeMentions","count","length","msg","replace","match","token","push","text","schemes","split","join","RegExp","pre","post","pretoken","posttoken","html","Markdown","parseMessageNotEscaped","tokenIndex","hasOwnProperty","indexOf","newToken","mentions","forEach","mention","username","channels","channel","name","deTokenize","noHtml","room","targetLanguage","targetLanguages","models","Subscriptions","getAutoTranslateLanguagesByRoomAndNotUser","u","defer","translations","targetMessage","Object","assign","escapeHTML","String","msgs","map","encodeURIComponent","query","getSupportedLanguages","language","findWhere","substr","result","HTTP","params","target","e","console","log","statusCode","data","txt","translation","translatedText","isEmpty","Messages","addTranslations","attachments","index","attachment","description","addAttachmentTranslations","response","error","status","Permissions","findOne","insert","roles","messageId","updateObj","keys","update","$set","attachmentIndex","updateAutoTranslateById","autoTranslate","$unset","updateAutoTranslateLanguageById","autoTranslateLanguage","rid","userId","subscriptionsRaw","model","rawCollection","distinct","wrapAsync","$ne","methods","field","options","Error","method","authz","hasPermission","check","subscription","findOneByRoomIdAndUserId","defaultLanguage","Rooms","findOneById","DDPRateLimiter","addRule"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,OAAOC,OAAP,CAAe,YAAW;AACzBC,aAAWC,QAAX,CAAoBC,GAApB,CAAwB,uBAAxB,EAAiD,KAAjD,EAAwD;AAAEC,UAAM,SAAR;AAAmBC,WAAO,SAA1B;AAAqCC,aAAS,eAA9C;AAA+DC,YAAQ;AAAvE,GAAxD;AACAN,aAAWC,QAAX,CAAoBC,GAApB,CAAwB,4BAAxB,EAAsD,EAAtD,EAA0D;AAAEC,UAAM,QAAR;AAAkBC,WAAO,SAAzB;AAAoCC,aAAS,eAA7C;AAA8DE,iBAAa;AAAEC,WAAK,uBAAP;AAAgCC,aAAO;AAAvC;AAA3E,GAA1D;AACA,CAHD,E;;;;;;;;;;;ACAA,IAAIC,CAAJ;;AAAMC,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACL,QAAEK,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIC,CAAJ;AAAML,OAAOC,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACC,UAAQC,CAAR,EAAU;AAACC,QAAED,CAAF;AAAI;;AAAhB,CAA1C,EAA4D,CAA5D;;AAGpE,MAAME,aAAN,CAAoB;AACnBC,gBAAc;AACb,SAAKC,SAAL,GAAiB,EAAjB;AACA,SAAKC,OAAL,GAAepB,WAAWC,QAAX,CAAoBoB,GAApB,CAAwB,uBAAxB,CAAf;AACA,SAAKC,MAAL,GAActB,WAAWC,QAAX,CAAoBoB,GAApB,CAAwB,4BAAxB,CAAd;AACA,SAAKE,kBAAL,GAA0B,EAA1B;AACAvB,eAAWwB,SAAX,CAAqBtB,GAArB,CAAyB,kBAAzB,EAA6C,KAAKuB,gBAAL,CAAsBC,IAAtB,CAA2B,IAA3B,CAA7C,EAA+E1B,WAAWwB,SAAX,CAAqBG,QAArB,CAA8BC,MAA7G,EAAqH,eAArH;AAEA5B,eAAWC,QAAX,CAAoBoB,GAApB,CAAwB,uBAAxB,EAAiD,CAACQ,GAAD,EAAMpB,KAAN,KAAgB;AAChE,WAAKW,OAAL,GAAeX,KAAf;AACA,KAFD;AAGAT,eAAWC,QAAX,CAAoBoB,GAApB,CAAwB,4BAAxB,EAAsD,CAACQ,GAAD,EAAMpB,KAAN,KAAgB;AACrE,WAAKa,MAAL,GAAcb,KAAd;AACA,KAFD;AAGA;;AAEDqB,WAASC,OAAT,EAAkB;AACjB,QAAI,CAACA,QAAQC,MAAT,IAAmB,CAACC,MAAMC,OAAN,CAAcH,QAAQC,MAAtB,CAAxB,EAAuD;AACtDD,cAAQC,MAAR,GAAiB,EAAjB;AACA;;AACDD,cAAU,KAAKI,cAAL,CAAoBJ,OAApB,CAAV;AACAA,cAAU,KAAKK,YAAL,CAAkBL,OAAlB,CAAV;AACAA,cAAU,KAAKM,YAAL,CAAkBN,OAAlB,CAAV;AACAA,cAAU,KAAKO,gBAAL,CAAsBP,OAAtB,CAAV;AACA,WAAOA,OAAP;AACA;;AAEDI,iBAAeJ,OAAf,EAAwB;AACvB,QAAIQ,QAAQR,QAAQC,MAAR,CAAeQ,MAA3B;AACAT,YAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,aAApB,EAAmC,UAASC,KAAT,EAAgB;AAChE,YAAMC,QAAS,yBAAyBL,OAAS,OAAjD;AACAR,cAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,aADmB;AAEnBE,cAAMH;AAFa,OAApB;AAIA,aAAOC,KAAP;AACA,KAPa,CAAd;AASA,WAAOb,OAAP;AACA;;AAEDM,eAAaN,OAAb,EAAsB;AACrB,QAAIQ,QAAQR,QAAQC,MAAR,CAAeQ,MAA3B;AAEA,UAAMO,UAAU/C,WAAWC,QAAX,CAAoBoB,GAApB,CAAwB,gCAAxB,EAA0D2B,KAA1D,CAAgE,GAAhE,EAAqEC,IAArE,CAA0E,GAA1E,CAAhB,CAHqB,CAKrB;;AACAlB,YAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,IAAIQ,MAAJ,CAAY,6BAA6BH,OAAS,qBAAlD,EAAwE,IAAxE,CAApB,EAAmG,UAASJ,KAAT,EAAgBQ,GAAhB,EAAqBL,IAArB,EAA2BM,IAA3B,EAAiC;AACjJ,YAAMC,WAAY,yBAAyBd,OAAS,OAApD;AACAR,cAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,eAAOS,QADY;AAEnBP,cAAMK;AAFa,OAApB;AAKA,YAAMG,YAAa,yBAAyBf,OAAS,OAArD;AACAR,cAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,eAAOU,SADY;AAEnBR,cAAMM;AAFa,OAApB;AAKA,aAAOC,WAAWP,IAAX,GAAkBQ,SAAzB;AACA,KAda,CAAd,CANqB,CAsBrB;;AACAvB,YAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,IAAIQ,MAAJ,CAAY,iBAAiBH,OAAS,gDAAtC,EAAuF,IAAvF,CAApB,EAAkH,UAASJ,KAAT,EAAgBQ,GAAhB,EAAqBL,IAArB,EAA2BM,IAA3B,EAAiC;AAChK,YAAMC,WAAY,yBAAyBd,OAAS,OAApD;AACAR,cAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,eAAOS,QADY;AAEnBP,cAAMK;AAFa,OAApB;AAKA,YAAMG,YAAa,yBAAyBf,OAAS,OAArD;AACAR,cAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,eAAOU,SADY;AAEnBR,cAAMM;AAFa,OAApB;AAKA,aAAOC,WAAWP,IAAX,GAAkBQ,SAAzB;AACA,KAda,CAAd;AAgBA,WAAOvB,OAAP;AACA;;AAEDK,eAAaL,OAAb,EAAsB;AACrB,QAAIQ,QAAQR,QAAQC,MAAR,CAAeQ,MAA3B;AAEAT,YAAQwB,IAAR,GAAexB,QAAQU,GAAvB;AACAV,cAAU/B,WAAWwD,QAAX,CAAoBC,sBAApB,CAA2C1B,OAA3C,CAAV;AACAA,YAAQU,GAAR,GAAcV,QAAQwB,IAAtB;;AAEA,SAAK,MAAMG,UAAX,IAAyB3B,QAAQC,MAAjC,EAAyC;AACxC,UAAID,QAAQC,MAAR,CAAe2B,cAAf,CAA8BD,UAA9B,CAAJ,EAA+C;AAC9C,cAAMd,QAAQb,QAAQC,MAAR,CAAe0B,UAAf,EAA2Bd,KAAzC;;AACA,YAAIA,MAAMgB,OAAN,CAAc,aAAd,MAAiC,CAAC,CAAtC,EAAyC;AACxC,gBAAMC,WAAY,yBAAyBtB,OAAS,OAApD;AACAR,kBAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoBE,KAApB,EAA2BiB,QAA3B,CAAd;AACA9B,kBAAQC,MAAR,CAAe0B,UAAf,EAA2Bd,KAA3B,GAAmCiB,QAAnC;AACA;AACD;AACD;;AAED,WAAO9B,OAAP;AACA;;AAEDO,mBAAiBP,OAAjB,EAA0B;AACzB,QAAIQ,QAAQR,QAAQC,MAAR,CAAeQ,MAA3B;;AAEA,QAAIT,QAAQ+B,QAAR,IAAoB/B,QAAQ+B,QAAR,CAAiBtB,MAAjB,GAA0B,CAAlD,EAAqD;AACpDT,cAAQ+B,QAAR,CAAiBC,OAAjB,CAAyBC,WAAW;AACnCjC,gBAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,IAAIQ,MAAJ,CAAY,KAAKc,QAAQC,QAAU,GAAnC,EAAuC,IAAvC,CAApB,EAAkEtB,SAAS;AACxF,gBAAMC,QAAS,yBAAyBL,OAAS,OAAjD;AACAR,kBAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,iBADmB;AAEnBE,kBAAMH;AAFa,WAApB;AAIA,iBAAOC,KAAP;AACA,SAPa,CAAd;AAQA,OATD;AAUA;;AAED,QAAIb,QAAQmC,QAAR,IAAoBnC,QAAQmC,QAAR,CAAiB1B,MAAjB,GAA0B,CAAlD,EAAqD;AACpDT,cAAQmC,QAAR,CAAiBH,OAAjB,CAAyBI,WAAW;AACnCpC,gBAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoB,IAAIQ,MAAJ,CAAY,KAAKiB,QAAQC,IAAM,GAA/B,EAAmC,IAAnC,CAApB,EAA8DzB,SAAS;AACpF,gBAAMC,QAAS,yBAAyBL,OAAS,OAAjD;AACAR,kBAAQC,MAAR,CAAea,IAAf,CAAoB;AACnBD,iBADmB;AAEnBE,kBAAMH;AAFa,WAApB;AAIA,iBAAOC,KAAP;AACA,SAPa,CAAd;AAQA,OATD;AAUA;;AAED,WAAOb,OAAP;AACA;;AAEDsC,aAAWtC,OAAX,EAAoB;AACnB,QAAIA,QAAQC,MAAR,IAAkBD,QAAQC,MAAR,CAAeQ,MAAf,GAAwB,CAA9C,EAAiD;AAChD,yBAAoCT,QAAQC,MAA5C,EAAoD;AAAA,cAAzC;AAACY,eAAD;AAAQE,cAAR;AAAcwB;AAAd,SAAyC;AACnDvC,gBAAQU,GAAR,GAAcV,QAAQU,GAAR,CAAYC,OAAZ,CAAoBE,KAApB,EAA2B,MAAM0B,SAASA,MAAT,GAAkBxB,IAAnD,CAAd;AACA;AACD;;AACD,WAAOf,QAAQU,GAAf;AACA;;AAEDhB,mBAAiBM,OAAjB,EAA0BwC,IAA1B,EAAgCC,cAAhC,EAAgD;AAC/C,QAAI,KAAKpD,OAAL,IAAgB,KAAKE,MAAzB,EAAiC;AAChC,UAAImD,eAAJ;;AACA,UAAID,cAAJ,EAAoB;AACnBC,0BAAkB,CAAED,cAAF,CAAlB;AACA,OAFD,MAEO;AACNC,0BAAkBzE,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCC,yCAAhC,CAA0EL,KAAK/D,GAA/E,EAAoFuB,QAAQ8C,CAAR,IAAa9C,QAAQ8C,CAAR,CAAUrE,GAA3G,CAAlB;AACA;;AACD,UAAIuB,QAAQU,GAAZ,EAAiB;AAChB3C,eAAOgF,KAAP,CAAa,MAAM;AAClB,gBAAMC,eAAe,EAArB;AACA,cAAIC,gBAAgBC,OAAOC,MAAP,CAAc,EAAd,EAAkBnD,OAAlB,CAApB;AAEAiD,wBAAczB,IAAd,GAAqBvC,EAAEmE,UAAF,CAAaC,OAAOJ,cAAcvC,GAArB,CAAb,CAArB;AACAuC,0BAAgB,KAAKlD,QAAL,CAAckD,aAAd,CAAhB;AAEA,cAAIK,OAAOL,cAAcvC,GAAd,CAAkBO,KAAlB,CAAwB,IAAxB,CAAX;AACAqC,iBAAOA,KAAKC,GAAL,CAAS7C,OAAO8C,mBAAmB9C,GAAnB,CAAhB,CAAP;AACA,gBAAM+C,QAAS,KAAKH,KAAKpC,IAAL,CAAU,KAAV,CAAkB,EAAtC;AAEA,gBAAM1B,qBAAqB,KAAKkE,qBAAL,CAA2B,IAA3B,CAA3B;AACAhB,0BAAgBV,OAAhB,CAAwB2B,YAAY;AACnC,gBAAIA,SAAS9B,OAAT,CAAiB,GAAjB,MAA0B,CAAC,CAA3B,IAAgC,CAAClD,EAAEiF,SAAF,CAAYpE,kBAAZ,EAAgC;AAAEmE;AAAF,aAAhC,CAArC,EAAoF;AACnFA,yBAAWA,SAASE,MAAT,CAAgB,CAAhB,EAAmB,CAAnB,CAAX;AACA;;AACD,gBAAIC,MAAJ;;AACA,gBAAI;AACHA,uBAASC,KAAKzE,GAAL,CAAS,0DAAT,EAAqE;AAAE0E,wBAAQ;AAAElE,uBAAK,KAAKP,MAAZ;AAAoB0E,0BAAQN;AAA5B,iBAAV;AAAkDF;AAAlD,eAArE,CAAT;AACA,aAFD,CAEE,OAAOS,CAAP,EAAU;AACXC,sBAAQC,GAAR,CAAY,2BAAZ,EAAyCF,CAAzC;AACA,qBAAOlE,OAAP;AACA;;AACD,gBAAI8D,OAAOO,UAAP,KAAsB,GAAtB,IAA6BP,OAAOQ,IAApC,IAA4CR,OAAOQ,IAAP,CAAYA,IAAxD,IAAgER,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjF,IAAiG9C,MAAMC,OAAN,CAAc2D,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAA/B,CAAjG,IAAiJc,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjB,CAA8BvC,MAA9B,GAAuC,CAA5L,EAA+L;AAC9L,oBAAM8D,MAAMT,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjB,CAA8BO,GAA9B,CAAkCiB,eAAeA,YAAYC,cAA7D,EAA6EvD,IAA7E,CAAkF,IAAlF,CAAZ;AACA8B,2BAAaW,QAAb,IAAyB,KAAKrB,UAAL,CAAgBY,OAAOC,MAAP,CAAc,EAAd,EAAkBF,aAAlB,EAAiC;AAAEvC,qBAAK6D;AAAP,eAAjC,CAAhB,CAAzB;AACA;AACD,WAfD;;AAgBA,cAAI,CAAC5F,EAAE+F,OAAF,CAAU1B,YAAV,CAAL,EAA8B;AAC7B/E,uBAAW0E,MAAX,CAAkBgC,QAAlB,CAA2BC,eAA3B,CAA2C5E,QAAQvB,GAAnD,EAAwDuE,YAAxD;AACA;AACD,SA/BD;AAgCA;;AAED,UAAIhD,QAAQ6E,WAAR,IAAuB7E,QAAQ6E,WAAR,CAAoBpE,MAApB,GAA6B,CAAxD,EAA2D;AAC1D1C,eAAOgF,KAAP,CAAa,MAAM;AAClB,eAAK,MAAM+B,KAAX,IAAoB9E,QAAQ6E,WAA5B,EAAyC;AACxC,gBAAI7E,QAAQ6E,WAAR,CAAoBjD,cAApB,CAAmCkD,KAAnC,CAAJ,EAA+C;AAC9C,oBAAMC,aAAa/E,QAAQ6E,WAAR,CAAoBC,KAApB,CAAnB;AACA,oBAAM9B,eAAe,EAArB;;AACA,kBAAI+B,WAAWC,WAAX,IAA0BD,WAAWhE,IAAzC,EAA+C;AAC9C,sBAAM0C,QAAS,KAAKD,mBAAmBuB,WAAWC,WAAX,IAA0BD,WAAWhE,IAAxD,CAA+D,EAAnF;AACA,sBAAMvB,qBAAqB,KAAKkE,qBAAL,CAA2B,IAA3B,CAA3B;AACAhB,gCAAgBV,OAAhB,CAAwB2B,YAAY;AACnC,sBAAIA,SAAS9B,OAAT,CAAiB,GAAjB,MAA0B,CAAC,CAA3B,IAAgC,CAAClD,EAAEiF,SAAF,CAAYpE,kBAAZ,EAAgC;AAAEmE;AAAF,mBAAhC,CAArC,EAAoF;AACnFA,+BAAWA,SAASE,MAAT,CAAgB,CAAhB,EAAmB,CAAnB,CAAX;AACA;;AACD,wBAAMC,SAASC,KAAKzE,GAAL,CAAS,0DAAT,EAAqE;AAAE0E,4BAAQ;AAAElE,2BAAK,KAAKP,MAAZ;AAAoB0E,8BAAQN;AAA5B,qBAAV;AAAkDF;AAAlD,mBAArE,CAAf;;AACA,sBAAIK,OAAOO,UAAP,KAAsB,GAAtB,IAA6BP,OAAOQ,IAApC,IAA4CR,OAAOQ,IAAP,CAAYA,IAAxD,IAAgER,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjF,IAAiG9C,MAAMC,OAAN,CAAc2D,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAA/B,CAAjG,IAAiJc,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjB,CAA8BvC,MAA9B,GAAuC,CAA5L,EAA+L;AAC9L,0BAAM8D,MAAMT,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBtB,YAAjB,CAA8BO,GAA9B,CAAkCiB,eAAeA,YAAYC,cAA7D,EAA6EvD,IAA7E,CAAkF,IAAlF,CAAZ;AACA8B,iCAAaW,QAAb,IAAyBY,GAAzB;AACA;AACD,iBATD;;AAUA,oBAAI,CAAC5F,EAAE+F,OAAF,CAAU1B,YAAV,CAAL,EAA8B;AAC7B/E,6BAAW0E,MAAX,CAAkBgC,QAAlB,CAA2BM,yBAA3B,CAAqDjF,QAAQvB,GAA7D,EAAkEqG,KAAlE,EAAyE9B,YAAzE;AACA;AACD;AACD;AACD;AACD,SAxBD;AAyBA;AACD;;AACD,WAAOhD,OAAP;AACA;;AAED0D,wBAAsBO,MAAtB,EAA8B;AAC7B,QAAI,KAAK5E,OAAL,IAAgB,KAAKE,MAAzB,EAAiC;AAChC,UAAI,KAAKC,kBAAL,CAAwByE,MAAxB,CAAJ,EAAqC;AACpC,eAAO,KAAKzE,kBAAL,CAAwByE,MAAxB,CAAP;AACA;;AAED,UAAIH,MAAJ;AACA,YAAME,SAAS;AAAElE,aAAK,KAAKP;AAAZ,OAAf;;AACA,UAAI0E,MAAJ,EAAY;AACXD,eAAOC,MAAP,GAAgBA,MAAhB;AACA;;AAED,UAAI;AACHH,iBAASC,KAAKzE,GAAL,CAAS,oEAAT,EAA+E;AAAE0E;AAAF,SAA/E,CAAT;AACA,OAFD,CAEE,OAAOE,CAAP,EAAU;AACX,YAAIA,EAAEgB,QAAF,IAAchB,EAAEgB,QAAF,CAAWb,UAAX,KAA0B,GAAxC,IAA+CH,EAAEgB,QAAF,CAAWZ,IAA1D,IAAkEJ,EAAEgB,QAAF,CAAWZ,IAAX,CAAgBa,KAAlF,IAA2FjB,EAAEgB,QAAF,CAAWZ,IAAX,CAAgBa,KAAhB,CAAsBC,MAAtB,KAAiC,kBAAhI,EAAoJ;AACnJpB,iBAAOC,MAAP,GAAgB,IAAhB;AACAA,mBAAS,IAAT;;AACA,cAAI,CAAC,KAAKzE,kBAAL,CAAwByE,MAAxB,CAAL,EAAsC;AACrCH,qBAASC,KAAKzE,GAAL,CAAS,oEAAT,EAA+E;AAAE0E;AAAF,aAA/E,CAAT;AACA;AACD;AACD,OAVD,SAUU;AACT,YAAI,KAAKxE,kBAAL,CAAwByE,MAAxB,CAAJ,EAAqC;AACpC,iBAAO,KAAKzE,kBAAL,CAAwByE,MAAxB,CAAP;AACA,SAFD,MAEO;AACN,eAAKzE,kBAAL,CAAwByE,UAAU,IAAlC,IAA0CH,UAAUA,OAAOQ,IAAjB,IAAyBR,OAAOQ,IAAP,CAAYA,IAArC,IAA6CR,OAAOQ,IAAP,CAAYA,IAAZ,CAAiBlF,SAAxG;AACA,iBAAO,KAAKI,kBAAL,CAAwByE,UAAU,IAAlC,CAAP;AACA;AACD;AACD;AACD;;AA1PkB;;AA6PpBhG,WAAWiB,aAAX,GAA2B,IAAIA,aAAJ,EAA3B,C;;;;;;;;;;;AChQAnB,OAAOC,OAAP,CAAe,MAAM;AACpB,MAAIC,WAAW0E,MAAX,IAAqB1E,WAAW0E,MAAX,CAAkB0C,WAA3C,EAAwD;AACvD,QAAI,CAACpH,WAAW0E,MAAX,CAAkB0C,WAAlB,CAA8BC,OAA9B,CAAsC;AAAE7G,WAAK;AAAP,KAAtC,CAAL,EAAuE;AACtER,iBAAW0E,MAAX,CAAkB0C,WAAlB,CAA8BE,MAA9B,CAAqC;AAAE9G,aAAK,gBAAP;AAAyB+G,eAAO,CAAC,OAAD;AAAhC,OAArC;AACA;AACD;AACD,CAND,E;;;;;;;;;;;ACAAvH,WAAW0E,MAAX,CAAkBgC,QAAlB,CAA2BC,eAA3B,GAA6C,UAASa,SAAT,EAAoBzC,YAApB,EAAkC;AAC9E,QAAM0C,YAAY,EAAlB;AACAxC,SAAOyC,IAAP,CAAY3C,YAAZ,EAA0BhB,OAA1B,CAAmClC,GAAD,IAAS;AAC1C,UAAM0E,cAAcxB,aAAalD,GAAb,CAApB;AACA4F,cAAW,gBAAgB5F,GAAK,EAAhC,IAAqC0E,WAArC;AACA,GAHD;AAIA,SAAO,KAAKoB,MAAL,CAAY;AAAEnH,SAAKgH;AAAP,GAAZ,EAAgC;AAAEI,UAAMH;AAAR,GAAhC,CAAP;AACA,CAPD;;AASAzH,WAAW0E,MAAX,CAAkBgC,QAAlB,CAA2BM,yBAA3B,GAAuD,UAASQ,SAAT,EAAoBK,eAApB,EAAqC9C,YAArC,EAAmD;AACzG,QAAM0C,YAAY,EAAlB;AACAxC,SAAOyC,IAAP,CAAY3C,YAAZ,EAA0BhB,OAA1B,CAAmClC,GAAD,IAAS;AAC1C,UAAM0E,cAAcxB,aAAalD,GAAb,CAApB;AACA4F,cAAW,eAAeI,eAAiB,iBAAiBhG,GAAK,EAAjE,IAAsE0E,WAAtE;AACA,GAHD;AAIA,SAAO,KAAKoB,MAAL,CAAY;AAAEnH,SAAKgH;AAAP,GAAZ,EAAgC;AAAEI,UAAMH;AAAR,GAAhC,CAAP;AACA,CAPD,C;;;;;;;;;;;ACTAzH,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCmD,uBAAhC,GAA0D,UAAStH,GAAT,EAAcuH,aAAd,EAA6B;AACtF,QAAMvC,QAAQ;AACbhF;AADa,GAAd;AAIA,MAAImH,MAAJ;;AACA,MAAII,aAAJ,EAAmB;AAClBJ,aAAS;AACRC,YAAM;AACLG;AADK;AADE,KAAT;AAKA,GAND,MAMO;AACNJ,aAAS;AACRK,cAAQ;AACPD,uBAAe;AADR;AADA,KAAT;AAKA;;AAED,SAAO,KAAKJ,MAAL,CAAYnC,KAAZ,EAAmBmC,MAAnB,CAAP;AACA,CArBD;;AAuBA3H,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCsD,+BAAhC,GAAkE,UAASzH,GAAT,EAAc0H,qBAAd,EAAqC;AACtG,QAAM1C,QAAQ;AACbhF;AADa,GAAd;AAIA,QAAMmH,SAAS;AACdC,UAAM;AACLM;AADK;AADQ,GAAf;AAMA,SAAO,KAAKP,MAAL,CAAYnC,KAAZ,EAAmBmC,MAAnB,CAAP;AACA,CAZD;;AAcA3H,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCC,yCAAhC,GAA4E,UAASuD,GAAT,EAAcC,MAAd,EAAsB;AACjG,QAAMC,mBAAmBrI,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgC2D,KAAhC,CAAsCC,aAAtC,EAAzB;AACA,QAAMC,WAAW1I,OAAO2I,SAAP,CAAiBJ,iBAAiBG,QAAlC,EAA4CH,gBAA5C,CAAjB;AACA,QAAM7C,QAAQ;AACb2C,OADa;AAEb,aAAS;AAAEO,WAAKN;AAAP,KAFI;AAGbL,mBAAe;AAHF,GAAd;AAKA,SAAOS,SAAS,uBAAT,EAAkChD,KAAlC,CAAP;AACA,CATD,C;;;;;;;;;;;ACrCA1F,OAAO6I,OAAP,CAAe;AACd,+BAA6BR,GAA7B,EAAkCS,KAAlC,EAAyCnI,KAAzC,EAAgDoI,OAAhD,EAAyD;AACxD,QAAI,CAAC/I,OAAOsI,MAAP,EAAL,EAAsB;AACrB,YAAM,IAAItI,OAAOgJ,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEC,gBAAQ;AAAV,OAAvD,CAAN;AACA;;AAED,QAAI,CAAC/I,WAAWgJ,KAAX,CAAiBC,aAAjB,CAA+BnJ,OAAOsI,MAAP,EAA/B,EAAgD,gBAAhD,CAAL,EAAwE;AACvE,YAAM,IAAItI,OAAOgJ,KAAX,CAAiB,0BAAjB,EAA6C,+BAA7C,EAA8E;AAAEC,gBAAQ;AAAV,OAA9E,CAAN;AACA;;AAEDG,UAAMf,GAAN,EAAW/C,MAAX;AACA8D,UAAMN,KAAN,EAAaxD,MAAb;AACA8D,UAAMzI,KAAN,EAAa2E,MAAb;;AAEA,QAAI,CAAC,eAAD,EAAkB,uBAAlB,EAA2CxB,OAA3C,CAAmDgF,KAAnD,MAA8D,CAAC,CAAnE,EAAsE;AACrE,YAAM,IAAI9I,OAAOgJ,KAAX,CAAiB,wBAAjB,EAA2C,wBAA3C,EAAqE;AAAEC,gBAAQ;AAAV,OAArE,CAAN;AACA;;AAED,UAAMI,eAAenJ,WAAW0E,MAAX,CAAkBC,aAAlB,CAAgCyE,wBAAhC,CAAyDjB,GAAzD,EAA8DrI,OAAOsI,MAAP,EAA9D,CAArB;;AACA,QAAI,CAACe,YAAL,EAAmB;AAClB,YAAM,IAAIrJ,OAAOgJ,KAAX,CAAiB,4BAAjB,EAA+C,sBAA/C,EAAuE;AAAEC,gBAAQ;AAAV,OAAvE,CAAN;AACA;;AAED,YAAQH,KAAR;AACC,WAAK,eAAL;AACC5I,mBAAW0E,MAAX,CAAkBC,aAAlB,CAAgCmD,uBAAhC,CAAwDqB,aAAa3I,GAArE,EAA0EC,UAAU,GAAV,GAAgB,IAAhB,GAAuB,KAAjG;;AACA,YAAI,CAAC0I,aAAajB,qBAAd,IAAuCW,QAAQQ,eAAnD,EAAoE;AACnErJ,qBAAW0E,MAAX,CAAkBC,aAAlB,CAAgCsD,+BAAhC,CAAgEkB,aAAa3I,GAA7E,EAAkFqI,QAAQQ,eAA1F;AACA;;AACD;;AACD,WAAK,uBAAL;AACCrJ,mBAAW0E,MAAX,CAAkBC,aAAlB,CAAgCsD,+BAAhC,CAAgEkB,aAAa3I,GAA7E,EAAkFC,KAAlF;AACA;AATF;;AAYA,WAAO,IAAP;AACA;;AApCa,CAAf,E;;;;;;;;;;;ACAAX,OAAO6I,OAAP,CAAe;AACd,mCAAiC5G,OAAjC,EAA0CyC,cAA1C,EAA0D;AACzD,UAAMD,OAAOvE,WAAW0E,MAAX,CAAkB4E,KAAlB,CAAwBC,WAAxB,CAAoCxH,WAAWA,QAAQoG,GAAvD,CAAb;;AACA,QAAIpG,WAAWwC,IAAX,IAAmBvE,WAAWiB,aAAlC,EAAiD;AAChD,aAAOjB,WAAWiB,aAAX,CAAyBQ,gBAAzB,CAA0CM,OAA1C,EAAmDwC,IAAnD,EAAyDC,cAAzD,CAAP;AACA;AACD;;AANa,CAAf,E;;;;;;;;;;;ACAA1E,OAAO6I,OAAP,CAAe;AACd,wCAAsCnE,cAAtC,EAAsD;AACrD,QAAI,CAACxE,WAAWgJ,KAAX,CAAiBC,aAAjB,CAA+BnJ,OAAOsI,MAAP,EAA/B,EAAgD,gBAAhD,CAAL,EAAwE;AACvE,YAAM,IAAItI,OAAOgJ,KAAX,CAAiB,0BAAjB,EAA6C,+BAA7C,EAA8E;AAAEC,gBAAQ;AAAV,OAA9E,CAAN;AACA;;AAED,WAAO/I,WAAWiB,aAAX,CAAyBwE,qBAAzB,CAA+CjB,cAA/C,CAAP;AACA;;AAPa,CAAf;AAUAgF,eAAeC,OAAf,CAAuB;AACtBtJ,QAAM,QADgB;AAEtBiE,QAAM,qCAFgB;;AAGtBgE;AAAO;AAAY;AAClB,WAAO,IAAP;AACA;;AALqB,CAAvB,EAMG,CANH,EAMM,KANN,E","file":"/packages/rocketchat_autotranslate.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.add('AutoTranslate_Enabled', false, { type: 'boolean', group: 'Message', section: 'AutoTranslate', public: true });\n\tRocketChat.settings.add('AutoTranslate_GoogleAPIKey', '', { type: 'string', group: 'Message', section: 'AutoTranslate', enableQuery: { _id: 'AutoTranslate_Enabled', value: true } });\n});\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nclass AutoTranslate {\n\tconstructor() {\n\t\tthis.languages = [];\n\t\tthis.enabled = RocketChat.settings.get('AutoTranslate_Enabled');\n\t\tthis.apiKey = RocketChat.settings.get('AutoTranslate_GoogleAPIKey');\n\t\tthis.supportedLanguages = {};\n\t\tRocketChat.callbacks.add('afterSaveMessage', this.translateMessage.bind(this), RocketChat.callbacks.priority.MEDIUM, 'AutoTranslate');\n\n\t\tRocketChat.settings.get('AutoTranslate_Enabled', (key, value) => {\n\t\t\tthis.enabled = value;\n\t\t});\n\t\tRocketChat.settings.get('AutoTranslate_GoogleAPIKey', (key, value) => {\n\t\t\tthis.apiKey = value;\n\t\t});\n\t}\n\n\ttokenize(message) {\n\t\tif (!message.tokens || !Array.isArray(message.tokens)) {\n\t\t\tmessage.tokens = [];\n\t\t}\n\t\tmessage = this.tokenizeEmojis(message);\n\t\tmessage = this.tokenizeCode(message);\n\t\tmessage = this.tokenizeURLs(message);\n\t\tmessage = this.tokenizeMentions(message);\n\t\treturn message;\n\t}\n\n\ttokenizeEmojis(message) {\n\t\tlet count = message.tokens.length;\n\t\tmessage.msg = message.msg.replace(/:[+\\w\\d]+:/g, function(match) {\n\t\t\tconst token = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken,\n\t\t\t\ttext: match\n\t\t\t});\n\t\t\treturn token;\n\t\t});\n\n\t\treturn message;\n\t}\n\n\ttokenizeURLs(message) {\n\t\tlet count = message.tokens.length;\n\n\t\tconst schemes = RocketChat.settings.get('Markdown_SupportSchemesForLink').split(',').join('|');\n\n\t\t// Support ![alt text](http://image url) and [text](http://link)\n\t\tmessage.msg = message.msg.replace(new RegExp(`(!?\\\\[)([^\\\\]]+)(\\\\]\\\\((?:${ schemes }):\\\\/\\\\/[^\\\\)]+\\\\))`, 'gm'), function(match, pre, text, post) {\n\t\t\tconst pretoken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken: pretoken,\n\t\t\t\ttext: pre\n\t\t\t});\n\n\t\t\tconst posttoken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken: posttoken,\n\t\t\t\ttext: post\n\t\t\t});\n\n\t\t\treturn pretoken + text + posttoken;\n\t\t});\n\n\t\t// Support <http://link|Text>\n\t\tmessage.msg = message.msg.replace(new RegExp(`((?:<|&lt;)(?:${ schemes }):\\\\/\\\\/[^\\\\|]+\\\\|)(.+?)(?=>|&gt;)((?:>|&gt;))`, 'gm'), function(match, pre, text, post) {\n\t\t\tconst pretoken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken: pretoken,\n\t\t\t\ttext: pre\n\t\t\t});\n\n\t\t\tconst posttoken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken: posttoken,\n\t\t\t\ttext: post\n\t\t\t});\n\n\t\t\treturn pretoken + text + posttoken;\n\t\t});\n\n\t\treturn message;\n\t}\n\n\ttokenizeCode(message) {\n\t\tlet count = message.tokens.length;\n\n\t\tmessage.html = message.msg;\n\t\tmessage = RocketChat.Markdown.parseMessageNotEscaped(message);\n\t\tmessage.msg = message.html;\n\n\t\tfor (const tokenIndex in message.tokens) {\n\t\t\tif (message.tokens.hasOwnProperty(tokenIndex)) {\n\t\t\t\tconst token = message.tokens[tokenIndex].token;\n\t\t\t\tif (token.indexOf('notranslate') === -1) {\n\t\t\t\t\tconst newToken = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\t\t\tmessage.msg = message.msg.replace(token, newToken);\n\t\t\t\t\tmessage.tokens[tokenIndex].token = newToken;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn message;\n\t}\n\n\ttokenizeMentions(message) {\n\t\tlet count = message.tokens.length;\n\n\t\tif (message.mentions && message.mentions.length > 0) {\n\t\t\tmessage.mentions.forEach(mention => {\n\t\t\t\tmessage.msg = message.msg.replace(new RegExp(`(@${ mention.username })`, 'gm'), match => {\n\t\t\t\t\tconst token = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\t\t\tmessage.tokens.push({\n\t\t\t\t\t\ttoken,\n\t\t\t\t\t\ttext: match\n\t\t\t\t\t});\n\t\t\t\t\treturn token;\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tif (message.channels && message.channels.length > 0) {\n\t\t\tmessage.channels.forEach(channel => {\n\t\t\t\tmessage.msg = message.msg.replace(new RegExp(`(#${ channel.name })`, 'gm'), match => {\n\t\t\t\t\tconst token = `<i class=notranslate>{${ count++ }}</i>`;\n\t\t\t\t\tmessage.tokens.push({\n\t\t\t\t\t\ttoken,\n\t\t\t\t\t\ttext: match\n\t\t\t\t\t});\n\t\t\t\t\treturn token;\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\treturn message;\n\t}\n\n\tdeTokenize(message) {\n\t\tif (message.tokens && message.tokens.length > 0) {\n\t\t\tfor (const {token, text, noHtml} of message.tokens) {\n\t\t\t\tmessage.msg = message.msg.replace(token, () => noHtml ? noHtml : text);\n\t\t\t}\n\t\t}\n\t\treturn message.msg;\n\t}\n\n\ttranslateMessage(message, room, targetLanguage) {\n\t\tif (this.enabled && this.apiKey) {\n\t\t\tlet targetLanguages;\n\t\t\tif (targetLanguage) {\n\t\t\t\ttargetLanguages = [ targetLanguage ];\n\t\t\t} else {\n\t\t\t\ttargetLanguages = RocketChat.models.Subscriptions.getAutoTranslateLanguagesByRoomAndNotUser(room._id, message.u && message.u._id);\n\t\t\t}\n\t\t\tif (message.msg) {\n\t\t\t\tMeteor.defer(() => {\n\t\t\t\t\tconst translations = {};\n\t\t\t\t\tlet targetMessage = Object.assign({}, message);\n\n\t\t\t\t\ttargetMessage.html = s.escapeHTML(String(targetMessage.msg));\n\t\t\t\t\ttargetMessage = this.tokenize(targetMessage);\n\n\t\t\t\t\tlet msgs = targetMessage.msg.split('\\n');\n\t\t\t\t\tmsgs = msgs.map(msg => encodeURIComponent(msg));\n\t\t\t\t\tconst query = `q=${ msgs.join('&q=') }`;\n\n\t\t\t\t\tconst supportedLanguages = this.getSupportedLanguages('en');\n\t\t\t\t\ttargetLanguages.forEach(language => {\n\t\t\t\t\t\tif (language.indexOf('-') !== -1 && !_.findWhere(supportedLanguages, { language })) {\n\t\t\t\t\t\t\tlanguage = language.substr(0, 2);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlet result;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tresult = HTTP.get('https://translation.googleapis.com/language/translate/v2', { params: { key: this.apiKey, target: language }, query });\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tconsole.log('Error translating message', e);\n\t\t\t\t\t\t\treturn message;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (result.statusCode === 200 && result.data && result.data.data && result.data.data.translations && Array.isArray(result.data.data.translations) && result.data.data.translations.length > 0) {\n\t\t\t\t\t\t\tconst txt = result.data.data.translations.map(translation => translation.translatedText).join('\\n');\n\t\t\t\t\t\t\ttranslations[language] = this.deTokenize(Object.assign({}, targetMessage, { msg: txt }));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tif (!_.isEmpty(translations)) {\n\t\t\t\t\t\tRocketChat.models.Messages.addTranslations(message._id, translations);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (message.attachments && message.attachments.length > 0) {\n\t\t\t\tMeteor.defer(() => {\n\t\t\t\t\tfor (const index in message.attachments) {\n\t\t\t\t\t\tif (message.attachments.hasOwnProperty(index)) {\n\t\t\t\t\t\t\tconst attachment = message.attachments[index];\n\t\t\t\t\t\t\tconst translations = {};\n\t\t\t\t\t\t\tif (attachment.description || attachment.text) {\n\t\t\t\t\t\t\t\tconst query = `q=${ encodeURIComponent(attachment.description || attachment.text) }`;\n\t\t\t\t\t\t\t\tconst supportedLanguages = this.getSupportedLanguages('en');\n\t\t\t\t\t\t\t\ttargetLanguages.forEach(language => {\n\t\t\t\t\t\t\t\t\tif (language.indexOf('-') !== -1 && !_.findWhere(supportedLanguages, { language })) {\n\t\t\t\t\t\t\t\t\t\tlanguage = language.substr(0, 2);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tconst result = HTTP.get('https://translation.googleapis.com/language/translate/v2', { params: { key: this.apiKey, target: language }, query });\n\t\t\t\t\t\t\t\t\tif (result.statusCode === 200 && result.data && result.data.data && result.data.data.translations && Array.isArray(result.data.data.translations) && result.data.data.translations.length > 0) {\n\t\t\t\t\t\t\t\t\t\tconst txt = result.data.data.translations.map(translation => translation.translatedText).join('\\n');\n\t\t\t\t\t\t\t\t\t\ttranslations[language] = txt;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tif (!_.isEmpty(translations)) {\n\t\t\t\t\t\t\t\t\tRocketChat.models.Messages.addAttachmentTranslations(message._id, index, translations);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\treturn message;\n\t}\n\n\tgetSupportedLanguages(target) {\n\t\tif (this.enabled && this.apiKey) {\n\t\t\tif (this.supportedLanguages[target]) {\n\t\t\t\treturn this.supportedLanguages[target];\n\t\t\t}\n\n\t\t\tlet result;\n\t\t\tconst params = { key: this.apiKey };\n\t\t\tif (target) {\n\t\t\t\tparams.target = target;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tresult = HTTP.get('https://translation.googleapis.com/language/translate/v2/languages', { params });\n\t\t\t} catch (e) {\n\t\t\t\tif (e.response && e.response.statusCode === 400 && e.response.data && e.response.data.error && e.response.data.error.status === 'INVALID_ARGUMENT') {\n\t\t\t\t\tparams.target = 'en';\n\t\t\t\t\ttarget = 'en';\n\t\t\t\t\tif (!this.supportedLanguages[target]) {\n\t\t\t\t\t\tresult = HTTP.get('https://translation.googleapis.com/language/translate/v2/languages', { params });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tif (this.supportedLanguages[target]) {\n\t\t\t\t\treturn this.supportedLanguages[target];\n\t\t\t\t} else {\n\t\t\t\t\tthis.supportedLanguages[target || 'en'] = result && result.data && result.data.data && result.data.data.languages;\n\t\t\t\t\treturn this.supportedLanguages[target || 'en'];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nRocketChat.AutoTranslate = new AutoTranslate;\n","Meteor.startup(() => {\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tif (!RocketChat.models.Permissions.findOne({ _id: 'auto-translate' })) {\n\t\t\tRocketChat.models.Permissions.insert({ _id: 'auto-translate', roles: ['admin'] });\n\t\t}\n\t}\n});\n","RocketChat.models.Messages.addTranslations = function(messageId, translations) {\n\tconst updateObj = {};\n\tObject.keys(translations).forEach((key) => {\n\t\tconst translation = translations[key];\n\t\tupdateObj[`translations.${ key }`] = translation;\n\t});\n\treturn this.update({ _id: messageId }, { $set: updateObj });\n};\n\nRocketChat.models.Messages.addAttachmentTranslations = function(messageId, attachmentIndex, translations) {\n\tconst updateObj = {};\n\tObject.keys(translations).forEach((key) => {\n\t\tconst translation = translations[key];\n\t\tupdateObj[`attachments.${ attachmentIndex }.translations.${ key }`] = translation;\n\t});\n\treturn this.update({ _id: messageId }, { $set: updateObj });\n};\n","RocketChat.models.Subscriptions.updateAutoTranslateById = function(_id, autoTranslate) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tlet update;\n\tif (autoTranslate) {\n\t\tupdate = {\n\t\t\t$set: {\n\t\t\t\tautoTranslate\n\t\t\t}\n\t\t};\n\t} else {\n\t\tupdate = {\n\t\t\t$unset: {\n\t\t\t\tautoTranslate: 1\n\t\t\t}\n\t\t};\n\t}\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateAutoTranslateLanguageById = function(_id, autoTranslateLanguage) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tautoTranslateLanguage\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.getAutoTranslateLanguagesByRoomAndNotUser = function(rid, userId) {\n\tconst subscriptionsRaw = RocketChat.models.Subscriptions.model.rawCollection();\n\tconst distinct = Meteor.wrapAsync(subscriptionsRaw.distinct, subscriptionsRaw);\n\tconst query = {\n\t\trid,\n\t\t'u._id': { $ne: userId },\n\t\tautoTranslate: true\n\t};\n\treturn distinct('autoTranslateLanguage', query);\n};\n","Meteor.methods({\n\t'autoTranslate.saveSettings'(rid, field, value, options) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'saveAutoTranslateSettings' });\n\t\t}\n\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'auto-translate')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Auto-Translate is not allowed', { method: 'autoTranslate.saveSettings'});\n\t\t}\n\n\t\tcheck(rid, String);\n\t\tcheck(field, String);\n\t\tcheck(value, String);\n\n\t\tif (['autoTranslate', 'autoTranslateLanguage'].indexOf(field) === -1) {\n\t\t\tthrow new Meteor.Error('error-invalid-settings', 'Invalid settings field', { method: 'saveAutoTranslateSettings' });\n\t\t}\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, Meteor.userId());\n\t\tif (!subscription) {\n\t\t\tthrow new Meteor.Error('error-invalid-subscription', 'Invalid subscription', { method: 'saveAutoTranslateSettings' });\n\t\t}\n\n\t\tswitch (field) {\n\t\t\tcase 'autoTranslate':\n\t\t\t\tRocketChat.models.Subscriptions.updateAutoTranslateById(subscription._id, value === '1' ? true : false);\n\t\t\t\tif (!subscription.autoTranslateLanguage && options.defaultLanguage) {\n\t\t\t\t\tRocketChat.models.Subscriptions.updateAutoTranslateLanguageById(subscription._id, options.defaultLanguage);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'autoTranslateLanguage':\n\t\t\t\tRocketChat.models.Subscriptions.updateAutoTranslateLanguageById(subscription._id, value);\n\t\t\t\tbreak;\n\t\t}\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\t'autoTranslate.translateMessage'(message, targetLanguage) {\n\t\tconst room = RocketChat.models.Rooms.findOneById(message && message.rid);\n\t\tif (message && room && RocketChat.AutoTranslate) {\n\t\t\treturn RocketChat.AutoTranslate.translateMessage(message, room, targetLanguage);\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'autoTranslate.getSupportedLanguages'(targetLanguage) {\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'auto-translate')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Auto-Translate is not allowed', { method: 'autoTranslate.saveSettings'});\n\t\t}\n\n\t\treturn RocketChat.AutoTranslate.getSupportedLanguages(targetLanguage);\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'autoTranslate.getSupportedLanguages',\n\tuserId(/*userId*/) {\n\t\treturn true;\n\t}\n}, 5, 60000);\n"]}