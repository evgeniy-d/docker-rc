{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:importer-hipchat/info.js","meteor://ðŸ’»app/packages/rocketchat:importer-hipchat/server/importer.js","meteor://ðŸ’»app/packages/rocketchat:importer-hipchat/server/adder.js"],"names":["module","export","HipChatImporterInfo","ImporterInfo","watch","require","v","constructor","HipChatImporter","Base","ProgressStep","Selection","SelectionChannel","SelectionUser","_","default","s","moment","info","userTags","roomPrefix","usersPrefix","prepare","dataURI","sentContentType","fileName","image","RocketChatFile","dataURIParse","zip","AdmZip","Buffer","zipEntries","getEntries","tempRooms","tempUsers","tempMessages","forEach","entry","entryName","indexOf","logger","debug","isDirectory","roomName","split","updateProgress","PREPARING_CHANNELS","JSON","parse","getData","toString","rooms","room","name","slugify","item","msgGroupData","error","warn","usersName","PREPARING_USERS","users","usersId","collection","insert","importRecord","_id","findOne","updateRecord","length","addCountToTotal","channelsId","channels","PREPARING_MESSAGES","messagesCount","Object","keys","channel","messagesObj","messages","date","msgs","getBSONSize","getMaxBSONSize","getBSONSafeArraysFromAnArray","splitMsg","i","messagesId","ERROR","getProgress","selectionUsers","map","user","user_id","email","is_deleted","is_bot","selectionChannels","room_id","is_archived","selectionMessages","count","USER_SELECTION","startImport","importSelection","start","Date","now","u","do_import","update","$set","c","channel_id","startedByUserId","Meteor","userId","defer","IMPORTING_USERS","runAsUser","existantUser","RocketChat","models","Users","findOneByEmailAddress","rocketId","push","hipchat","mention_name","rocket","username","Accounts","createUser","password","toUpperCase","call","joinDefaultChannelsSilenced","photo_url","undefined","parseInt","tz","timezone","format","setName","addCountCompleted","IMPORTING_CHANNELS","replace","existantRoom","Rooms","findOneByName","owner_user_id","returned","rid","created","IMPORTING_MESSAGES","nousers","hipchatChannel","getHipChatChannelFromName","findOneById","fields","usernames","t","message","from","getRocketUser","msgObj","msg","convertHipChatMessageToRocketChat","ts","sendMessage","isArray","console","FINISHING","DONE","e","timeTook","log","channelName","find","hipchatId","userReplace","getSelection","Importers","add"],"mappings":"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","file":"/packages/rocketchat_importer-hipchat.js","sourcesContent":["import { ImporterInfo } from 'meteor/rocketchat:importer';\n\nexport class HipChatImporterInfo extends ImporterInfo {\n\tconstructor() {\n\t\tsuper('hipchat', 'HipChat', 'application/zip');\n\t}\n}\n","import {\n\tBase,\n\tProgressStep,\n\tSelection,\n\tSelectionChannel,\n\tSelectionUser\n} from 'meteor/rocketchat:importer';\n\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport moment from 'moment';\n\nimport 'moment-timezone';\n\nexport class HipChatImporter extends Base {\n\tconstructor(info) {\n\t\tsuper(info);\n\n\t\tthis.userTags = [];\n\t\tthis.roomPrefix = 'hipchat_export/rooms/';\n\t\tthis.usersPrefix = 'hipchat_export/users/';\n\t}\n\n\tprepare(dataURI, sentContentType, fileName) {\n\t\tsuper.prepare(dataURI, sentContentType, fileName);\n\t\tconst image = RocketChatFile.dataURIParse(dataURI).image;\n\t\t// const contentType = ref.contentType;\n\t\tconst zip = new this.AdmZip(new Buffer(image, 'base64'));\n\t\tconst zipEntries = zip.getEntries();\n\t\tlet tempRooms = [];\n\t\tlet tempUsers = [];\n\t\tconst tempMessages = {};\n\n\t\tzipEntries.forEach(entry => {\n\t\t\tif (entry.entryName.indexOf('__MACOSX') > -1) {\n\t\t\t\tthis.logger.debug(`Ignoring the file: ${ entry.entryName }`);\n\t\t\t}\n\t\t\tif (entry.isDirectory) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (entry.entryName.indexOf(this.roomPrefix) > -1) {\n\t\t\t\tlet roomName = entry.entryName.split(this.roomPrefix)[1];\n\t\t\t\tif (roomName === 'list.json') {\n\t\t\t\t\tsuper.updateProgress(ProgressStep.PREPARING_CHANNELS);\n\t\t\t\t\ttempRooms = JSON.parse(entry.getData().toString()).rooms;\n\t\t\t\t\ttempRooms.forEach(room => {\n\t\t\t\t\t\troom.name = s.slugify(room.name);\n\t\t\t\t\t});\n\t\t\t\t} else if (roomName.indexOf('/') > -1) {\n\t\t\t\t\tconst item = roomName.split('/');\n\t\t\t\t\troomName = s.slugify(item[0]);\n\t\t\t\t\tconst msgGroupData = item[1].split('.')[0];\n\t\t\t\t\tif (!tempMessages[roomName]) {\n\t\t\t\t\t\ttempMessages[roomName] = {};\n\t\t\t\t\t}\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn tempMessages[roomName][msgGroupData] = JSON.parse(entry.getData().toString());\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\treturn this.logger.warn(`${ entry.entryName } is not a valid JSON file! Unable to import it.`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (entry.entryName.indexOf(this.usersPrefix) > -1) {\n\t\t\t\tconst usersName = entry.entryName.split(this.usersPrefix)[1];\n\t\t\t\tif (usersName === 'list.json') {\n\t\t\t\t\tsuper.updateProgress(ProgressStep.PREPARING_USERS);\n\t\t\t\t\treturn tempUsers = JSON.parse(entry.getData().toString()).users;\n\t\t\t\t} else {\n\t\t\t\t\treturn this.logger.warn(`Unexpected file in the ${ this.name } import: ${ entry.entryName }`);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tconst usersId = this.collection.insert({\n\t\t\t'import': this.importRecord._id,\n\t\t\t'importer': this.name,\n\t\t\t'type': 'users',\n\t\t\t'users': tempUsers\n\t\t});\n\t\tthis.users = this.collection.findOne(usersId);\n\t\tthis.updateRecord({\n\t\t\t'count.users': tempUsers.length\n\t\t});\n\t\tthis.addCountToTotal(tempUsers.length);\n\t\tconst channelsId = this.collection.insert({\n\t\t\t'import': this.importRecord._id,\n\t\t\t'importer': this.name,\n\t\t\t'type': 'channels',\n\t\t\t'channels': tempRooms\n\t\t});\n\t\tthis.channels = this.collection.findOne(channelsId);\n\t\tthis.updateRecord({\n\t\t\t'count.channels': tempRooms.length\n\t\t});\n\t\tthis.addCountToTotal(tempRooms.length);\n\t\tsuper.updateProgress(ProgressStep.PREPARING_MESSAGES);\n\t\tlet messagesCount = 0;\n\t\tObject.keys(tempMessages).forEach(channel => {\n\t\t\tconst messagesObj = tempMessages[channel];\n\t\t\tthis.messages[channel] = this.messages[channel] || {};\n\t\t\tObject.keys(messagesObj).forEach(date => {\n\t\t\t\tconst msgs = messagesObj[date];\n\t\t\t\tmessagesCount += msgs.length;\n\t\t\t\tthis.updateRecord({\n\t\t\t\t\t'messagesstatus': `${ channel }/${ date }`\n\t\t\t\t});\n\t\t\t\tif (Base.getBSONSize(msgs) > Base.getMaxBSONSize()) {\n\t\t\t\t\tBase.getBSONSafeArraysFromAnArray(msgs).forEach((splitMsg, i) => {\n\t\t\t\t\t\tconst messagesId = this.collection.insert({\n\t\t\t\t\t\t\t'import': this.importRecord._id,\n\t\t\t\t\t\t\t'importer': this.name,\n\t\t\t\t\t\t\t'type': 'messages',\n\t\t\t\t\t\t\t'name': `${ channel }/${ date }.${ i }`,\n\t\t\t\t\t\t\t'messages': splitMsg\n\t\t\t\t\t\t});\n\t\t\t\t\t\tthis.messages[channel][`${ date }.${ i }`] = this.collection.findOne(messagesId);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tconst messagesId = this.collection.insert({\n\t\t\t\t\t\t'import': this.importRecord._id,\n\t\t\t\t\t\t'importer': this.name,\n\t\t\t\t\t\t'type': 'messages',\n\t\t\t\t\t\t'name': `${ channel }/${ date }`,\n\t\t\t\t\t\t'messages': msgs\n\t\t\t\t\t});\n\t\t\t\t\tthis.messages[channel][date] = this.collection.findOne(messagesId);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\tthis.updateRecord({\n\t\t\t'count.messages': messagesCount,\n\t\t\t'messagesstatus': null\n\t\t});\n\t\tthis.addCountToTotal(messagesCount);\n\t\tif (tempUsers.length === 0 || tempRooms.length === 0 || messagesCount === 0) {\n\t\t\tthis.logger.warn(`The loaded users count ${ tempUsers.length }, the loaded channels ${ tempRooms.length }, and the loaded messages ${ messagesCount }`);\n\t\t\tsuper.updateProgress(ProgressStep.ERROR);\n\t\t\treturn this.getProgress();\n\t\t}\n\t\tconst selectionUsers = tempUsers.map(function(user) {\n\t\t\treturn new SelectionUser(user.user_id, user.name, user.email, user.is_deleted, false, !user.is_bot);\n\t\t});\n\t\tconst selectionChannels = tempRooms.map(function(room) {\n\t\t\treturn new SelectionChannel(room.room_id, room.name, room.is_archived, true, false);\n\t\t});\n\t\tconst selectionMessages = this.importRecord.count.messages;\n\t\tsuper.updateProgress(ProgressStep.USER_SELECTION);\n\t\treturn new Selection(this.name, selectionUsers, selectionChannels, selectionMessages);\n\t}\n\n\tstartImport(importSelection) {\n\t\tsuper.startImport(importSelection);\n\t\tconst start = Date.now();\n\n\t\timportSelection.users.forEach(user => {\n\t\t\tthis.users.users.forEach(u => {\n\t\t\t\tif (u.user_id === user.user_id) {\n\t\t\t\t\tu.do_import = user.do_import;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\tthis.collection.update({_id: this.users._id}, { $set: { 'users': this.users.users } });\n\n\t\timportSelection.channels.forEach(channel =>\n\t\t\tthis.channels.channels.forEach(c => c.room_id === channel.channel_id && (c.do_import = channel.do_import))\n\t\t);\n\t\tthis.collection.update({ _id: this.channels._id }, { $set: { 'channels': this.channels.channels }});\n\n\t\tconst startedByUserId = Meteor.userId();\n\t\tMeteor.defer(() => {\n\t\t\tsuper.updateProgress(ProgressStep.IMPORTING_USERS);\n\n\t\t\ttry {\n\t\t\t\tthis.users.users.forEach(user => {\n\t\t\t\t\tif (!user.do_import) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tconst existantUser = RocketChat.models.Users.findOneByEmailAddress(user.email);\n\t\t\t\t\t\tif (existantUser) {\n\t\t\t\t\t\t\tuser.rocketId = existantUser._id;\n\t\t\t\t\t\t\tthis.userTags.push({\n\t\t\t\t\t\t\t\thipchat: `@${ user.mention_name }`,\n\t\t\t\t\t\t\t\trocket: `@${ existantUser.username }`\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst userId = Accounts.createUser({\n\t\t\t\t\t\t\t\temail: user.email,\n\t\t\t\t\t\t\t\tpassword: Date.now() + user.name + user.email.toUpperCase()\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tuser.rocketId = userId;\n\t\t\t\t\t\t\tthis.userTags.push({\n\t\t\t\t\t\t\t\thipchat: `@${ user.mention_name }`,\n\t\t\t\t\t\t\t\trocket: `@${ user.mention_name }`\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tMeteor.runAsUser(userId, () => {\n\t\t\t\t\t\t\t\tMeteor.call('setUsername', user.mention_name, {\n\t\t\t\t\t\t\t\t\tjoinDefaultChannelsSilenced: true\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tMeteor.call('setAvatarFromService', user.photo_url, undefined, 'url');\n\t\t\t\t\t\t\t\treturn Meteor.call('userSetUtcOffset', parseInt(moment().tz(user.timezone).format('Z').toString().split(':')[0]));\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (user.name != null) {\n\t\t\t\t\t\t\t\tRocketChat.models.Users.setName(userId, user.name);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (user.is_deleted) {\n\t\t\t\t\t\t\t\tMeteor.call('setUserActiveStatus', userId, false);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn this.addCountCompleted(1);\n\t\t\t\t\t});\n\t\t\t\t});\n\n\t\t\t\tthis.collection.update({ _id: this.users._id }, { $set: { 'users': this.users.users }});\n\n\t\t\t\tsuper.updateProgress(ProgressStep.IMPORTING_CHANNELS);\n\t\t\t\tthis.channels.channels.forEach(channel => {\n\t\t\t\t\tif (!channel.do_import) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tchannel.name = channel.name.replace(/ /g, '');\n\t\t\t\t\t\tconst existantRoom = RocketChat.models.Rooms.findOneByName(channel.name);\n\t\t\t\t\t\tif (existantRoom) {\n\t\t\t\t\t\t\tchannel.rocketId = existantRoom._id;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlet userId = '';\n\t\t\t\t\t\t\tthis.users.users.forEach(user => {\n\t\t\t\t\t\t\t\tif (user.user_id === channel.owner_user_id) {\n\t\t\t\t\t\t\t\t\tuserId = user.rocketId;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (userId === '') {\n\t\t\t\t\t\t\t\tthis.logger.warn(`Failed to find the channel creator for ${ channel.name }, setting it to the current running user.`);\n\t\t\t\t\t\t\t\tuserId = startedByUserId;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tMeteor.runAsUser(userId, () => {\n\t\t\t\t\t\t\t\tconst returned = Meteor.call('createChannel', channel.name, []);\n\t\t\t\t\t\t\t\treturn channel.rocketId = returned.rid;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tRocketChat.models.Rooms.update({\n\t\t\t\t\t\t\t\t_id: channel.rocketId\n\t\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\t\t'ts': new Date(channel.created * 1000)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn this.addCountCompleted(1);\n\t\t\t\t\t});\n\t\t\t\t});\n\n\t\t\t\tthis.collection.update({ _id: this.channels._id }, { $set: { 'channels': this.channels.channels }});\n\n\t\t\t\tsuper.updateProgress(ProgressStep.IMPORTING_MESSAGES);\n\t\t\t\tconst nousers = {};\n\n\t\t\t\tObject.keys(this.messages).forEach(channel => {\n\t\t\t\t\tconst messagesObj = this.messages[channel];\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tconst hipchatChannel = this.getHipChatChannelFromName(channel);\n\t\t\t\t\t\tif (hipchatChannel != null ? hipchatChannel.do_import : undefined) {\n\t\t\t\t\t\t\tconst room = RocketChat.models.Rooms.findOneById(hipchatChannel.rocketId, {\n\t\t\t\t\t\t\t\tfields: {\n\t\t\t\t\t\t\t\t\tusernames: 1,\n\t\t\t\t\t\t\t\t\tt: 1,\n\t\t\t\t\t\t\t\t\tname: 1\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tObject.keys(messagesObj).forEach(date => {\n\t\t\t\t\t\t\t\tconst msgs = messagesObj[date];\n\t\t\t\t\t\t\t\tthis.updateRecord({\n\t\t\t\t\t\t\t\t\t'messagesstatus': `${ channel }/${ date }.${ msgs.messages.length }`\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\tmsgs.messages.forEach(message => {\n\t\t\t\t\t\t\t\t\tif (message.from != null) {\n\t\t\t\t\t\t\t\t\t\tconst user = this.getRocketUser(message.from.user_id);\n\t\t\t\t\t\t\t\t\t\tif (user != null) {\n\t\t\t\t\t\t\t\t\t\t\tconst msgObj = {\n\t\t\t\t\t\t\t\t\t\t\t\tmsg: this.convertHipChatMessageToRocketChat(message.message),\n\t\t\t\t\t\t\t\t\t\t\t\tts: new Date(message.date),\n\t\t\t\t\t\t\t\t\t\t\t\tu: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t_id: user._id,\n\t\t\t\t\t\t\t\t\t\t\t\t\tusername: user.username\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t\tRocketChat.sendMessage(user, msgObj, room, true);\n\t\t\t\t\t\t\t\t\t\t} else if (!nousers[message.from.user_id]) {\n\t\t\t\t\t\t\t\t\t\t\tnousers[message.from.user_id] = message.from;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t} else if (!_.isArray(message)) {\n\t\t\t\t\t\t\t\t\t\tconsole.warn('Please report the following:', message);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tthis.addCountCompleted(1);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\n\t\t\t\tthis.logger.warn('The following did not have users:', nousers);\n\t\t\t\tsuper.updateProgress(ProgressStep.FINISHING);\n\n\t\t\t\tthis.channels.channels.forEach(channel => {\n\t\t\t\t\tif (channel.do_import && channel.is_archived) {\n\t\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\t\treturn Meteor.call('archiveRoom', channel.rocketId);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tsuper.updateProgress(ProgressStep.DONE);\n\t\t\t} catch (e) {\n\t\t\t\tthis.logger.error(e);\n\t\t\t\tsuper.updateProgress(ProgressStep.ERROR);\n\t\t\t}\n\n\t\t\tconst timeTook = Date.now() - start;\n\t\t\treturn this.logger.log(`Import took ${ timeTook } milliseconds.`);\n\t\t});\n\n\t\treturn this.getProgress();\n\t}\n\n\tgetHipChatChannelFromName(channelName) {\n\t\treturn this.channels.channels.find(channel => channel.name === channelName);\n\t}\n\n\tgetRocketUser(hipchatId) {\n\t\tconst user = this.users.users.find(user => user.user_id === hipchatId);\n\t\treturn user ? RocketChat.models.Users.findOneById(user.rocketId, {\n\t\t\tfields: {\n\t\t\t\tusername: 1,\n\t\t\t\tname: 1\n\t\t\t}\n\t\t}) : undefined;\n\t}\n\n\tconvertHipChatMessageToRocketChat(message) {\n\t\tif (message != null) {\n\t\t\tthis.userTags.forEach(userReplace => {\n\t\t\t\tmessage = message.replace(userReplace.hipchat, userReplace.rocket);\n\t\t\t});\n\t\t} else {\n\t\t\tmessage = '';\n\t\t}\n\t\treturn message;\n\t}\n\n\tgetSelection() {\n\t\tconst selectionUsers = this.users.users.map(function(user) {\n\t\t\treturn new SelectionUser(user.user_id, user.name, user.email, user.is_deleted, false, !user.is_bot);\n\t\t});\n\t\tconst selectionChannels = this.channels.channels.map(function(room) {\n\t\t\treturn new SelectionChannel(room.room_id, room.name, room.is_archived, true, false);\n\t\t});\n\t\treturn new Selection(this.name, selectionUsers, selectionChannels, this.importRecord.count.messages);\n\t}\n}\n","import { Importers } from 'meteor/rocketchat:importer';\nimport { HipChatImporterInfo } from '../info';\nimport { HipChatImporter } from './importer';\n\nImporters.add(new HipChatImporterInfo(), HipChatImporter);\n"]}