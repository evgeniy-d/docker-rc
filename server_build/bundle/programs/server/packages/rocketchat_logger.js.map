{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:logger/server/server.js"],"names":["module","export","SystemLogger","StdOut","LoggerManager","processString","Logger","_","watch","require","default","v","s","EventEmitter","constructor","enabled","loggers","queue","showPackage","showFileAndLine","logLevel","register","logger","name","emit","addToQueue","args","push","dispatchQueue","each","item","_log","apply","clearQueue","disable","enable","defaultTypes","debug","color","level","log","info","success","warn","error","_Logger","config","self","Object","assign","typeConfig","type","call","section","__section","method","box","methods","sections","getPrefix","options","prefix","details","_getCallerDetails","detailParts","file","line","length","join","getStack","stack","Error","lines","split","splice","index","len","match","exec","slice","packageMatch","makeABox","message","title","isArray","Math","max","map","topLine","pad","separator","lrpad","rpad","arguments","isString","undefined","subPrefix","console","forEach","unshift","global","string","date","obj","EJSON","parse","time","Log","format","startup","write","process","stdout","Date","id","Random","ts","RocketChat","limit","settings","get","shift","Meteor","publish","userId","authz","hasPermission","ready","added","on"],"mappings":"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","file":"/packages/rocketchat_logger.js","sourcesContent":["/* globals EventEmitter LoggerManager SystemLogger Log*/\nimport _ from 'underscore';\nimport s from 'underscore.string';\n\n//TODO: change this global to import\nLoggerManager = new class extends EventEmitter { // eslint-disable-line no-undef\n\tconstructor() {\n\t\tsuper();\n\t\tthis.enabled = false;\n\t\tthis.loggers = {};\n\t\tthis.queue = [];\n\t\tthis.showPackage = false;\n\t\tthis.showFileAndLine = false;\n\t\tthis.logLevel = 0;\n\t}\n\tregister(logger) {\n\t\tif (!logger instanceof Logger) {\n\t\t\treturn;\n\t\t}\n\t\tthis.loggers[logger.name] = logger;\n\t\tthis.emit('register', logger);\n\t}\n\taddToQueue(logger, args) {\n\t\tthis.queue.push({\n\t\t\tlogger, args\n\t\t});\n\t}\n\tdispatchQueue() {\n\t\t_.each(this.queue, (item) => item.logger._log.apply(item.logger, item.args));\n\t\tthis.clearQueue();\n\t}\n\tclearQueue() {\n\t\tthis.queue = [];\n\t}\n\n\tdisable() {\n\t\tthis.enabled = false;\n\t}\n\n\tenable(dispatchQueue = false) {\n\t\tthis.enabled = true;\n\t\treturn (dispatchQueue === true) ? this.dispatchQueue() : this.clearQueue();\n\t}\n};\n\n\n\nconst defaultTypes = {\n\tdebug: {\n\t\tname: 'debug',\n\t\tcolor: 'blue',\n\t\tlevel: 2\n\t},\n\tlog: {\n\t\tname: 'info',\n\t\tcolor: 'blue',\n\t\tlevel: 1\n\t},\n\tinfo: {\n\t\tname: 'info',\n\t\tcolor: 'blue',\n\t\tlevel: 1\n\t},\n\tsuccess: {\n\t\tname: 'info',\n\t\tcolor: 'green',\n\t\tlevel: 1\n\t},\n\twarn: {\n\t\tname: 'warn',\n\t\tcolor: 'magenta',\n\t\tlevel: 1\n\t},\n\terror: {\n\t\tname: 'error',\n\t\tcolor: 'red',\n\t\tlevel: 0\n\t}\n};\n\nclass _Logger {\n\tconstructor(name, config = {}) {\n\t\tconst self = this;\n\t\tthis.name = name;\n\n\t\tthis.config = Object.assign({}, config);\n\t\tif (LoggerManager.loggers && LoggerManager.loggers[this.name] != null) {\n\t\t\tLoggerManager.loggers[this.name].warn('Duplicated instance');\n\t\t\treturn LoggerManager.loggers[this.name];\n\t\t}\n\t\t_.each(defaultTypes, (typeConfig, type) => {\n\t\t\tthis[type] = function(...args) {\n\t\t\t\treturn self._log.call(self, {\n\t\t\t\t\tsection: this.__section,\n\t\t\t\t\ttype,\n\t\t\t\t\tlevel: typeConfig.level,\n\t\t\t\t\tmethod: typeConfig.name,\n\t\t\t\t\t'arguments': args\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tself[`${ type }_box`] = function(...args) {\n\t\t\t\treturn self._log.call(self, {\n\t\t\t\t\tsection: this.__section,\n\t\t\t\t\ttype,\n\t\t\t\t\tbox: true,\n\t\t\t\t\tlevel: typeConfig.level,\n\t\t\t\t\tmethod: typeConfig.name,\n\t\t\t\t\t'arguments': args\n\t\t\t\t});\n\t\t\t};\n\t\t});\n\t\tif (this.config.methods) {\n\t\t\t_.each(this.config.methods, (typeConfig, method) => {\n\t\t\t\tif (this[method] != null) {\n\t\t\t\t\tself.warn(`Method ${ method } already exists`);\n\t\t\t\t}\n\t\t\t\tif (defaultTypes[typeConfig.type] == null) {\n\t\t\t\t\tself.warn(`Method type ${ typeConfig.type } does not exist`);\n\t\t\t\t}\n\t\t\t\tthis[method] = function(...args) {\n\t\t\t\t\treturn self._log.call(self, {\n\t\t\t\t\t\tsection: this.__section,\n\t\t\t\t\t\ttype: typeConfig.type,\n\t\t\t\t\t\tlevel: typeConfig.level != null ? typeConfig.level : defaultTypes[typeConfig.type] && defaultTypes[typeConfig.type].level,\n\t\t\t\t\t\tmethod,\n\t\t\t\t\t\t'arguments': args\n\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t\tthis[`${ method }_box`] = function(...args) {\n\t\t\t\t\treturn self._log.call(self, {\n\t\t\t\t\t\tsection: this.__section,\n\t\t\t\t\t\ttype: typeConfig.type,\n\t\t\t\t\t\tbox: true,\n\t\t\t\t\t\tlevel: typeConfig.level != null ? typeConfig.level : defaultTypes[typeConfig.type] && defaultTypes[typeConfig.type].level,\n\t\t\t\t\t\tmethod,\n\t\t\t\t\t\t'arguments': args\n\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\t\tif (this.config.sections) {\n\t\t\t_.each(this.config.sections, (name, section) => {\n\t\t\t\tthis[section] = {};\n\t\t\t\t_.each(defaultTypes, (typeConfig, type) => {\n\t\t\t\t\tself[section][type] = (...args) => this[type].apply({__section: name}, args);\n\t\t\t\t\tself[section][`${ type }_box`] = (...args) => this[`${ type }_box`].apply({__section: name}, args);\n\t\t\t\t});\n\t\t\t\t_.each(this.config.methods, (typeConfig, method) => {\n\t\t\t\t\tself[section][method] = (...args) => self[method].apply({__section: name}, args);\n\t\t\t\t\tself[section][`${ method }_box`] = (...args) => self[`${ method }_box`].apply({__section: name}, args);\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tLoggerManager.register(this);\n\t}\n\tgetPrefix(options) {\n\t\tlet prefix = `${ this.name } âž” ${ options.method }`;\n\t\tif (options.section) {\n\t\t\tprefix = `${ this.name } âž” ${ options.section }.${ options.method }`;\n\t\t}\n\t\tconst details = this._getCallerDetails();\n\t\tconst detailParts = [];\n\t\tif (details['package'] && (LoggerManager.showPackage === true || options.type === 'error')) {\n\t\t\tdetailParts.push(details['package']);\n\t\t}\n\t\tif (LoggerManager.showFileAndLine === true || options.type === 'error') {\n\t\t\tif ((details.file != null) && (details.line != null)) {\n\t\t\t\tdetailParts.push(`${ details.file }:${ details.line }`);\n\t\t\t} else {\n\t\t\t\tif (details.file != null) {\n\t\t\t\t\tdetailParts.push(details.file);\n\t\t\t\t}\n\t\t\t\tif (details.line != null) {\n\t\t\t\t\tdetailParts.push(details.line);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (defaultTypes[options.type]) {\n\t\t\t// format the message to a colored message\n\t\t\tprefix = prefix[defaultTypes[options.type].color];\n\t\t}\n\t\tif (detailParts.length > 0) {\n\t\t\tprefix = `${ detailParts.join(' ') } ${ prefix }`;\n\t\t}\n\t\treturn prefix;\n\t}\n\t_getCallerDetails() {\n\t\tconst getStack = () => {\n\t\t\t// We do NOT use Error.prepareStackTrace here (a V8 extension that gets us a\n\t\t\t// core-parsed stack) since it's impossible to compose it with the use of\n\t\t\t// Error.prepareStackTrace used on the server for source maps.\n\t\t\tconst {stack} = new Error();\n\t\t\treturn stack;\n\t\t};\n\t\tconst stack = getStack();\n\t\tif (!stack) {\n\t\t\treturn {};\n\t\t}\n\t\tconst lines = stack.split('\\n').splice(1);\n\t\t// looking for the first line outside the logging package (or an\n\t\t// eval if we find that first)\n\t\tlet line = lines[0];\n\t\tfor (let index = 0, len = lines.length; index < len, index++; line = lines[index]) {\n\t\t\tif (line.match(/^\\s*at eval \\(eval/)) {\n\t\t\t\treturn {file: 'eval'};\n\t\t\t}\n\n\t\t\tif (!line.match(/packages\\/rocketchat_logger(?:\\/|\\.js)/)) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tconst details = {};\n\t\t// The format for FF is 'functionName@filePath:lineNumber'\n\t\t// The format for V8 is 'functionName (packages/logging/logging.js:81)' or\n\t\t//                      'packages/logging/logging.js:81'\n\t\tconst match = /(?:[@(]| at )([^(]+?):([0-9:]+)(?:\\)|$)/.exec(line);\n\t\tif (!match) {\n\t\t\treturn details;\n\t\t}\n\t\tdetails.line = match[2].split(':')[0];\n\t\t// Possible format: https://foo.bar.com/scripts/file.js?random=foobar\n\t\t// XXX: if you can write the following in better way, please do it\n\t\t// XXX: what about evals?\n\t\tdetails.file = match[1].split('/').slice(-1)[0].split('?')[0];\n\t\tconst packageMatch = match[1].match(/packages\\/([^\\.\\/]+)(?:\\/|\\.)/);\n\t\tif (packageMatch) {\n\t\t\tdetails['package'] = packageMatch[1];\n\t\t}\n\t\treturn details;\n\t}\n\tmakeABox(message, title) {\n\t\tif (!_.isArray(message)) {\n\t\t\tmessage = message.split('\\n');\n\t\t}\n\t\tlet len = 0;\n\n\t\tlen = Math.max.apply(null, message.map(line => line.length));\n\n\t\tconst topLine = `+--${ s.pad('', len, '-') }--+`;\n\t\tconst separator = `|  ${ s.pad('', len, '') }  |`;\n\t\tlet lines = [];\n\n\t\tlines.push(topLine);\n\t\tif (title) {\n\t\t\tlines.push(`|  ${ s.lrpad(title, len) }  |`);\n\t\t\tlines.push(topLine);\n\t\t}\n\t\tlines.push(separator);\n\n\t\tlines = [...lines, ...message.map(line => `|  ${ s.rpad(line, len) }  |`)];\n\n\t\tlines.push(separator);\n\t\tlines.push(topLine);\n\t\treturn lines;\n\t}\n\n\t_log(options) {\n\t\tif (LoggerManager.enabled === false) {\n\t\t\tLoggerManager.addToQueue(this, arguments);\n\t\t\treturn;\n\t\t}\n\t\tif (options.level == null) {\n\t\t\toptions.level = 1;\n\t\t}\n\n\t\tif (LoggerManager.logLevel < options.level) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst prefix = this.getPrefix(options);\n\n\t\tif (options.box === true && _.isString(options.arguments[0])) {\n\t\t\tlet color = undefined;\n\t\t\tif (defaultTypes[options.type]) {\n\t\t\t\tcolor = defaultTypes[options.type].color;\n\t\t\t}\n\n\t\t\tconst box = this.makeABox(options.arguments[0], options.arguments[1]);\n\t\t\tlet subPrefix = 'âž”';\n\t\t\tif (color) {\n\t\t\t\tsubPrefix = subPrefix[color];\n\t\t\t}\n\n\t\t\tconsole.log(subPrefix, prefix);\n\t\t\tbox.forEach(line => {\n\t\t\t\tconsole.log(subPrefix, color ? line[color]: line);\n\t\t\t});\n\n\t\t} else {\n\t\t\toptions.arguments.unshift(prefix);\n\t\t\tconsole.log.apply(console, options.arguments);\n\t\t}\n\t}\n}\n// TODO: change this global to import\nLogger = global.Logger = _Logger;\nconst processString = function(string, date) {\n\tlet obj;\n\ttry {\n\t\tif (string[0] === '{') {\n\t\t\tobj = EJSON.parse(string);\n\t\t} else {\n\t\t\tobj = {\n\t\t\t\tmessage: string,\n\t\t\t\ttime: date,\n\t\t\t\tlevel: 'info'\n\t\t\t};\n\t\t}\n\t\treturn Log.format(obj, {color: true});\n\t} catch (error) {\n\t\treturn string;\n\t}\n};\n// TODO: change this global to import\nSystemLogger = new Logger('System', { // eslint-disable-line no-undef\n\tmethods: {\n\t\tstartup: {\n\t\t\ttype: 'success',\n\t\t\tlevel: 0\n\t\t}\n\t}\n});\n\n\nconst StdOut = new class extends EventEmitter {\n\tconstructor() {\n\t\tsuper();\n\t\tconst write = process.stdout.write;\n\t\tthis.queue = [];\n\t\tprocess.stdout.write = (...args) => {\n\t\t\twrite.apply(process.stdout, args);\n\t\t\tconst date = new Date;\n\t\t\tconst string = processString(args[0], date);\n\t\t\tconst item = {\n\t\t\t\tid: Random.id(),\n\t\t\t\tstring,\n\t\t\t\tts: date\n\t\t\t};\n\t\t\tthis.queue.push(item);\n\n\t\t\tif (typeof RocketChat !== 'undefined') {\n\t\t\t\tconst limit = RocketChat.settings.get('Log_View_Limit');\n\t\t\t\tif (limit && this.queue.length > limit) {\n\t\t\t\t\tthis.queue.shift();\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.emit('write', string, item);\n\t\t};\n\t}\n};\n\n\nMeteor.publish('stdout', function() {\n\tif (!this.userId || RocketChat.authz.hasPermission(this.userId, 'view-logs') !== true) {\n\t\treturn this.ready();\n\t}\n\n\tStdOut.queue.forEach(item => {\n\t\tthis.added('stdout', item.id, {\n\t\t\tstring: item.string,\n\t\t\tts: item.ts\n\t\t});\n\t});\n\n\tthis.ready();\n\tStdOut.on('write', (string, item) => {\n\t\tthis.added('stdout', item.id, {\n\t\t\tstring: item.string,\n\t\t\tts: item.ts\n\t\t});\n\t});\n});\n\n\nexport { SystemLogger, StdOut, LoggerManager, processString, Logger };\n"]}