{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:reactions/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:reactions/setReaction.js"],"names":["RocketChat","models","Messages","setReactions","messageId","reactions","update","_id","$set","unsetReactions","$unset","_","module","watch","require","default","v","removeUserReaction","message","reaction","username","usernames","splice","indexOf","length","Meteor","methods","setReaction","shouldReact","userId","Error","method","findOneById","room","call","rid","replace","emoji","list","EmojiCustom","findByNameOrAlias","count","user","Array","isArray","muted","reactWhenReadOnly","Notifications","notifyUser","Random","id","ts","Date","msg","TAPi18n","__","language","Subscriptions","findOne","userAlreadyReacted","Boolean","undefined","isEmpty","callbacks","run","push","msgStream","emit"],"mappings":"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","file":"/packages/rocketchat_reactions.js","sourcesContent":["RocketChat.models.Messages.setReactions = function(messageId, reactions) {\n\treturn this.update({ _id: messageId }, { $set: { reactions }});\n};\n\nRocketChat.models.Messages.unsetReactions = function(messageId) {\n\treturn this.update({ _id: messageId }, { $unset: { reactions: 1 }});\n};\n","/* globals msgStream */\nimport _ from 'underscore';\n\nconst removeUserReaction = (message, reaction, username) => {\n\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(username), 1);\n\tif (message.reactions[reaction].usernames.length === 0) {\n\t\tdelete message.reactions[reaction];\n\t}\n\treturn message;\n};\n\nMeteor.methods({\n\tsetReaction(reaction, messageId, shouldReact) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'setReaction' });\n\t\t}\n\n\t\tconst message = RocketChat.models.Messages.findOneById(messageId);\n\n\t\tif (!message) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'setReaction' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', message.rid, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'setReaction' });\n\t\t}\n\n\t\treaction = `:${ reaction.replace(/:/g, '') }:`;\n\n\t\tif (!RocketChat.emoji.list[reaction] && RocketChat.models.EmojiCustom.findByNameOrAlias(reaction).count() === 0) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Invalid emoji provided.', { method: 'setReaction' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (Array.isArray(room.muted) && room.muted.indexOf(user.username) !== -1 && !room.reactWhenReadOnly) {\n\t\t\tRocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {\n\t\t\t\t_id: Random.id(),\n\t\t\t\trid: room._id,\n\t\t\t\tts: new Date(),\n\t\t\t\tmsg: TAPi18n.__('You_have_been_muted', {}, user.language)\n\t\t\t});\n\t\t\treturn false;\n\t\t} else if (!RocketChat.models.Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst userAlreadyReacted = Boolean(message.reactions) && Boolean(message.reactions[reaction]) && message.reactions[reaction].usernames.indexOf(user.username) !== -1;\n\t\t// When shouldReact was not informed, toggle the reaction.\n\t\tif (shouldReact === undefined) {\n\t\t\tshouldReact = !userAlreadyReacted;\n\t\t}\n\n\t\tif (userAlreadyReacted === shouldReact) {\n\t\t\treturn;\n\t\t}\n\t\tif (userAlreadyReacted) {\n\t\t\tremoveUserReaction(message, reaction, user.username);\n\n\t\t\tif (_.isEmpty(message.reactions)) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tRocketChat.models.Messages.unsetReactions(messageId);\n\t\t\t\tRocketChat.callbacks.run('unsetReaction', messageId, reaction);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: []\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t}\n\n\t\tmsgStream.emit(message.rid, message);\n\n\t\treturn;\n\t}\n});\n"]}