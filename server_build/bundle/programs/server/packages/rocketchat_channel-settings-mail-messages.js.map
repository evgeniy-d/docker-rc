{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:channel-settings-mail-messages/server/lib/startup.js","meteor://ðŸ’»app/packages/rocketchat:channel-settings-mail-messages/server/methods/mailMessages.js"],"names":["Meteor","startup","permission","_id","roles","RocketChat","models","Permissions","upsert","$setOnInsert","_","module","watch","require","default","v","moment","methods","data","userId","Error","method","check","Match","ObjectIncluding","rid","String","to_users","to_emails","subject","messages","language","room","call","authz","hasPermission","action","rfcMailPatternWithName","emails","compact","trim","split","missing","length","each","username","user","Users","findOneByUsername","address","push","console","log","email","test","shift","toLowerCase","localeFn","Function","locale","header","placeholders","replace","settings","get","footer","html","Messages","findByRoomIdAndMessageIds","sort","ts","map","message","dateTime","format","u","Message","parse","join","defer","Email","send","to","from","replyTo","success"],"mappings":"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","file":"/packages/rocketchat_channel-settings-mail-messages.js","sourcesContent":["Meteor.startup(function() {\n\tconst permission = {\n\t\t_id: 'mail-messages',\n\t\troles: ['admin']\n\t};\n\treturn RocketChat.models.Permissions.upsert(permission._id, {\n\t\t$setOnInsert: permission\n\t});\n});\n","import _ from 'underscore';\nimport moment from 'moment';\n\nMeteor.methods({\n\t'mailMessages'(data) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'mailMessages'\n\t\t\t});\n\t\t}\n\t\tcheck(data, Match.ObjectIncluding({\n\t\t\trid: String,\n\t\t\tto_users: [String],\n\t\t\tto_emails: String,\n\t\t\tsubject: String,\n\t\t\tmessages: [String],\n\t\t\tlanguage: String\n\t\t}));\n\t\tconst room = Meteor.call('canAccessRoom', data.rid, Meteor.userId());\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', {\n\t\t\t\tmethod: 'mailMessages'\n\t\t\t});\n\t\t}\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'mail-messages')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Mailing is not allowed', {\n\t\t\t\tmethod: 'mailMessages',\n\t\t\t\taction: 'Mailing'\n\t\t\t});\n\t\t}\n\t\tconst rfcMailPatternWithName = /^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/;\n\t\tconst emails = _.compact(data.to_emails.trim().split(','));\n\t\tconst missing = [];\n\t\tif (data.to_users.length > 0) {\n\t\t\t_.each(data.to_users, (username) => {\n\t\t\t\tconst user = RocketChat.models.Users.findOneByUsername(username);\n\t\t\t\tif (user && user.emails && user.emails[0] && user.emails[0].address) {\n\t\t\t\t\temails.push(user.emails[0].address);\n\t\t\t\t} else {\n\t\t\t\t\tmissing.push(username);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tconsole.log('Sending messages to e-mails: ', emails);\n\t\t_.each(emails, (email) => {\n\t\t\tif (!rfcMailPatternWithName.test(email.trim())) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email', `Invalid email ${ email }`, {\n\t\t\t\t\tmethod: 'mailMessages',\n\t\t\t\t\temail\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t\tconst user = Meteor.user();\n\t\tconst email = user.emails && user.emails[0] && user.emails[0].address;\n\t\tdata.language = data.language.split('-').shift().toLowerCase();\n\t\tif (data.language !== 'en') {\n\t\t\tconst localeFn = Meteor.call('loadLocale', data.language);\n\t\t\tif (localeFn) {\n\t\t\t\tFunction(localeFn).call({moment});\n\t\t\t\tmoment.locale(data.language);\n\t\t\t}\n\t\t}\n\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\t\tconst html = RocketChat.models.Messages.findByRoomIdAndMessageIds(data.rid, data.messages, {\n\t\t\tsort: {\tts: 1 }\n\t\t}).map(function(message) {\n\t\t\tconst dateTime = moment(message.ts).locale(data.language).format('L LT');\n\t\t\treturn `<p style='margin-bottom: 5px'><b>${ message.u.username }</b> <span style='color: #aaa; font-size: 12px'>${ dateTime }</span><br/>${ RocketChat.Message.parse(message, data.language) }</p>`;\n\t\t}).join('');\n\n\t\tMeteor.defer(function() {\n\t\t\tEmail.send({\n\t\t\t\tto: emails,\n\t\t\t\tfrom: RocketChat.settings.get('From_Email'),\n\t\t\t\treplyTo: email,\n\t\t\t\tsubject: data.subject,\n\t\t\t\thtml: header + html + footer\n\t\t\t});\n\t\t\treturn console.log(`Sending email to ${ emails.join(', ') }`);\n\t\t});\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmissing\n\t\t};\n\t}\n});\n"]}