{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/models/SmarshHistory.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/functions/sendEmail.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/functions/generateEml.js","meteor://ðŸ’»app/packages/rocketchat:smarsh-connector/server/startup.js"],"names":["RocketChat","smarsh","moment","module","watch","require","default","v","settings","addGroup","addSettings","add","type","i18nLabel","enableQuery","_id","value","$exists","$ne","placeholder","zoneValues","tz","names","map","_timeZonesToSettings","name","key","values","History","models","_Base","constructor","_","sendEmail","data","attachments","files","length","each","fileId","file","Uploads","findOneById","store","rs","UploadFS","getStore","getReadStream","push","filename","streamSource","Email","send","to","get","from","subject","html","body","start","end","opentr","closetr","open20td","open60td","closetd","_getLink","attachment","url","title_link","replace","Meteor","public","sandstorm","match","absoluteUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","generateEml","defer","smarshMissingEmail","timeZone","Rooms","find","forEach","room","smarshHistory","findOne","query","rid","ts","$gt","lastRan","date","Date","rows","users","msgs","time","diff","usernames","join","Messages","message","format","sender","Users","u","indexOf","emails","address","t","messageType","MessageTypes","getType","TAPi18n","__","msg","title","attaches","_loopThroughMessageAttachments","a","image_url","result","upsert","lastResult","smarshJobName","_addSmarshSyncedCronJob","debounce","bindEnvironment","__addSmarshSyncedCronJobDebounced","SyncedCron","nextScheduledAtDate","remove","schedule","parser","text","job","startup"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAAA,WAAWC,MAAX,GAAoB,EAApB,C;;;;;;;;;;;ACAA,IAAIC,MAAJ;AAAWC,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAACC,UAAQC,CAAR,EAAU;AAACL,aAAOK,CAAP;AAAS;;AAArB,CAA/B,EAAsD,CAAtD;AAAyDJ,OAAOC,KAAP,CAAaC,QAAQ,iBAAR,CAAb;AAGpEL,WAAWQ,QAAX,CAAoBC,QAApB,CAA6B,QAA7B,EAAuC,SAASC,WAAT,GAAuB;AAC7D,OAAKC,GAAL,CAAS,gBAAT,EAA2B,KAA3B,EAAkC;AACjCC,UAAM,SAD2B;AAEjCC,eAAW,gBAFsB;AAGjCC,iBAAa;AACZC,WAAK,YADO;AAEZC,aAAO;AACNC,iBAAS,CADH;AAENC,aAAK;AAFC;AAFK;AAHoB,GAAlC;AAWA,OAAKP,GAAL,CAAS,cAAT,EAAyB,EAAzB,EAA6B;AAC5BC,UAAM,QADsB;AAE5BC,eAAW,cAFiB;AAG5BM,iBAAa;AAHe,GAA7B;AAKA,OAAKR,GAAL,CAAS,2BAAT,EAAsC,sBAAtC,EAA8D;AAC7DC,UAAM,QADuD;AAE7DC,eAAW,2BAFkD;AAG7DM,iBAAa;AAHgD,GAA9D;AAMA,QAAMC,aAAalB,OAAOmB,EAAP,CAAUC,KAAV,GAAkBC,GAAlB,CAAsB,SAASC,oBAAT,CAA8BC,IAA9B,EAAoC;AAC5E,WAAO;AACNC,WAAKD,IADC;AAENZ,iBAAWY;AAFL,KAAP;AAIA,GALkB,CAAnB;AAMA,OAAKd,GAAL,CAAS,iBAAT,EAA4B,qBAA5B,EAAmD;AAClDC,UAAM,QAD4C;AAElDe,YAAQP;AAF0C,GAAnD;AAKA,OAAKT,GAAL,CAAS,iBAAT,EAA4B,kBAA5B,EAAgD;AAC/CC,UAAM,QADyC;AAE/Ce,YAAQ,CAAC;AACRD,WAAK,kBADG;AAERb,iBAAW;AAFH,KAAD,EAGL;AACFa,WAAK,kBADH;AAEFb,iBAAW;AAFT,KAHK,EAML;AACFa,WAAK,eADH;AAEFb,iBAAW;AAFT,KANK,EASL;AACFa,WAAK,eADH;AAEFb,iBAAW;AAFT,KATK,CAFuC;AAe/CC,iBAAa;AACZC,WAAK,YADO;AAEZC,aAAO;AACNC,iBAAS,CADH;AAENC,aAAK;AAFC;AAFK;AAfkC,GAAhD;AAuBA,CAzDD,E;;;;;;;;;;;ACHAlB,WAAWC,MAAX,CAAkB2B,OAAlB,GAA4B,IAAI,cAAc5B,WAAW6B,MAAX,CAAkBC,KAAhC,CAAsC;AACrEC,gBAAc;AACb,UAAM,gBAAN;AACA;;AAHoE,CAA1C,EAA5B,C;;;;;;;;;;;ACAA,IAAIC,CAAJ;;AAAM7B,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACyB,QAAEzB,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;;AAUNP,WAAWC,MAAX,CAAkBgC,SAAlB,GAA+BC,IAAD,IAAU;AACvC,QAAMC,cAAc,EAApB;;AAEA,MAAID,KAAKE,KAAL,CAAWC,MAAX,GAAoB,CAAxB,EAA2B;AAC1BL,MAAEM,IAAF,CAAOJ,KAAKE,KAAZ,EAAoBG,MAAD,IAAY;AAC9B,YAAMC,OAAOxC,WAAW6B,MAAX,CAAkBY,OAAlB,CAA0BC,WAA1B,CAAsCH,MAAtC,CAAb;;AACA,UAAIC,KAAKG,KAAL,KAAe,oBAAf,IAAuCH,KAAKG,KAAL,KAAe,YAA1D,EAAwE;AACvE,cAAMC,KAAKC,SAASC,QAAT,CAAkBN,KAAKG,KAAvB,EAA8BI,aAA9B,CAA4CR,MAA5C,EAAoDC,IAApD,CAAX;AACAL,oBAAYa,IAAZ,CAAiB;AAChBC,oBAAUT,KAAKf,IADC;AAEhByB,wBAAcN;AAFE,SAAjB;AAIA;AACD,KATD;AAUA;;AAEDO,QAAMC,IAAN,CAAW;AACVC,QAAIrD,WAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,cAAxB,CADM;AAEVC,UAAMvD,WAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,YAAxB,CAFI;AAGVE,aAAStB,KAAKsB,OAHJ;AAIVC,UAAMvB,KAAKwB,IAJD;AAKVvB;AALU,GAAX;AAOA,CAvBD,C;;;;;;;;;;;ACVA,IAAIH,CAAJ;;AAAM7B,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACyB,QAAEzB,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIL,MAAJ;AAAWC,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAACC,UAAQC,CAAR,EAAU;AAACL,aAAOK,CAAP;AAAS;;AAArB,CAA/B,EAAsD,CAAtD;AAAyDJ,OAAOC,KAAP,CAAaC,QAAQ,iBAAR,CAAb;AAIlI,MAAMsD,QAAQ,mKAAd;AACA,MAAMC,MAAM,kBAAZ;AACA,MAAMC,SAAS,iCAAf;AACA,MAAMC,UAAU,OAAhB;AACA,MAAMC,WAAW,iEAAjB;AACA,MAAMC,WAAW,+EAAjB;AACA,MAAMC,UAAU,OAAhB;;AAEA,SAASC,QAAT,CAAkBC,UAAlB,EAA8B;AAC7B,QAAMC,MAAMD,WAAWE,UAAX,CAAsBC,OAAtB,CAA8B,IAA9B,EAAoC,KAApC,CAAZ;;AAEA,MAAIC,OAAO/D,QAAP,CAAgBgE,MAAhB,CAAuBC,SAAvB,IAAoCL,IAAIM,KAAJ,CAAU,kBAAV,CAAxC,EAAuE;AACtE,WAAON,GAAP;AACA,GAFD,MAEO;AACN,WAAOG,OAAOI,WAAP,GAAqBL,OAArB,CAA6B,KAA7B,EAAoC,EAApC,IAA0CM,0BAA0BC,oBAApE,GAA2FT,GAAlG;AACA;AACD;;AAEDpE,WAAWC,MAAX,CAAkB6E,WAAlB,GAAgC,MAAM;AACrCP,SAAOQ,KAAP,CAAa,MAAM;AAClB,UAAMC,qBAAqBhF,WAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,2BAAxB,CAA3B;AACA,UAAM2B,WAAWjF,WAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,iBAAxB,CAAjB;AAEAtD,eAAW6B,MAAX,CAAkBqD,KAAlB,CAAwBC,IAAxB,GAA+BC,OAA/B,CAAwCC,IAAD,IAAU;AAChD,YAAMC,gBAAgBtF,WAAWC,MAAX,CAAkB2B,OAAlB,CAA0B2D,OAA1B,CAAkC;AAAExE,aAAKsE,KAAKtE;AAAZ,OAAlC,CAAtB;AACA,YAAMyE,QAAQ;AAAEC,aAAKJ,KAAKtE;AAAZ,OAAd;;AAEA,UAAIuE,aAAJ,EAAmB;AAClBE,cAAME,EAAN,GAAW;AAAEC,eAAKL,cAAcM;AAArB,SAAX;AACA;;AAED,YAAMC,OAAO,IAAIC,IAAJ,EAAb;AACA,YAAMC,OAAO,EAAb;AACA,YAAM7D,OAAO;AACZ8D,eAAO,EADK;AAEZC,cAAM,CAFM;AAGZ7D,eAAO,EAHK;AAIZ8D,cAAMZ,gBAAgBpF,OAAO2F,IAAP,EAAaM,IAAb,CAAkBjG,OAAOoF,cAAcM,OAArB,CAAlB,EAAiD,SAAjD,CAAhB,GAA8E1F,OAAO2F,IAAP,EAAaM,IAAb,CAAkBjG,OAAOmF,KAAKK,EAAZ,CAAlB,EAAmC,SAAnC,CAJxE;AAKZL,cAAMA,KAAK5D,IAAL,GAAa,IAAI4D,KAAK5D,IAAM,EAA5B,GAAiC,2BAA2B4D,KAAKe,SAAL,CAAeC,IAAf,CAAoB,KAApB,CAA4B;AALlF,OAAb;AAQArG,iBAAW6B,MAAX,CAAkByE,QAAlB,CAA2BnB,IAA3B,CAAgCK,KAAhC,EAAuCJ,OAAvC,CAAgDmB,OAAD,IAAa;AAC3DR,aAAK/C,IAAL,CAAUa,MAAV,EAD2D,CAG3D;;AACAkC,aAAK/C,IAAL,CAAUe,QAAV;AACAgC,aAAK/C,IAAL,CAAU9C,OAAOqG,QAAQb,EAAf,EAAmBrE,EAAnB,CAAsB4D,QAAtB,EAAgCuB,MAAhC,CAAuC,uBAAvC,CAAV;AACAT,aAAK/C,IAAL,CAAUiB,OAAV,EAN2D,CAQ3D;;AACA8B,aAAK/C,IAAL,CAAUe,QAAV;AACA,cAAM0C,SAASzG,WAAW6B,MAAX,CAAkB6E,KAAlB,CAAwBnB,OAAxB,CAAgC;AAAExE,eAAKwF,QAAQI,CAAR,CAAU5F;AAAjB,SAAhC,CAAf;;AACA,YAAImB,KAAK8D,KAAL,CAAWY,OAAX,CAAmBH,OAAO1F,GAA1B,MAAmC,CAAC,CAAxC,EAA2C;AAC1CmB,eAAK8D,KAAL,CAAWhD,IAAX,CAAgByD,OAAO1F,GAAvB;AACA,SAb0D,CAe3D;;;AACA,YAAI0F,OAAOI,MAAP,IAAiBJ,OAAOI,MAAP,CAAc,CAAd,CAAjB,IAAqCJ,OAAOI,MAAP,CAAc,CAAd,EAAiBC,OAA1D,EAAmE;AAClEf,eAAK/C,IAAL,CAAW,GAAGyD,OAAOhF,IAAM,QAAQgF,OAAOI,MAAP,CAAc,CAAd,EAAiBC,OAAS,MAA7D;AACA,SAFD,MAEO;AACNf,eAAK/C,IAAL,CAAW,GAAGyD,OAAOhF,IAAM,QAAQuD,kBAAoB,MAAvD;AACA;;AACDe,aAAK/C,IAAL,CAAUiB,OAAV,EArB2D,CAuB3D;;AACA8B,aAAK/C,IAAL,CAAUgB,QAAV;AACA9B,aAAK+D,IAAL;;AACA,YAAIM,QAAQQ,CAAZ,EAAe;AACd,gBAAMC,cAAchH,WAAWiH,YAAX,CAAwBC,OAAxB,CAAgCX,OAAhC,CAApB;;AACA,cAAIS,WAAJ,EAAiB;AAChBjB,iBAAK/C,IAAL,CAAUmE,QAAQC,EAAR,CAAWJ,YAAYT,OAAvB,EAAgCS,YAAY9E,IAAZ,GAAmB8E,YAAY9E,IAAZ,CAAiBqE,OAAjB,CAAnB,GAA+C,EAA/E,EAAmF,IAAnF,CAAV;AACA,WAFD,MAEO;AACNR,iBAAK/C,IAAL,CAAW,GAAGuD,QAAQc,GAAK,KAAKd,QAAQQ,CAAG,GAA3C;AACA;AACD,SAPD,MAOO,IAAIR,QAAQ/D,IAAZ,EAAkB;AACxBN,eAAKE,KAAL,CAAWY,IAAX,CAAgBuD,QAAQ/D,IAAR,CAAazB,GAA7B;AACAgF,eAAK/C,IAAL,CAAW,GAAGuD,QAAQpE,WAAR,CAAoB,CAApB,EAAuBmF,KAAO,KAAKpD,SAASqC,QAAQpE,WAAR,CAAoB,CAApB,CAAT,CAAkC,GAAnF;AACA,SAHM,MAGA,IAAIoE,QAAQpE,WAAZ,EAAyB;AAC/B,gBAAMoF,WAAW,EAAjB;;AACAvF,YAAEM,IAAF,CAAOiE,QAAQpE,WAAf,EAA4B,SAASqF,8BAAT,CAAwCC,CAAxC,EAA2C;AACtE,gBAAIA,EAAEC,SAAN,EAAiB;AAChBH,uBAASvE,IAAT,CAAcyE,EAAEC,SAAhB;AACA,aAHqE,CAItE;AACA;AACA;AACA;;AACA,WARD;;AAUA3B,eAAK/C,IAAL,CAAW,GAAGuD,QAAQc,GAAK,KAAKE,SAASlB,IAAT,CAAc,IAAd,CAAqB,GAArD;AACA,SAbM,MAaA;AACNN,eAAK/C,IAAL,CAAUuD,QAAQc,GAAlB;AACA;;AACDtB,aAAK/C,IAAL,CAAUiB,OAAV;AAEA8B,aAAK/C,IAAL,CAAUc,OAAV;AACA,OAvDD;;AAyDA,UAAIiC,KAAK1D,MAAL,KAAgB,CAApB,EAAuB;AACtB,cAAMsF,SAAShE,QAAQoC,KAAKM,IAAL,CAAU,EAAV,CAAR,GAAwBzC,GAAvC;AAEA5D,mBAAWC,MAAX,CAAkB2B,OAAlB,CAA0BgG,MAA1B,CAAiC;AAAE7G,eAAKsE,KAAKtE;AAAZ,SAAjC,EAAoD;AACnDA,eAAKsE,KAAKtE,GADyC;AAEnD6E,mBAASC,IAF0C;AAGnDgC,sBAAYF;AAHuC,SAApD;AAMA3H,mBAAWC,MAAX,CAAkBgC,SAAlB,CAA4B;AAC3ByB,gBAAMiE,MADqB;AAE3BnE,mBAAU,gBAAgBtB,KAAK8D,KAAL,CAAW3D,MAAQ,WAAWH,KAAK+D,IAAM,cAAc/D,KAAKE,KAAL,CAAWC,MAAQ,WAAWH,KAAKgE,IAAM,gBAAgBhE,KAAKmD,IAAM,EAF1H;AAG3BjD,iBAAOF,KAAKE;AAHe,SAA5B;AAKA;AACD,KA1FD;AA2FA,GA/FD;AAgGA,CAjGD,C;;;;;;;;;;;ACtBA,IAAIJ,CAAJ;;AAAM7B,OAAOC,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACyB,QAAEzB,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAGN,MAAMuH,gBAAgB,sBAAtB;;AAEA,MAAMC,0BAA0B/F,EAAEgG,QAAF,CAAWzD,OAAO0D,eAAP,CAAuB,SAASC,iCAAT,GAA6C;AAC9G,MAAIC,WAAWC,mBAAX,CAA+BN,aAA/B,CAAJ,EAAmD;AAClDK,eAAWE,MAAX,CAAkBP,aAAlB;AACA;;AAED,MAAI9H,WAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,gBAAxB,KAA6CtD,WAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,cAAxB,MAA4C,EAAzF,IAA+FtD,WAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,YAAxB,MAA0C,EAA7I,EAAiJ;AAChJ6E,eAAWxH,GAAX,CAAe;AACdc,YAAMqG,aADQ;AAEdQ,gBAAWC,MAAD,IAAYA,OAAOC,IAAP,CAAYxI,WAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,iBAAxB,EAA2CgB,OAA3C,CAAmD,IAAnD,EAAyD,GAAzD,CAAZ,CAFR;AAGdmE,WAAKzI,WAAWC,MAAX,CAAkB6E;AAHT,KAAf;AAKA;AACD,CAZ0C,CAAX,EAY5B,GAZ4B,CAAhC;;AAcAP,OAAOmE,OAAP,CAAe,MAAM;AACpBnE,SAAOQ,KAAP,CAAa,MAAM;AAClBgD;;AAEA/H,eAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,iBAAxB,EAA2CyE,uBAA3C;AACA/H,eAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,gBAAxB,EAA0CyE,uBAA1C;AACA/H,eAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,cAAxB,EAAwCyE,uBAAxC;AACA/H,eAAWQ,QAAX,CAAoB8C,GAApB,CAAwB,YAAxB,EAAsCyE,uBAAtC;AACA,GAPD;AAQA,CATD,E","file":"/packages/rocketchat_smarsh-connector.js","sourcesContent":["RocketChat.smarsh = {};\n","import moment from 'moment';\nimport 'moment-timezone';\n\nRocketChat.settings.addGroup('Smarsh', function addSettings() {\n\tthis.add('Smarsh_Enabled', false, {\n\t\ttype: 'boolean',\n\t\ti18nLabel: 'Smarsh_Enabled',\n\t\tenableQuery: {\n\t\t\t_id: 'From_Email',\n\t\t\tvalue: {\n\t\t\t\t$exists: 1,\n\t\t\t\t$ne: ''\n\t\t\t}\n\t\t}\n\t});\n\tthis.add('Smarsh_Email', '', {\n\t\ttype: 'string',\n\t\ti18nLabel: 'Smarsh_Email',\n\t\tplaceholder: 'email@domain.com'\n\t});\n\tthis.add('Smarsh_MissingEmail_Email', 'no-email@example.com', {\n\t\ttype: 'string',\n\t\ti18nLabel: 'Smarsh_MissingEmail_Email',\n\t\tplaceholder: 'no-email@example.com'\n\t});\n\n\tconst zoneValues = moment.tz.names().map(function _timeZonesToSettings(name) {\n\t\treturn {\n\t\t\tkey: name,\n\t\t\ti18nLabel: name\n\t\t};\n\t});\n\tthis.add('Smarsh_Timezone', 'America/Los_Angeles', {\n\t\ttype: 'select',\n\t\tvalues: zoneValues\n\t});\n\n\tthis.add('Smarsh_Interval', 'every_30_minutes', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'every_30_seconds',\n\t\t\ti18nLabel: 'every_30_seconds'\n\t\t}, {\n\t\t\tkey: 'every_30_minutes',\n\t\t\ti18nLabel: 'every_30_minutes'\n\t\t}, {\n\t\t\tkey: 'every_1_hours',\n\t\t\ti18nLabel: 'every_hour'\n\t\t}, {\n\t\t\tkey: 'every_6_hours',\n\t\t\ti18nLabel: 'every_six_hours'\n\t\t}],\n\t\tenableQuery: {\n\t\t\t_id: 'From_Email',\n\t\t\tvalue: {\n\t\t\t\t$exists: 1,\n\t\t\t\t$ne: ''\n\t\t\t}\n\t\t}\n\t});\n});\n","RocketChat.smarsh.History = new class extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('smarsh_history');\n\t}\n};\n","/* globals UploadFS */\n//Expects the following details:\n// {\n// \tbody: '<table>',\n// \tsubject: 'Rocket.Chat, 17 Users, 24 Messages, 1 File, 799504 Minutes, in #random',\n//  files: ['i3nc9l3mn']\n// }\n\nimport _ from 'underscore';\n\nRocketChat.smarsh.sendEmail = (data) => {\n\tconst attachments = [];\n\n\tif (data.files.length > 0) {\n\t\t_.each(data.files, (fileId) => {\n\t\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\t\t\tif (file.store === 'rocketchat_uploads' || file.store === 'fileSystem') {\n\t\t\t\tconst rs = UploadFS.getStore(file.store).getReadStream(fileId, file);\n\t\t\t\tattachments.push({\n\t\t\t\t\tfilename: file.name,\n\t\t\t\t\tstreamSource: rs\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tEmail.send({\n\t\tto: RocketChat.settings.get('Smarsh_Email'),\n\t\tfrom: RocketChat.settings.get('From_Email'),\n\t\tsubject: data.subject,\n\t\thtml: data.body,\n\t\tattachments\n\t});\n};\n","import _ from 'underscore';\nimport moment from 'moment';\nimport 'moment-timezone';\n\nconst start = '<table style=\"width: 100%; border: 1px solid; border-collapse: collapse; table-layout: fixed; margin-top: 10px; font-size: 12px; word-break: break-word;\"><tbody>';\nconst end = '</tbody></table>';\nconst opentr = '<tr style=\"border: 1px solid;\">';\nconst closetr = '</tr>';\nconst open20td = '<td style=\"border: 1px solid; text-align: center; width: 20%;\">';\nconst open60td = '<td style=\"border: 1px solid; text-align: left; width: 60%; padding: 0 5px;\">';\nconst closetd = '</td>';\n\nfunction _getLink(attachment) {\n\tconst url = attachment.title_link.replace(/ /g, '%20');\n\n\tif (Meteor.settings.public.sandstorm || url.match(/^(https?:)?\\/\\//i)) {\n\t\treturn url;\n\t} else {\n\t\treturn Meteor.absoluteUrl().replace(/\\/$/, '') + __meteor_runtime_config__.ROOT_URL_PATH_PREFIX + url;\n\t}\n}\n\nRocketChat.smarsh.generateEml = () => {\n\tMeteor.defer(() => {\n\t\tconst smarshMissingEmail = RocketChat.settings.get('Smarsh_MissingEmail_Email');\n\t\tconst timeZone = RocketChat.settings.get('Smarsh_Timezone');\n\n\t\tRocketChat.models.Rooms.find().forEach((room) => {\n\t\t\tconst smarshHistory = RocketChat.smarsh.History.findOne({ _id: room._id });\n\t\t\tconst query = { rid: room._id };\n\n\t\t\tif (smarshHistory) {\n\t\t\t\tquery.ts = { $gt: smarshHistory.lastRan };\n\t\t\t}\n\n\t\t\tconst date = new Date();\n\t\t\tconst rows = [];\n\t\t\tconst data = {\n\t\t\t\tusers: [],\n\t\t\t\tmsgs: 0,\n\t\t\t\tfiles: [],\n\t\t\t\ttime: smarshHistory ? moment(date).diff(moment(smarshHistory.lastRan), 'minutes') : moment(date).diff(moment(room.ts), 'minutes'),\n\t\t\t\troom: room.name ? `#${ room.name }` : `Direct Message Between: ${ room.usernames.join(' & ') }`\n\t\t\t};\n\n\t\t\tRocketChat.models.Messages.find(query).forEach((message) => {\n\t\t\t\trows.push(opentr);\n\n\t\t\t\t//The timestamp\n\t\t\t\trows.push(open20td);\n\t\t\t\trows.push(moment(message.ts).tz(timeZone).format('YYYY-MM-DD HH-mm-ss z'));\n\t\t\t\trows.push(closetd);\n\n\t\t\t\t//The sender\n\t\t\t\trows.push(open20td);\n\t\t\t\tconst sender = RocketChat.models.Users.findOne({ _id: message.u._id });\n\t\t\t\tif (data.users.indexOf(sender._id) === -1) {\n\t\t\t\t\tdata.users.push(sender._id);\n\t\t\t\t}\n\n\t\t\t\t//Get the user's email, can be nothing if it is an unconfigured bot account (like rocket.cat)\n\t\t\t\tif (sender.emails && sender.emails[0] && sender.emails[0].address) {\n\t\t\t\t\trows.push(`${ sender.name } &lt;${ sender.emails[0].address }&gt;`);\n\t\t\t\t} else {\n\t\t\t\t\trows.push(`${ sender.name } &lt;${ smarshMissingEmail }&gt;`);\n\t\t\t\t}\n\t\t\t\trows.push(closetd);\n\n\t\t\t\t//The message\n\t\t\t\trows.push(open60td);\n\t\t\t\tdata.msgs++;\n\t\t\t\tif (message.t) {\n\t\t\t\t\tconst messageType = RocketChat.MessageTypes.getType(message);\n\t\t\t\t\tif (messageType) {\n\t\t\t\t\t\trows.push(TAPi18n.__(messageType.message, messageType.data ? messageType.data(message) : '', 'en'));\n\t\t\t\t\t} else {\n\t\t\t\t\t\trows.push(`${ message.msg } (${ message.t })`);\n\t\t\t\t\t}\n\t\t\t\t} else if (message.file) {\n\t\t\t\t\tdata.files.push(message.file._id);\n\t\t\t\t\trows.push(`${ message.attachments[0].title } (${ _getLink(message.attachments[0]) })`);\n\t\t\t\t} else if (message.attachments) {\n\t\t\t\t\tconst attaches = [];\n\t\t\t\t\t_.each(message.attachments, function _loopThroughMessageAttachments(a) {\n\t\t\t\t\t\tif (a.image_url) {\n\t\t\t\t\t\t\tattaches.push(a.image_url);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t//TODO: Verify other type of attachments which need to be handled that aren't file uploads and image urls\n\t\t\t\t\t\t// } else {\n\t\t\t\t\t\t// \tconsole.log(a);\n\t\t\t\t\t\t// }\n\t\t\t\t\t});\n\n\t\t\t\t\trows.push(`${ message.msg } (${ attaches.join(', ') })`);\n\t\t\t\t} else {\n\t\t\t\t\trows.push(message.msg);\n\t\t\t\t}\n\t\t\t\trows.push(closetd);\n\n\t\t\t\trows.push(closetr);\n\t\t\t});\n\n\t\t\tif (rows.length !== 0) {\n\t\t\t\tconst result = start + rows.join('') + end;\n\n\t\t\t\tRocketChat.smarsh.History.upsert({ _id: room._id }, {\n\t\t\t\t\t_id: room._id,\n\t\t\t\t\tlastRan: date,\n\t\t\t\t\tlastResult: result\n\t\t\t\t});\n\n\t\t\t\tRocketChat.smarsh.sendEmail({\n\t\t\t\t\tbody: result,\n\t\t\t\t\tsubject: `Rocket.Chat, ${ data.users.length } Users, ${ data.msgs } Messages, ${ data.files.length } Files, ${ data.time } Minutes, in ${ data.room }`,\n\t\t\t\t\tfiles: data.files\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n};\n","/* globals SyncedCron */\nimport _ from 'underscore';\n\nconst smarshJobName = 'Smarsh EML Connector';\n\nconst _addSmarshSyncedCronJob = _.debounce(Meteor.bindEnvironment(function __addSmarshSyncedCronJobDebounced() {\n\tif (SyncedCron.nextScheduledAtDate(smarshJobName)) {\n\t\tSyncedCron.remove(smarshJobName);\n\t}\n\n\tif (RocketChat.settings.get('Smarsh_Enabled') && RocketChat.settings.get('Smarsh_Email') !== '' && RocketChat.settings.get('From_Email') !== '') {\n\t\tSyncedCron.add({\n\t\t\tname: smarshJobName,\n\t\t\tschedule: (parser) => parser.text(RocketChat.settings.get('Smarsh_Interval').replace(/_/g, ' ')),\n\t\t\tjob: RocketChat.smarsh.generateEml\n\t\t});\n\t}\n}), 500);\n\nMeteor.startup(() => {\n\tMeteor.defer(() => {\n\t\t_addSmarshSyncedCronJob();\n\n\t\tRocketChat.settings.get('Smarsh_Interval', _addSmarshSyncedCronJob);\n\t\tRocketChat.settings.get('Smarsh_Enabled', _addSmarshSyncedCronJob);\n\t\tRocketChat.settings.get('Smarsh_Email', _addSmarshSyncedCronJob);\n\t\tRocketChat.settings.get('From_Email', _addSmarshSyncedCronJob);\n\t});\n});\n"]}