{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/methods/snippetMessage.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/requests.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/publications/snippetedMessagesByRoom.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/publications/snippetedMessage.js"],"names":["Meteor","startup","RocketChat","settings","add","type","public","group","models","Permissions","upsert","$setOnInsert","roles","methods","snippetMessage","message","filename","userId","Error","method","room","Rooms","findOne","_id","rid","subscription","Subscriptions","findOneByRoomIdAndUserId","fields","get","Messages","cloneAndSaveAsHistoryById","me","Users","findOneById","snippeted","snippetedAt","Date","now","snippetedBy","username","callbacks","run","setSnippetedByIdAndUserId","createWithTypeRoomIdMessageAndUser","WebApp","connectHandlers","use","req","res","rawCookies","token","uid","cookie","Cookies","headers","query","rc_uid","rc_token","user","findOneByIdAndLoginToken","writeHead","end","match","exec","url","snippet","undefined","setHeader","encodeURIComponent","snippetName","snippetContent","msg","substr","length","write","publish","limit","ready","publication","cursorHandle","findSnippetedByRoom","sort","ts","observeChanges","added","record","changed","removed","onStop","stop","roomSnippetQuery","cursor","find"],"mappings":"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","file":"/packages/rocketchat_message-snippet.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.add('Message_AllowSnippeting', false, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\tgroup: 'Message'\n\t});\n\tRocketChat.models.Permissions.upsert('snippet-message', {\n\t\t$setOnInsert: {\n\t\t\troles: ['owner', 'moderator', 'admin']\n\t\t}\n\t});\n});\n\n","Meteor.methods({\n\tsnippetMessage(message, filename) {\n\t\tif (Meteor.userId() == null) {\n\t\t\t//noinspection JSUnresolvedFunction\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user',\n\t\t\t\t{method: 'snippetMessage'});\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOne({ _id: message.rid });\n\n\t\tif ((typeof room === 'undefined') || (room === null)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(message.rid, Meteor.userId(), { fields: { _id: 1 } });\n\t\tif (!subscription) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// If we keep history of edits, insert a new message to store history information\n\t\tif (RocketChat.settings.get('Message_KeepHistory')) {\n\t\t\tRocketChat.models.Messages.cloneAndSaveAsHistoryById(message._id);\n\t\t}\n\n\t\tconst me = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tmessage.snippeted = true;\n\t\tmessage.snippetedAt = Date.now;\n\t\tmessage.snippetedBy = {\n\t\t\t_id: Meteor.userId(),\n\t\t\tusername: me.username\n\t\t};\n\n\t\tmessage = RocketChat.callbacks.run('beforeSaveMessage', message);\n\n\t\t// Create the SnippetMessage\n\t\tRocketChat.models.Messages.setSnippetedByIdAndUserId(message, filename, message.snippetedBy,\n\t\t\tmessage.snippeted, Date.now, filename);\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser(\n\t\t\t'message_snippeted', message.rid, '', me, {\t'snippetId': message._id, 'snippetName': filename });\n\t}\n});\n","/* global Cookies */\nWebApp.connectHandlers.use('/snippet/download', function(req, res) {\n\tlet rawCookies;\n\tlet token;\n\tlet uid;\n\tconst cookie = new Cookies();\n\n\tif (req.headers && req.headers.cookie !== null) {\n\t\trawCookies = req.headers.cookie;\n\t}\n\n\tif (rawCookies !== null) {\n\t\tuid = cookie.get('rc_uid', rawCookies);\n\t}\n\n\tif (rawCookies !== null) {\n\t\ttoken = cookie.get('rc_token', rawCookies);\n\t}\n\n\tif (uid === null) {\n\t\tuid = req.query.rc_uid;\n\t\ttoken = req.query.rc_token;\n\t}\n\n\tconst user = RocketChat.models.Users.findOneByIdAndLoginToken(uid, token);\n\n\tif (!(uid && token && user)) {\n\t\tres.writeHead(403);\n\t\tres.end();\n\t\treturn false;\n\t}\n\tconst match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst snippet = RocketChat.models.Messages.findOne(\n\t\t\t{\n\t\t\t\t'_id': match[1],\n\t\t\t\t'snippeted': true\n\t\t\t}\n\t\t);\n\t\tconst room = RocketChat.models.Rooms.findOne({ '_id': snippet.rid, 'usernames': { '$in': [user.username] }});\n\t\tif (room === undefined) {\n\t\t\tres.writeHead(403);\n\t\t\tres.end();\n\t\t\treturn false;\n\t\t}\n\n\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(snippet.snippetName) }`);\n\t\tres.setHeader('Content-Type', 'application/octet-stream');\n\n\t\t// Removing the ``` contained in the msg.\n\t\tconst snippetContent = snippet.msg.substr(3, snippet.msg.length - 6);\n\t\tres.setHeader('Content-Length', snippetContent.length);\n\t\tres.write(snippetContent);\n\t\tres.end();\n\t\treturn;\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n\treturn;\n});\n","Meteor.publish('snippetedMessages', function(rid, limit=50) {\n\tif (typeof this.userId === 'undefined' || this.userId === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst publication = this;\n\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\n\tif (typeof user === 'undefined' || user === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst cursorHandle = RocketChat.models.Messages.findSnippetedByRoom(\n\t\trid,\n\t\t{\n\t\t\tsort: {ts: -1},\n\t\t\tlimit\n\t\t}\n\t).observeChanges({\n\t\tadded(_id, record) {\n\t\t\tpublication.added('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tchanged(_id, record) {\n\t\t\tpublication.changed('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tremoved(_id) {\n\t\t\tpublication.removed('rocketchat_snippeted_message', _id);\n\t\t}\n\t});\n\tthis.ready();\n\n\tthis.onStop = function() {\n\t\tcursorHandle.stop();\n\t};\n});\n","Meteor.publish('snippetedMessage', function(_id) {\n\tif (typeof this.userId === 'undefined' || this.userId === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst snippet = RocketChat.models.Messages.findOne({_id, snippeted: true});\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\tconst roomSnippetQuery = {\n\t\t'_id': snippet.rid,\n\t\t'usernames': {\n\t\t\t'$in': [\n\t\t\t\tuser.username\n\t\t\t]\n\t\t}\n\t};\n\n\tif (RocketChat.models.Rooms.findOne(roomSnippetQuery) === undefined) {\n\t\treturn this.ready();\n\t}\n\n\tconst publication = this;\n\n\n\tif (typeof user === 'undefined' || user === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst cursor = RocketChat.models.Messages.find(\n\t\t{ _id }\n\t).observeChanges({\n\t\tadded(_id, record) {\n\t\t\tpublication.added('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tchanged(_id, record) {\n\t\t\tpublication.changed('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tremoved(_id) {\n\t\t\tpublication.removed('rocketchat_snippeted_message', _id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop = function() {\n\t\tcursor.stop();\n\t};\n});\n"]}