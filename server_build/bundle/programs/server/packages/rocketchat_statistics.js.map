{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:statistics/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:statistics/server/models/Statistics.js","meteor://ðŸ’»app/packages/rocketchat:statistics/server/functions/get.js","meteor://ðŸ’»app/packages/rocketchat:statistics/server/functions/save.js","meteor://ðŸ’»app/packages/rocketchat:statistics/server/methods/getStatistics.js"],"names":["RocketChat","statistics","models","Statistics","_Base","constructor","tryEnsureIndex","findOneById","_id","options","query","findOne","findLast","sort","createdAt","limit","records","find","fetch","_","module","watch","require","default","v","os","wizardFields","get","_getStatistics","wizard","forEach","field","record","Settings","wizardField","replace","toLowerCase","value","uniqueId","settings","installedAt","Info","version","tag","branch","totalUsers","Meteor","users","count","activeUsers","active","nonActiveUsers","onlineUsers","statusConnection","awayUsers","offlineUsers","totalRooms","Rooms","totalChannels","findByType","totalPrivateGroups","totalDirect","totalLivechat","totalMessages","Messages","totalChannelMessages","reduce","fields","_countChannelMessages","num","room","msgs","totalPrivateGroupMessages","_countPrivateGroupMessages","totalDirectMessages","_countDirectMessages","totalLivechatMessages","_countLivechatMessages","lastLogin","Users","getLastLogin","lastMessageSentAt","getLastTimestamp","lastSeenSubscription","Subscriptions","getLastSeen","type","platform","arch","release","uptime","loadavg","totalmem","freemem","cpus","process","nodeVersion","pid","deploy","method","env","DEPLOY_METHOD","DEPLOY_PLATFORM","migration","Migrations","_getControl","instanceCount","InstanceStatus","getCollection","_updatedAt","$gt","Date","now","MongoInternals","defaultRemoteCollectionDriver","mongo","_oplogHandle","onOplogEntry","oplogEnabled","save","insert","methods","getStatistics","refresh","userId","Error","authz","hasPermission"],"mappings":"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","file":"/packages/rocketchat_statistics.js","sourcesContent":["RocketChat.statistics = {};\n","RocketChat.models.Statistics = new class extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('statistics');\n\n\t\tthis.tryEnsureIndex({ 'createdAt': 1 });\n\t}\n\n\t// FIND ONE\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindLast() {\n\t\tconst options = {\n\t\t\tsort: {\n\t\t\t\tcreatedAt: -1\n\t\t\t},\n\t\t\tlimit: 1\n\t\t};\n\t\tconst records = this.find({}, options).fetch();\n\t\treturn records && records[0];\n\t}\n};\n","/* global InstanceStatus, MongoInternals */\nimport _ from 'underscore';\nimport os from 'os';\n\nconst wizardFields = [\n\t'Organization_Type',\n\t'Organization_Name',\n\t'Industry',\n\t'Size',\n\t'Country',\n\t'Website',\n\t'Site_Name',\n\t'Language',\n\t'Server_Type',\n\t'Allow_Marketing_Emails'\n];\n\nRocketChat.statistics.get = function _getStatistics() {\n\tconst statistics = {};\n\n\t// Setup Wizard\n\tstatistics.wizard = {};\n\twizardFields.forEach(field => {\n\t\tconst record = RocketChat.models.Settings.findOne(field);\n\t\tif (record) {\n\t\t\tconst wizardField = field.replace(/_/g, '').replace(field[0], field[0].toLowerCase());\n\t\t\tstatistics.wizard[wizardField] = record.value;\n\t\t}\n\t});\n\n\t// Version\n\tstatistics.uniqueId = RocketChat.settings.get('uniqueID');\n\tif (RocketChat.models.Settings.findOne('uniqueID')) {\n\t\tstatistics.installedAt = RocketChat.models.Settings.findOne('uniqueID').createdAt;\n\t}\n\n\tif (RocketChat.Info) {\n\t\tstatistics.version = RocketChat.Info.version;\n\t\tstatistics.tag = RocketChat.Info.tag;\n\t\tstatistics.branch = RocketChat.Info.branch;\n\t}\n\n\t// User statistics\n\tstatistics.totalUsers = Meteor.users.find().count();\n\tstatistics.activeUsers = Meteor.users.find({ active: true }).count();\n\tstatistics.nonActiveUsers = statistics.totalUsers - statistics.activeUsers;\n\tstatistics.onlineUsers = Meteor.users.find({ statusConnection: 'online' }).count();\n\tstatistics.awayUsers = Meteor.users.find({ statusConnection: 'away' }).count();\n\tstatistics.offlineUsers = statistics.totalUsers - statistics.onlineUsers - statistics.awayUsers;\n\n\t// Room statistics\n\tstatistics.totalRooms = RocketChat.models.Rooms.find().count();\n\tstatistics.totalChannels = RocketChat.models.Rooms.findByType('c').count();\n\tstatistics.totalPrivateGroups = RocketChat.models.Rooms.findByType('p').count();\n\tstatistics.totalDirect = RocketChat.models.Rooms.findByType('d').count();\n\tstatistics.totalLivechat = RocketChat.models.Rooms.findByType('l').count();\n\n\t// Message statistics\n\tstatistics.totalMessages = RocketChat.models.Messages.find().count();\n\tstatistics.totalChannelMessages = _.reduce(RocketChat.models.Rooms.findByType('c', { fields: { 'msgs': 1 }}).fetch(), function _countChannelMessages(num, room) { return num + room.msgs; }, 0);\n\tstatistics.totalPrivateGroupMessages = _.reduce(RocketChat.models.Rooms.findByType('p', { fields: { 'msgs': 1 }}).fetch(), function _countPrivateGroupMessages(num, room) { return num + room.msgs; }, 0);\n\tstatistics.totalDirectMessages = _.reduce(RocketChat.models.Rooms.findByType('d', { fields: { 'msgs': 1 }}).fetch(), function _countDirectMessages(num, room) { return num + room.msgs; }, 0);\n\tstatistics.totalLivechatMessages = _.reduce(RocketChat.models.Rooms.findByType('l', { fields: { 'msgs': 1 }}).fetch(), function _countLivechatMessages(num, room) { return num + room.msgs; }, 0);\n\n\tstatistics.lastLogin = RocketChat.models.Users.getLastLogin();\n\tstatistics.lastMessageSentAt = RocketChat.models.Messages.getLastTimestamp();\n\tstatistics.lastSeenSubscription = RocketChat.models.Subscriptions.getLastSeen();\n\n\tstatistics.os = {\n\t\ttype: os.type(),\n\t\tplatform: os.platform(),\n\t\tarch: os.arch(),\n\t\trelease: os.release(),\n\t\tuptime: os.uptime(),\n\t\tloadavg: os.loadavg(),\n\t\ttotalmem: os.totalmem(),\n\t\tfreemem: os.freemem(),\n\t\tcpus: os.cpus()\n\t};\n\n\tstatistics.process = {\n\t\tnodeVersion: process.version,\n\t\tpid: process.pid,\n\t\tuptime: process.uptime()\n\t};\n\n\tstatistics.deploy = {\n\t\tmethod: process.env.DEPLOY_METHOD || 'tar',\n\t\tplatform: process.env.DEPLOY_PLATFORM || 'selfinstall'\n\t};\n\n\tstatistics.migration = RocketChat.Migrations._getControl();\n\tstatistics.instanceCount = InstanceStatus.getCollection().find({ _updatedAt: { $gt: new Date(Date.now() - process.uptime() * 1000 - 2000) }}).count();\n\n\tif (MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle && MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle.onOplogEntry && RocketChat.settings.get('Force_Disable_OpLog_For_Cache') !== true) {\n\t\tstatistics.oplogEnabled = true;\n\t}\n\n\treturn statistics;\n};\n","RocketChat.statistics.save = function() {\n\tconst statistics = RocketChat.statistics.get();\n\tstatistics.createdAt = new Date;\n\tRocketChat.models.Statistics.insert(statistics);\n\treturn statistics;\n};\n","Meteor.methods({\n\tgetStatistics(refresh) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'getStatistics' });\n\t\t}\n\n\t\tif (RocketChat.authz.hasPermission(Meteor.userId(), 'view-statistics') !== true) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'getStatistics' });\n\t\t}\n\n\t\tif (refresh) {\n\t\t\treturn RocketChat.statistics.save();\n\t\t} else {\n\t\t\treturn RocketChat.models.Statistics.findLast();\n\t\t}\n\t}\n});\n"]}