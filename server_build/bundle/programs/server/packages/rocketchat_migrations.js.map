{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:migrations/migrations.js"],"names":["_","module","watch","require","default","v","s","moment","DefaultMigration","version","up","Migrations","_list","options","log","logger","logIfLatest","lockExpiration","retryInterval","maxAttempts","collectionName","config","opts","extend","_collection","Mongo","Collection","makeABox","message","color","isArray","split","len","reduce","memo","msg","Math","max","length","text","map","lrpad","join","topLine","pad","separator","bottomLine","createLogger","prefix","check","String","level","Match","OneOf","isFunction","tag","Log","forEach","partial","add","migration","Meteor","Error","Object","freeze","push","sortBy","m","migrateTo","command","isUndefined","subcommand","migrated","attempts","_migrateTo","last","parseInt","willRetry","_sleepForMs","console","yellow","control","_getControl","RocketChat","Info","commit","hash","date","branch","process","exit","getVersion","rerun","self","currentVersion","lock","info","migrate","_findIndexByVersion","unlock","startIdx","endIdx","direction","idx","maybeName","name","e","Date","dateMinusInterval","subtract","toDate","build","update","_id","$or","locked","lockedAt","$lt","buildAt","$ne","$set","_setControl","i","findOne","Number","Boolean","upsert","_reset","remove"],"mappings":"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","file":"/packages/rocketchat_migrations.js","sourcesContent":["/* eslint no-use-before-define:0 */\n/* globals Log*/\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport moment from 'moment';\n/*\n\tAdds migration capabilities. Migrations are defined like:\n\n\tMigrations.add({\n\t\tup: function() {}, //*required* code to run to migrate upwards\n\t\tversion: 1, //*required* number to identify migration order\n\t\tdown: function() {}, //*optional* code to run to migrate downwards\n\t\tname: 'Something' //*optional* display name for the migration\n\t});\n\n\tThe ordering of migrations is determined by the version you set.\n\n\tTo run the migrations, set the MIGRATE environment variable to either\n\t'latest' or the version number you want to migrate to. Optionally, append\n\t',exit' if you want the migrations to exit the meteor process, e.g if you're\n\tmigrating from a script (remember to pass the --once parameter).\n\n\te.g:\n\tMIGRATE=\"latest\" mrt # ensure we'll be at the latest version and run the app\n\tMIGRATE=\"latest,exit\" mrt --once # ensure we'll be at the latest version and exit\n\tMIGRATE=\"2,exit\" mrt --once # migrate to version 2 and exit\n\n\tNote: Migrations will lock ensuring only 1 app can be migrating at once. If\n\ta migration crashes, the control record in the migrations collection will\n\tremain locked and at the version it was at previously, however the db could\n\tbe in an inconsistant state.\n*/\n\n// since we'll be at version 0 by default, we should have a migration set for it.\nconst DefaultMigration = {\n\tversion: 0,\n\tup() {\n\t\t// @TODO: check if collection \"migrations\" exist\n\t\t// If exists, rename and rerun _migrateTo\n\t}\n};\n\nconst Migrations = this.Migrations = {\n\t_list: [DefaultMigration],\n\toptions: {\n\t\t// false disables logging\n\t\tlog: true,\n\t\t// null or a function\n\t\tlogger: null,\n\t\t// enable/disable info log \"already at latest.\"\n\t\tlogIfLatest: true,\n\t\t// lock will be valid for this amount of minutes\n\t\tlockExpiration: 5,\n\t\t// retry interval in seconds\n\t\tretryInterval: 10,\n\t\t// max number of attempts to retry unlock\n\t\tmaxAttempts: 30,\n\t\t// migrations collection name\n\t\tcollectionName: 'migrations'\n\t\t// collectionName: \"rocketchat_migrations\"\n\t},\n\tconfig(opts) {\n\t\tthis.options = _.extend({}, this.options, opts);\n\t}\n};\n\nMigrations._collection = new Mongo.Collection(Migrations.options.collectionName);\n\n/* Create a box around messages for displaying on a console.log */\nfunction makeABox(message, color = 'red') {\n\tif (!_.isArray(message)) {\n\t\tmessage = message.split('\\n');\n\t}\n\tconst len = _(message).reduce(function(memo, msg) {\n\t\treturn Math.max(memo, msg.length);\n\t}, 0) + 4;\n\tconst text = message.map((msg) => {\n\t\treturn '|' [color] + s.lrpad(msg, len)[color] + '|' [color];\n\t}).join('\\n');\n\tconst topLine = '+' [color] + s.pad('', len, '-')[color] + '+' [color];\n\tconst separator = '|' [color] + s.pad('', len, '') + '|' [color];\n\tconst bottomLine = '+' [color] + s.pad('', len, '-')[color] + '+' [color];\n\treturn `\\n${ topLine }\\n${ separator }\\n${ text }\\n${ separator }\\n${ bottomLine }\\n`;\n}\n\n/*\n\tLogger factory function. Takes a prefix string and options object\n\tand uses an injected `logger` if provided, else falls back to\n\tMeteor's `Log` package.\n\tWill send a log object to the injected logger, on the following form:\n\t\tmessage: String\n\t\tlevel: String (info, warn, error, debug)\n\t\ttag: 'Migrations'\n*/\nfunction createLogger(prefix) {\n\tcheck(prefix, String);\n\n\t// Return noop if logging is disabled.\n\tif (Migrations.options.log === false) {\n\t\treturn function() {};\n\t}\n\n\treturn function(level, message) {\n\t\tcheck(level, Match.OneOf('info', 'error', 'warn', 'debug'));\n\t\tcheck(message, Match.OneOf(String, [String]));\n\n\t\tconst logger = Migrations.options && Migrations.options.logger;\n\n\t\tif (logger && _.isFunction(logger)) {\n\n\t\t\tlogger({\n\t\t\t\tlevel,\n\t\t\t\tmessage,\n\t\t\t\ttag: prefix\n\t\t\t});\n\n\t\t} else {\n\t\t\tLog[level]({\n\t\t\t\tmessage: `${ prefix }: ${ message }`\n\t\t\t});\n\t\t}\n\t};\n}\n\n// collection holding the control record\n\nconst log = createLogger('Migrations');\n\n['info', 'warn', 'error', 'debug'].forEach(function(level) {\n\tlog[level] = _.partial(log, level);\n});\n\n// if (process.env.MIGRATE)\n//   Migrations.migrateTo(process.env.MIGRATE);\n\n// Add a new migration:\n// {up: function *required\n//  version: Number *required\n//  down: function *optional\n//  name: String *optional\n// }\nMigrations.add = function(migration) {\n\tif (typeof migration.up !== 'function') { throw new Meteor.Error('Migration must supply an up function.'); }\n\n\tif (typeof migration.version !== 'number') { throw new Meteor.Error('Migration must supply a version number.'); }\n\n\tif (migration.version <= 0) { throw new Meteor.Error('Migration version must be greater than 0'); }\n\n\t// Freeze the migration object to make it hereafter immutable\n\tObject.freeze(migration);\n\n\tthis._list.push(migration);\n\tthis._list = _.sortBy(this._list, function(m) {\n\t\treturn m.version;\n\t});\n};\n\n// Attempts to run the migrations using command in the form of:\n// e.g 'latest', 'latest,exit', 2\n// use 'XX,rerun' to re-run the migration at that version\nMigrations.migrateTo = function(command) {\n\tif (_.isUndefined(command) || command === '' || this._list.length === 0) { throw new Error(`Cannot migrate using invalid command: ${ command }`); }\n\n\tlet version;\n\tlet subcommand;\n\tif (typeof command === 'number') {\n\t\tversion = command;\n\t} else {\n\t\tversion = command.split(',')[0];\n\t\tsubcommand = command.split(',')[1];\n\t}\n\n\tconst maxAttempts = Migrations.options.maxAttempts;\n\tconst retryInterval = Migrations.options.retryInterval;\n\tlet migrated;\n\tfor (let attempts = 1; attempts <= maxAttempts; attempts++) {\n\t\tif (version === 'latest') {\n\t\t\tmigrated = this._migrateTo(_.last(this._list).version);\n\t\t} else {\n\t\t\tmigrated = this._migrateTo(parseInt(version), (subcommand === 'rerun'));\n\t\t}\n\t\tif (migrated) {\n\t\t\tbreak;\n\t\t} else {\n\t\t\tlet willRetry;\n\t\t\tif (attempts < maxAttempts) {\n\t\t\t\twillRetry = ` Trying again in ${ retryInterval } seconds.`;\n\t\t\t\tMeteor._sleepForMs(retryInterval * 1000);\n\t\t\t} else {\n\t\t\t\twillRetry = '';\n\t\t\t}\n\t\t\tconsole.log(`Not migrating, control is locked. Attempt ${ attempts }/${ maxAttempts }.${ willRetry }`.yellow);\n\t\t}\n\t}\n\tif (!migrated) {\n\t\tconst control = this._getControl(); // Side effect: upserts control document.\n\t\tconsole.log(makeABox([\n\t\t\t'ERROR! SERVER STOPPED',\n\t\t\t'',\n\t\t\t'Your database migration control is locked.',\n\t\t\t'Please make sure you are running the latest version and try again.',\n\t\t\t'If the problem persists, please contact support.',\n\t\t\t'',\n\t\t\t`This Rocket.Chat version: ${ RocketChat.Info.version }`,\n\t\t\t`Database locked at version: ${ control.version }`,\n\t\t\t`Database target version: ${ version === 'latest' ? _.last(this._list).version : version }`,\n\t\t\t'',\n\t\t\t`Commit: ${ RocketChat.Info.commit.hash }`,\n\t\t\t`Date: ${ RocketChat.Info.commit.date }`,\n\t\t\t`Branch: ${ RocketChat.Info.commit.branch }`,\n\t\t\t`Tag: ${ RocketChat.Info.commit.tag }`\n\t\t]));\n\t\tprocess.exit(1);\n\t}\n\n\t// remember to run meteor with --once otherwise it will restart\n\tif (subcommand === 'exit') { process.exit(0); }\n};\n\n// just returns the current version\nMigrations.getVersion = function() {\n\treturn this._getControl().version;\n};\n\n// migrates to the specific version passed in\nMigrations._migrateTo = function(version, rerun) {\n\tconst self = this;\n\tconst control = this._getControl(); // Side effect: upserts control document.\n\tlet currentVersion = control.version;\n\n\tif (lock() === false) {\n\t\t// log.info('Not migrating, control is locked.');\n\t\t// Warning\n\t\treturn false;\n\t}\n\n\tif (rerun) {\n\t\tlog.info(`Rerunning version ${ version }`);\n\t\tmigrate('up', this._findIndexByVersion(version));\n\t\tlog.info('Finished migrating.');\n\t\tunlock();\n\t\treturn true;\n\t}\n\n\tif (currentVersion === version) {\n\t\tif (this.options.logIfLatest) {\n\t\t\tlog.info(`Not migrating, already at version ${ version }`);\n\t\t}\n\t\tunlock();\n\t\treturn true;\n\t}\n\n\tconst startIdx = this._findIndexByVersion(currentVersion);\n\tconst endIdx = this._findIndexByVersion(version);\n\n\t// log.info('startIdx:' + startIdx + ' endIdx:' + endIdx);\n\tlog.info(`Migrating from version ${ this._list[startIdx].version } -> ${ this._list[endIdx].version }`);\n\n\t// run the actual migration\n\tfunction migrate(direction, idx) {\n\t\tconst migration = self._list[idx];\n\n\t\tif (typeof migration[direction] !== 'function') {\n\t\t\tunlock();\n\t\t\tthrow new Meteor.Error(`Cannot migrate ${ direction } on version ${ migration.version }`);\n\t\t}\n\n\t\tfunction maybeName() {\n\t\t\treturn migration.name ? ` (${ migration.name })` : '';\n\t\t}\n\n\t\tlog.info(`Running ${ direction }() on version ${ migration.version }${ maybeName() }`);\n\n\t\ttry {\n\t\t\tmigration[direction](migration);\n\t\t} catch (e) {\n\t\t\tconsole.log(makeABox([\n\t\t\t\t'ERROR! SERVER STOPPED',\n\t\t\t\t'',\n\t\t\t\t'Your database migration failed:',\n\t\t\t\te.message,\n\t\t\t\t'',\n\t\t\t\t'Please make sure you are running the latest version and try again.',\n\t\t\t\t'If the problem persists, please contact support.',\n\t\t\t\t'',\n\t\t\t\t`This Rocket.Chat version: ${ RocketChat.Info.version }`,\n\t\t\t\t`Database locked at version: ${ control.version }`,\n\t\t\t\t`Database target version: ${ version }`,\n\t\t\t\t'',\n\t\t\t\t`Commit: ${ RocketChat.Info.commit.hash }`,\n\t\t\t\t`Date: ${ RocketChat.Info.commit.date }`,\n\t\t\t\t`Branch: ${ RocketChat.Info.commit.branch }`,\n\t\t\t\t`Tag: ${ RocketChat.Info.commit.tag }`\n\t\t\t]));\n\t\t\tprocess.exit(1);\n\t\t}\n\t}\n\n\t// Returns true if lock was acquired.\n\tfunction lock() {\n\t\tconst date = new Date();\n\t\tconst dateMinusInterval = moment(date).subtract(self.options.lockExpiration, 'minutes').toDate();\n\t\tconst build = RocketChat.Info ? RocketChat.Info.build.date : date;\n\n\t\t// This is atomic. The selector ensures only one caller at a time will see\n\t\t// the unlocked control, and locking occurs in the same update's modifier.\n\t\t// All other simultaneous callers will get false back from the update.\n\t\treturn self._collection.update({\n\t\t\t_id: 'control',\n\t\t\t$or: [{\n\t\t\t\tlocked: false\n\t\t\t}, {\n\t\t\t\tlockedAt: {\n\t\t\t\t\t$lt: dateMinusInterval\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\tbuildAt: {\n\t\t\t\t\t$ne: build\n\t\t\t\t}\n\t\t\t}]\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tlocked: true,\n\t\t\t\tlockedAt: date,\n\t\t\t\tbuildAt: build\n\t\t\t}\n\t\t}) === 1;\n\t}\n\n\n\t// Side effect: saves version.\n\tfunction unlock() {\n\t\tself._setControl({\n\t\t\tlocked: false,\n\t\t\tversion: currentVersion\n\t\t});\n\t}\n\n\tif (currentVersion < version) {\n\t\tfor (let i = startIdx; i < endIdx; i++) {\n\t\t\tmigrate('up', i + 1);\n\t\t\tcurrentVersion = self._list[i + 1].version;\n\t\t\tself._setControl({\n\t\t\t\tlocked: true,\n\t\t\t\tversion: currentVersion\n\t\t\t});\n\t\t}\n\t} else {\n\t\tfor (let i = startIdx; i > endIdx; i--) {\n\t\t\tmigrate('down', i);\n\t\t\tcurrentVersion = self._list[i - 1].version;\n\t\t\tself._setControl({\n\t\t\t\tlocked: true,\n\t\t\t\tversion: currentVersion\n\t\t\t});\n\t\t}\n\t}\n\n\tunlock();\n\tlog.info('Finished migrating.');\n};\n\n// gets the current control record, optionally creating it if non-existant\nMigrations._getControl = function() {\n\tconst control = this._collection.findOne({\n\t\t_id: 'control'\n\t});\n\n\treturn control || this._setControl({\n\t\tversion: 0,\n\t\tlocked: false\n\t});\n};\n\n// sets the control record\nMigrations._setControl = function(control) {\n\t// be quite strict\n\tcheck(control.version, Number);\n\tcheck(control.locked, Boolean);\n\n\tthis._collection.update({\n\t\t_id: 'control'\n\t}, {\n\t\t$set: {\n\t\t\tversion: control.version,\n\t\t\tlocked: control.locked\n\t\t}\n\t}, {\n\t\tupsert: true\n\t});\n\n\treturn control;\n};\n\n// returns the migration index in _list or throws if not found\nMigrations._findIndexByVersion = function(version) {\n\tfor (let i = 0; i < this._list.length; i++) {\n\t\tif (this._list[i].version === version) { return i; }\n\t}\n\n\tthrow new Meteor.Error(`Can't find migration version ${ version }`);\n};\n\n//reset (mainly intended for tests)\nMigrations._reset = function() {\n\tthis._list = [{\n\t\tversion: 0,\n\t\tup() {}\n\t}];\n\tthis._collection.remove({});\n};\n\nRocketChat.Migrations = Migrations;\n"]}