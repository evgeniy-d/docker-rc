{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:search/server/index.js","meteor://ðŸ’»app/packages/rocketchat:search/server/events/events.js","meteor://ðŸ’»app/packages/rocketchat:search/server/logger/logger.js","meteor://ðŸ’»app/packages/rocketchat:search/server/model/provider.js","meteor://ðŸ’»app/packages/rocketchat:search/server/provider/defaultProvider.js","meteor://ðŸ’»app/packages/rocketchat:search/server/service/providerService.js","meteor://ðŸ’»app/packages/rocketchat:search/server/service/validationService.js"],"names":["module","export","searchProviderService","SearchProvider","watch","require","v","default","SearchLogger","EventService","_pushError","name","value","payload","debug","promoteEvent","activeProvider","on","eventService","RocketChat","callbacks","add","m","_id","models","Users","clientAction","id","data","user","findOneById","Rooms","room","Logger","exportDefault","Setting","constructor","basekey","key","type","defaultValue","options","_basekey","_value","undefined","load","settings","get","Settings","list","Object","keys","map","Error","forEach","match","info","_key","_settings","i18nLabel","i18nDescription","iconName","settingsAsMap","resultTemplate","suggestionItemTemplate","search","text","context","callback","suggest","supportsSuggestions","run","reason","Promise","resolve","reject","start","stop","DefaultProvider","alert","_rid","searchAll","rid","_limit","limit","Meteor","call","register","_","validationService","SearchProviderService","providers","use","stopProvider","then","e","provider","addGroup","self","values","public","filter","length","section","setting","_options","enableQuery","push","configProvider","debounce","bindEnvironment","providerId","startup","methods","JSON","stringify","error","validateSearchResult","description","icon","mapObject","ValidationService","result","subscriptionCache","getSubscription","uid","hasOwnProperty","userCache","getUsername","findById","fetch","username","userId","message","docs","msg","subscription","r","t","valid"],"mappings":"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","file":"/packages/rocketchat_search.js","sourcesContent":["import './model/provider';\nimport './service/providerService.js';\nimport './service/validationService.js';\nimport './events/events.js';\nimport './provider/defaultProvider.js';\n\nimport {searchProviderService} from './service/providerService';\nimport SearchProvider from './model/provider';\n\nexport {\n\tsearchProviderService,\n\tSearchProvider\n};\n","import {searchProviderService} from '../service/providerService';\nimport SearchLogger from '../logger/logger';\n\nclass EventService {\n\n\t/*eslint no-unused-vars: [2, { \"args\": \"none\" }]*/\n\t_pushError(name, value, payload) {\n\t\t//TODO implement a (performant) cache\n\t\tSearchLogger.debug(`Error on event '${ name }' with id '${ value }'`);\n\t}\n\n\tpromoteEvent(name, value, payload) {\n\t\tif (!(searchProviderService.activeProvider && searchProviderService.activeProvider.on(name, value, payload))) {\n\t\t\tthis._pushError(name, value, payload);\n\t\t}\n\t}\n}\n\nconst eventService = new EventService();\n\n/**\n * Listen to message changes via Hooks\n */\nRocketChat.callbacks.add('afterSaveMessage', function(m) {\n\teventService.promoteEvent('message.save', m._id, m);\n});\n\nRocketChat.callbacks.add('afterDeleteMessage', function(m) {\n\teventService.promoteEvent('message.delete', m._id);\n});\n\n/**\n * Listen to user and room changes via cursor\n */\n\n\nRocketChat.models.Users.on('change', ({clientAction, id, data}) => {\n\tswitch (clientAction) {\n\t\tcase 'updated':\n\t\tcase 'inserted':\n\t\t\tconst user = data || RocketChat.models.Users.findOneById(id);\n\t\t\teventService.promoteEvent('user.save', id, user);\n\t\t\tbreak;\n\n\t\tcase 'removed':\n\t\t\teventService.promoteEvent('user.delete', id);\n\t\t\tbreak;\n\t}\n});\n\nRocketChat.models.Rooms.on('change', ({clientAction, id, data}) => {\n\tswitch (clientAction) {\n\t\tcase 'updated':\n\t\tcase 'inserted':\n\t\t\tconst room = data || RocketChat.models.Rooms.findOneById(id);\n\t\t\teventService.promoteEvent('room.save', id, room);\n\t\t\tbreak;\n\n\t\tcase 'removed':\n\t\t\teventService.promoteEvent('room.delete', id);\n\t\t\tbreak;\n\t}\n});\n","const SearchLogger = new Logger('Search Logger', {});\nexport default SearchLogger;\n","/*eslint no-unused-vars: [2, { \"args\": \"none\" }]*/\nimport SearchLogger from '../logger/logger';\n\n/**\n * Setting Object in order to manage settings loading for providers and admin ui display\n */\nclass Setting {\n\tconstructor(basekey, key, type, defaultValue, options = {}) {\n\t\tthis._basekey = basekey;\n\t\tthis.key = key;\n\t\tthis.type = type;\n\t\tthis.defaultValue = defaultValue;\n\t\tthis.options = options;\n\t\tthis._value = undefined;\n\t}\n\n\tget value() {\n\t\treturn this._value;\n\t}\n\n\t/**\n\t * Id is generated based on baseKey and key\n\t * @returns {string}\n\t */\n\tget id() {\n\t\treturn `Search.${ this._basekey }.${ this.key }`;\n\t}\n\n\tload() {\n\t\tthis._value = RocketChat.settings.get(this.id);\n\n\t\tif (this._value === undefined) { this._value = this.defaultValue; }\n\t}\n\n}\n\n/**\n * Settings Object allows to manage Setting Objects\n */\nclass Settings {\n\tconstructor(basekey) {\n\t\tthis.basekey = basekey;\n\t\tthis.settings = {};\n\t}\n\n\tadd(key, type, defaultValue, options) {\n\t\tthis.settings[key] = new Setting(this.basekey, key, type, defaultValue, options);\n\t}\n\n\tlist() {\n\t\treturn Object.keys(this.settings).map(key => this.settings[key]);\n\t}\n\n\tmap() {\n\t\treturn this.settings;\n\t}\n\n\t/**\n\t * return the value for key\n\t * @param key\n\t */\n\tget(key) {\n\t\tif (!this.settings[key]) { throw new Error('Setting is not set'); }\n\t\treturn this.settings[key].value;\n\t}\n\n\t/**\n\t * load currently stored values of all settings\n\t */\n\tload() {\n\t\tObject.keys(this.settings).forEach((key) => {\n\t\t\tthis.settings[key].load();\n\t\t});\n\t}\n}\n\nexport default class SearchProvider {\n\n\t/**\n\t * Create search provider, key must match /^[a-z0-9]+$/\n\t * @param key\n\t */\n\tconstructor(key) {\n\n\t\tif (!key.match(/^[A-z0-9]+$/)) { throw new Error(`cannot instantiate provider: ${ key } does not match key-pattern`); }\n\n\t\tSearchLogger.info(`create search provider ${ key }`);\n\n\t\tthis._key = key;\n\t\tthis._settings = new Settings(key);\n\t}\n\n\t/*--- basic params ---*/\n\tget key() {\n\t\treturn this._key;\n\t}\n\n\tget i18nLabel() {\n\t\treturn undefined;\n\t}\n\n\tget i18nDescription() {\n\t\treturn undefined;\n\t}\n\n\tget iconName() {\n\t\treturn 'magnifier';\n\t}\n\n\tget settings() {\n\t\treturn this._settings.list();\n\t}\n\n\tget settingsAsMap() {\n\t\treturn this._settings.map();\n\t}\n\n\t/*--- templates ---*/\n\tget resultTemplate() {\n\t\treturn 'DefaultSearchResultTemplate';\n\t}\n\n\tget suggestionItemTemplate() {\n\t\treturn 'DefaultSuggestionItemTemplate';\n\t}\n\n\t/*--- search functions ---*/\n\t/**\n\t * Search using the current search provider and check if results are valid for the user. The search result has\n\t * the format {messages:{start:0,numFound:1,docs:[{...}]},users:{...},rooms:{...}}\n\t * @param text the search text\n\t * @param context the context (uid, rid)\n\t * @param payload custom payload (e.g. for paging)\n\t * @param callback is used to return result an can be called with (error,result)\n\t */\n\tsearch(text, context, payload, callback) {\n\t\tthrow new Error('Function search has to be implemented');\n\t}\n\n\t/**\n\t * Returns an ordered list of suggestions. The result should have at least the form [{text:string}]\n\t * @param text\n\t * @param context\n\t * @param payload\n\t * @param callback\n\t */\n\tsuggest(text, context, payload, callback) {\n\t\tcallback(null, []);\n\t}\n\n\tget supportsSuggestions() {\n\t\treturn false;\n\t}\n\n\t/*--- triggers ---*/\n\ton(name, value) {\n\t\treturn true;\n\t}\n\n\t/*--- livecycle ---*/\n\trun(reason, callback) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._settings.load();\n\t\t\tthis.start(reason, resolve, reject);\n\t\t});\n\t}\n\n\tstart(reason, resolve) {\n\t\tresolve();\n\t}\n\n\tstop(resolve) {\n\t\tresolve();\n\t}\n}\n\n","import {searchProviderService} from '../service/providerService';\nimport SearchProvider from '../model/provider';\n\n/**\n * Implements the default provider (based on mongo db search)\n */\nclass DefaultProvider extends SearchProvider {\n\n\t/**\n\t * Enable settings: GlobalSearchEnabled, PageSize\n\t */\n\tconstructor() {\n\t\tsuper('defaultProvider');\n\t\tthis._settings.add('GlobalSearchEnabled', 'boolean', false, {\n\t\t\ti18nLabel: 'Global_Search',\n\t\t\talert: 'This feature is currently in beta and could decrease the application performance! Please report bugs to github.com/RocketChat/Rocket.Chat/issues'\n\t\t});\n\t\tthis._settings.add('PageSize', 'int', 10, {\n\t\t\ti18nLabel: 'Search_Page_Size'\n\t\t});\n\t}\n\n\tget i18nLabel() {\n\t\treturn 'Default provider';\n\t}\n\n\tget i18nDescription() {\n\t\treturn 'You_can_search_using_RegExp_eg';\n\t}\n\n\t/**\n\t * {@inheritDoc}\n\t * Uses Meteor function 'messageSearch'\n\t */\n\tsearch(text, context, payload = {}, callback) {\n\n\t\tconst _rid = payload.searchAll ? undefined : context.rid;\n\n\t\tconst _limit = payload.limit || this._settings.get('PageSize');\n\n\t\tMeteor.call('messageSearch', text, _rid, _limit, callback);\n\n\t}\n}\n\n//register provider\nsearchProviderService.register(new DefaultProvider());\n","/* globals RocketChat */\nimport _ from 'underscore';\n\nimport {validationService} from '../service/validationService';\nimport SearchLogger from '../logger/logger';\n\nclass SearchProviderService {\n\n\tconstructor() {\n\t\tthis.providers = {};\n\t\tthis.activeProvider = undefined;\n\t}\n\n\t/**\n\t * Stop current provider (if there is one) and start the new\n\t * @param id the id of the provider which should be started\n\t * @param cb a possible callback if provider is active or not (currently not in use)\n\t */\n\tuse(id) {\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!this.providers[id]) { throw new Error(`provider ${ id } cannot be found`); }\n\n\t\t\tlet reason = 'switch';\n\n\t\t\tif (!this.activeProvider) {\n\t\t\t\treason = 'startup';\n\t\t\t} else if (this.activeProvider.key === this.providers[id].key) {\n\t\t\t\treason = 'update';\n\t\t\t}\n\n\t\t\tconst stopProvider = () => {\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tif (this.activeProvider) {\n\n\t\t\t\t\t\tSearchLogger.debug(`Stopping provider '${ this.activeProvider.key }'`);\n\n\t\t\t\t\t\tthis.activeProvider.stop(resolve, reject);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tstopProvider().then(() => {\n\t\t\t\tthis.activeProvider = undefined;\n\n\t\t\t\tSearchLogger.debug(`Start provider '${ id }'`);\n\n\t\t\t\ttry {\n\n\t\t\t\t\tthis.providers[id].run(reason).then(() => {\n\t\t\t\t\t\tthis.activeProvider = this.providers[id];\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t}, reject);\n\n\t\t\t\t} catch (e) {\n\t\t\t\t\treject(e);\n\t\t\t\t}\n\t\t\t}, reject);\n\n\t\t});\n\n\t}\n\n\t/**\n\t * Registers a search provider on system startup\n\t * @param provider\n\t */\n\tregister(provider) {\n\t\tthis.providers[provider.key] = provider;\n\t}\n\n\t/**\n\t * Starts the service (loads provider settings for admin ui, add lister not setting changes, enable current provider\n\t */\n\tstart() {\n\t\tSearchLogger.debug('Load data for all providers');\n\n\t\tconst providers = this.providers;\n\n\t\t//add settings for admininistration\n\t\tRocketChat.settings.addGroup('Search', function() {\n\n\t\t\tconst self = this;\n\n\t\t\tself.add('Search.Provider', 'defaultProvider', {\n\t\t\t\ttype: 'select',\n\t\t\t\tvalues: Object.keys(providers).map((key) => { return {key, i18nLabel: providers[key].i18nLabel}; }),\n\t\t\t\tpublic: true,\n\t\t\t\ti18nLabel: 'Search_Provider'\n\t\t\t});\n\n\t\t\tObject.keys(providers)\n\t\t\t\t.filter((key) => providers[key].settings && providers[key].settings.length > 0)\n\t\t\t\t.forEach(function(key) {\n\t\t\t\t\tself.section(providers[key].i18nLabel, function() {\n\t\t\t\t\t\tproviders[key].settings.forEach((setting) => {\n\n\t\t\t\t\t\t\tconst _options = {\n\t\t\t\t\t\t\t\ttype: setting.type,\n\t\t\t\t\t\t\t\t...setting.options\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t_options.enableQuery = _options.enableQuery || [];\n\n\t\t\t\t\t\t\t_options.enableQuery.push({\n\t\t\t\t\t\t\t\t_id: 'Search.Provider',\n\t\t\t\t\t\t\t\tvalue: key\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tthis.add(setting.id, setting.defaultValue, _options);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t});\n\n\t\t//add listener to react on setting changes\n\t\tconst configProvider = _.debounce(Meteor.bindEnvironment(() => {\n\t\t\tconst providerId = RocketChat.settings.get('Search.Provider');\n\n\t\t\tif (providerId) {\n\t\t\t\tthis.use(providerId);//TODO do something with success and errors\n\t\t\t}\n\n\t\t}), 1000);\n\n\t\tRocketChat.settings.get(/^Search\\./, configProvider);\n\t}\n\n}\n\nexport const searchProviderService = new SearchProviderService();\n\nMeteor.startup(() => {\n\tsearchProviderService.start();\n});\n\nMeteor.methods({\n\t/**\n\t * Search using the current search provider and check if results are valid for the user. The search result has\n\t * the format {messages:{start:0,numFound:1,docs:[{...}]},users:{...},rooms:{...}}\n\t * @param text the search text\n\t * @param context the context (uid, rid)\n\t * @param payload custom payload (e.g. for paging)\n\t * @returns {*}\n\t */\n\t'rocketchatSearch.search'(text, context, payload) {\n\n\t\treturn new Promise((resolve, reject) => {\n\n\t\t\tpayload = payload !== null ? payload : undefined;//TODO is this cleanup necessary?\n\n\t\t\ttry {\n\n\t\t\t\tif (!searchProviderService.activeProvider) {\n\t\t\t\t\tthrow new Error('Provider currently not active');\n\t\t\t\t}\n\n\t\t\t\tSearchLogger.debug('search: ', `\\n\\tText:${ text }\\n\\tContext:${ JSON.stringify(context) }\\n\\tPayload:${ JSON.stringify(payload) }`);\n\n\t\t\t\tsearchProviderService.activeProvider.search(text, context, payload, (error, data) => {\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(validationService.validateSearchResult(data));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (e) {\n\t\t\t\treject(e);\n\t\t\t}\n\t\t});\n\t},\n\t'rocketchatSearch.suggest'(text, context, payload) {\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tpayload = payload !== null ? payload : undefined;//TODO is this cleanup necessary?\n\n\t\t\ttry {\n\n\t\t\t\tif (!searchProviderService.activeProvider) { throw new Error('Provider currently not active'); }\n\n\t\t\t\tSearchLogger.debug('suggest: ', `\\n\\tText:${ text }\\n\\tContext:${ JSON.stringify(context) }\\n\\tPayload:${ JSON.stringify(payload) }`);\n\n\t\t\t\tsearchProviderService.activeProvider.suggest(text, context, payload, (error, data) => {\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(data);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (e) {\n\t\t\t\treject(e);\n\t\t\t}\n\t\t});\n\t},\n\t/**\n\t * Get the current provider with key, description, resultTemplate, suggestionItemTemplate and settings (as Map)\n\t * @returns {*}\n\t */\n\t'rocketchatSearch.getProvider'() {\n\t\tif (!searchProviderService.activeProvider) { return undefined; }\n\n\t\treturn {\n\t\t\tkey: searchProviderService.activeProvider.key,\n\t\t\tdescription: searchProviderService.activeProvider.i18nDescription,\n\t\t\ticon: searchProviderService.activeProvider.iconName,\n\t\t\tresultTemplate: searchProviderService.activeProvider.resultTemplate,\n\t\t\tsupportsSuggestions: searchProviderService.activeProvider.supportsSuggestions,\n\t\t\tsuggestionItemTemplate: searchProviderService.activeProvider.suggestionItemTemplate,\n\t\t\tsettings: _.mapObject(searchProviderService.activeProvider.settingsAsMap, (setting) => {\n\t\t\t\treturn setting.value;\n\t\t\t})\n\t\t};\n\t}\n});\n\n","import SearchLogger from '../logger/logger';\n\nclass ValidationService {\n\tconstructor() {}\n\n\tvalidateSearchResult(result) {\n\n\t\tconst subscriptionCache = {};\n\n\t\tconst getSubscription = (rid, uid) => {\n\t\t\tif (!subscriptionCache.hasOwnProperty(rid)) {\n\t\t\t\tsubscriptionCache[rid] = Meteor.call('canAccessRoom', rid, uid);\n\t\t\t}\n\n\t\t\treturn subscriptionCache[rid];\n\t\t};\n\n\t\tconst userCache = {};\n\n\t\tconst getUsername = (uid) => {\n\t\t\tif (!userCache.hasOwnProperty(uid)) {\n\t\t\t\ttry {\n\t\t\t\t\tuserCache[uid] = RocketChat.models.Users.findById(uid).fetch()[0].username;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tuserCache[uid] = undefined;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn userCache[uid];\n\t\t};\n\n\t\tconst uid = Meteor.userId();\n\t\t//get subscription for message\n\t\tif (result.message) {\n\t\t\tresult.message.docs.forEach((msg) => {\n\n\t\t\t\tconst subscription = getSubscription(msg.rid, uid);\n\n\t\t\t\tif (subscription) {\n\t\t\t\t\tmsg.r = {name: subscription.name, t: subscription.t};\n\t\t\t\t\tmsg.username = getUsername(msg.user);\n\t\t\t\t\tmsg.valid = true;\n\t\t\t\t\tSearchLogger.debug(`user ${ uid } can access ${ msg.rid } ( ${ subscription.t === 'd' ? subscription.username : subscription.name } )`);\n\t\t\t\t} else {\n\t\t\t\t\tSearchLogger.debug(`user ${ uid } can NOT access ${ msg.rid }`);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tresult.message.docs.filter((msg) => {\n\t\t\t\treturn msg.valid;\n\t\t\t});\n\t\t}\n\n\t\tif (result.room) {\n\t\t\tresult.room.docs.forEach((room) => {\n\t\t\t\tconst subscription = getSubscription(room._id, uid);\n\t\t\t\tif (subscription) {\n\t\t\t\t\troom.valid = true;\n\t\t\t\t\tSearchLogger.debug(`user ${ uid } can access ${ room._id } ( ${ subscription.t === 'd' ? subscription.username : subscription.name } )`);\n\t\t\t\t} else {\n\t\t\t\t\tSearchLogger.debug(`user ${ uid } can NOT access ${ room._id }`);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tresult.room.docs.filter((room) => {\n\t\t\t\treturn room.valid;\n\t\t\t});\n\t\t}\n\n\t\treturn result;\n\t}\n}\n\nexport const validationService = new ValidationService();\n"]}