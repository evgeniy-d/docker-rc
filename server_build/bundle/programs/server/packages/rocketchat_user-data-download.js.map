{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:user-data-download/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:user-data-download/server/cronProcessDownloads.js"],"names":["RocketChat","settings","addGroup","add","type","public","i18nLabel","fs","module","watch","require","default","v","path","archiver","zipFolder","get","trim","processingFrequency","startFile","fileName","content","writeFileSync","writeToFile","appendFileSync","createDir","folderName","existsSync","mkdirSync","loadUserSubscriptions","exportOperation","roomList","exportUserId","userId","cursor","models","Subscriptions","findByUserId","forEach","subscription","roomId","rid","roomData","Rooms","findOneById","roomName","name","t","replace","userData","Users","fullExport","fileType","targetFile","push","exportedCount","status","getAttachmentData","attachment","attachmentData","title","title_link","image_url","audio_url","video_url","message_link","image_type","image_size","video_size","video_type","audio_size","audio_type","url","remote","fileId","urlMatch","exec","length","match","file","Uploads","_id","addToFileList","join","assetsPath","copied","fileList","getMessageData","msg","attachments","messageObject","username","u","ts","copyFile","FileUpload","copy","continueExportingRoom","exportOpRoomData","exportPath","filePath","limit","skip","Messages","findByRoomId","count","messageString","JSON","stringify","messageType","userName","timestamp","Date","toUTCString","message","TAPi18n","__","user_added","user_by","room_name","user_removed","user","description","assetUrl","link","isExportComplete","incomplete","some","isDownloadFinished","anyDownloadPending","fileData","sendEmail","lastFile","UserDataFiles","findLastFileByUser","emails","address","emailAddress","fromAddress","subject","download_link","body","rfcMailPatternWithName","test","Meteor","defer","Email","send","to","from","html","console","log","makeZipFile","output","createWriteStream","generatedFile","archive","on","err","pipe","directory","finalize","uploadZipFile","callback","userDataStore","getStore","stat","wrapAsync","stream","createReadStream","contentType","size","userDisplayName","utcDate","toISOString","split","newFileName","encodeURIComponent","details","insert","Error","method","generateChannelsFile","newRoomData","continueExportOperation","unlinkSync","ExportOperations","updateOperation","e","error","processDataDownloads","findAllPending","startup","SyncedCron","schedule","parser","cron","job"],"mappings":"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","file":"/packages/rocketchat_user-data-download.js","sourcesContent":["RocketChat.settings.addGroup('UserDataDownload', function() {\n\n\tthis.add('UserData_EnableDownload', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nLabel: 'UserData_EnableDownload'\n\t});\n\n\tthis.add('UserData_FileSystemPath', '', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nLabel: 'UserData_FileSystemPath'\n\t});\n\n\tthis.add('UserData_FileSystemZipPath', '', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nLabel: 'UserData_FileSystemZipPath'\n\t});\n\n\tthis.add('UserData_ProcessingFrequency', 15, {\n\t\ttype: 'int',\n\t\tpublic: true,\n\t\ti18nLabel: 'UserData_ProcessingFrequency'\n\t});\n\n\tthis.add('UserData_MessageLimitPerRequest', 100, {\n\t\ttype: 'int',\n\t\tpublic: true,\n\t\ti18nLabel: 'UserData_MessageLimitPerRequest'\n\t});\n\n\n});\n","/* globals SyncedCron */\n\nimport fs from 'fs';\nimport path from 'path';\nimport archiver from 'archiver';\n\nlet zipFolder = '/tmp/zipFiles';\nif (RocketChat.settings.get('UserData_FileSystemZipPath') != null) {\n\tif (RocketChat.settings.get('UserData_FileSystemZipPath').trim() !== '') {\n\t\tzipFolder = RocketChat.settings.get('UserData_FileSystemZipPath');\n\t}\n}\n\nlet processingFrequency = 15;\nif (RocketChat.settings.get('UserData_ProcessingFrequency') > 0) {\n\tprocessingFrequency = RocketChat.settings.get('UserData_ProcessingFrequency');\n}\n\nconst startFile = function(fileName, content) {\n\tfs.writeFileSync(fileName, content);\n};\n\nconst writeToFile = function(fileName, content) {\n\tfs.appendFileSync(fileName, content);\n};\n\nconst createDir = function(folderName) {\n\tif (!fs.existsSync(folderName)) {\n\t\tfs.mkdirSync(folderName);\n\t}\n};\n\nconst loadUserSubscriptions = function(exportOperation) {\n\texportOperation.roomList = [];\n\n\tconst exportUserId = exportOperation.userId;\n\tconst cursor = RocketChat.models.Subscriptions.findByUserId(exportUserId);\n\tcursor.forEach((subscription) => {\n\t\tconst roomId = subscription.rid;\n\t\tconst roomData = RocketChat.models.Rooms.findOneById(roomId);\n\t\tlet roomName = roomData.name ? roomData.name : roomId;\n\t\tlet userId = null;\n\n\t\tif (subscription.t === 'd') {\n\t\t\tuserId = roomId.replace(exportUserId, '');\n\t\t\tconst userData = RocketChat.models.Users.findOneById(userId);\n\n\t\t\tif (userData) {\n\t\t\t\troomName = userData.name;\n\t\t\t}\n\t\t}\n\n\t\tconst fileName = exportOperation.fullExport ? roomId : roomName;\n\t\tconst fileType = exportOperation.fullExport ? 'json' : 'html';\n\t\tconst targetFile = `${ fileName }.${ fileType }`;\n\n\t\texportOperation.roomList.push({\n\t\t\troomId,\n\t\t\troomName,\n\t\t\tuserId,\n\t\t\texportedCount: 0,\n\t\t\tstatus: 'pending',\n\t\t\ttargetFile,\n\t\t\ttype: subscription.t\n\t\t});\n\t});\n\n\tif (exportOperation.fullExport) {\n\t\texportOperation.status = 'exporting-rooms';\n\t} else {\n\t\texportOperation.status = 'exporting';\n\t}\n};\n\nconst getAttachmentData = function(attachment) {\n\tconst attachmentData = {\n\t\ttype : attachment.type,\n\t\ttitle: attachment.title,\n\t\ttitle_link: attachment.title_link,\n\t\timage_url: attachment.image_url,\n\t\taudio_url: attachment.audio_url,\n\t\tvideo_url: attachment.video_url,\n\t\tmessage_link: attachment.message_link,\n\t\timage_type: attachment.image_type,\n\t\timage_size: attachment.image_size,\n\t\tvideo_size: attachment.video_size,\n\t\tvideo_type: attachment.video_type,\n\t\taudio_size: attachment.audio_size,\n\t\taudio_type: attachment.audio_type,\n\t\turl: null,\n\t\tremote: false,\n\t\tfileId: null,\n\t\tfileName: null\n\t};\n\n\tconst url = attachment.title_link || attachment.image_url || attachment.audio_url || attachment.video_url || attachment.message_link;\n\tif (url) {\n\t\tattachmentData.url = url;\n\n\t\tconst urlMatch = /\\:\\/\\//.exec(url);\n\t\tif (urlMatch && urlMatch.length > 0) {\n\t\t\tattachmentData.remote = true;\n\t\t} else {\n\t\t\tconst match = /^\\/([^\\/]+)\\/([^\\/]+)\\/(.*)/.exec(url);\n\n\t\t\tif (match && match[2]) {\n\t\t\t\tconst file = RocketChat.models.Uploads.findOneById(match[2]);\n\n\t\t\t\tif (file) {\n\t\t\t\t\tattachmentData.fileId = file._id;\n\t\t\t\t\tattachmentData.fileName = file.name;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn attachmentData;\n};\n\nconst addToFileList = function(exportOperation, attachment) {\n\tconst targetFile = path.join(exportOperation.assetsPath, `${ attachment.fileId }-${ attachment.fileName }`);\n\n\tconst attachmentData = {\n\t\turl: attachment.url,\n\t\tcopied: false,\n\t\tremote: attachment.remote,\n\t\tfileId: attachment.fileId,\n\t\tfileName: attachment.fileName,\n\t\ttargetFile\n\t};\n\n\texportOperation.fileList.push(attachmentData);\n};\n\nconst getMessageData = function(msg, exportOperation) {\n\tconst attachments = [];\n\n\tif (msg.attachments) {\n\t\tmsg.attachments.forEach((attachment) => {\n\t\t\tconst attachmentData = getAttachmentData(attachment);\n\n\t\t\tattachments.push(attachmentData);\n\t\t\taddToFileList(exportOperation, attachmentData);\n\t\t});\n\t}\n\n\tconst messageObject = {\n\t\tmsg: msg.msg,\n\t\tusername: msg.u.username,\n\t\tts: msg.ts\n\t};\n\n\tif (attachments && attachments.length > 0) {\n\t\tmessageObject.attachments = attachments;\n\t}\n\tif (msg.t) {\n\t\tmessageObject.type = msg.t;\n\t}\n\tif (msg.u.name) {\n\t\tmessageObject.name = msg.u.name;\n\t}\n\n\treturn messageObject;\n};\n\nconst copyFile = function(exportOperation, attachmentData) {\n\tif (attachmentData.copied || attachmentData.remote || !attachmentData.fileId) {\n\t\tattachmentData.copied = true;\n\t\treturn;\n\t}\n\n\tconst file = RocketChat.models.Uploads.findOneById(attachmentData.fileId);\n\n\tif (file) {\n\t\tif (FileUpload.copy(file, attachmentData.targetFile)) {\n\t\t\tattachmentData.copied = true;\n\t\t}\n\t}\n};\n\nconst continueExportingRoom = function(exportOperation, exportOpRoomData) {\n\tcreateDir(exportOperation.exportPath);\n\tcreateDir(exportOperation.assetsPath);\n\n\tconst filePath = path.join(exportOperation.exportPath, exportOpRoomData.targetFile);\n\n\tif (exportOpRoomData.status === 'pending') {\n\t\texportOpRoomData.status = 'exporting';\n\t\tstartFile(filePath, '');\n\t\tif (!exportOperation.fullExport) {\n\t\t\twriteToFile(filePath, '<meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\">');\n\t\t}\n\t}\n\n\tlet limit = 100;\n\tif (RocketChat.settings.get('UserData_MessageLimitPerRequest') > 0) {\n\t\tlimit = RocketChat.settings.get('UserData_MessageLimitPerRequest');\n\t}\n\n\tconst skip = exportOpRoomData.exportedCount;\n\n\tconst cursor = RocketChat.models.Messages.findByRoomId(exportOpRoomData.roomId, { limit, skip });\n\tconst count = cursor.count();\n\n\tcursor.forEach((msg) => {\n\t\tconst messageObject = getMessageData(msg, exportOperation);\n\n\t\tif (exportOperation.fullExport) {\n\t\t\tconst messageString = JSON.stringify(messageObject);\n\t\t\twriteToFile(filePath, `${ messageString }\\n`);\n\t\t} else {\n\t\t\tconst messageType = msg.t;\n\t\t\tconst userName = msg.u.username || msg.u.name;\n\t\t\tconst timestamp = msg.ts ? new Date(msg.ts).toUTCString() : '';\n\t\t\tlet message = msg.msg;\n\n\t\t\tswitch (messageType) {\n\t\t\t\tcase 'uj':\n\t\t\t\t\tmessage = TAPi18n.__('User_joined_channel');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'ul':\n\t\t\t\t\tmessage = TAPi18n.__('User_left');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'au':\n\t\t\t\t\tmessage = TAPi18n.__('User_added_by', {user_added : msg.msg, user_by : msg.u.username });\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'r':\n\t\t\t\t\tmessage = TAPi18n.__('Room_name_changed', { room_name: msg.msg, user_by: msg.u.username });\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'ru':\n\t\t\t\t\tmessage = TAPi18n.__('User_removed_by', {user_removed : msg.msg, user_by : msg.u.username });\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'wm':\n\t\t\t\t\tmessage = TAPi18n.__('Welcome', {user: msg.u.username });\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'livechat-close':\n\t\t\t\t\tmessage = TAPi18n.__('Conversation_finished');\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (message !== msg.msg) {\n\t\t\t\tmessage = `<i>${ message }</i>`;\n\t\t\t}\n\n\t\t\twriteToFile(filePath, `<p><strong>${ userName }</strong> (${ timestamp }):<br/>`);\n\t\t\twriteToFile(filePath, message);\n\n\t\t\tif (messageObject.attachments && messageObject.attachments.length > 0) {\n\t\t\t\tmessageObject.attachments.forEach((attachment) => {\n\t\t\t\t\tif (attachment.type === 'file') {\n\t\t\t\t\t\tconst description = attachment.description || attachment.title || TAPi18n.__('Message_Attachments');\n\n\t\t\t\t\t\tconst assetUrl = `./assets/${ attachment.fileId }-${ attachment.fileName }`;\n\t\t\t\t\t\tconst link = `<br/><a href=\"${ assetUrl }\">${ description }</a>`;\n\t\t\t\t\t\twriteToFile(filePath, link);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\twriteToFile(filePath, '</p>');\n\t\t}\n\n\t\texportOpRoomData.exportedCount++;\n\t});\n\n\tif (count <= exportOpRoomData.exportedCount) {\n\t\texportOpRoomData.status = 'completed';\n\t\treturn true;\n\t}\n\n\treturn false;\n};\n\nconst isExportComplete = function(exportOperation) {\n\tconst incomplete = exportOperation.roomList.some((exportOpRoomData) => {\n\t\treturn exportOpRoomData.status !== 'completed';\n\t});\n\n\treturn !incomplete;\n};\n\nconst isDownloadFinished = function(exportOperation) {\n\tconst anyDownloadPending = exportOperation.fileList.some((fileData) => {\n\t\treturn !fileData.copied && !fileData.remote;\n\t});\n\n\treturn !anyDownloadPending;\n};\n\nconst sendEmail = function(userId) {\n\tconst lastFile = RocketChat.models.UserDataFiles.findLastFileByUser(userId);\n\tif (lastFile) {\n\t\tconst userData = RocketChat.models.Users.findOneById(userId);\n\n\t\tif (userData && userData.emails && userData.emails[0] && userData.emails[0].address) {\n\t\t\tconst emailAddress = `${ userData.name } <${ userData.emails[0].address }>`;\n\t\t\tconst fromAddress = RocketChat.settings.get('From_Email');\n\t\t\tconst subject = TAPi18n.__('UserDataDownload_EmailSubject');\n\n\t\t\tconst download_link = lastFile.url;\n\t\t\tconst body = TAPi18n.__('UserDataDownload_EmailBody', { download_link });\n\n\t\t\tconst rfcMailPatternWithName = /^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/;\n\n\t\t\tif (rfcMailPatternWithName.test(emailAddress)) {\n\t\t\t\tMeteor.defer(function() {\n\t\t\t\t\treturn Email.send({\n\t\t\t\t\t\tto: emailAddress,\n\t\t\t\t\t\tfrom: fromAddress,\n\t\t\t\t\t\tsubject,\n\t\t\t\t\t\thtml: body\n\t\t\t\t\t});\n\t\t\t\t});\n\n\t\t\t\treturn console.log(`Sending email to ${ emailAddress }`);\n\t\t\t}\n\t\t}\n\t}\n};\n\nconst makeZipFile = function(exportOperation) {\n\tcreateDir(zipFolder);\n\n\tconst targetFile = path.join(zipFolder, `${ exportOperation.userId }.zip`);\n\tif (fs.existsSync(targetFile)) {\n\t\texportOperation.status = 'uploading';\n\t\treturn;\n\t}\n\n\tconst output = fs.createWriteStream(targetFile);\n\n\texportOperation.generatedFile = targetFile;\n\n\tconst archive = archiver('zip');\n\n\toutput.on('close', () => {\n\t});\n\n\tarchive.on('error', (err) => {\n\t\tthrow err;\n\t});\n\n\tarchive.pipe(output);\n\tarchive.directory(exportOperation.exportPath, false);\n\tarchive.finalize();\n};\n\nconst uploadZipFile = function(exportOperation, callback) {\n\tconst userDataStore = FileUpload.getStore('UserDataFiles');\n\tconst filePath = exportOperation.generatedFile;\n\n\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\tconst stream = fs.createReadStream(filePath);\n\n\tconst contentType = 'application/zip';\n\tconst size = stat.size;\n\n\tconst userId = exportOperation.userId;\n\tconst user = RocketChat.models.Users.findOneById(userId);\n\tconst userDisplayName = user ? user.name : userId;\n\tconst utcDate = new Date().toISOString().split('T')[0];\n\n\tconst newFileName = encodeURIComponent(`${ utcDate }-${ userDisplayName }.zip`);\n\n\tconst details = {\n\t\tuserId,\n\t\ttype: contentType,\n\t\tsize,\n\t\tname: newFileName\n\t};\n\n\tuserDataStore.insert(details, stream, (err) => {\n\t\tif (err) {\n\t\t\tthrow new Meteor.Error('invalid-file', 'Invalid Zip File', { method: 'cronProcessDownloads.uploadZipFile' });\n\t\t} else {\n\t\t\tcallback();\n\t\t}\n\t});\n};\n\nconst generateChannelsFile = function(exportOperation) {\n\tif (exportOperation.fullExport) {\n\t\tconst fileName = path.join(exportOperation.exportPath, 'channels.json');\n\t\tstartFile(fileName, '');\n\n\t\texportOperation.roomList.forEach((roomData) => {\n\t\t\tconst newRoomData = {\n\t\t\t\troomId: roomData.roomId,\n\t\t\t\troomName: roomData.roomName,\n\t\t\t\ttype: roomData.type\n\t\t\t};\n\n\t\t\tconst messageString = JSON.stringify(newRoomData);\n\t\t\twriteToFile(fileName, `${ messageString }\\n`);\n\t\t});\n\t}\n\n\texportOperation.status = 'exporting';\n};\n\nconst continueExportOperation = function(exportOperation) {\n\tif (exportOperation.status === 'completed') {\n\t\treturn;\n\t}\n\n\tif (!exportOperation.roomList) {\n\t\tloadUserSubscriptions(exportOperation);\n\t}\n\n\ttry {\n\n\t\tif (exportOperation.status === 'exporting-rooms') {\n\t\t\tgenerateChannelsFile(exportOperation);\n\t\t}\n\n\t\t//Run every room on every request, to avoid missing new messages on the rooms that finished first.\n\t\tif (exportOperation.status === 'exporting') {\n\t\t\texportOperation.roomList.forEach((exportOpRoomData) => {\n\t\t\t\tcontinueExportingRoom(exportOperation, exportOpRoomData);\n\t\t\t});\n\n\t\t\tif (isExportComplete(exportOperation)) {\n\t\t\t\texportOperation.status = 'downloading';\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (exportOperation.status === 'downloading') {\n\t\t\texportOperation.fileList.forEach((attachmentData) => {\n\t\t\t\tcopyFile(exportOperation, attachmentData);\n\t\t\t});\n\n\t\t\tif (isDownloadFinished(exportOperation)) {\n\t\t\t\tconst targetFile = path.join(zipFolder, `${ exportOperation.userId }.zip`);\n\t\t\t\tif (fs.existsSync(targetFile)) {\n\t\t\t\t\tfs.unlinkSync(targetFile);\n\t\t\t\t}\n\n\t\t\t\texportOperation.status = 'compressing';\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (exportOperation.status === 'compressing') {\n\t\t\tmakeZipFile(exportOperation);\n\t\t\treturn;\n\t\t}\n\n\t\tif (exportOperation.status === 'uploading') {\n\t\t\tuploadZipFile(exportOperation, () => {\n\t\t\t\texportOperation.status = 'completed';\n\t\t\t\tRocketChat.models.ExportOperations.updateOperation(exportOperation);\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\t} catch (e) {\n\t\tconsole.error(e);\n\t}\n};\n\nfunction processDataDownloads() {\n\tconst cursor = RocketChat.models.ExportOperations.findAllPending({limit: 1});\n\tcursor.forEach((exportOperation) => {\n\t\tif (exportOperation.status === 'completed') {\n\t\t\treturn;\n\t\t}\n\n\t\tcontinueExportOperation(exportOperation);\n\t\tRocketChat.models.ExportOperations.updateOperation(exportOperation);\n\n\t\tif (exportOperation.status === 'completed') {\n\t\t\tsendEmail(exportOperation.userId);\n\t\t}\n\t});\n}\n\nMeteor.startup(function() {\n\tMeteor.defer(function() {\n\t\tprocessDataDownloads();\n\n\t\tSyncedCron.add({\n\t\t\tname: 'Generate download files for user data',\n\t\t\tschedule: (parser) => parser.cron(`*/${ processingFrequency } * * * *`),\n\t\t\tjob: processDataDownloads\n\t\t});\n\t});\n});\n"]}