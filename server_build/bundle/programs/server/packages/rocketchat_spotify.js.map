{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:spotify/lib/spotify.js"],"names":["_","module","watch","require","default","v","s","process","message","source","callback","trim","msgParts","split","index","length","part","undefined","codeMatch","match","Spotify","transform","urls","Array","isArray","concat","changed","msg","re","exec","data","filter","slice","value","path","map","escape","join","url","push","render","html","item","from","quotedSource","replace","RegExp","RocketChat","callbacks","add","priority","LOW","MEDIUM"],"mappings":"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","file":"/packages/rocketchat_spotify.js","sourcesContent":["/*\n * Spotify a named function that will process Spotify links or syntaxes (ex: spotify:track:1q6IK1l4qpYykOaWaLJkWG)\n * @param {Object} message - The message object\n */\nimport _ from 'underscore';\nimport s from 'underscore.string';\n\nconst process = function(message, source, callback) {\n\tif (s.trim(source)) {\n\t\t// Separate text in code blocks and non code blocks\n\t\tconst msgParts = source.split(/(```\\w*[\\n ]?[\\s\\S]*?```+?)|(`(?:[^`]+)`)/);\n\n\t\tfor (let index = 0; index < msgParts.length; index++) {\n\t\t\t// Verify if this part is code\n\t\t\tconst part = msgParts[index];\n\n\t\t\tif (((part != null ? part.length > 0 : undefined) != null)) {\n\t\t\t\tconst codeMatch = part.match(/(?:```(\\w*)[\\n ]?([\\s\\S]*?)```+?)|(?:`(?:[^`]+)`)/);\n\t\t\t\tif (codeMatch == null) {\n\t\t\t\t\tcallback(message, msgParts, index, part);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n};\nclass Spotify {\n\tstatic transform(message) {\n\t\tlet urls = [];\n\t\tif (Array.isArray(message.urls)) {\n\t\t\turls = urls.concat(message.urls);\n\t\t}\n\n\t\tlet changed = false;\n\n\t\tprocess(message, message.msg, function(message, msgParts, index, part) {\n\t\t\tconst re = /(?:^|\\s)spotify:([^:\\s]+):([^:\\s]+)(?::([^:\\s]+))?(?::(\\S+))?(?:\\s|$)/g;\n\n\t\t\tlet match;\n\t\t\twhile ((match = re.exec(part))) {\n\t\t\t\tconst data = _.filter(match.slice(1), value => value != null);\n\t\t\t\tconst path = _.map(data, value => _.escape(value)).join('/');\n\t\t\t\tconst url = `https://open.spotify.com/${ path }`;\n\t\t\t\turls.push({url, 'source': `spotify:${ data.join(':') }`});\n\t\t\t\tchanged = true;\n\t\t\t}\n\n\t\t});\n\n\t\t// Re-mount message\n\t\tif (changed) {\n\t\t\tmessage.urls = urls;\n\t\t}\n\n\t\treturn message;\n\t}\n\n\tstatic render(message) {\n\t\tprocess(message, message.html, function(message, msgParts, index, part) {\n\t\t\tif (Array.isArray(message.urls)) {\n\t\t\t\tfor (const item of Array.from(message.urls)) {\n\t\t\t\t\tif (item.source) {\n\t\t\t\t\t\tconst quotedSource = item.source.replace(/[\\\\^$.*+?()[\\]{}|]/g, '\\\\$&');\n\t\t\t\t\t\tconst re = new RegExp(`(^|\\\\s)${ quotedSource }(\\\\s|$)`, 'g');\n\t\t\t\t\t\tmsgParts[index] = part.replace(re, `$1<a href=\"${ item.url }\" target=\"_blank\">${ item.source }</a>$2`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn message.html = msgParts.join('');\n\t\t\t}\n\t\t});\n\n\t\treturn message;\n\t}\n}\n\nRocketChat.callbacks.add('beforeSaveMessage', Spotify.transform, RocketChat.callbacks.priority.LOW, 'spotify-save');\nRocketChat.callbacks.add('renderMessage', Spotify.render, RocketChat.callbacks.priority.MEDIUM, 'spotify-render');\nRocketChat.Spotify = Spotify;\n"]}