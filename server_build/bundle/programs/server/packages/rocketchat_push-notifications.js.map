{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:push-notifications/server/methods/saveNotificationSettings.js","meteor://ðŸ’»app/packages/rocketchat:push-notifications/server/models/Subscriptions.js"],"names":["Meteor","methods","saveNotificationSettings","roomId","field","value","userId","Error","method","check","String","notifications","updateMethod","subscription","RocketChat","models","Subscriptions","updateAudioNotificationsById","_id","userPref","getUserNotificationPreference","updateDesktopNotificationsById","origin","updateMobilePushNotificationsById","updateEmailNotificationsById","updateUnreadAlertById","updateDisableNotificationsById","updateHideUnreadStatusById","updateMuteGroupMentions","updateDesktopNotificationDurationById","updateAudioNotificationValueById","isInvalidNotification","Object","keys","includes","basicValuesForNotifications","fieldsMustHaveBasicValues","findOneByRoomIdAndUserId","saveAudioNotificationValue","rid","saveDesktopNotificationDuration","audioNotifications","query","update","$unset","$set","audioNotificationValue","desktopNotifications","desktopPrefOrigin","desktopNotificationDuration","parseInt","mobilePushNotifications","mobilePrefOrigin","emailNotifications","emailPrefOrigin","unreadAlert","disableNotifications","hideUnreadStatus","muteGroupMentions","findAlwaysNotifyAudioUsersByRoomId","find","findAlwaysNotifyDesktopUsersByRoomId","findDontNotifyDesktopUsersByRoomId","findAlwaysNotifyMobileUsersByRoomId","findDontNotifyMobileUsersByRoomId","findWithSendEmailByRoomId","$exists","fields","u","findNotificationPreferencesByRoom","_db","t","name","fname","code","ignored","userHighlights","findAllMessagesNotificationPreferencesByRoom","$or","$in"],"mappings":"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","file":"/packages/rocketchat_push-notifications.js","sourcesContent":["Meteor.methods({\n\tsaveNotificationSettings(roomId, field, value) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'saveNotificationSettings' });\n\t\t}\n\t\tcheck(roomId, String);\n\t\tcheck(field, String);\n\t\tcheck(value, String);\n\n\t\tconst notifications = {\n\t\t\t'audioNotifications': {\n\t\t\t\tupdateMethod: (subscription, value) => RocketChat.models.Subscriptions.updateAudioNotificationsById(subscription._id, value)\n\t\t\t},\n\t\t\t'desktopNotifications': {\n\t\t\t\tupdateMethod: (subscription, value) => {\n\t\t\t\t\tif (value === 'default') {\n\t\t\t\t\t\tconst userPref = RocketChat.getUserNotificationPreference(Meteor.userId(), 'desktop');\n\t\t\t\t\t\tRocketChat.models.Subscriptions.updateDesktopNotificationsById(subscription._id, userPref.origin === 'server' ? null : userPref);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tRocketChat.models.Subscriptions.updateDesktopNotificationsById(subscription._id, { value, origin: 'subscription' });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t'mobilePushNotifications': {\n\t\t\t\tupdateMethod: (subscription, value) => {\n\t\t\t\t\tif (value === 'default') {\n\t\t\t\t\t\tconst userPref = RocketChat.getUserNotificationPreference(Meteor.userId(), 'mobile');\n\t\t\t\t\t\tRocketChat.models.Subscriptions.updateMobilePushNotificationsById(subscription._id, userPref.origin === 'server' ? null : userPref);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tRocketChat.models.Subscriptions.updateMobilePushNotificationsById(subscription._id, { value, origin: 'subscription' });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t'emailNotifications': {\n\t\t\t\tupdateMethod: (subscription, value) => {\n\t\t\t\t\tif (value === 'default') {\n\t\t\t\t\t\tconst userPref = RocketChat.getUserNotificationPreference(Meteor.userId(), 'email');\n\t\t\t\t\t\tRocketChat.models.Subscriptions.updateEmailNotificationsById(subscription._id, userPref.origin === 'server' ? null : userPref);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tRocketChat.models.Subscriptions.updateEmailNotificationsById(subscription._id, { value, origin: 'subscription' });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t'unreadAlert': {\n\t\t\t\tupdateMethod: (subscription, value) => RocketChat.models.Subscriptions.updateUnreadAlertById(subscription._id, value)\n\t\t\t},\n\t\t\t'disableNotifications': {\n\t\t\t\tupdateMethod: (subscription, value) => RocketChat.models.Subscriptions.updateDisableNotificationsById(subscription._id, value === '1')\n\t\t\t},\n\t\t\t'hideUnreadStatus': {\n\t\t\t\tupdateMethod: (subscription, value) => RocketChat.models.Subscriptions.updateHideUnreadStatusById(subscription._id, value === '1')\n\t\t\t},\n\t\t\t'muteGroupMentions': {\n\t\t\t\tupdateMethod: (subscription, value) => RocketChat.models.Subscriptions.updateMuteGroupMentions(subscription._id, value === '1')\n\t\t\t},\n\t\t\t'desktopNotificationDuration': {\n\t\t\t\tupdateMethod: (subscription, value) => RocketChat.models.Subscriptions.updateDesktopNotificationDurationById(subscription._id, value)\n\t\t\t},\n\t\t\t'audioNotificationValue': {\n\t\t\t\tupdateMethod: (subscription, value) => RocketChat.models.Subscriptions.updateAudioNotificationValueById(subscription._id, value)\n\t\t\t}\n\t\t};\n\t\tconst isInvalidNotification = !Object.keys(notifications).includes(field);\n\t\tconst basicValuesForNotifications = ['all', 'mentions', 'nothing', 'default'];\n\t\tconst fieldsMustHaveBasicValues = ['emailNotifications', 'audioNotifications', 'mobilePushNotifications', 'desktopNotifications'];\n\n\t\tif (isInvalidNotification) {\n\t\t\tthrow new Meteor.Error('error-invalid-settings', 'Invalid settings field', { method: 'saveNotificationSettings' });\n\t\t}\n\n\t\tif (fieldsMustHaveBasicValues.includes(field) && !basicValuesForNotifications.includes(value)) {\n\t\t\tthrow new Meteor.Error('error-invalid-settings', 'Invalid settings value', { method: 'saveNotificationSettings' });\n\t\t}\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(roomId, Meteor.userId());\n\t\tif (!subscription) {\n\t\t\tthrow new Meteor.Error('error-invalid-subscription', 'Invalid subscription', { method: 'saveNotificationSettings' });\n\t\t}\n\n\t\tnotifications[field].updateMethod(subscription, value);\n\n\t\treturn true;\n\t},\n\n\tsaveAudioNotificationValue(rid, value) {\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, Meteor.userId());\n\t\tif (!subscription) {\n\t\t\tthrow new Meteor.Error('error-invalid-subscription', 'Invalid subscription', { method: 'saveAudioNotificationValue' });\n\t\t}\n\t\tRocketChat.models.Subscriptions.updateAudioNotificationValueById(subscription._id, value);\n\t\treturn true;\n\t},\n\n\tsaveDesktopNotificationDuration(rid, value) {\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, Meteor.userId());\n\t\tif (!subscription) {\n\t\t\tthrow new Meteor.Error('error-invalid-subscription', 'Invalid subscription', { method: 'saveDesktopNotificationDuration' });\n\t\t}\n\t\tRocketChat.models.Subscriptions.updateDesktopNotificationDurationById(subscription._id, value);\n\t\treturn true;\n\t}\n});\n","RocketChat.models.Subscriptions.updateAudioNotificationsById = function(_id, audioNotifications) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {};\n\n\tif (audioNotifications === 'default') {\n\t\tupdate.$unset = { audioNotifications: 1 };\n\t} else {\n\t\tupdate.$set = { audioNotifications };\n\t}\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateAudioNotificationValueById = function(_id, audioNotificationValue) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\taudioNotificationValue\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateDesktopNotificationsById = function(_id, desktopNotifications) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {};\n\n\tif (desktopNotifications === null) {\n\t\tupdate.$unset = {\n\t\t\tdesktopNotifications: 1,\n\t\t\tdesktopPrefOrigin: 1\n\t\t};\n\t} else {\n\t\tupdate.$set = {\n\t\t\tdesktopNotifications: desktopNotifications.value,\n\t\t\tdesktopPrefOrigin: desktopNotifications.origin\n\t\t};\n\t}\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateDesktopNotificationDurationById = function(_id, value) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tdesktopNotificationDuration: parseInt(value)\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateMobilePushNotificationsById = function(_id, mobilePushNotifications) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {};\n\n\tif (mobilePushNotifications === null) {\n\t\tupdate.$unset = {\n\t\t\tmobilePushNotifications: 1,\n\t\t\tmobilePrefOrigin: 1\n\t\t};\n\t} else {\n\t\tupdate.$set = {\n\t\t\tmobilePushNotifications: mobilePushNotifications.value,\n\t\t\tmobilePrefOrigin: mobilePushNotifications.origin\n\t\t};\n\t}\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateEmailNotificationsById = function(_id, emailNotifications) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {};\n\n\tif (emailNotifications === null) {\n\t\tupdate.$unset = {\n\t\t\temailNotifications: 1,\n\t\t\temailPrefOrigin: 1\n\t\t};\n\t} else {\n\t\tupdate.$set = {\n\t\t\temailNotifications: emailNotifications.value,\n\t\t\temailPrefOrigin: emailNotifications.origin\n\t\t};\n\t}\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateUnreadAlertById = function(_id, unreadAlert) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tunreadAlert\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateDisableNotificationsById = function(_id, disableNotifications) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tdisableNotifications\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateHideUnreadStatusById = function(_id, hideUnreadStatus) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\thideUnreadStatus\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.updateMuteGroupMentions = function(_id, muteGroupMentions) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tmuteGroupMentions\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Subscriptions.findAlwaysNotifyAudioUsersByRoomId = function(roomId) {\n\tconst query = {\n\t\trid: roomId,\n\t\taudioNotifications: 'all'\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Subscriptions.findAlwaysNotifyDesktopUsersByRoomId = function(roomId) {\n\tconst query = {\n\t\trid: roomId,\n\t\tdesktopNotifications: 'all'\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Subscriptions.findDontNotifyDesktopUsersByRoomId = function(roomId) {\n\tconst query = {\n\t\trid: roomId,\n\t\tdesktopNotifications: 'nothing'\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Subscriptions.findAlwaysNotifyMobileUsersByRoomId = function(roomId) {\n\tconst query = {\n\t\trid: roomId,\n\t\tmobilePushNotifications: 'all'\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Subscriptions.findDontNotifyMobileUsersByRoomId = function(roomId) {\n\tconst query = {\n\t\trid: roomId,\n\t\tmobilePushNotifications: 'nothing'\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Subscriptions.findWithSendEmailByRoomId = function(roomId) {\n\tconst query = {\n\t\trid: roomId,\n\t\temailNotifications: {\n\t\t\t$exists: true\n\t\t}\n\t};\n\n\treturn this.find(query, { fields: { emailNotifications: 1, u: 1 } });\n};\n\n\nRocketChat.models.Subscriptions.findNotificationPreferencesByRoom = function(query/*{ roomId: rid, desktopFilter: desktopNotifications, mobileFilter: mobilePushNotifications, emailFilter: emailNotifications }*/) {\n\n\treturn this._db.find(query, {\n\t\tfields: {\n\n\t\t\t// fields needed for notifications\n\t\t\trid: 1,\n\t\t\tt: 1,\n\t\t\tu: 1,\n\t\t\tname: 1,\n\t\t\tfname: 1,\n\t\t\tcode: 1,\n\n\t\t\t// fields to define if should send a notification\n\t\t\tignored: 1,\n\t\t\taudioNotifications: 1,\n\t\t\taudioNotificationValue: 1,\n\t\t\tdesktopNotificationDuration: 1,\n\t\t\tdesktopNotifications: 1,\n\t\t\tmobilePushNotifications: 1,\n\t\t\temailNotifications: 1,\n\t\t\tdisableNotifications: 1,\n\t\t\tmuteGroupMentions: 1,\n\t\t\tuserHighlights: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Subscriptions.findAllMessagesNotificationPreferencesByRoom = function(roomId) {\n\tconst query = {\n\t\trid: roomId,\n\t\t'u._id': {$exists: true},\n\t\t$or: [\n\t\t\t{ desktopNotifications: { $in: ['all', 'mentions'] } },\n\t\t\t{ mobilePushNotifications: { $in: ['all', 'mentions'] } },\n\t\t\t{ emailNotifications: { $in: ['all', 'mentions'] } }\n\t\t]\n\t};\n\n\treturn this._db.find(query, {\n\t\tfields: {\n\t\t\t'u._id': 1,\n\t\t\taudioNotifications: 1,\n\t\t\taudioNotificationValue: 1,\n\t\t\tdesktopNotificationDuration: 1,\n\t\t\tdesktopNotifications: 1,\n\t\t\tmobilePushNotifications: 1,\n\t\t\temailNotifications: 1,\n\t\t\tdisableNotifications: 1,\n\t\t\tmuteGroupMentions: 1\n\t\t}\n\t});\n};\n"]}