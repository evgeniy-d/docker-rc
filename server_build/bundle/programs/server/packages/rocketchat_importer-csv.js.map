{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:importer-csv/info.js","meteor://ðŸ’»app/packages/rocketchat:importer-csv/server/importer.js","meteor://ðŸ’»app/packages/rocketchat:importer-csv/server/adder.js"],"names":["module","export","CsvImporterInfo","ImporterInfo","watch","require","v","constructor","text","href","CsvImporter","Base","ProgressStep","Selection","SelectionChannel","SelectionUser","info","csvParser","messages","Map","prepare","dataURI","sentContentType","fileName","uriResult","RocketChatFile","dataURIParse","zip","AdmZip","Buffer","image","zipEntries","getEntries","tempChannels","tempUsers","tempMessages","entry","logger","debug","entryName","indexOf","isDirectory","toLowerCase","updateProgress","PREPARING_CHANNELS","parsedChannels","getData","toString","map","c","id","trim","replace","name","creator","isPrivate","members","split","m","PREPARING_USERS","parsedUsers","u","username","email","item","channelName","msgGroupData","get","set","msgs","e","warn","ts","usersId","collection","insert","importRecord","_id","users","findOne","updateRecord","length","addCountToTotal","channelsId","channels","PREPARING_MESSAGES","messagesCount","channel","messagesMap","entries","getBSONSize","getMaxBSONSize","getBSONSafeArraysFromAnArray","forEach","splitMsg","i","messagesId","error","ERROR","getProgress","selectionUsers","selectionChannels","selectionMessages","count","USER_SELECTION","startImport","importSelection","started","Date","now","user","user_id","do_import","update","$set","channel_id","startedByUserId","Meteor","userId","defer","IMPORTING_USERS","runAsUser","existantUser","RocketChat","models","Users","findOneByEmailAddress","findOneByUsername","rocketId","$addToSet","importIds","Accounts","createUser","password","toUpperCase","call","joinDefaultChannelsSilenced","setName","addCountCompleted","IMPORTING_CHANNELS","existantRoom","Rooms","findOneByName","creatorId","roomInfo","rid","cname","keys","push","ch","csvChannel","getChannelFromName","values","msg","getUserFromUsername","IMPORTING_MESSAGES","room","findOneById","fields","usernames","t","timestamps","isNaN","parseInt","suffix","undefined","msgObj","sendMessage","FINISHING","DONE","timeTook","log","getSelection","Importers","add"],"mappings":"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","file":"/packages/rocketchat_importer-csv.js","sourcesContent":["import { ImporterInfo } from 'meteor/rocketchat:importer';\n\nexport class CsvImporterInfo extends ImporterInfo {\n\tconstructor() {\n\t\tsuper('csv', 'CSV', 'application/zip', [{\n\t\t\ttext: 'Importer_CSV_Information',\n\t\t\thref: 'https://rocket.chat/docs/administrator-guides/import/csv/'\n\t\t}]);\n\t}\n}\n","import {\n\tBase,\n\tProgressStep,\n\tSelection,\n\tSelectionChannel,\n\tSelectionUser\n} from 'meteor/rocketchat:importer';\n\nexport class CsvImporter extends Base {\n\tconstructor(info) {\n\t\tsuper(info);\n\n\t\tthis.csvParser = require('csv-parse/lib/sync');\n\t\tthis.messages = new Map();\n\t}\n\n\tprepare(dataURI, sentContentType, fileName) {\n\t\tsuper.prepare(dataURI, sentContentType, fileName);\n\n\t\tconst uriResult = RocketChatFile.dataURIParse(dataURI);\n\t\tconst zip = new this.AdmZip(new Buffer(uriResult.image, 'base64'));\n\t\tconst zipEntries = zip.getEntries();\n\n\t\tlet tempChannels = [];\n\t\tlet tempUsers = [];\n\t\tconst tempMessages = new Map();\n\t\tfor (const entry of zipEntries) {\n\t\t\tthis.logger.debug(`Entry: ${ entry.entryName }`);\n\n\t\t\t//Ignore anything that has `__MACOSX` in it's name, as sadly these things seem to mess everything up\n\t\t\tif (entry.entryName.indexOf('__MACOSX') > -1) {\n\t\t\t\tthis.logger.debug(`Ignoring the file: ${ entry.entryName }`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t//Directories are ignored, since they are \"virtual\" in a zip file\n\t\t\tif (entry.isDirectory) {\n\t\t\t\tthis.logger.debug(`Ignoring the directory entry: ${ entry.entryName }`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t//Parse the channels\n\t\t\tif (entry.entryName.toLowerCase() === 'channels.csv') {\n\t\t\t\tsuper.updateProgress(ProgressStep.PREPARING_CHANNELS);\n\t\t\t\tconst parsedChannels = this.csvParser(entry.getData().toString());\n\t\t\t\ttempChannels = parsedChannels.map((c) => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tid: c[0].trim().replace('.', '_'),\n\t\t\t\t\t\tname: c[0].trim(),\n\t\t\t\t\t\tcreator: c[1].trim(),\n\t\t\t\t\t\tisPrivate: c[2].trim().toLowerCase() === 'private' ? true : false,\n\t\t\t\t\t\tmembers: c[3].trim().split(';').map((m) => m.trim())\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t//Parse the users\n\t\t\tif (entry.entryName.toLowerCase() === 'users.csv') {\n\t\t\t\tsuper.updateProgress(ProgressStep.PREPARING_USERS);\n\t\t\t\tconst parsedUsers = this.csvParser(entry.getData().toString());\n\t\t\t\ttempUsers = parsedUsers.map((u) => { return { id: u[0].trim().replace('.', '_'), username: u[0].trim(), email: u[1].trim(), name: u[2].trim() }; });\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t//Parse the messages\n\t\t\tif (entry.entryName.indexOf('/') > -1) {\n\t\t\t\tconst item = entry.entryName.split('/'); //random/messages.csv\n\t\t\t\tconst channelName = item[0]; //random\n\t\t\t\tconst msgGroupData = item[1].split('.')[0]; //2015-10-04\n\n\t\t\t\tif (!tempMessages.get(channelName)) {\n\t\t\t\t\ttempMessages.set(channelName, new Map());\n\t\t\t\t}\n\n\t\t\t\tlet msgs = [];\n\n\t\t\t\ttry {\n\t\t\t\t\tmsgs = this.csvParser(entry.getData().toString());\n\t\t\t\t} catch (e) {\n\t\t\t\t\tthis.logger.warn(`The file ${ entry.entryName } contains invalid syntax`, e);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\ttempMessages.get(channelName).set(msgGroupData, msgs.map((m) => { return { username: m[0], ts: m[1], text: m[2] }; }));\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\t// Insert the users record, eventually this might have to be split into several ones as well\n\t\t// if someone tries to import a several thousands users instance\n\t\tconst usersId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'users', 'users': tempUsers });\n\t\tthis.users = this.collection.findOne(usersId);\n\t\tsuper.updateRecord({ 'count.users': tempUsers.length });\n\t\tsuper.addCountToTotal(tempUsers.length);\n\n\t\t// Insert the channels records.\n\t\tconst channelsId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'channels', 'channels': tempChannels });\n\t\tthis.channels = this.collection.findOne(channelsId);\n\t\tsuper.updateRecord({ 'count.channels': tempChannels.length });\n\t\tsuper.addCountToTotal(tempChannels.length);\n\n\t\t// Save the messages records to the import record for `startImport` usage\n\t\tsuper.updateProgress(ProgressStep.PREPARING_MESSAGES);\n\t\tlet messagesCount = 0;\n\t\tfor (const [channel, messagesMap] of tempMessages.entries()) {\n\t\t\tif (!this.messages.get(channel)) {\n\t\t\t\tthis.messages.set(channel, new Map());\n\t\t\t}\n\n\t\t\tfor (const [msgGroupData, msgs] of messagesMap.entries()) {\n\t\t\t\tmessagesCount += msgs.length;\n\t\t\t\tsuper.updateRecord({ 'messagesstatus': `${ channel }/${ msgGroupData }` });\n\n\t\t\t\tif (Base.getBSONSize(msgs) > Base.getMaxBSONSize()) {\n\t\t\t\t\tBase.getBSONSafeArraysFromAnArray(msgs).forEach((splitMsg, i) => {\n\t\t\t\t\t\tconst messagesId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'messages', 'name': `${ channel }/${ msgGroupData }.${ i }`, 'messages': splitMsg });\n\t\t\t\t\t\tthis.messages.get(channel).set(`${ msgGroupData }.${ i }`, this.collection.findOne(messagesId));\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tconst messagesId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'messages', 'name': `${ channel }/${ msgGroupData }`, 'messages': msgs });\n\t\t\t\t\tthis.messages.get(channel).set(msgGroupData, this.collection.findOne(messagesId));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tsuper.updateRecord({ 'count.messages': messagesCount, 'messagesstatus': null });\n\t\tsuper.addCountToTotal(messagesCount);\n\n\t\t//Ensure we have at least a single user, channel, or message\n\t\tif (tempUsers.length === 0 && tempChannels.length === 0 && messagesCount === 0) {\n\t\t\tthis.logger.error('No users, channels, or messages found in the import file.');\n\t\t\tsuper.updateProgress(ProgressStep.ERROR);\n\t\t\treturn super.getProgress();\n\t\t}\n\n\t\tconst selectionUsers = tempUsers.map((u) => new SelectionUser(u.id, u.username, u.email, false, false, true));\n\t\tconst selectionChannels = tempChannels.map((c) => new SelectionChannel(c.id, c.name, false, true, c.isPrivate));\n\t\tconst selectionMessages = this.importRecord.count.messages;\n\n\t\tsuper.updateProgress(ProgressStep.USER_SELECTION);\n\t\treturn new Selection(this.name, selectionUsers, selectionChannels, selectionMessages);\n\t}\n\n\tstartImport(importSelection) {\n\t\tsuper.startImport(importSelection);\n\t\tconst started = Date.now();\n\n\t\t//Ensure we're only going to import the users that the user has selected\n\t\tfor (const user of importSelection.users) {\n\t\t\tfor (const u of this.users.users) {\n\t\t\t\tif (u.id === user.user_id) {\n\t\t\t\t\tu.do_import = user.do_import;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.collection.update({ _id: this.users._id }, { $set: { 'users': this.users.users }});\n\n\t\t//Ensure we're only importing the channels the user has selected.\n\t\tfor (const channel of importSelection.channels) {\n\t\t\tfor (const c of this.channels.channels) {\n\t\t\t\tif (c.id === channel.channel_id) {\n\t\t\t\t\tc.do_import = channel.do_import;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.collection.update({ _id: this.channels._id }, { $set: { 'channels': this.channels.channels }});\n\n\t\tconst startedByUserId = Meteor.userId();\n\t\tMeteor.defer(() => {\n\t\t\tsuper.updateProgress(ProgressStep.IMPORTING_USERS);\n\n\t\t\ttry {\n\t\t\t\t//Import the users\n\t\t\t\tfor (const u of this.users.users) {\n\t\t\t\t\tif (!u.do_import) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tlet existantUser = RocketChat.models.Users.findOneByEmailAddress(u.email);\n\n\t\t\t\t\t\t//If we couldn't find one by their email address, try to find an existing user by their username\n\t\t\t\t\t\tif (!existantUser) {\n\t\t\t\t\t\t\texistantUser = RocketChat.models.Users.findOneByUsername(u.username);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (existantUser) {\n\t\t\t\t\t\t\t//since we have an existing user, let's try a few things\n\t\t\t\t\t\t\tu.rocketId = existantUser._id;\n\t\t\t\t\t\t\tRocketChat.models.Users.update({ _id: u.rocketId }, { $addToSet: { importIds: u.id } });\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst userId = Accounts.createUser({ email: u.email, password: Date.now() + u.name + u.email.toUpperCase() });\n\t\t\t\t\t\t\tMeteor.runAsUser(userId, () => {\n\t\t\t\t\t\t\t\tMeteor.call('setUsername', u.username, {joinDefaultChannelsSilenced: true});\n\t\t\t\t\t\t\t\tRocketChat.models.Users.setName(userId, u.name);\n\t\t\t\t\t\t\t\tRocketChat.models.Users.update({ _id: userId }, { $addToSet: { importIds: u.id } });\n\t\t\t\t\t\t\t\tu.rocketId = userId;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.collection.update({ _id: this.users._id }, { $set: { 'users': this.users.users }});\n\n\t\t\t\t//Import the channels\n\t\t\t\tsuper.updateProgress(ProgressStep.IMPORTING_CHANNELS);\n\t\t\t\tfor (const c of this.channels.channels) {\n\t\t\t\t\tif (!c.do_import) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tconst existantRoom = RocketChat.models.Rooms.findOneByName(c.name);\n\t\t\t\t\t\t//If the room exists or the name of it is 'general', then we don't need to create it again\n\t\t\t\t\t\tif (existantRoom || c.name.toUpperCase() === 'GENERAL') {\n\t\t\t\t\t\t\tc.rocketId = c.name.toUpperCase() === 'GENERAL' ? 'GENERAL' : existantRoom._id;\n\t\t\t\t\t\t\tRocketChat.models.Rooms.update({ _id: c.rocketId }, { $addToSet: { importIds: c.id } });\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t//Find the rocketchatId of the user who created this channel\n\t\t\t\t\t\t\tlet creatorId = startedByUserId;\n\t\t\t\t\t\t\tfor (const u of this.users.users) {\n\t\t\t\t\t\t\t\tif (u.username === c.creator && u.do_import) {\n\t\t\t\t\t\t\t\t\tcreatorId = u.rocketId;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//Create the channel\n\t\t\t\t\t\t\tMeteor.runAsUser(creatorId, () => {\n\t\t\t\t\t\t\t\tconst roomInfo = Meteor.call(c.isPrivate ? 'createPrivateGroup' : 'createChannel', c.name, c.members);\n\t\t\t\t\t\t\t\tc.rocketId = roomInfo.rid;\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tRocketChat.models.Rooms.update({ _id: c.rocketId }, { $addToSet: { importIds: c.id } });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.collection.update({ _id: this.channels._id }, { $set: { 'channels': this.channels.channels }});\n\n\t\t\t\t//If no channels file, collect channel map from DB for message-only import\n\t\t\t\tif (this.channels.channels.length === 0) {\n\t\t\t\t\tfor (const cname of this.messages.keys()) {\n\t\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\t\tconst existantRoom = RocketChat.models.Rooms.findOneByName(cname);\n\t\t\t\t\t\t\tif (existantRoom || cname.toUpperCase() === 'GENERAL') {\n\t\t\t\t\t\t\t\tthis.channels.channels.push({\n\t\t\t\t\t\t\t\t\tid: cname.replace('.', '_'),\n\t\t\t\t\t\t\t\t\tname: cname,\n\t\t\t\t\t\t\t\t\trocketId: (cname.toUpperCase() === 'GENERAL' ? 'GENERAL' : existantRoom._id),\n\t\t\t\t\t\t\t\t\tdo_import: true\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t//If no users file, collect user map from DB for message-only import\n\t\t\t\tif (this.users.users.length === 0) {\n\t\t\t\t\tfor (const [ch, messagesMap] of this.messages.entries()) {\n\t\t\t\t\t\tconst csvChannel = this.getChannelFromName(ch);\n\t\t\t\t\t\tif (!csvChannel || !csvChannel.do_import) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\t\tfor (const msgs of messagesMap.values()) {\n\t\t\t\t\t\t\t\tfor (const msg of msgs.messages) {\n\t\t\t\t\t\t\t\t\tif (!this.getUserFromUsername(msg.username)) {\n\t\t\t\t\t\t\t\t\t\tconst user = RocketChat.models.Users.findOneByUsername(msg.username);\n\t\t\t\t\t\t\t\t\t\tif (user) {\n\t\t\t\t\t\t\t\t\t\t\tthis.users.users.push({\n\t\t\t\t\t\t\t\t\t\t\t\trocketId: user._id,\n\t\t\t\t\t\t\t\t\t\t\t\tusername: user.username\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t//Import the Messages\n\t\t\t\tsuper.updateProgress(ProgressStep.IMPORTING_MESSAGES);\n\t\t\t\tfor (const [ch, messagesMap] of this.messages.entries()) {\n\t\t\t\t\tconst csvChannel = this.getChannelFromName(ch);\n\t\t\t\t\tif (!csvChannel || !csvChannel.do_import) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst room = RocketChat.models.Rooms.findOneById(csvChannel.rocketId, { fields: { usernames: 1, t: 1, name: 1 } });\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tconst timestamps = {};\n\t\t\t\t\t\tfor (const [msgGroupData, msgs] of messagesMap.entries()) {\n\t\t\t\t\t\t\tsuper.updateRecord({ 'messagesstatus': `${ ch }/${ msgGroupData }.${ msgs.messages.length }` });\n\t\t\t\t\t\t\tfor (const msg of msgs.messages) {\n\t\t\t\t\t\t\t\tif (isNaN(new Date(parseInt(msg.ts)))) {\n\t\t\t\t\t\t\t\t\tthis.logger.warn(`Timestamp on a message in ${ ch }/${ msgGroupData } is invalid`);\n\t\t\t\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tconst creator = this.getUserFromUsername(msg.username);\n\t\t\t\t\t\t\t\tif (creator) {\n\t\t\t\t\t\t\t\t\tlet suffix = '';\n\t\t\t\t\t\t\t\t\tif (timestamps[msg.ts] === undefined) {\n\t\t\t\t\t\t\t\t\t\ttimestamps[msg.ts] = 1;\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tsuffix = `-${ timestamps[msg.ts] }`;\n\t\t\t\t\t\t\t\t\t\ttimestamps[msg.ts] += 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tconst msgObj = {\n\t\t\t\t\t\t\t\t\t\t_id: `csv-${ csvChannel.id }-${ msg.ts }${ suffix }`,\n\t\t\t\t\t\t\t\t\t\tts: new Date(parseInt(msg.ts)),\n\t\t\t\t\t\t\t\t\t\tmsg: msg.text,\n\t\t\t\t\t\t\t\t\t\trid: room._id,\n\t\t\t\t\t\t\t\t\t\tu: {\n\t\t\t\t\t\t\t\t\t\t\t_id: creator._id,\n\t\t\t\t\t\t\t\t\t\t\tusername: creator.username\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\tRocketChat.sendMessage(creator, msgObj, room, true);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tsuper.updateProgress(ProgressStep.FINISHING);\n\t\t\t\tsuper.updateProgress(ProgressStep.DONE);\n\t\t\t} catch (e) {\n\t\t\t\tthis.logger.error(e);\n\t\t\t\tsuper.updateProgress(ProgressStep.ERROR);\n\t\t\t}\n\n\t\t\tconst timeTook = Date.now() - started;\n\t\t\tthis.logger.log(`CSV Import took ${ timeTook } milliseconds.`);\n\t\t});\n\n\t\treturn super.getProgress();\n\t}\n\n\tgetSelection() {\n\t\tconst selectionUsers = this.users.users.map((u) => new SelectionUser(u.id, u.username, u.email, false, false, true));\n\t\tconst selectionChannels = this.channels.channels.map((c) => new SelectionChannel(c.id, c.name, false, true, c.isPrivate));\n\t\tconst selectionMessages = this.importRecord.count.messages;\n\n\t\treturn new Selection(this.name, selectionUsers, selectionChannels, selectionMessages);\n\t}\n\n\tgetChannelFromName(channelName) {\n\t\tfor (const ch of this.channels.channels) {\n\t\t\tif (ch.name === channelName) {\n\t\t\t\treturn ch;\n\t\t\t}\n\t\t}\n\t}\n\n\tgetUserFromUsername(username) {\n\t\tfor (const u of this.users.users) {\n\t\t\tif (u.username === username) {\n\t\t\t\treturn RocketChat.models.Users.findOneById(u.rocketId, { fields: { username: 1 }});\n\t\t\t}\n\t\t}\n\t}\n}\n","import { Importers } from 'meteor/rocketchat:importer';\nimport { CsvImporterInfo } from '../info';\nimport { CsvImporter } from './importer';\n\nImporters.add(new CsvImporterInfo(), CsvImporter);\n"]}