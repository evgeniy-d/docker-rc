{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:internal-hubot/hubot.js","meteor://ðŸ’»app/packages/rocketchat:internal-hubot/settings.js"],"names":["_","module","watch","require","default","v","s","Hubot","Npm","DEBUG","InternalHubot","sendHelper","Meteor","bindEnvironment","robot","envelope","strings","map","length","string","shift","err","console","error","logger","Response","prototype","priv","adapter","Robot","loadAdapter","bind","f","g","self","args","apply","Array","from","constructor","hear","respond","enter","leave","topic","catchAll","user","users","findOne","username","name","fields","regex","callback","RocketChatAdapter","Adapter","send","log","blue","room","id","RocketChat","sendMessage","msg","_id","emote","rid","u","message","private","call","action","settings","get","to","reply","str","play","run","emit","brain","mergeData","close","InternalHubotReceiver","models","Rooms","findOneById","enabledForC","enabledForD","enabledForP","subscribedToP","Subscriptions","findOneByRoomIdAndUserId","t","InternalHubotUser","User","InternalHubotTextMessage","TextMessage","receive","HubotScripts","modulesToLoad","customPath","load","__meteor_bootstrap__","serverDir","split","path","scriptsToLoad","forEach","scriptFile","trim","fn","parseHelp","green","e","red","init","debounce","alias","callbacks","add","priority","LOW","remove","startup","Settings","findByIds","observe","changed","addGroup","type","i18nLabel","i18nDescription"],"mappings":"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","file":"/packages/rocketchat_internal-hubot.js","sourcesContent":["/* globals __meteor_bootstrap__ */\nimport _ from 'underscore';\nimport s from 'underscore.string';\n\nimport 'coffeescript/register';\n\nconst Hubot = Npm.require('hubot');\n\n// Start a hubot, connected to our chat room.\n// 'use strict'\n// Log messages?\nconst DEBUG = false;\n\nlet InternalHubot = {};\n\nconst sendHelper = Meteor.bindEnvironment((robot, envelope, strings, map) =>{\n\twhile (strings.length > 0) {\n\t\tconst string = strings.shift();\n\t\tif (typeof(string) === 'function') {\n\t\t\tstring();\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tmap(string);\n\t\t\t} catch (err) {\n\t\t\t\tif (DEBUG) { console.error(`Hubot error: ${ err }`); }\n\t\t\t\trobot.logger.error(`RocketChat send error: ${ err }`);\n\t\t\t}\n\t\t}\n\t}\n});\n\n// Monkey-patch Hubot to support private messages\nHubot.Response.prototype.priv = (...strings) => this.robot.adapter.priv(this.envelope, ...strings);\n\n// More monkey-patching\nHubot.Robot.prototype.loadAdapter = () => {}; // disable\n\n// grrrr, Meteor.bindEnvironment doesn't preserve `this` apparently\nconst bind = function(f) {\n\tconst g = Meteor.bindEnvironment((self, ...args) => f.apply(self, args));\n\treturn function(...args) { return g(this, ...Array.from(args)); };\n};\n\nclass Robot extends Hubot.Robot {\n\tconstructor(...args) {\n\t\tsuper(...(args || []));\n\t\tthis.hear = bind(this.hear);\n\t\tthis.respond = bind(this.respond);\n\t\tthis.enter = bind(this.enter);\n\t\tthis.leave = bind(this.leave);\n\t\tthis.topic = bind(this.topic);\n\t\tthis.error = bind(this.error);\n\t\tthis.catchAll = bind(this.catchAll);\n\t\tthis.user = Meteor.users.findOne({username: this.name}, {fields: {username: 1}});\n\t}\n\tloadAdapter() { return false; }\n\thear(regex, callback) { return super.hear(regex, Meteor.bindEnvironment(callback)); }\n\trespond(regex, callback) { return super.respond(regex, Meteor.bindEnvironment(callback)); }\n\tenter(callback) { return super.enter(Meteor.bindEnvironment(callback)); }\n\tleave(callback) { return super.leave(Meteor.bindEnvironment(callback)); }\n\ttopic(callback) { return super.topic(Meteor.bindEnvironment(callback)); }\n\terror(callback) { return super.error(Meteor.bindEnvironment(callback)); }\n\tcatchAll(callback) { return super.catchAll(Meteor.bindEnvironment(callback)); }\n}\n\nclass RocketChatAdapter extends Hubot.Adapter {\n\t// Public: Raw method for sending data back to the chat source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more Strings for each message to send.\n\t//\n\t// Returns nothing.\n\tsend(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> send'.blue); }\n\t\t// console.log envelope, strings\n\t\treturn sendHelper(this.robot, envelope, strings, string => {\n\t\t\tif (DEBUG) { console.log(`send ${ envelope.room }: ${ string } (${ envelope.user.id })`); }\n\t\t\treturn RocketChat.sendMessage(InternalHubot.user, { msg: string }, { _id: envelope.room });\n\t\t});\n\t}\n\n\t// Public: Raw method for sending emote data back to the chat source.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more Strings for each message to send.\n\t//\n\t// Returns nothing.\n\temote(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> emote'.blue); }\n\t\treturn sendHelper(this.robot, envelope, strings, string => {\n\t\t\tif (DEBUG) { console.log(`emote ${ envelope.rid }: ${ string } (${ envelope.u.username })`); }\n\t\t\tif (envelope.message.private) { return this.priv(envelope, `*** ${ string } ***`); }\n\t\t\treturn Meteor.call('sendMessage', {\n\t\t\t\tmsg: string,\n\t\t\t\trid: envelope.rid,\n\t\t\t\taction: true\n\t\t\t}\n\t\t\t);\n\t\t});\n\t}\n\n\t// Priv: our extension -- send a PM to user\n\tpriv(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> priv'.blue); }\n\t\treturn sendHelper(this.robot, envelope, strings, function(string) {\n\t\t\tif (DEBUG) { console.log(`priv ${ envelope.room }: ${ string } (${ envelope.user.id })`); }\n\t\t\treturn Meteor.call('sendMessage', {\n\t\t\t\tu: {\n\t\t\t\t\tusername: RocketChat.settings.get('InternalHubot_Username')\n\t\t\t\t},\n\t\t\t\tto: `${ envelope.user.id }`,\n\t\t\t\tmsg: string,\n\t\t\t\trid: envelope.room\n\t\t\t});\n\t\t});\n\t}\n\n\t// Public: Raw method for building a reply and sending it back to the chat\n\t// source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more Strings for each reply to send.\n\t//\n\t// Returns nothing.\n\treply(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> reply'.blue); }\n\t\tif (envelope.message.private) {\n\t\t\treturn this.priv(envelope, ...strings);\n\t\t} else {\n\t\t\treturn this.send(envelope, ...strings.map(str => `${ envelope.user.name }: ${ str }`));\n\t\t}\n\t}\n\n\t// Public: Raw method for setting a topic on the chat source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One more more Strings to set as the topic.\n\t//\n\t// Returns nothing.\n\ttopic(/*envelope, ...strings*/) {\n\t\tif (DEBUG) { return console.log('ROCKETCHATADAPTER -> topic'.blue); }\n\t}\n\n\t// Public: Raw method for playing a sound in the chat source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more strings for each play message to send.\n\t//\n\t// Returns nothing\n\tplay(/*envelope, ...strings*/) {\n\t\tif (DEBUG) { return console.log('ROCKETCHATADAPTER -> play'.blue); }\n\t}\n\n\t// Public: Raw method for invoking the bot to run. Extend this.\n\t//\n\t// Returns nothing.\n\trun() {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> run'.blue); }\n\t\tthis.robot.emit('connected');\n\t\treturn this.robot.brain.mergeData({});\n\t}\n\t// @robot.brain.emit 'loaded'\n\n\t// Public: Raw method for shutting the bot down. Extend this.\n\t//\n\t// Returns nothing.\n\tclose() {\n\t\tif (DEBUG) { return console.log('ROCKETCHATADAPTER -> close'.blue); }\n\t}\n}\n\nconst InternalHubotReceiver = (message) => {\n\tif (DEBUG) { console.log(message); }\n\tif (message.u.username !== InternalHubot.name) {\n\t\tconst room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tconst enabledForC = RocketChat.settings.get('InternalHubot_EnableForChannels');\n\t\tconst enabledForD = RocketChat.settings.get('InternalHubot_EnableForDirectMessages');\n\t\tconst enabledForP = RocketChat.settings.get('InternalHubot_EnableForPrivateGroups');\n\t\tconst subscribedToP = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, InternalHubot.user._id);\n\n\t\tif (\n\t\t\t(room.t === 'c' && enabledForC)\n\t\t\t|| (room.t === 'd' && enabledForD)\n\t\t\t|| (room.t === 'p' && enabledForP && subscribedToP)\n\t\t) {\n\t\t\tconst InternalHubotUser = new Hubot.User(message.u.username, {room: message.rid});\n\t\t\tconst InternalHubotTextMessage = new Hubot.TextMessage(InternalHubotUser, message.msg, message._id);\n\t\t\tInternalHubot.adapter.receive(InternalHubotTextMessage);\n\t\t}\n\t}\n\treturn message;\n};\n\nclass HubotScripts {\n\tconstructor(robot) {\n\t\tconst modulesToLoad = [\n\t\t\t'hubot-help/src/help.coffee'\n\t\t];\n\t\tconst customPath = RocketChat.settings.get('InternalHubot_PathToLoadCustomScripts');\n\t\tHubotScripts.load(`${ __meteor_bootstrap__.serverDir }/npm/node_modules/meteor/rocketchat_internal-hubot/node_modules/`, modulesToLoad, robot);\n\t\tHubotScripts.load(customPath, RocketChat.settings.get('InternalHubot_ScriptsToLoad').split(',') || [], robot);\n\t}\n\n\tstatic load(path, scriptsToLoad, robot) {\n\t\tif (!path || !scriptsToLoad) {\n\t\t\treturn;\n\t\t}\n\t\tscriptsToLoad.forEach(scriptFile => {\n\t\t\ttry {\n\t\t\t\tscriptFile = s.trim(scriptFile);\n\t\t\t\tif (scriptFile === '') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// delete require.cache[require.resolve(path+scriptFile)];\n\t\t\t\tconst fn = Npm.require(path + scriptFile);\n\t\t\t\tif (typeof(fn) === 'function') {\n\t\t\t\t\tfn(robot);\n\t\t\t\t} else {\n\t\t\t\t\tfn.default(robot);\n\t\t\t\t}\n\t\t\t\trobot.parseHelp(path + scriptFile);\n\t\t\t\tconsole.log(`Loaded ${ scriptFile }`.green);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.log(`Can't load ${ scriptFile }`.red);\n\t\t\t\tconsole.log(e);\n\t\t\t}\n\t\t});\n\t}\n}\n\nconst init = _.debounce(Meteor.bindEnvironment(() => {\n\tif (RocketChat.settings.get('InternalHubot_Enabled')) {\n\t\tInternalHubot = new Robot(null, null, false, RocketChat.settings.get('InternalHubot_Username'));\n\t\tInternalHubot.alias = 'bot';\n\t\tInternalHubot.adapter = new RocketChatAdapter(InternalHubot);\n\t\tnew HubotScripts(InternalHubot);\n\t\tInternalHubot.run();\n\t\treturn RocketChat.callbacks.add('afterSaveMessage', InternalHubotReceiver, RocketChat.callbacks.priority.LOW, 'InternalHubot');\n\t} else {\n\t\tInternalHubot = {};\n\t\treturn RocketChat.callbacks.remove('afterSaveMessage', 'InternalHubot');\n\t}\n}), 1000);\n\nMeteor.startup(function() {\n\tinit();\n\tRocketChat.models.Settings.findByIds([ 'InternalHubot_Username', 'InternalHubot_Enabled', 'InternalHubot_ScriptsToLoad', 'InternalHubot_PathToLoadCustomScripts']).observe({\n\t\tchanged() {\n\t\t\treturn init();\n\t\t}\n\t});\n\t// TODO useful when we have the ability to invalidate `require` cache\n\t// RocketChat.RateLimiter.limitMethod('reloadInternalHubot', 1, 5000, {\n\t// \tuserId(/*userId*/) { return true; }\n\t// });\n\t// Meteor.methods({\n\t// \treloadInternalHubot: () => init()\n\t// });\n});\n","RocketChat.settings.addGroup('InternalHubot', function() {\n\tthis.add('InternalHubot_Enabled', false, { type: 'boolean', i18nLabel: 'Enabled' });\n\tthis.add('InternalHubot_Username', 'rocket.cat', { type: 'string', i18nLabel: 'Username', i18nDescription: 'InternalHubot_Username_Description', 'public': true });\n\tthis.add('InternalHubot_ScriptsToLoad', '', { type: 'string'});\n\tthis.add('InternalHubot_PathToLoadCustomScripts', '', { type: 'string' });\n\tthis.add('InternalHubot_EnableForChannels', true, { type: 'boolean' });\n\tthis.add('InternalHubot_EnableForDirectMessages', false, { type: 'boolean' });\n\tthis.add('InternalHubot_EnableForPrivateGroups', false, { type: 'boolean' });\n\t// this.add('InternalHubot_reload', 'reloadInternalHubot', {\n\t// \ttype: 'action',\n\t// \tactionText: 'reload'\n\t// });\n});\n"]}