{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:oembed/server/server.js","meteor://ðŸ’»app/packages/rocketchat:oembed/server/providers.js","meteor://ðŸ’»app/packages/rocketchat:oembed/server/jumpToMessage.js","meteor://ðŸ’»app/packages/rocketchat:oembed/server/models/OEmbedCache.js"],"names":["module1","module","_","watch","require","default","v","URL","querystring","iconv","ipRangeCheck","he","jschardet","request","HTTPInternals","NpmModules","OEmbed","getCharset","contentType","body","detectedCharset","httpHeaderCharset","htmlMetaCharset","result","binary","toString","detected","detect","confidence","encoding","toLowerCase","m1","match","m2","toUtf8","decode","getUrlContent","urlObj","redirectCount","callback","isString","parse","parsedUrl","pick","ignoredHosts","RocketChat","settings","get","replace","split","includes","hostname","safePorts","port","length","data","callbacks","run","attachments","url","format","opts","strictSSL","gzip","maxRedirects","headers","statusCode","error","chunks","chunksTotalLength","stream","on","response","abort","chunk","push","Meteor","bindEnvironment","buffer","Buffer","concat","err","getUrlMeta","withFragment","getUrlContentSync","wrapAsync","queryStringObj","query","_escaped_fragment_","stringify","path","pathname","content","metas","undefined","meta","title","pageTitle","unescape","name","value","name1","changeCase","camelCase","fragment","headerObj","Object","keys","forEach","header","getUrlMetaWithCache","cache","models","OEmbedCache","findOneById","createWithIdAndData","_error","console","getRelevantHeaders","headersObj","key","lowerCaseKey","trim","getRelevantMetaTags","metaObj","tags","test","rocketUrlParser","message","Array","isArray","urls","changed","item","ignoreParse","startsWith","sandstorm","grain","sandstormViewInfo","union","Messages","setMessageAttachments","_id","setUrlsById","add","priority","LOW","remove","QueryString","Providers","constructor","providers","getConsumerUrl","provider","endPoint","search","registerProvider","getProviders","getProviderForUrl","find","candidate","re","RegExp","oembed","consumerUrl","extend","host","MEDIUM","queryString","JSON","each","log","recursiveRemove","deep","map","msg","indexOf","absoluteUrl","jumpToMessage","translations","alias","u","username","getAvatarUrlFromUsername","ts","_Base","tryEnsureIndex","options","findOne","record","updatedAt","Date","insert","removeAfterDate","date","$lte"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAMA,UAAQC,MAAd;;AAAqB,IAAIC,CAAJ;;AAAMF,QAAQG,KAAR,CAAcC,QAAQ,YAAR,CAAd,EAAoC;AAACC,UAAQC,CAAR,EAAU;AAACJ,QAAEI,CAAF;AAAI;;AAAhB,CAApC,EAAsD,CAAtD;AAAyD,IAAIC,GAAJ;AAAQP,QAAQG,KAAR,CAAcC,QAAQ,KAAR,CAAd,EAA6B;AAACC,UAAQC,CAAR,EAAU;AAACC,UAAID,CAAJ;AAAM;;AAAlB,CAA7B,EAAiD,CAAjD;AAAoD,IAAIE,WAAJ;AAAgBR,QAAQG,KAAR,CAAcC,QAAQ,aAAR,CAAd,EAAqC;AAACC,UAAQC,CAAR,EAAU;AAACE,kBAAYF,CAAZ;AAAc;;AAA1B,CAArC,EAAiE,CAAjE;AAAoE,IAAIG,KAAJ;AAAUT,QAAQG,KAAR,CAAcC,QAAQ,YAAR,CAAd,EAAoC;AAACC,UAAQC,CAAR,EAAU;AAACG,YAAMH,CAAN;AAAQ;;AAApB,CAApC,EAA0D,CAA1D;AAA6D,IAAII,YAAJ;AAAiBV,QAAQG,KAAR,CAAcC,QAAQ,gBAAR,CAAd,EAAwC;AAACC,UAAQC,CAAR,EAAU;AAACI,mBAAaJ,CAAb;AAAe;;AAA3B,CAAxC,EAAqE,CAArE;AAAwE,IAAIK,EAAJ;AAAOX,QAAQG,KAAR,CAAcC,QAAQ,IAAR,CAAd,EAA4B;AAACC,UAAQC,CAAR,EAAU;AAACK,SAAGL,CAAH;AAAK;;AAAjB,CAA5B,EAA+C,CAA/C;AAAkD,IAAIM,SAAJ;AAAcZ,QAAQG,KAAR,CAAcC,QAAQ,WAAR,CAAd,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACM,gBAAUN,CAAV;AAAY;;AAAxB,CAAnC,EAA6D,CAA7D;AAS3c,MAAMO,UAAUC,cAAcC,UAAd,CAAyBF,OAAzB,CAAiCZ,MAAjD;AACA,MAAMe,SAAS,EAAf,C,CAEA;AACA;AACA;AACA;;AACA,MAAMC,aAAa,UAASC,WAAT,EAAsBC,IAAtB,EAA4B;AAC9C,MAAIC,eAAJ;AACA,MAAIC,iBAAJ;AACA,MAAIC,eAAJ;AACA,MAAIC,MAAJ;AAEAL,gBAAcA,eAAe,EAA7B;AAEA,QAAMM,SAASL,KAAKM,QAAL,CAAc,QAAd,CAAf;AACA,QAAMC,WAAWd,UAAUe,MAAV,CAAiBH,MAAjB,CAAjB;;AACA,MAAIE,SAASE,UAAT,GAAsB,GAA1B,EAA+B;AAC9BR,sBAAkBM,SAASG,QAAT,CAAkBC,WAAlB,EAAlB;AACA;;AACD,QAAMC,KAAKb,YAAYc,KAAZ,CAAkB,oBAAlB,CAAX;;AACA,MAAID,EAAJ,EAAQ;AACPV,wBAAoBU,GAAG,CAAH,EAAMD,WAAN,EAApB;AACA;;AACD,QAAMG,KAAKT,OAAOQ,KAAP,CAAa,qCAAb,CAAX;;AACA,MAAIC,EAAJ,EAAQ;AACPX,sBAAkBW,GAAG,CAAH,EAAMH,WAAN,EAAlB;AACA;;AACD,MAAIV,eAAJ,EAAqB;AACpB,QAAIA,oBAAoBC,iBAAxB,EAA2C;AAC1CE,eAASF,iBAAT;AACA,KAFD,MAEO,IAAID,oBAAoBE,eAAxB,EAAyC;AAC/CC,eAASD,eAAT;AACA;AACD;;AACD,MAAI,CAACC,MAAL,EAAa;AACZA,aAASF,qBAAqBC,eAArB,IAAwCF,eAAjD;AACA;;AACD,SAAOG,UAAU,OAAjB;AACA,CAhCD;;AAkCA,MAAMW,SAAS,UAAShB,WAAT,EAAsBC,IAAtB,EAA4B;AAC1C,SAAOV,MAAM0B,MAAN,CAAahB,IAAb,EAAmBF,WAAWC,WAAX,EAAwBC,IAAxB,CAAnB,CAAP;AACA,CAFD;;AAIA,MAAMiB,gBAAgB,UAASC,MAAT,EAAiBC,gBAAgB,CAAjC,EAAoCC,QAApC,EAA8C;AAEnE,MAAIrC,EAAEsC,QAAF,CAAWH,MAAX,CAAJ,EAAwB;AACvBA,aAAS9B,IAAIkC,KAAJ,CAAUJ,MAAV,CAAT;AACA;;AAED,QAAMK,YAAYxC,EAAEyC,IAAF,CAAON,MAAP,EAAe,CAAC,MAAD,EAAS,MAAT,EAAiB,UAAjB,EAA6B,UAA7B,EAAyC,MAAzC,EAAiD,OAAjD,EAA0D,QAA1D,EAAoE,UAApE,CAAf,CAAlB;;AACA,QAAMO,eAAeC,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,uBAAxB,EAAiDC,OAAjD,CAAyD,KAAzD,EAAgE,EAAhE,EAAoEC,KAApE,CAA0E,GAA1E,KAAkF,EAAvG;;AACA,MAAIL,aAAaM,QAAb,CAAsBR,UAAUS,QAAhC,KAA6CzC,aAAagC,UAAUS,QAAvB,EAAiCP,YAAjC,CAAjD,EAAiG;AAChG,WAAOL,UAAP;AACA;;AAED,QAAMa,YAAYP,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,oBAAxB,EAA8CC,OAA9C,CAAsD,KAAtD,EAA6D,EAA7D,EAAiEC,KAAjE,CAAuE,GAAvE,KAA+E,EAAjG;;AACA,MAAIP,UAAUW,IAAV,IAAkBD,UAAUE,MAAV,GAAmB,CAArC,IAA2C,CAACF,UAAUF,QAAV,CAAmBR,UAAUW,IAA7B,CAAhD,EAAqF;AACpF,WAAOd,UAAP;AACA;;AAED,QAAMgB,OAAOV,WAAWW,SAAX,CAAqBC,GAArB,CAAyB,4BAAzB,EAAuD;AACnEpB,UADmE;AAEnEK;AAFmE,GAAvD,CAAb;;AAIA,MAAIa,KAAKG,WAAL,IAAoB,IAAxB,EAA8B;AAC7B,WAAOnB,SAAS,IAAT,EAAegB,IAAf,CAAP;AACA;;AACD,QAAMI,MAAMpD,IAAIqD,MAAJ,CAAWL,KAAKlB,MAAhB,CAAZ;AACA,QAAMwB,OAAO;AACZF,OADY;AAEZG,eAAW,CAACjB,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,gCAAxB,CAFA;AAGZgB,UAAM,IAHM;AAIZC,kBAAc1B,aAJF;AAKZ2B,aAAS;AACR,oBAAcpB,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,qBAAxB;AADN;AALG,GAAb;AASA,MAAIkB,UAAU,IAAd;AACA,MAAIC,aAAa,IAAjB;AACA,MAAIC,QAAQ,IAAZ;AACA,QAAMC,SAAS,EAAf;AACA,MAAIC,oBAAoB,CAAxB;AACA,QAAMC,SAASzD,QAAQgD,IAAR,CAAf;AACAS,SAAOC,EAAP,CAAU,UAAV,EAAsB,UAASC,QAAT,EAAmB;AACxCN,iBAAaM,SAASN,UAAtB;AACAD,cAAUO,SAASP,OAAnB;;AACA,QAAIO,SAASN,UAAT,KAAwB,GAA5B,EAAiC;AAChC,aAAOI,OAAOG,KAAP,EAAP;AACA;AACD,GAND;AAOAH,SAAOC,EAAP,CAAU,MAAV,EAAkB,UAASG,KAAT,EAAgB;AACjCN,WAAOO,IAAP,CAAYD,KAAZ;AACAL,yBAAqBK,MAAMpB,MAA3B;;AACA,QAAIe,oBAAoB,MAAxB,EAAgC;AAC/B,aAAOC,OAAOG,KAAP,EAAP;AACA;AACD,GAND;AAOAH,SAAOC,EAAP,CAAU,KAAV,EAAiBK,OAAOC,eAAP,CAAuB,YAAW;AAClD,QAAIV,SAAS,IAAb,EAAmB;AAClB,aAAO5B,SAAS,IAAT,EAAe;AACrB4B,aADqB;AAErBzB;AAFqB,OAAf,CAAP;AAIA;;AACD,UAAMoC,SAASC,OAAOC,MAAP,CAAcZ,MAAd,CAAf;AACA,WAAO7B,SAAS,IAAT,EAAe;AACrB0B,aADqB;AAErB9C,YAAMe,OAAO+B,QAAQ,cAAR,CAAP,EAAgCa,MAAhC,CAFe;AAGrBpC,eAHqB;AAIrBwB;AAJqB,KAAf,CAAP;AAMA,GAdgB,CAAjB;AAeA,SAAOI,OAAOC,EAAP,CAAU,OAAV,EAAmB,UAASU,GAAT,EAAc;AACvC,WAAOd,QAAQc,GAAf;AACA,GAFM,CAAP;AAGA,CAxED;;AA0EAjE,OAAOkE,UAAP,GAAoB,UAASvB,GAAT,EAAcwB,YAAd,EAA4B;AAC/C,QAAMC,oBAAoBR,OAAOS,SAAP,CAAiBjD,aAAjB,CAA1B;AACA,QAAMC,SAAS9B,IAAIkC,KAAJ,CAAUkB,GAAV,CAAf;;AACA,MAAIwB,gBAAgB,IAApB,EAA0B;AACzB,UAAMG,iBAAiB9E,YAAYiC,KAAZ,CAAkBJ,OAAOkD,KAAzB,CAAvB;AACAD,mBAAeE,kBAAf,GAAoC,EAApC;AACAnD,WAAOkD,KAAP,GAAe/E,YAAYiF,SAAZ,CAAsBH,cAAtB,CAAf;AACA,QAAII,OAAOrD,OAAOsD,QAAlB;;AACA,QAAItD,OAAOkD,KAAP,IAAgB,IAApB,EAA0B;AACzBG,cAAS,IAAIrD,OAAOkD,KAAO,EAA3B;AACA;;AACDlD,WAAOqD,IAAP,GAAcA,IAAd;AACA;;AACD,QAAME,UAAUR,kBAAkB/C,MAAlB,EAA0B,CAA1B,CAAhB;;AACA,MAAI,CAACuD,OAAL,EAAc;AACb;AACA;;AACD,MAAIA,QAAQlC,WAAR,IAAuB,IAA3B,EAAiC;AAChC,WAAOkC,OAAP;AACA;;AACD,MAAIC,QAAQC,SAAZ;;AACA,MAAIF,WAAWA,QAAQzE,IAAvB,EAA6B;AAC5B0E,YAAQ,EAAR;AACAD,YAAQzE,IAAR,CAAa6B,OAAb,CAAqB,iCAArB,EAAwD,UAAS+C,IAAT,EAAeC,KAAf,EAAsB;AAC7E,aAAOH,MAAMI,SAAN,IAAmB,IAAnB,GAA0BJ,MAAMI,SAAhC,GAA4CJ,MAAMI,SAAN,GAAkBtF,GAAGuF,QAAH,CAAYF,KAAZ,CAArE;AACA,KAFD;AAGAJ,YAAQzE,IAAR,CAAa6B,OAAb,CAAqB,gFAArB,EAAuG,UAAS+C,IAAT,EAAeI,IAAf,EAAqBC,KAArB,EAA4B;AAClI,UAAIC,KAAJ;AACA,aAAOR,MAAMQ,QAAQC,WAAWC,SAAX,CAAqBJ,IAArB,CAAd,KAA6C,IAA7C,GAAoDN,MAAMQ,KAAN,CAApD,GAAmER,MAAMQ,KAAN,IAAe1F,GAAGuF,QAAH,CAAYE,KAAZ,CAAzF;AACA,KAHD;AAIAR,YAAQzE,IAAR,CAAa6B,OAAb,CAAqB,gFAArB,EAAuG,UAAS+C,IAAT,EAAeI,IAAf,EAAqBC,KAArB,EAA4B;AAClI,UAAIC,KAAJ;AACA,aAAOR,MAAMQ,QAAQC,WAAWC,SAAX,CAAqBJ,IAArB,CAAd,KAA6C,IAA7C,GAAoDN,MAAMQ,KAAN,CAApD,GAAmER,MAAMQ,KAAN,IAAe1F,GAAGuF,QAAH,CAAYE,KAAZ,CAAzF;AACA,KAHD;AAIAR,YAAQzE,IAAR,CAAa6B,OAAb,CAAqB,gFAArB,EAAuG,UAAS+C,IAAT,EAAeK,KAAf,EAAsBD,IAAtB,EAA4B;AAClI,UAAIE,KAAJ;AACA,aAAOR,MAAMQ,QAAQC,WAAWC,SAAX,CAAqBJ,IAArB,CAAd,KAA6C,IAA7C,GAAoDN,MAAMQ,KAAN,CAApD,GAAmER,MAAMQ,KAAN,IAAe1F,GAAGuF,QAAH,CAAYE,KAAZ,CAAzF;AACA,KAHD;AAIAR,YAAQzE,IAAR,CAAa6B,OAAb,CAAqB,gFAArB,EAAuG,UAAS+C,IAAT,EAAeK,KAAf,EAAsBD,IAAtB,EAA4B;AAClI,UAAIE,KAAJ;AACA,aAAOR,MAAMQ,QAAQC,WAAWC,SAAX,CAAqBJ,IAArB,CAAd,KAA6C,IAA7C,GAAoDN,MAAMQ,KAAN,CAApD,GAAmER,MAAMQ,KAAN,IAAe1F,GAAGuF,QAAH,CAAYE,KAAZ,CAAzF;AACA,KAHD;;AAIA,QAAIP,MAAMW,QAAN,KAAmB,GAAnB,IAA2BrB,gBAAgB,IAA/C,EAAsD;AACrD,aAAOnE,OAAOkE,UAAP,CAAkBvB,GAAlB,EAAuB,IAAvB,CAAP;AACA;AACD;;AACD,MAAIM,UAAU6B,SAAd;AACA,MAAIvC,OAAOuC,SAAX;;AAGA,MAAIF,WAAWA,QAAQ3B,OAAvB,EAAgC;AAC/BA,cAAU,EAAV;AACA,UAAMwC,YAAYb,QAAQ3B,OAA1B;AACAyC,WAAOC,IAAP,CAAYF,SAAZ,EAAuBG,OAAvB,CAAgCC,MAAD,IAAY;AAC1C5C,cAAQqC,WAAWC,SAAX,CAAqBM,MAArB,CAAR,IAAwCJ,UAAUI,MAAV,CAAxC;AACA,KAFD;AAGA;;AACD,MAAIjB,WAAWA,QAAQ1B,UAAR,KAAuB,GAAtC,EAA2C;AAC1C,WAAOX,IAAP;AACA;;AACDA,SAAOV,WAAWW,SAAX,CAAqBC,GAArB,CAAyB,0BAAzB,EAAqD;AAC3DsC,UAAMF,KADqD;AAE3D5B,WAF2D;AAG3DvB,eAAWkD,QAAQlD,SAHwC;AAI3DkD;AAJ2D,GAArD,CAAP;AAMA,SAAOrC,IAAP;AACA,CAnED;;AAqEAvC,OAAO8F,mBAAP,GAA6B,UAASnD,GAAT,EAAcwB,YAAd,EAA4B;AACxD,QAAM4B,QAAQlE,WAAWmE,MAAX,CAAkBC,WAAlB,CAA8BC,WAA9B,CAA0CvD,GAA1C,CAAd;;AACA,MAAIoD,SAAS,IAAb,EAAmB;AAClB,WAAOA,MAAMxD,IAAb;AACA;;AACD,QAAMA,OAAOvC,OAAOkE,UAAP,CAAkBvB,GAAlB,EAAuBwB,YAAvB,CAAb;;AACA,MAAI5B,QAAQ,IAAZ,EAAkB;AACjB,QAAI;AACHV,iBAAWmE,MAAX,CAAkBC,WAAlB,CAA8BE,mBAA9B,CAAkDxD,GAAlD,EAAuDJ,IAAvD;AACA,KAFD,CAEE,OAAO6D,MAAP,EAAe;AAChBC,cAAQlD,KAAR,CAAc,0BAAd,EAA0CR,GAA1C;AACA;;AACD,WAAOJ,IAAP;AACA;AACD,CAdD;;AAgBA,MAAM+D,qBAAqB,UAASC,UAAT,EAAqB;AAC/C,QAAMtD,UAAU,EAAhB;AACAyC,SAAOC,IAAP,CAAYY,UAAZ,EAAwBX,OAAxB,CAAiCY,GAAD,IAAS;AACxC,UAAMpB,QAAQmB,WAAWC,GAAX,CAAd;AACA,UAAMC,eAAeD,IAAI1F,WAAJ,EAArB;;AACA,QAAI,CAAC2F,iBAAiB,aAAjB,IAAkCA,iBAAiB,eAApD,KAAyErB,SAASA,MAAMsB,IAAN,OAAiB,EAAvG,EAA4G;AAC3GzD,cAAQuD,GAAR,IAAepB,KAAf;AACA;AACD,GAND;;AAQA,MAAIM,OAAOC,IAAP,CAAY1C,OAAZ,EAAqBX,MAArB,GAA8B,CAAlC,EAAqC;AACpC,WAAOW,OAAP;AACA;AACD,CAbD;;AAeA,MAAM0D,sBAAsB,UAASC,OAAT,EAAkB;AAC7C,QAAMC,OAAO,EAAb;AACAnB,SAAOC,IAAP,CAAYiB,OAAZ,EAAqBhB,OAArB,CAA8BY,GAAD,IAAS;AACrC,UAAMpB,QAAQwB,QAAQJ,GAAR,CAAd;;AACA,QAAI,uEAAuEM,IAAvE,CAA4EN,IAAI1F,WAAJ,EAA5E,KAAmGsE,SAASA,MAAMsB,IAAN,OAAiB,EAAjI,EAAsI;AACrIG,WAAKL,GAAL,IAAYpB,KAAZ;AACA;AACD,GALD;;AAOA,MAAIM,OAAOC,IAAP,CAAYkB,IAAZ,EAAkBvE,MAAlB,GAA2B,CAA/B,EAAkC;AACjC,WAAOuE,IAAP;AACA;AACD,CAZD;;AAcA7G,OAAO+G,eAAP,GAAyB,UAASC,OAAT,EAAkB;AAC1C,MAAIC,MAAMC,OAAN,CAAcF,QAAQG,IAAtB,CAAJ,EAAiC;AAChC,QAAIzE,cAAc,EAAlB;AACA,QAAI0E,UAAU,KAAd;AACAJ,YAAQG,IAAR,CAAavB,OAAb,CAAqB,UAASyB,IAAT,EAAe;AACnC,UAAIA,KAAKC,WAAL,KAAqB,IAAzB,EAA+B;AAC9B;AACA;;AACD,UAAID,KAAK1E,GAAL,CAAS4E,UAAT,CAAoB,UAApB,CAAJ,EAAqC;AACpCH,kBAAU,IAAV;AACAC,aAAKtC,IAAL,GAAY;AACXyC,qBAAW;AACVC,mBAAOJ,KAAKK;AADF;AADA,SAAZ;AAKA;AACA;;AACD,UAAI,CAAC,gBAAgBZ,IAAhB,CAAqBO,KAAK1E,GAA1B,CAAL,EAAqC;AACpC;AACA;;AACD,YAAMJ,OAAOvC,OAAO8F,mBAAP,CAA2BuB,KAAK1E,GAAhC,CAAb;;AACA,UAAIJ,QAAQ,IAAZ,EAAkB;AACjB,YAAIA,KAAKG,WAAT,EAAsB;AACrB,iBAAOA,cAAcxD,EAAEyI,KAAF,CAAQjF,WAAR,EAAqBH,KAAKG,WAA1B,CAArB;AACA,SAFD,MAEO;AACN,cAAIH,KAAKwC,IAAL,IAAa,IAAjB,EAAuB;AACtBsC,iBAAKtC,IAAL,GAAY4B,oBAAoBpE,KAAKwC,IAAzB,CAAZ;AACA;;AACD,cAAIxC,KAAKU,OAAL,IAAgB,IAApB,EAA0B;AACzBoE,iBAAKpE,OAAL,GAAeqD,mBAAmB/D,KAAKU,OAAxB,CAAf;AACA;;AACDoE,eAAK3F,SAAL,GAAiBa,KAAKb,SAAtB;AACA,iBAAO0F,UAAU,IAAjB;AACA;AACD;AACD,KA/BD;;AAgCA,QAAI1E,YAAYJ,MAAhB,EAAwB;AACvBT,iBAAWmE,MAAX,CAAkB4B,QAAlB,CAA2BC,qBAA3B,CAAiDb,QAAQc,GAAzD,EAA8DpF,WAA9D;AACA;;AACD,QAAI0E,YAAY,IAAhB,EAAsB;AACrBvF,iBAAWmE,MAAX,CAAkB4B,QAAlB,CAA2BG,WAA3B,CAAuCf,QAAQc,GAA/C,EAAoDd,QAAQG,IAA5D;AACA;AACD;;AACD,SAAOH,OAAP;AACA,CA5CD;;AA8CAnF,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,WAAxB,EAAqC,UAASyE,GAAT,EAAcpB,KAAd,EAAqB;AACzD,MAAIA,KAAJ,EAAW;AACV,WAAOvD,WAAWW,SAAX,CAAqBwF,GAArB,CAAyB,kBAAzB,EAA6ChI,OAAO+G,eAApD,EAAqElF,WAAWW,SAAX,CAAqByF,QAArB,CAA8BC,GAAnG,EAAwG,WAAxG,CAAP;AACA,GAFD,MAEO;AACN,WAAOrG,WAAWW,SAAX,CAAqB2F,MAArB,CAA4B,kBAA5B,EAAgD,WAAhD,CAAP;AACA;AACD,CAND,E;;;;;;;;;;;AChSA,IAAIjJ,CAAJ;;AAAMD,OAAOE,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACJ,QAAEI,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIC,GAAJ;AAAQN,OAAOE,KAAP,CAAaC,QAAQ,KAAR,CAAb,EAA4B;AAACC,UAAQC,CAAR,EAAU;AAACC,UAAID,CAAJ;AAAM;;AAAlB,CAA5B,EAAgD,CAAhD;AAAmD,IAAI8I,WAAJ;AAAgBnJ,OAAOE,KAAP,CAAaC,QAAQ,aAAR,CAAb,EAAoC;AAACC,UAAQC,CAAR,EAAU;AAAC8I,kBAAY9I,CAAZ;AAAc;;AAA1B,CAApC,EAAgE,CAAhE;;AAKzI,MAAM+I,SAAN,CAAgB;AACfC,gBAAc;AACb,SAAKC,SAAL,GAAiB,EAAjB;AACA;;AAED,SAAOC,cAAP,CAAsBC,QAAtB,EAAgC9F,GAAhC,EAAqC;AACpC,UAAMtB,SAAS9B,IAAIkC,KAAJ,CAAUgH,SAASC,QAAnB,EAA6B,IAA7B,CAAf;AACArH,WAAOkD,KAAP,CAAa,KAAb,IAAsB5B,GAAtB;AACA,WAAOtB,OAAOsH,MAAd;AACA,WAAOpJ,IAAIqD,MAAJ,CAAWvB,MAAX,CAAP;AACA;;AAEDuH,mBAAiBH,QAAjB,EAA2B;AAC1B,WAAO,KAAKF,SAAL,CAAe5E,IAAf,CAAoB8E,QAApB,CAAP;AACA;;AAEDI,iBAAe;AACd,WAAO,KAAKN,SAAZ;AACA;;AAEDO,oBAAkBnG,GAAlB,EAAuB;AACtB,WAAOzD,EAAE6J,IAAF,CAAO,KAAKR,SAAZ,EAAuB,UAASE,QAAT,EAAmB;AAChD,YAAMO,YAAY9J,EAAE6J,IAAF,CAAON,SAAStB,IAAhB,EAAsB,UAAS8B,EAAT,EAAa;AACpD,eAAOA,GAAGnC,IAAH,CAAQnE,GAAR,CAAP;AACA,OAFiB,CAAlB;;AAGA,aAAOqG,aAAa,IAApB;AACA,KALM,CAAP;AAMA;;AA3Bc;;AA8BhB,MAAMT,YAAY,IAAIF,SAAJ,EAAlB;AAEAE,UAAUK,gBAAV,CAA2B;AAC1BzB,QAAM,CAAC,IAAI+B,MAAJ,CAAW,8BAAX,CAAD,CADoB;AAE1BR,YAAU;AAFgB,CAA3B;AAKAH,UAAUK,gBAAV,CAA2B;AAC1BzB,QAAM,CAAC,IAAI+B,MAAJ,CAAW,0BAAX,CAAD,EAAyC,IAAIA,MAAJ,CAAW,yCAAX,CAAzC,EAAgG,IAAIA,MAAJ,CAAW,6CAAX,CAAhG,CADoB;AAE1BR,YAAU;AAFgB,CAA3B;AAKAH,UAAUK,gBAAV,CAA2B;AAC1BzB,QAAM,CAAC,IAAI+B,MAAJ,CAAW,+BAAX,CAAD,EAA8C,IAAIA,MAAJ,CAAW,wBAAX,CAA9C,CADoB;AAE1BR,YAAU;AAFgB,CAA3B;AAKAH,UAAUK,gBAAV,CAA2B;AAC1BzB,QAAM,CAAC,IAAI+B,MAAJ,CAAW,4BAAX,CAAD,EAA2C,IAAIA,MAAJ,CAAW,qBAAX,CAA3C,CADoB;AAE1BR,YAAU;AAFgB,CAA3B;AAKAH,UAAUK,gBAAV,CAA2B;AAC1BzB,QAAM,CAAC,IAAI+B,MAAJ,CAAW,yCAAX,CAAD,CADoB;AAE1BR,YAAU;AAFgB,CAA3B;AAKAH,UAAUK,gBAAV,CAA2B;AAC1BzB,QAAM,CAAC,IAAI+B,MAAJ,CAAW,yCAAX,CAAD,CADoB;AAE1BR,YAAU;AAFgB,CAA3B;AAKA7G,WAAWsH,MAAX,GAAoB,EAApB;AAEAtH,WAAWsH,MAAX,CAAkBZ,SAAlB,GAA8BA,SAA9B;AAEA1G,WAAWW,SAAX,CAAqBwF,GAArB,CAAyB,4BAAzB,EAAuD,UAASzF,IAAT,EAAe;AACrE,MAAIA,KAAKb,SAAL,IAAkB,IAAtB,EAA4B;AAC3B,UAAMiB,MAAMpD,IAAIqD,MAAJ,CAAWL,KAAKb,SAAhB,CAAZ;AACA,UAAM+G,WAAWF,UAAUO,iBAAV,CAA4BnG,GAA5B,CAAjB;;AACA,QAAI8F,YAAY,IAAhB,EAAsB;AACrB,UAAIW,cAAcf,UAAUG,cAAV,CAAyBC,QAAzB,EAAmC9F,GAAnC,CAAlB;AACAyG,oBAAc7J,IAAIkC,KAAJ,CAAU2H,WAAV,EAAuB,IAAvB,CAAd;;AACAlK,QAAEmK,MAAF,CAAS9G,KAAKb,SAAd,EAAyB0H,WAAzB;;AACA7G,WAAKlB,MAAL,CAAYgB,IAAZ,GAAmB+G,YAAY/G,IAA/B;AACAE,WAAKlB,MAAL,CAAYc,QAAZ,GAAuBiH,YAAYjH,QAAnC;AACAI,WAAKlB,MAAL,CAAYsD,QAAZ,GAAuByE,YAAYzE,QAAnC;AACApC,WAAKlB,MAAL,CAAYkD,KAAZ,GAAoB6E,YAAY7E,KAAhC;AACA,aAAOhC,KAAKlB,MAAL,CAAYsH,MAAnB;AACA,aAAOpG,KAAKlB,MAAL,CAAYiI,IAAnB;AACA;AACD;;AACD,SAAO/G,IAAP;AACA,CAjBD,EAiBGV,WAAWW,SAAX,CAAqByF,QAArB,CAA8BsB,MAjBjC,EAiByC,yBAjBzC;AAmBA1H,WAAWW,SAAX,CAAqBwF,GAArB,CAAyB,0BAAzB,EAAqD,UAASzF,IAAT,EAAe;AACnE,MAAIA,KAAKb,SAAL,IAAkBa,KAAKb,SAAL,CAAe6C,KAArC,EAA4C;AAC3C,QAAIiF,cAAcjH,KAAKb,SAAL,CAAe6C,KAAjC;;AACA,QAAIrF,EAAEsC,QAAF,CAAWe,KAAKb,SAAL,CAAe6C,KAA1B,CAAJ,EAAsC;AACrCiF,oBAAcpB,YAAY3G,KAAZ,CAAkBc,KAAKb,SAAL,CAAe6C,KAAjC,CAAd;AACA;;AACD,QAAIiF,YAAY7G,GAAZ,IAAmB,IAAvB,EAA6B;AAC5B,YAAMA,MAAM6G,YAAY7G,GAAxB;AACA,YAAM8F,WAAWF,UAAUO,iBAAV,CAA4BnG,GAA5B,CAAjB;;AACA,UAAI8F,YAAY,IAAhB,EAAsB;AACrB,YAAIlG,KAAKqC,OAAL,IAAgBrC,KAAKqC,OAAL,CAAazE,IAAjC,EAAuC;AACtC,cAAI;AACH,kBAAM0E,QAAQ4E,KAAKhI,KAAL,CAAWc,KAAKqC,OAAL,CAAazE,IAAxB,CAAd;;AACAjB,cAAEwK,IAAF,CAAO7E,KAAP,EAAc,UAASO,KAAT,EAAgBoB,GAAhB,EAAqB;AAClC,kBAAItH,EAAEsC,QAAF,CAAW4D,KAAX,CAAJ,EAAuB;AACtB,uBAAO7C,KAAKwC,IAAL,CAAUO,WAAWC,SAAX,CAAsB,UAAUiB,GAAK,EAArC,CAAV,IAAqDpB,KAA5D;AACA;AACD,aAJD;;AAKA7C,iBAAKwC,IAAL,CAAU,WAAV,IAAyBpC,GAAzB;AACA,WARD,CAQE,OAAOQ,KAAP,EAAc;AACfkD,oBAAQsD,GAAR,CAAYxG,KAAZ;AACA;AACD;AACD;AACD;AACD;;AACD,SAAOZ,IAAP;AACA,CA3BD,EA2BGV,WAAWW,SAAX,CAAqByF,QAArB,CAA8BsB,MA3BjC,EA2ByC,wBA3BzC,E;;;;;;;;;;;AC1FA,IAAIrK,CAAJ;;AAAMD,OAAOE,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACJ,QAAEI,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIC,GAAJ;AAAQN,OAAOE,KAAP,CAAaC,QAAQ,KAAR,CAAb,EAA4B;AAACC,UAAQC,CAAR,EAAU;AAACC,UAAID,CAAJ;AAAM;;AAAlB,CAA5B,EAAgD,CAAhD;AAAmD,IAAI8I,WAAJ;AAAgBnJ,OAAOE,KAAP,CAAaC,QAAQ,aAAR,CAAb,EAAoC;AAACC,UAAQC,CAAR,EAAU;AAAC8I,kBAAY9I,CAAZ;AAAc;;AAA1B,CAApC,EAAgE,CAAhE;;AAKzI,MAAMsK,kBAAkB,CAAC5C,OAAD,EAAU6C,OAAO,CAAjB,KAAuB;AAC9C,MAAI7C,OAAJ,EAAa;AACZ,QAAI,iBAAiBA,OAAjB,IAA4BA,QAAQtE,WAAR,KAAwB,IAApD,IAA4DmH,OAAOhI,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,yBAAxB,CAAvE,EAA2H;AAC1HiF,cAAQtE,WAAR,CAAoBoH,GAApB,CAAyBC,GAAD,IAASH,gBAAgBG,GAAhB,EAAqBF,OAAO,CAA5B,CAAjC;AACA,KAFD,MAEO;AACN,aAAO7C,QAAQtE,WAAf;AACA;AACD;;AACD,SAAOsE,OAAP;AACA,CATD;;AAWAnF,WAAWW,SAAX,CAAqBwF,GAArB,CAAyB,mBAAzB,EAA+C+B,GAAD,IAAS;AACtD,MAAIA,OAAOA,IAAI5C,IAAf,EAAqB;AACpB4C,QAAI5C,IAAJ,CAASvB,OAAT,CAAkByB,IAAD,IAAU;AAC1B,UAAIA,KAAK1E,GAAL,CAASqH,OAAT,CAAiBpG,OAAOqG,WAAP,EAAjB,MAA2C,CAA/C,EAAkD;AACjD,cAAM5I,SAAS9B,IAAIkC,KAAJ,CAAU4F,KAAK1E,GAAf,CAAf;;AACA,YAAItB,OAAOkD,KAAX,EAAkB;AACjB,gBAAMiF,cAAcpB,YAAY3G,KAAZ,CAAkBJ,OAAOkD,KAAzB,CAApB;;AACA,cAAIrF,EAAEsC,QAAF,CAAWgI,YAAYO,GAAvB,CAAJ,EAAiC;AAAE;AAClC,kBAAMG,gBAAgBN,gBAAgB/H,WAAWmE,MAAX,CAAkB4B,QAAlB,CAA2B1B,WAA3B,CAAuCsD,YAAYO,GAAnD,CAAhB,CAAtB;;AACA,gBAAIG,aAAJ,EAAmB;AAClBH,kBAAIrH,WAAJ,GAAkBqH,IAAIrH,WAAJ,IAAmB,EAArC;AACAqH,kBAAIrH,WAAJ,CAAgBiB,IAAhB,CAAqB;AACpB,wBAASuG,cAAcH,GADH;AAEpB,gCAAgBG,cAAcC,YAFV;AAGpB,+BAAgBD,cAAcE,KAAd,IAAuBF,cAAcG,CAAd,CAAgBC,QAHnC;AAIpB,+BAAgBC,yBAAyBL,cAAcG,CAAd,CAAgBC,QAAzC,CAJI;AAKpB,gCAAiBjD,KAAK1E,GALF;AAMpB,+BAAgBuH,cAAcxH,WAAd,IAA6B,EANzB;AAOpB,sBAAMwH,cAAcM;AAPA,eAArB;AASAnD,mBAAKC,WAAL,GAAmB,IAAnB;AACA;AACD;AACD;AACD;AACD,KAvBD;AAwBA;;AACD,SAAOyC,GAAP;AACA,CA5BD,EA4BGlI,WAAWW,SAAX,CAAqByF,QAArB,CAA8BC,GA5BjC,EA4BsC,eA5BtC,E;;;;;;;;;;;ACfArG,WAAWmE,MAAX,CAAkBC,WAAlB,GAAgC,IAAI,cAAcpE,WAAWmE,MAAX,CAAkByE,KAAhC,CAAsC;AACzEnC,gBAAc;AACb,UAAM,cAAN;AACA,SAAKoC,cAAL,CAAoB;AAAE,mBAAa;AAAf,KAApB;AACA,GAJwE,CAMzE;;;AACAxE,cAAY4B,GAAZ,EAAiB6C,OAAjB,EAA0B;AACzB,UAAMpG,QAAQ;AACbuD;AADa,KAAd;AAGA,WAAO,KAAK8C,OAAL,CAAarG,KAAb,EAAoBoG,OAApB,CAAP;AACA,GAZwE,CAczE;;;AACAxE,sBAAoB2B,GAApB,EAAyBvF,IAAzB,EAA+B;AAC9B,UAAMsI,SAAS;AACd/C,SADc;AAEdvF,UAFc;AAGduI,iBAAW,IAAIC,IAAJ;AAHG,KAAf;AAKAF,WAAO/C,GAAP,GAAa,KAAKkD,MAAL,CAAYH,MAAZ,CAAb;AACA,WAAOA,MAAP;AACA,GAvBwE,CAyBzE;;;AACAI,kBAAgBC,IAAhB,EAAsB;AACrB,UAAM3G,QAAQ;AACbuG,iBAAW;AACVK,cAAMD;AADI;AADE,KAAd;AAKA,WAAO,KAAK/C,MAAL,CAAY5D,KAAZ,CAAP;AACA;;AAjCwE,CAA1C,EAAhC,C","file":"/packages/rocketchat_oembed.js","sourcesContent":["/*globals HTTPInternals, changeCase */\nimport _ from 'underscore';\nimport URL from 'url';\nimport querystring from 'querystring';\nimport iconv from 'iconv-lite';\nimport ipRangeCheck from 'ip-range-check';\nimport he from 'he';\nimport jschardet from 'jschardet';\n\nconst request = HTTPInternals.NpmModules.request.module;\nconst OEmbed = {};\n\n//  Detect encoding\n//  Priority:\n//  Detected == HTTP Header > Detected == HTML meta > HTTP Header > HTML meta > Detected > Default (utf-8)\n//  See also: https://www.w3.org/International/questions/qa-html-encoding-declarations.en#quickanswer\nconst getCharset = function(contentType, body) {\n\tlet detectedCharset;\n\tlet httpHeaderCharset;\n\tlet htmlMetaCharset;\n\tlet result;\n\n\tcontentType = contentType || '';\n\n\tconst binary = body.toString('binary');\n\tconst detected = jschardet.detect(binary);\n\tif (detected.confidence > 0.8) {\n\t\tdetectedCharset = detected.encoding.toLowerCase();\n\t}\n\tconst m1 = contentType.match(/charset=([\\w\\-]+)/i);\n\tif (m1) {\n\t\thttpHeaderCharset = m1[1].toLowerCase();\n\t}\n\tconst m2 = binary.match(/<meta\\b[^>]*charset=[\"']?([\\w\\-]+)/i);\n\tif (m2) {\n\t\thtmlMetaCharset = m2[1].toLowerCase();\n\t}\n\tif (detectedCharset) {\n\t\tif (detectedCharset === httpHeaderCharset) {\n\t\t\tresult = httpHeaderCharset;\n\t\t} else if (detectedCharset === htmlMetaCharset) {\n\t\t\tresult = htmlMetaCharset;\n\t\t}\n\t}\n\tif (!result) {\n\t\tresult = httpHeaderCharset || htmlMetaCharset || detectedCharset;\n\t}\n\treturn result || 'utf-8';\n};\n\nconst toUtf8 = function(contentType, body) {\n\treturn iconv.decode(body, getCharset(contentType, body));\n};\n\nconst getUrlContent = function(urlObj, redirectCount = 5, callback) {\n\n\tif (_.isString(urlObj)) {\n\t\turlObj = URL.parse(urlObj);\n\t}\n\n\tconst parsedUrl = _.pick(urlObj, ['host', 'hash', 'pathname', 'protocol', 'port', 'query', 'search', 'hostname']);\n\tconst ignoredHosts = RocketChat.settings.get('API_EmbedIgnoredHosts').replace(/\\s/g, '').split(',') || [];\n\tif (ignoredHosts.includes(parsedUrl.hostname) || ipRangeCheck(parsedUrl.hostname, ignoredHosts)) {\n\t\treturn callback();\n\t}\n\n\tconst safePorts = RocketChat.settings.get('API_EmbedSafePorts').replace(/\\s/g, '').split(',') || [];\n\tif (parsedUrl.port && safePorts.length > 0 && (!safePorts.includes(parsedUrl.port))) {\n\t\treturn callback();\n\t}\n\n\tconst data = RocketChat.callbacks.run('oembed:beforeGetUrlContent', {\n\t\turlObj,\n\t\tparsedUrl\n\t});\n\tif (data.attachments != null) {\n\t\treturn callback(null, data);\n\t}\n\tconst url = URL.format(data.urlObj);\n\tconst opts = {\n\t\turl,\n\t\tstrictSSL: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs'),\n\t\tgzip: true,\n\t\tmaxRedirects: redirectCount,\n\t\theaders: {\n\t\t\t'User-Agent': RocketChat.settings.get('API_Embed_UserAgent')\n\t\t}\n\t};\n\tlet headers = null;\n\tlet statusCode = null;\n\tlet error = null;\n\tconst chunks = [];\n\tlet chunksTotalLength = 0;\n\tconst stream = request(opts);\n\tstream.on('response', function(response) {\n\t\tstatusCode = response.statusCode;\n\t\theaders = response.headers;\n\t\tif (response.statusCode !== 200) {\n\t\t\treturn stream.abort();\n\t\t}\n\t});\n\tstream.on('data', function(chunk) {\n\t\tchunks.push(chunk);\n\t\tchunksTotalLength += chunk.length;\n\t\tif (chunksTotalLength > 250000) {\n\t\t\treturn stream.abort();\n\t\t}\n\t});\n\tstream.on('end', Meteor.bindEnvironment(function() {\n\t\tif (error != null) {\n\t\t\treturn callback(null, {\n\t\t\t\terror,\n\t\t\t\tparsedUrl\n\t\t\t});\n\t\t}\n\t\tconst buffer = Buffer.concat(chunks);\n\t\treturn callback(null, {\n\t\t\theaders,\n\t\t\tbody: toUtf8(headers['content-type'], buffer),\n\t\t\tparsedUrl,\n\t\t\tstatusCode\n\t\t});\n\t}));\n\treturn stream.on('error', function(err) {\n\t\treturn error = err;\n\t});\n};\n\nOEmbed.getUrlMeta = function(url, withFragment) {\n\tconst getUrlContentSync = Meteor.wrapAsync(getUrlContent);\n\tconst urlObj = URL.parse(url);\n\tif (withFragment != null) {\n\t\tconst queryStringObj = querystring.parse(urlObj.query);\n\t\tqueryStringObj._escaped_fragment_ = '';\n\t\turlObj.query = querystring.stringify(queryStringObj);\n\t\tlet path = urlObj.pathname;\n\t\tif (urlObj.query != null) {\n\t\t\tpath += `?${ urlObj.query }`;\n\t\t}\n\t\turlObj.path = path;\n\t}\n\tconst content = getUrlContentSync(urlObj, 5);\n\tif (!content) {\n\t\treturn;\n\t}\n\tif (content.attachments != null) {\n\t\treturn content;\n\t}\n\tlet metas = undefined;\n\tif (content && content.body) {\n\t\tmetas = {};\n\t\tcontent.body.replace(/<title[^>]*>([^<]*)<\\/title>/gmi, function(meta, title) {\n\t\t\treturn metas.pageTitle != null ? metas.pageTitle : metas.pageTitle = he.unescape(title);\n\t\t});\n\t\tcontent.body.replace(/<meta[^>]*(?:name|property)=[']([^']*)['][^>]*\\scontent=[']([^']*)['][^>]*>/gmi, function(meta, name, value) {\n\t\t\tlet name1;\n\t\t\treturn metas[name1 = changeCase.camelCase(name)] != null ? metas[name1] : metas[name1] = he.unescape(value);\n\t\t});\n\t\tcontent.body.replace(/<meta[^>]*(?:name|property)=[\"]([^\"]*)[\"][^>]*\\scontent=[\"]([^\"]*)[\"][^>]*>/gmi, function(meta, name, value) {\n\t\t\tlet name1;\n\t\t\treturn metas[name1 = changeCase.camelCase(name)] != null ? metas[name1] : metas[name1] = he.unescape(value);\n\t\t});\n\t\tcontent.body.replace(/<meta[^>]*\\scontent=[']([^']*)['][^>]*(?:name|property)=[']([^']*)['][^>]*>/gmi, function(meta, value, name) {\n\t\t\tlet name1;\n\t\t\treturn metas[name1 = changeCase.camelCase(name)] != null ? metas[name1] : metas[name1] = he.unescape(value);\n\t\t});\n\t\tcontent.body.replace(/<meta[^>]*\\scontent=[\"]([^\"]*)[\"][^>]*(?:name|property)=[\"]([^\"]*)[\"][^>]*>/gmi, function(meta, value, name) {\n\t\t\tlet name1;\n\t\t\treturn metas[name1 = changeCase.camelCase(name)] != null ? metas[name1] : metas[name1] = he.unescape(value);\n\t\t});\n\t\tif (metas.fragment === '!' && (withFragment == null)) {\n\t\t\treturn OEmbed.getUrlMeta(url, true);\n\t\t}\n\t}\n\tlet headers = undefined;\n\tlet data = undefined;\n\n\n\tif (content && content.headers) {\n\t\theaders = {};\n\t\tconst headerObj = content.headers;\n\t\tObject.keys(headerObj).forEach((header) => {\n\t\t\theaders[changeCase.camelCase(header)] = headerObj[header];\n\t\t});\n\t}\n\tif (content && content.statusCode !== 200) {\n\t\treturn data;\n\t}\n\tdata = RocketChat.callbacks.run('oembed:afterParseContent', {\n\t\tmeta: metas,\n\t\theaders,\n\t\tparsedUrl: content.parsedUrl,\n\t\tcontent\n\t});\n\treturn data;\n};\n\nOEmbed.getUrlMetaWithCache = function(url, withFragment) {\n\tconst cache = RocketChat.models.OEmbedCache.findOneById(url);\n\tif (cache != null) {\n\t\treturn cache.data;\n\t}\n\tconst data = OEmbed.getUrlMeta(url, withFragment);\n\tif (data != null) {\n\t\ttry {\n\t\t\tRocketChat.models.OEmbedCache.createWithIdAndData(url, data);\n\t\t} catch (_error) {\n\t\t\tconsole.error('OEmbed duplicated record', url);\n\t\t}\n\t\treturn data;\n\t}\n};\n\nconst getRelevantHeaders = function(headersObj) {\n\tconst headers = {};\n\tObject.keys(headersObj).forEach((key) => {\n\t\tconst value = headersObj[key];\n\t\tconst lowerCaseKey = key.toLowerCase();\n\t\tif ((lowerCaseKey === 'contenttype' || lowerCaseKey === 'contentlength') && (value && value.trim() !== '')) {\n\t\t\theaders[key] = value;\n\t\t}\n\t});\n\n\tif (Object.keys(headers).length > 0) {\n\t\treturn headers;\n\t}\n};\n\nconst getRelevantMetaTags = function(metaObj) {\n\tconst tags = {};\n\tObject.keys(metaObj).forEach((key) => {\n\t\tconst value = metaObj[key];\n\t\tif (/^(og|fb|twitter|oembed|msapplication).+|description|title|pageTitle$/.test(key.toLowerCase()) && (value && value.trim() !== '')) {\n\t\t\ttags[key] = value;\n\t\t}\n\t});\n\n\tif (Object.keys(tags).length > 0) {\n\t\treturn tags;\n\t}\n};\n\nOEmbed.rocketUrlParser = function(message) {\n\tif (Array.isArray(message.urls)) {\n\t\tlet attachments = [];\n\t\tlet changed = false;\n\t\tmessage.urls.forEach(function(item) {\n\t\t\tif (item.ignoreParse === true) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (item.url.startsWith('grain://')) {\n\t\t\t\tchanged = true;\n\t\t\t\titem.meta = {\n\t\t\t\t\tsandstorm: {\n\t\t\t\t\t\tgrain: item.sandstormViewInfo\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!/^https?:\\/\\//i.test(item.url)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst data = OEmbed.getUrlMetaWithCache(item.url);\n\t\t\tif (data != null) {\n\t\t\t\tif (data.attachments) {\n\t\t\t\t\treturn attachments = _.union(attachments, data.attachments);\n\t\t\t\t} else {\n\t\t\t\t\tif (data.meta != null) {\n\t\t\t\t\t\titem.meta = getRelevantMetaTags(data.meta);\n\t\t\t\t\t}\n\t\t\t\t\tif (data.headers != null) {\n\t\t\t\t\t\titem.headers = getRelevantHeaders(data.headers);\n\t\t\t\t\t}\n\t\t\t\t\titem.parsedUrl = data.parsedUrl;\n\t\t\t\t\treturn changed = true;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tif (attachments.length) {\n\t\t\tRocketChat.models.Messages.setMessageAttachments(message._id, attachments);\n\t\t}\n\t\tif (changed === true) {\n\t\t\tRocketChat.models.Messages.setUrlsById(message._id, message.urls);\n\t\t}\n\t}\n\treturn message;\n};\n\nRocketChat.settings.get('API_Embed', function(key, value) {\n\tif (value) {\n\t\treturn RocketChat.callbacks.add('afterSaveMessage', OEmbed.rocketUrlParser, RocketChat.callbacks.priority.LOW, 'API_Embed');\n\t} else {\n\t\treturn RocketChat.callbacks.remove('afterSaveMessage', 'API_Embed');\n\t}\n});\n","/*globals changeCase */\nimport _ from 'underscore';\nimport URL from 'url';\nimport QueryString from 'querystring';\n\nclass Providers {\n\tconstructor() {\n\t\tthis.providers = [];\n\t}\n\n\tstatic getConsumerUrl(provider, url) {\n\t\tconst urlObj = URL.parse(provider.endPoint, true);\n\t\turlObj.query['url'] = url;\n\t\tdelete urlObj.search;\n\t\treturn URL.format(urlObj);\n\t}\n\n\tregisterProvider(provider) {\n\t\treturn this.providers.push(provider);\n\t}\n\n\tgetProviders() {\n\t\treturn this.providers;\n\t}\n\n\tgetProviderForUrl(url) {\n\t\treturn _.find(this.providers, function(provider) {\n\t\t\tconst candidate = _.find(provider.urls, function(re) {\n\t\t\t\treturn re.test(url);\n\t\t\t});\n\t\t\treturn candidate != null;\n\t\t});\n\t}\n}\n\nconst providers = new Providers();\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://soundcloud.com/\\\\S+')],\n\tendPoint: 'https://soundcloud.com/oembed?format=json&maxheight=150'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://vimeo.com/[^/]+'), new RegExp('https?://vimeo.com/channels/[^/]+/[^/]+'), new RegExp('https://vimeo.com/groups/[^/]+/videos/[^/]+')],\n\tendPoint: 'https://vimeo.com/api/oembed.json?maxheight=200'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www.youtube.com/\\\\S+'), new RegExp('https?://youtu.be/\\\\S+')],\n\tendPoint: 'https://www.youtube.com/oembed?maxheight=200'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www.rdio.com/\\\\S+'), new RegExp('https?://rd.io/\\\\S+')],\n\tendPoint: 'https://www.rdio.com/api/oembed/?format=json&maxheight=150'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www.slideshare.net/[^/]+/[^/]+')],\n\tendPoint: 'https://www.slideshare.net/api/oembed/2?format=json&maxheight=200'\n});\n\nproviders.registerProvider({\n\turls: [new RegExp('https?://www.dailymotion.com/video/\\\\S+')],\n\tendPoint: 'https://www.dailymotion.com/services/oembed?maxheight=200'\n});\n\nRocketChat.oembed = {};\n\nRocketChat.oembed.providers = providers;\n\nRocketChat.callbacks.add('oembed:beforeGetUrlContent', function(data) {\n\tif (data.parsedUrl != null) {\n\t\tconst url = URL.format(data.parsedUrl);\n\t\tconst provider = providers.getProviderForUrl(url);\n\t\tif (provider != null) {\n\t\t\tlet consumerUrl = Providers.getConsumerUrl(provider, url);\n\t\t\tconsumerUrl = URL.parse(consumerUrl, true);\n\t\t\t_.extend(data.parsedUrl, consumerUrl);\n\t\t\tdata.urlObj.port = consumerUrl.port;\n\t\t\tdata.urlObj.hostname = consumerUrl.hostname;\n\t\t\tdata.urlObj.pathname = consumerUrl.pathname;\n\t\t\tdata.urlObj.query = consumerUrl.query;\n\t\t\tdelete data.urlObj.search;\n\t\t\tdelete data.urlObj.host;\n\t\t}\n\t}\n\treturn data;\n}, RocketChat.callbacks.priority.MEDIUM, 'oembed-providers-before');\n\nRocketChat.callbacks.add('oembed:afterParseContent', function(data) {\n\tif (data.parsedUrl && data.parsedUrl.query) {\n\t\tlet queryString = data.parsedUrl.query;\n\t\tif (_.isString(data.parsedUrl.query)) {\n\t\t\tqueryString = QueryString.parse(data.parsedUrl.query);\n\t\t}\n\t\tif (queryString.url != null) {\n\t\t\tconst url = queryString.url;\n\t\t\tconst provider = providers.getProviderForUrl(url);\n\t\t\tif (provider != null) {\n\t\t\t\tif (data.content && data.content.body) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst metas = JSON.parse(data.content.body);\n\t\t\t\t\t\t_.each(metas, function(value, key) {\n\t\t\t\t\t\t\tif (_.isString(value)) {\n\t\t\t\t\t\t\t\treturn data.meta[changeCase.camelCase(`oembed_${ key }`)] = value;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\tdata.meta['oembedUrl'] = url;\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tconsole.log(error);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn data;\n}, RocketChat.callbacks.priority.MEDIUM, 'oembed-providers-after');\n","/* globals getAvatarUrlFromUsername */\nimport _ from 'underscore';\nimport URL from 'url';\nimport QueryString from 'querystring';\n\nconst recursiveRemove = (message, deep = 1) => {\n\tif (message) {\n\t\tif ('attachments' in message && message.attachments !== null && deep < RocketChat.settings.get('Message_QuoteChainLimit')) {\n\t\t\tmessage.attachments.map((msg) => recursiveRemove(msg, deep + 1));\n\t\t} else {\n\t\t\tdelete(message.attachments);\n\t\t}\n\t}\n\treturn message;\n};\n\nRocketChat.callbacks.add('beforeSaveMessage', (msg) => {\n\tif (msg && msg.urls) {\n\t\tmsg.urls.forEach((item) => {\n\t\t\tif (item.url.indexOf(Meteor.absoluteUrl()) === 0) {\n\t\t\t\tconst urlObj = URL.parse(item.url);\n\t\t\t\tif (urlObj.query) {\n\t\t\t\t\tconst queryString = QueryString.parse(urlObj.query);\n\t\t\t\t\tif (_.isString(queryString.msg)) { // Jump-to query param\n\t\t\t\t\t\tconst jumpToMessage = recursiveRemove(RocketChat.models.Messages.findOneById(queryString.msg));\n\t\t\t\t\t\tif (jumpToMessage) {\n\t\t\t\t\t\t\tmsg.attachments = msg.attachments || [];\n\t\t\t\t\t\t\tmsg.attachments.push({\n\t\t\t\t\t\t\t\t'text' : jumpToMessage.msg,\n\t\t\t\t\t\t\t\t'translations': jumpToMessage.translations,\n\t\t\t\t\t\t\t\t'author_name' : jumpToMessage.alias || jumpToMessage.u.username,\n\t\t\t\t\t\t\t\t'author_icon' : getAvatarUrlFromUsername(jumpToMessage.u.username),\n\t\t\t\t\t\t\t\t'message_link' : item.url,\n\t\t\t\t\t\t\t\t'attachments' : jumpToMessage.attachments || [],\n\t\t\t\t\t\t\t\t'ts': jumpToMessage.ts\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\titem.ignoreParse = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\treturn msg;\n}, RocketChat.callbacks.priority.LOW, 'jumpToMessage');\n","\nRocketChat.models.OEmbedCache = new class extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('oembed_cache');\n\t\tthis.tryEnsureIndex({ 'updatedAt': 1 });\n\t}\n\n\t//FIND ONE\n\tfindOneById(_id, options) {\n\t\tconst query = {\n\t\t\t_id\n\t\t};\n\t\treturn this.findOne(query, options);\n\t}\n\n\t//INSERT\n\tcreateWithIdAndData(_id, data) {\n\t\tconst record = {\n\t\t\t_id,\n\t\t\tdata,\n\t\t\tupdatedAt: new Date\n\t\t};\n\t\trecord._id = this.insert(record);\n\t\treturn record;\n\t}\n\n\t//REMOVE\n\tremoveAfterDate(date) {\n\t\tconst query = {\n\t\t\tupdatedAt: {\n\t\t\t\t$lte: date\n\t\t\t}\n\t\t};\n\t\treturn this.remove(query);\n\t}\n};\n\n\n"]}