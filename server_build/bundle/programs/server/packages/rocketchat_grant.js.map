{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:grant/server/index.js","meteor://ðŸ’»app/packages/rocketchat:grant/server/authenticate.js","meteor://ðŸ’»app/packages/rocketchat:grant/server/error.js","meteor://ðŸ’»app/packages/rocketchat:grant/server/grant.js","meteor://ðŸ’»app/packages/rocketchat:grant/server/providers.js","meteor://ðŸ’»app/packages/rocketchat:grant/server/redirect.js","meteor://ðŸ’»app/packages/rocketchat:grant/server/routes.js","meteor://ðŸ’»app/packages/rocketchat:grant/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:grant/server/storage.js"],"names":["module","export","path","generateCallback","generateAppCallback","Providers","Settings","GrantError","WebApp","watch","require","v","session","default","Grant","fiber","generateConfig","redirect","middleware","providers","grant","connectHandlers","use","secret","resave","saveUninitialized","req","res","next","run","Meteor","startup","config","authenticate","AccountsServer","RocketChat","Accounts","setAvatarFromUrl","userId","url","Promise","resolve","reject","runAsUser","call","err","details","timeToReset","t","seconds","parseInt","findUserByOAuthId","providerName","id","models","Users","findOne","addOAuthIdToUserProfile","user","providerId","profile","Object","assign","settings","oauth","setProfile","getAccessToken","i","indexOf","barePath","substring","splitPath","split","token","find","p","match","replace","tokens","accessToken","provider","get","userData","getUser","_id","findOneByEmailAddress","email","loginResult","loginWithUser","createUser","username","avatar","setName","name","setEmailVerified","Error","constructor","args","getConfig","addProviders","forEach","enabled","registeredProvider","console","error","data","key","scope","callback","apps","_","appName","protocol","host","hostname","state","check","Storage","routes","register","options","String","Match","OneOf","Function","_add","toLowerCase","exportDefault","route","list","push","end","JSON","stringify","parseUrl","getAppConfig","providerConfig","appCallback","appConfig","app","redirectUrl","errorUrl","refreshToken","message","getPaths","slice","paths","Apps","add","body","Optional","Boolean","_data","all","fn","keys","has"],"mappings":"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","file":"/packages/rocketchat_grant.js","sourcesContent":["import { WebApp } from 'meteor/webapp';\nimport session from 'express-session';\nimport Grant from 'grant-express';\nimport fiber from 'fibers';\n\nimport { GrantError } from './error';\nimport { generateConfig } from './grant';\nimport { path, generateCallback, generateAppCallback } from './routes';\nimport { middleware as redirect } from './redirect';\nimport Providers, { middleware as providers } from './providers';\nimport Settings from './settings';\n\nlet grant;\n\nWebApp.connectHandlers.use(session({\n\tsecret: 'grant',\n\tresave: true,\n\tsaveUninitialized: true\n}));\n\n// grant\nWebApp.connectHandlers.use(path, (req, res, next) => {\n\tif (grant) {\n\t\tgrant(req, res, next);\n\t} else {\n\t\tnext();\n\t}\n});\n\n// callbacks\nWebApp.connectHandlers.use((req, res, next) => {\n\tfiber(() => {\n\t\tredirect(req, res, next);\n\t}).run();\n});\n\n// providers\nWebApp.connectHandlers.use((req, res, next) => {\n\tfiber(() => {\n\t\tproviders(req, res, next);\n\t}).run();\n});\n\nMeteor.startup(() => {\n\tconst config = generateConfig();\n\n\tgrant = new Grant(config);\n});\n\nexport {\n\tpath,\n\tgenerateCallback,\n\tgenerateAppCallback,\n\tProviders,\n\tSettings,\n\tGrantError\n};\n","import { AccountsServer } from 'meteor/rocketchat:accounts';\nimport { RocketChat } from 'meteor/rocketchat:lib';\nimport { Accounts } from 'meteor/accounts-base';\nimport { Meteor } from 'meteor/meteor';\n\nimport { GrantError } from './error';\nimport Providers from './providers';\n\nconst setAvatarFromUrl = (userId, url) => {\n\treturn new Promise((resolve, reject) => {\n\t\tMeteor.runAsUser(userId, () => {\n\t\t\tMeteor.call('setAvatarFromService', url, '', 'url', (err) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tif (err.details.timeToReset && err.details.timeToReset) {\n\t\t\t\t\t\treject((t('error-too-many-requests', {\n\t\t\t\t\t\t\tseconds: parseInt(err.details.timeToReset / 1000)\n\t\t\t\t\t\t})));\n\t\t\t\t\t} else {\n\t\t\t\t\t\treject(t('Avatar_url_invalid_or_error'));\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t});\n};\n\nconst findUserByOAuthId = (providerName, id) => {\n\treturn RocketChat.models.Users.findOne({ [`settings.profile.oauth.${ providerName }`]: id });\n};\n\nconst addOAuthIdToUserProfile = (user, providerName, providerId) => {\n\tconst profile = Object.assign({}, user.settings.profile, {\n\t\toauth: {\n\t\t\t...user.settings.profile.oauth,\n\t\t\t[providerName]: providerId\n\t\t}\n\t});\n\n\tRocketChat.models.Users.setProfile(user.id, profile);\n};\n\nfunction getAccessToken(req) {\n\tconst i = req.url.indexOf('?');\n\n\tif (i === -1) {\n\t\treturn;\n\t}\n\n\tconst barePath = req.url.substring(i + 1);\n\tconst splitPath = barePath.split('&');\n\tconst token = splitPath.find(p => p.match(/access_token=[a-zA-Z0-9]+/));\n\n\tif (token) {\n\t\treturn token.replace('access_token=', '');\n\t}\n}\n\nexport async function authenticate(providerName, req) {\n\tlet tokens;\n\tconst accessToken = getAccessToken(req);\n\tconst provider = Providers.get(providerName);\n\n\tif (!provider) {\n\t\tthrow new GrantError(`Provider '${ providerName }' not found`);\n\t}\n\n\tconst userData = provider.getUser(accessToken);\n\n\tlet user = findUserByOAuthId(providerName, userData.id);\n\n\tif (user) {\n\t\tuser.id = user._id;\n\t} else {\n\t\tuser = RocketChat.models.Users.findOneByEmailAddress(userData.email);\n\t\tif (user) {\n\t\t\tuser.id = user._id;\n\t\t}\n\t}\n\n\tif (user) {\n\t\taddOAuthIdToUserProfile(user, providerName, userData.id);\n\n\t\tconst loginResult = await AccountsServer.loginWithUser({ id: user.id });\n\n\t\ttokens = loginResult.tokens;\n\t} else {\n\t\tconst id = Accounts.createUser({\n\t\t\temail: userData.email,\n\t\t\tusername: userData.username\n\t\t});\n\n\t\tRocketChat.models.Users.setProfile(id, {\n\t\t\tavatar: userData.avatar,\n\t\t\toauth: {\n\t\t\t\t[providerName]: userData.id\n\t\t\t}\n\t\t});\n\t\tRocketChat.models.Users.setName(id, userData.name);\n\t\tRocketChat.models.Users.setEmailVerified(id, userData.email);\n\n\t\tawait setAvatarFromUrl(id, userData.avatar);\n\n\t\tconst loginResult = await AccountsServer.loginWithUser({ id });\n\n\t\ttokens = loginResult.tokens;\n\t}\n\n\treturn tokens;\n}\n","export class GrantError extends Error {\n\tconstructor(...args) {\n\t\tsuper(...args);\n\t}\n}\n","import { RocketChat } from 'meteor/rocketchat:lib';\n\nimport Providers from './providers';\nimport Settings from './settings';\nimport { path, generateCallback, generateAppCallback } from './routes';\n\nfunction addProviders(config) {\n\tSettings.forEach((settings, providerName) => {\n\t\tif (settings.enabled === true) {\n\t\t\tconst registeredProvider = Providers.get(providerName);\n\n\t\t\tif (!registeredProvider) {\n\t\t\t\tconsole.error(`No configuration for '${ providerName }' provider`);\n\t\t\t}\n\n\t\t\t// basic settings\n\t\t\tconst data = {\n\t\t\t\tkey: settings.key,\n\t\t\t\tsecret: settings.secret,\n\t\t\t\tscope: registeredProvider.scope,\n\t\t\t\tcallback: generateCallback(providerName)\n\t\t\t};\n\n\t\t\t// set each app\n\t\t\tSettings.apps.forEach((_, appName) => {\n\t\t\t\tdata[appName] = {\n\t\t\t\t\tcallback: generateAppCallback(providerName, appName)\n\t\t\t\t};\n\t\t\t});\n\n\t\t\tconfig[providerName] = data;\n\t\t}\n\t});\n}\n\nconst config = {};\n\nexport function generateConfig() {\n\tconfig['server'] = {\n\t\tprotocol: 'http',\n\t\thost: RocketChat.hostname,\n\t\tpath,\n\t\tstate: true\n\t};\n\n\taddProviders(config);\n\n\treturn config;\n}\n\nexport function getConfig() {\n\treturn config;\n}\n","import { check } from 'meteor/check';\n\nimport { Storage } from './storage';\nimport { routes } from './routes';\n\nclass Providers extends Storage {\n\tregister(name, options, getUser) {\n\t\tcheck(name, String);\n\t\tcheck(options, {\n\t\t\t// eslint-disable-next-line\n\t\t\tscope: Match.OneOf(String, [String])\n\t\t});\n\t\tcheck(getUser, Function);\n\n\t\tthis._add(name.toLowerCase(), {\n\t\t\tscope: options.scope,\n\t\t\tgetUser\n\t\t});\n\t}\n}\n\nconst providers = new Providers;\n\nexport default providers;\n\nexport function middleware(req, res, next) {\n\tconst route = routes.providers(req);\n\n\tif (route) {\n\t\tconst list = [];\n\n\t\tproviders.forEach((_, name) => list.push(name));\n\n\t\tres.end(JSON.stringify({\n\t\t\tdata: list\n\t\t}));\n\t\treturn;\n\t}\n\n\tnext();\n}\n","import { authenticate } from './authenticate';\nimport Settings from './settings';\nimport { routes } from './routes';\nimport { GrantError } from './error';\n\nfunction parseUrl(url, config) {\n\treturn url.replace(/\\{[\\ ]*(provider|accessToken|refreshToken|error)[\\ ]*\\}/g, (_, key) => config[key]);\n}\n\nfunction getAppConfig(providerName, appName) {\n\tconst providerConfig = Settings.get(providerName);\n\n\tif (providerConfig) {\n\t\treturn Settings.apps.get(appName);\n\t}\n}\n\nexport async function middleware(req, res, next) {\n\tconst route = routes.appCallback(req);\n\n\t// handle app callback\n\tif (route) {\n\t\tconst config = {\n\t\t\tprovider: route.provider\n\t\t};\n\t\tconst appConfig = getAppConfig(route.provider, route.app);\n\n\t\tif (appConfig) {\n\t\t\tconst {\n\t\t\t\tredirectUrl,\n\t\t\t\terrorUrl\n\t\t\t} = appConfig;\n\n\t\t\ttry {\n\t\t\t\tconst tokens = await authenticate(route.provider, req);\n\n\t\t\t\tconfig.accessToken = tokens.accessToken;\n\t\t\t\tconfig.refreshToken = tokens.refreshToken;\n\n\t\t\t\tres.redirect(parseUrl(redirectUrl, config));\n\t\t\t\treturn;\n\t\t\t} catch (error) {\n\t\t\t\tconfig.error = error instanceof GrantError ? error.message : 'Something went wrong';\n\n\t\t\t\tconsole.error(error);\n\n\t\t\t\tres.redirect(parseUrl(errorUrl, config));\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tnext();\n}\n","export const path = '/_oauth_apps';\n\nexport function generateCallback(providerName) {\n\treturn `${ path }/${ providerName }/callback`;\n}\n\nexport function generateAppCallback(providerName, appName) {\n\treturn generateCallback(`${ providerName }/${ appName }`);\n}\n\nexport function getPaths(req) {\n\tconst i = req.url.indexOf('?');\n\tlet barePath;\n\n\tif (i === -1) {\n\t\tbarePath = req.url;\n\t} else {\n\t\tbarePath = req.url.substring(0, i);\n\t}\n\n\tconst splitPath = barePath.split('/');\n\n\t// Any non-oauth request will continue down the default\n\t// middlewares.\n\tif (splitPath[1] === '_oauth_apps') {\n\t\treturn splitPath.slice(2);\n\t}\n}\n\nexport const routes = {\n\t// :path/:provider/:app/callback\n\tappCallback: (req) => {\n\t\tconst paths = getPaths(req);\n\n\t\tif (paths && paths[2] === 'callback') {\n\t\t\treturn {\n\t\t\t\tprovider: paths[0],\n\t\t\t\tapp: paths[1]\n\t\t\t};\n\t\t}\n\t},\n\t// :path/providers\n\tproviders: (req) => {\n\t\tconst paths = getPaths(req);\n\n\t\treturn paths && paths[0] === 'providers';\n\t}\n};\n","import { check } from 'meteor/check';\n\nimport { Storage } from './storage';\n\nclass Apps extends Storage {\n\tadd(name, body) {\n\t\tcheck(name, String);\n\t\tcheck(body, {\n\t\t\tredirectUrl: String,\n\t\t\terrorUrl: String\n\t\t});\n\n\t\tthis._add(name, body);\n\t}\n}\n\nclass Settings extends Storage {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.apps = new Apps;\n\t}\n\tadd(settings) {\n\t\tcheck(settings, {\n\t\t\tenabled: Match.Optional(Boolean),\n\t\t\tprovider: String,\n\t\t\tkey: String,\n\t\t\tsecret: String\n\t\t});\n\n\t\tthis._add(settings.provider, {\n\t\t\tenabled: settings.enabled === true,\n\t\t\tprovider: settings.provider,\n\t\t\tkey: settings.key,\n\t\t\tsecret: settings.secret\n\t\t});\n\t}\n}\n\nconst settings = new Settings;\n\nexport default settings;\n","export class Storage {\n\tconstructor() {\n\t\tthis._data = {};\n\t}\n\n\tall() {\n\t\treturn this._data;\n\t}\n\n\tforEach(fn) {\n\t\tObject.keys(this.all())\n\t\t\t.forEach((name) => {\n\t\t\t\tfn(this.get(name), name);\n\t\t\t});\n\t}\n\n\tget(name) {\n\t\treturn this.all()[name.toLowerCase()];\n\t}\n\n\thas(name) {\n\t\treturn !!this._data[name];\n\t}\n\n\t_add(name, body) {\n\t\tif (this.has(name)) {\n\t\t\tconsole.error(`'${ name }' have been already defined`);\n\t\t\treturn;\n\t\t}\n\n\t\tthis._data[name] = body;\n\t}\n}\n"]}