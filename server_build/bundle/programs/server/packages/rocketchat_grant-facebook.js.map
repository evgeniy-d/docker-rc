{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:grant-facebook/server/index.js"],"names":["module","export","getUser","Providers","GrantError","watch","require","v","HTTP","userAgent","version","getIdentity","accessToken","fields","get","headers","params","access_token","join","data","err","message","getPicture","redirect","height","width","type","whitelisted","identity","avatar","username","name","toLowerCase","replace","id","email","first_name","last_name","url","register","scope"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAAAA,OAAOC,MAAP,CAAc;AAACC,WAAQ,MAAIA;AAAb,CAAd;AAAqC,IAAIC,SAAJ,EAAcC,UAAd;AAAyBJ,OAAOK,KAAP,CAAaC,QAAQ,yBAAR,CAAb,EAAgD;AAACH,YAAUI,CAAV,EAAY;AAACJ,gBAAUI,CAAV;AAAY,GAA1B;;AAA2BH,aAAWG,CAAX,EAAa;AAACH,iBAAWG,CAAX;AAAa;;AAAtD,CAAhD,EAAwG,CAAxG;AAA2G,IAAIC,IAAJ;AAASR,OAAOK,KAAP,CAAaC,QAAQ,aAAR,CAAb,EAAoC;AAACE,OAAKD,CAAL,EAAO;AAACC,WAAKD,CAAL;AAAO;;AAAhB,CAApC,EAAsD,CAAtD;AAGlL,MAAME,YAAY,QAAlB;AACA,MAAMC,UAAU,OAAhB;;AAEA,SAASC,WAAT,CAAqBC,WAArB,EAAkCC,MAAlC,EAA0C;AACzC,MAAI;AACH,WAAOL,KAAKM,GAAL,CACL,8BAA8BJ,OAAS,KADlC,EACwC;AAC7CK,eAAS;AAAE,sBAAcN;AAAhB,OADoC;AAE7CO,cAAQ;AACPC,sBAAcL,WADP;AAEPC,gBAAQA,OAAOK,IAAP,CAAY,GAAZ;AAFD;AAFqC,KADxC,EAOHC,IAPJ;AAQA,GATD,CASE,OAAOC,GAAP,EAAY;AACb,UAAM,IAAIhB,UAAJ,CAAgB,2CAA2CgB,IAAIC,OAAS,EAAxE,CAAN;AACA;AACD;;AAED,SAASC,UAAT,CAAoBV,WAApB,EAAiC;AAChC,MAAI;AACH,WAAOJ,KAAKM,GAAL,CACL,8BAA8BJ,OAAS,aADlC,EACgD;AACrDK,eAAS;AAAE,sBAAcN;AAAhB,OAD4C;AAErDO,cAAQ;AACPO,kBAAU,KADH;AAEPC,gBAAQ,GAFD;AAGPC,eAAO,GAHA;AAIPC,cAAM,QAJC;AAKPT,sBAAcL;AALP;AAF6C,KADhD,EAUHO,IAVJ;AAWA,GAZD,CAYE,OAAOC,GAAP,EAAY;AACb,UAAM,IAAIhB,UAAJ,CAAgB,kDAAkDgB,IAAIC,OAAS,EAA/E,CAAN;AACA;AACD;;AAEM,SAASnB,OAAT,CAAiBU,WAAjB,EAA8B;AACpC,QAAMe,cAAc,CAAC,IAAD,EAAO,OAAP,EAAgB,MAAhB,EAAwB,YAAxB,EAAsC,WAAtC,CAApB;AACA,QAAMC,WAAWjB,YAAYC,WAAZ,EAAyBe,WAAzB,CAAjB;AACA,QAAME,SAASP,WAAWV,WAAX,CAAf;AACA,QAAMkB,WAAWF,SAASG,IAAT,CAAcC,WAAd,GAA4BC,OAA5B,CAAoC,GAApC,EAAyC,GAAzC,CAAjB;AAEA,SAAO;AACNC,QAAIN,SAASM,EADP;AAENC,WAAOP,SAASO,KAFV;AAGNL,YAHM;AAINC,UAAO,GAAGH,SAASQ,UAAY,IAAIR,SAASS,SAAW,EAJjD;AAKNR,YAAQA,OAAOV,IAAP,CAAYmB;AALd,GAAP;AAOA;;AAED;AACAnC,UAAUoC,QAAV,CAAmB,UAAnB,EAA+B;AAAEC,SAAO,CAAC,gBAAD,EAAmB,OAAnB;AAAT,CAA/B,EAAuEtC,OAAvE,E","file":"/packages/rocketchat_grant-facebook.js","sourcesContent":["import { Providers, GrantError } from 'meteor/rocketchat:grant';\nimport { HTTP } from 'meteor/http';\n\nconst userAgent = 'Meteor';\nconst version = 'v2.10';\n\nfunction getIdentity(accessToken, fields) {\n\ttry {\n\t\treturn HTTP.get(\n\t\t\t`https://graph.facebook.com/${ version }/me`, {\n\t\t\t\theaders: { 'User-Agent': userAgent },\n\t\t\t\tparams: {\n\t\t\t\t\taccess_token: accessToken,\n\t\t\t\t\tfields: fields.join(',')\n\t\t\t\t}\n\t\t\t}).data;\n\t} catch (err) {\n\t\tthrow new GrantError(`Failed to fetch identity from Facebook. ${ err.message }`);\n\t}\n}\n\nfunction getPicture(accessToken) {\n\ttry {\n\t\treturn HTTP.get(\n\t\t\t`https://graph.facebook.com/${ version }/me/picture`, {\n\t\t\t\theaders: { 'User-Agent': userAgent },\n\t\t\t\tparams: {\n\t\t\t\t\tredirect: false,\n\t\t\t\t\theight: 200,\n\t\t\t\t\twidth: 200,\n\t\t\t\t\ttype: 'normal',\n\t\t\t\t\taccess_token: accessToken\n\t\t\t\t}\n\t\t\t}).data;\n\t} catch (err) {\n\t\tthrow new GrantError(`Failed to fetch profile picture from Facebook. ${ err.message }`);\n\t}\n}\n\nexport function getUser(accessToken) {\n\tconst whitelisted = ['id', 'email', 'name', 'first_name', 'last_name'];\n\tconst identity = getIdentity(accessToken, whitelisted);\n\tconst avatar = getPicture(accessToken);\n\tconst username = identity.name.toLowerCase().replace(' ', '.');\n\n\treturn {\n\t\tid: identity.id,\n\t\temail: identity.email,\n\t\tusername,\n\t\tname: `${ identity.first_name } ${ identity.last_name }`,\n\t\tavatar: avatar.data.url\n\t};\n}\n\n// Register Facebook OAuth\nProviders.register('facebook', { scope: ['public_profile', 'email'] }, getUser);\n"]}