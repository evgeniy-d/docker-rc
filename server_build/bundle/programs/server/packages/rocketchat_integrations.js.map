{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:integrations/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/logger.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/validation.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/triggerHandler.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/Integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/IntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/addIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/updateIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/deleteIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/addOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/updateOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/replayOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/deleteOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/clearIntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/api/api.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/triggers.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/processWebhookMessage.js"],"names":["RocketChat","integrations","outgoingEvents","sendMessage","label","value","use","channel","triggerWords","targetRoom","fileUploaded","roomArchived","roomCreated","roomJoined","roomLeft","userCreated","logger","Logger","sections","incoming","outgoing","_","module","watch","require","default","v","s","scopedChannels","validChannelChars","_verifyRequiredFields","integration","event","Match","test","String","trim","Meteor","Error","function","username","urls","index","url","entries","without","undefined","length","_verifyUserHasPermissionForChannels","userId","channels","includes","authz","hasPermission","record","channelType","substr","models","Rooms","findOne","$or","_id","name","Users","hasAllPermission","Subscriptions","findOneByRoomIdAndUserId","fields","_verifyRetryInformation","retryFailedCalls","retryCount","parseInt","retryDelay","toLowerCase","validateOutgoing","_validateOutgoing","map","split","forEach","word","scriptEnabled","script","babelOptions","Object","assign","Babel","getDefaultOptions","runtime","compact","minified","comments","scriptCompiled","compile","code","scriptError","e","pick","runOnEdits","user","type","moment","vm","Fiber","Future","triggerHandler","RocketChatIntegrationHandler","constructor","successResults","compiledScripts","triggers","Integrations","find","observe","added","addIntegration","changed","removeIntegration","removed","debug","isEmpty","concat","trigger","values","isTriggerEnabled","trig","enabled","updateHistory","historyId","step","data","triggerWord","ranPrepareScript","prepareSentMessage","processSentMessage","resultMessage","finished","httpCallData","httpError","httpResult","error","errorStack","history","omit","room","JSON","stringify","IntegrationHistory","update","$set","_createdAt","Date","insert","Random","id","nameOrId","message","impersonateUser","findOneByUsername","user_name","tmpRoom","getRoomByNameOrIdWithOptionToJoin","currentUserId","errorOnEmpty","warn","t","bot","i","defaultValues","alias","avatar","emoji","processWebhookMessage","buildSandbox","store","sandbox","scriptTimeout","reject","setTimeout","console","Promise","Store","set","key","val","get","HTTP","method","options","result","call","keys","filter","k","startsWith","getIntegrationScript","compiledScript","_updatedAt","vmScript","info","createScript","runInNewContext","Script","replace","stack","hasScriptAndMethod","executeScript","params","fromPromise","timeout","wait","eventNameArgumentsToObject","argObject","arguments","arghhh","owner","mapEventArgsToData","channel_id","channel_name","message_id","timestamp","ts","user_id","u","text","msg","editedAt","isEdited","createdAt","executeTriggers","triggersToExecute","usernames","push","all_direct_messages","all_public_channels","all_private_groups","__any","triggerToExecute","executeTrigger","executeTriggerUrl","theHistoryId","tries","triggerWordAnywhere","indexOf","token","trigger_word","opts","auth","npmRequestOptions","rejectUnauthorized","settings","strictSSL","headers","request","prepareMessage","statusCode","response","status_code","content","content_raw","scriptResult","waitTime","Math","pow","er","attachments","resultMsg","replay","Messages","findOneById","_Base","findByType","disableByUserId","multi","findByIntegrationId","findByIntegrationIdAndCreatedBy","creatorId","findOneByIntegrationIdAndHistoryId","integrationId","findByEventName","findFailed","removeByIntegrationId","remove","publish","_integrationPublication","ready","_integrationHistoryPublication","limit","sort","methods","addIncomingIntegration","isString","extend","_createdBy","Roles","addUserRoles","updateIncomingIntegration","currentIntegration","_updatedBy","deleteIncomingIntegration","addOutgoingIntegration","updateOutgoingIntegration","replayOutgoingIntegration","deleteOutgoingIntegration","clearIntegrationHistory","Api","Restivus","enableCors","apiPath","payloadKeys","bodyParams","payloadIsWrapped","payload","parse","body","success","decodeURIComponent","Livechat","API","v1","failure","createIntegration","runAsUser","target_url","trigger_words","integrationToRemove","executeIntegrationRest","urlParams","setEncoding","read","hash","_parsedUrl","search","query","queryParams","pathname","path","url_raw","url_params","scriptResponse","addIntegrationRest","removeIntegrationRest","integrationSampleRest","integrationInfoRest","addRoute","authRequired","post","callbackHandler","_callbackHandler","eventType","_wrapperFunction","callbacks","add","priority","LOW","messageObj","mustBeJoined","sentData","roomId","channelValue","joinChannel","tryDirectByUserIdOnly","isArray","log","red","parseUrls","groupable","icon_url","icon_emoji","attachment","messageReturn"],"mappings":"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","file":"/packages/rocketchat_integrations.js","sourcesContent":["RocketChat.integrations = {\n\toutgoingEvents: {\n\t\tsendMessage: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_SendMessage',\n\t\t\tvalue: 'sendMessage',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: true,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tfileUploaded: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_FileUploaded',\n\t\t\tvalue: 'fileUploaded',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomArchived: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomArchived',\n\t\t\tvalue: 'roomArchived',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomCreated',\n\t\t\tvalue: 'roomCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomJoined: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomJoined',\n\t\t\tvalue: 'roomJoined',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomLeft: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomLeft',\n\t\t\tvalue: 'roomLeft',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tuserCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_UserCreated',\n\t\t\tvalue: 'userCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: true\n\t\t\t}\n\t\t}\n\t}\n};\n","/* globals logger:true */\n/* exported logger */\n\nlogger = new Logger('Integrations', {\n\tsections: {\n\t\tincoming: 'Incoming WebHook',\n\t\toutgoing: 'Outgoing WebHook'\n\t}\n});\n","/* global Babel */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nconst scopedChannels = ['all_public_channels', 'all_private_groups', 'all_direct_messages'];\nconst validChannelChars = ['@', '#'];\n\nfunction _verifyRequiredFields(integration) {\n\tif (!integration.event || !Match.test(integration.event, String) || integration.event.trim() === '' || !RocketChat.integrations.outgoingEvents[integration.event]) {\n\t\tthrow new Meteor.Error('error-invalid-event-type', 'Invalid event type', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!integration.username || !Match.test(integration.username, String) || integration.username.trim() === '') {\n\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.targetRoom && !integration.targetRoom) {\n\t\tthrow new Meteor.Error('error-invalid-targetRoom', 'Invalid Target Room', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!Match.test(integration.urls, [String])) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tfor (const [index, url] of integration.urls.entries()) {\n\t\tif (url.trim() === '') {\n\t\t\tdelete integration.urls[index];\n\t\t}\n\t}\n\n\tintegration.urls = _.without(integration.urls, [undefined]);\n\n\tif (integration.urls.length === 0) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n}\n\nfunction _verifyUserHasPermissionForChannels(integration, userId, channels) {\n\tfor (let channel of channels) {\n\t\tif (scopedChannels.includes(channel)) {\n\t\t\tif (channel === 'all_public_channels') {\n\t\t\t\t// No special permissions needed to add integration to public channels\n\t\t\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t} else {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\n\t\t\tif (!RocketChat.authz.hasAllPermission(userId, 'manage-integrations', 'manage-own-integrations') && !RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(record._id, userId, { fields: { _id: 1 } })) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction _verifyRetryInformation(integration) {\n\tif (!integration.retryFailedCalls) {\n\t\treturn;\n\t}\n\n\t// Don't allow negative retry counts\n\tintegration.retryCount = integration.retryCount && parseInt(integration.retryCount) > 0 ? parseInt(integration.retryCount) : 4;\n\tintegration.retryDelay = !integration.retryDelay || !integration.retryDelay.trim() ? 'powers-of-ten' : integration.retryDelay.toLowerCase();\n}\n\nRocketChat.integrations.validateOutgoing = function _validateOutgoing(integration, userId) {\n\tif (integration.channel && Match.test(integration.channel, String) && integration.channel.trim() === '') {\n\t\tdelete integration.channel;\n\t}\n\n\t//Moved to it's own function to statisfy the complexity rule\n\t_verifyRequiredFields(integration);\n\n\tlet channels = [];\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.channel) {\n\t\tif (!Match.test(integration.channel, String)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing' });\n\t\t} else {\n\t\t\tchannels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\t\tfor (const channel of channels) {\n\t\t\t\tif (!validChannelChars.includes(channel[0]) && !scopedChannels.includes(channel.toLowerCase())) {\n\t\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { function: 'validateOutgoing' });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\tthrow new Meteor.Error('error-invalid-permissions', 'Invalid permission for required Integration creation.', { function: 'validateOutgoing' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.triggerWords && integration.triggerWords) {\n\t\tif (!Match.test(integration.triggerWords, [String])) {\n\t\t\tthrow new Meteor.Error('error-invalid-triggerWords', 'Invalid triggerWords', { function: 'validateOutgoing' });\n\t\t}\n\n\t\tintegration.triggerWords.forEach((word, index) => {\n\t\t\tif (!word || word.trim() === '') {\n\t\t\t\tdelete integration.triggerWords[index];\n\t\t\t}\n\t\t});\n\n\t\tintegration.triggerWords = _.without(integration.triggerWords, [undefined]);\n\t} else {\n\t\tdelete integration.triggerWords;\n\t}\n\n\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\ttry {\n\t\t\tconst babelOptions = Object.assign(Babel.getDefaultOptions({ runtime: false }), { compact: true, minified: true, comments: false });\n\n\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\tintegration.scriptError = undefined;\n\t\t} catch (e) {\n\t\t\tintegration.scriptCompiled = undefined;\n\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t}\n\t}\n\n\tif (typeof integration.runOnEdits !== 'undefined') {\n\t\t// Verify this value is only true/false\n\t\tintegration.runOnEdits = integration.runOnEdits === true;\n\t}\n\n\t_verifyUserHasPermissionForChannels(integration, userId, channels);\n\t_verifyRetryInformation(integration);\n\n\tconst user = RocketChat.models.Users.findOne({ username: integration.username });\n\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user (did you delete the `rocket.cat` user?)', { function: 'validateOutgoing' });\n\t}\n\n\tintegration.type = 'webhook-outgoing';\n\tintegration.userId = user._id;\n\tintegration.channel = channels;\n\n\treturn integration;\n};\n","/* global logger, processWebhookMessage */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport moment from 'moment';\nimport vm from 'vm';\nimport Fiber from 'fibers';\nimport Future from 'fibers/future';\n\nRocketChat.integrations.triggerHandler = new class RocketChatIntegrationHandler {\n\tconstructor() {\n\t\tthis.vm = vm;\n\t\tthis.successResults = [200, 201, 202];\n\t\tthis.compiledScripts = {};\n\t\tthis.triggers = {};\n\n\t\tRocketChat.models.Integrations.find({type: 'webhook-outgoing'}).observe({\n\t\t\tadded: (record) => {\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tchanged: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tremoved: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t}\n\t\t});\n\t}\n\n\taddIntegration(record) {\n\t\tlogger.outgoing.debug(`Adding the integration ${ record.name } of the event ${ record.event }!`);\n\t\tlet channels;\n\t\tif (record.event && !RocketChat.integrations.outgoingEvents[record.event].use.channel) {\n\t\t\tlogger.outgoing.debug('The integration doesnt rely on channels.');\n\t\t\t//We don't use any channels, so it's special ;)\n\t\t\tchannels = ['__any'];\n\t\t} else if (_.isEmpty(record.channel)) {\n\t\t\tlogger.outgoing.debug('The integration had an empty channel property, so it is going on all the public channels.');\n\t\t\tchannels = ['all_public_channels'];\n\t\t} else {\n\t\t\tlogger.outgoing.debug('The integration is going on these channels:', record.channel);\n\t\t\tchannels = [].concat(record.channel);\n\t\t}\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!this.triggers[channel]) {\n\t\t\t\tthis.triggers[channel] = {};\n\t\t\t}\n\n\t\t\tthis.triggers[channel][record._id] = record;\n\t\t}\n\t}\n\n\tremoveIntegration(record) {\n\t\tfor (const trigger of Object.values(this.triggers)) {\n\t\t\tdelete trigger[record._id];\n\t\t}\n\t}\n\n\tisTriggerEnabled(trigger) {\n\t\tfor (const trig of Object.values(this.triggers)) {\n\t\t\tif (trig[trigger._id]) {\n\t\t\t\treturn trig[trigger._id].enabled;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tupdateHistory({ historyId, step, integration, event, data, triggerWord, ranPrepareScript, prepareSentMessage, processSentMessage, resultMessage, finished, url, httpCallData, httpError, httpResult, error, errorStack }) {\n\t\tconst history = {\n\t\t\ttype: 'outgoing-webhook',\n\t\t\tstep\n\t\t};\n\n\t\t// Usually is only added on initial insert\n\t\tif (integration) {\n\t\t\thistory.integration = integration;\n\t\t}\n\n\t\t// Usually is only added on initial insert\n\t\tif (event) {\n\t\t\thistory.event = event;\n\t\t}\n\n\t\tif (data) {\n\t\t\thistory.data = { ...data };\n\n\t\t\tif (data.user) {\n\t\t\t\thistory.data.user = _.omit(data.user, ['services']);\n\t\t\t}\n\n\t\t\tif (data.room) {\n\t\t\t\thistory.data.room = data.room;\n\t\t\t}\n\t\t}\n\n\t\tif (triggerWord) {\n\t\t\thistory.triggerWord = triggerWord;\n\t\t}\n\n\t\tif (typeof ranPrepareScript !== 'undefined') {\n\t\t\thistory.ranPrepareScript = ranPrepareScript;\n\t\t}\n\n\t\tif (prepareSentMessage) {\n\t\t\thistory.prepareSentMessage = prepareSentMessage;\n\t\t}\n\n\t\tif (processSentMessage) {\n\t\t\thistory.processSentMessage = processSentMessage;\n\t\t}\n\n\t\tif (resultMessage) {\n\t\t\thistory.resultMessage = resultMessage;\n\t\t}\n\n\t\tif (typeof finished !== 'undefined') {\n\t\t\thistory.finished = finished;\n\t\t}\n\n\t\tif (url) {\n\t\t\thistory.url = url;\n\t\t}\n\n\t\tif (typeof httpCallData !== 'undefined') {\n\t\t\thistory.httpCallData = httpCallData;\n\t\t}\n\n\t\tif (httpError) {\n\t\t\thistory.httpError = httpError;\n\t\t}\n\n\t\tif (typeof httpResult !== 'undefined') {\n\t\t\thistory.httpResult = JSON.stringify(httpResult, null, 2);\n\t\t}\n\n\t\tif (typeof error !== 'undefined') {\n\t\t\thistory.error = error;\n\t\t}\n\n\t\tif (typeof errorStack !== 'undefined') {\n\t\t\thistory.errorStack = errorStack;\n\t\t}\n\n\t\tif (historyId) {\n\t\t\tRocketChat.models.IntegrationHistory.update({ _id: historyId }, { $set: history });\n\t\t\treturn historyId;\n\t\t} else {\n\t\t\thistory._createdAt = new Date();\n\t\t\treturn RocketChat.models.IntegrationHistory.insert(Object.assign({ _id: Random.id() }, history));\n\t\t}\n\t}\n\n\t//Trigger is the trigger, nameOrId is a string which is used to try and find a room, room is a room, message is a message, and data contains \"user_name\" if trigger.impersonateUser is truthful.\n\tsendMessage({ trigger, nameOrId = '', room, message, data }) {\n\t\tlet user;\n\t\t//Try to find the user who we are impersonating\n\t\tif (trigger.impersonateUser) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(data.user_name);\n\t\t}\n\n\t\t//If they don't exist (aka the trigger didn't contain a user) then we set the user based upon the\n\t\t//configured username for the integration since this is required at all times.\n\t\tif (!user) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(trigger.username);\n\t\t}\n\n\t\tlet tmpRoom;\n\t\tif (nameOrId || trigger.targetRoom || message.channel) {\n\t\t\ttmpRoom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: nameOrId || message.channel || trigger.targetRoom, errorOnEmpty: false }) || room;\n\t\t} else {\n\t\t\ttmpRoom = room;\n\t\t}\n\n\t\t//If no room could be found, we won't be sending any messages but we'll warn in the logs\n\t\tif (!tmpRoom) {\n\t\t\tlogger.outgoing.warn(`The Integration \"${ trigger.name }\" doesn't have a room configured nor did it provide a room to send the message to.`);\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found a room for ${ trigger.name } which is: ${ tmpRoom.name } with a type of ${ tmpRoom.t }`);\n\n\t\tmessage.bot = { i: trigger._id };\n\n\t\tconst defaultValues = {\n\t\t\talias: trigger.alias,\n\t\t\tavatar: trigger.avatar,\n\t\t\temoji: trigger.emoji\n\t\t};\n\n\t\tif (tmpRoom.t === 'd') {\n\t\t\tmessage.channel = `@${ tmpRoom._id }`;\n\t\t} else {\n\t\t\tmessage.channel = `#${ tmpRoom._id }`;\n\t\t}\n\n\t\tmessage = processWebhookMessage(message, user, defaultValues);\n\t\treturn message;\n\t}\n\n\tbuildSandbox(store = {}) {\n\t\tconst sandbox = {\n\t\t\tscriptTimeout(reject) {\n\t\t\t\treturn setTimeout(() => reject('timed out'), 3000);\n\t\t\t},\n\t\t\t_,\n\t\t\ts,\n\t\t\tconsole,\n\t\t\tmoment,\n\t\t\tFiber,\n\t\t\tPromise,\n\t\t\tStore: {\n\t\t\t\tset: (key, val) => store[key] = val,\n\t\t\t\tget: (key) => store[key]\n\t\t\t},\n\t\t\tHTTP: (method, url, options) => {\n\t\t\t\ttry {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t\t};\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn { error };\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tObject.keys(RocketChat.models).filter(k => !k.startsWith('_')).forEach(k => {\n\t\t\tsandbox[k] = RocketChat.models[k];\n\t\t});\n\n\t\treturn { store, sandbox };\n\t}\n\n\tgetIntegrationScript(integration) {\n\t\tconst compiledScript = this.compiledScripts[integration._id];\n\t\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\t\treturn compiledScript.script;\n\t\t}\n\n\t\tconst script = integration.scriptCompiled;\n\t\tconst { store, sandbox } = this.buildSandbox();\n\n\t\tlet vmScript;\n\t\ttry {\n\t\t\tlogger.outgoing.info('Will evaluate script of Trigger', integration.name);\n\t\t\tlogger.outgoing.debug(script);\n\n\t\t\tvmScript = this.vm.createScript(script, 'script.js');\n\n\t\t\tvmScript.runInNewContext(sandbox);\n\n\t\t\tif (sandbox.Script) {\n\t\t\t\tthis.compiledScripts[integration._id] = {\n\t\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\t\tstore,\n\t\t\t\t\t_updatedAt: integration._updatedAt\n\t\t\t\t};\n\n\t\t\t\treturn this.compiledScripts[integration._id].script;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlogger.outgoing.error(`Error evaluating Script in Trigger ${ integration.name }:`);\n\t\t\tlogger.outgoing.error(script.replace(/^/gm, '  '));\n\t\t\tlogger.outgoing.error('Stack Trace:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\tthrow new Meteor.Error('error-evaluating-script');\n\t\t}\n\n\t\tif (!sandbox.Script) {\n\t\t\tlogger.outgoing.error(`Class \"Script\" not in Trigger ${ integration.name }:`);\n\t\t\tthrow new Meteor.Error('class-script-not-found');\n\t\t}\n\t}\n\n\thasScriptAndMethod(integration, method) {\n\t\tif (integration.scriptEnabled !== true || !integration.scriptCompiled || integration.scriptCompiled.trim() === '') {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn typeof script[method] !== 'undefined';\n\t}\n\n\texecuteScript(integration, method, params, historyId) {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: 'execute-script-getting-script', error: true, errorStack: e });\n\t\t\treturn;\n\t\t}\n\n\t\tif (!script[method]) {\n\t\t\tlogger.outgoing.error(`Method \"${ method }\" no found in the Integration \"${ integration.name }\"`);\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-no-method-${ method }` });\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst { sandbox } = this.buildSandbox(this.compiledScripts[integration._id].store);\n\t\t\tsandbox.script = script;\n\t\t\tsandbox.method = method;\n\t\t\tsandbox.params = params;\n\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-before-running-${ method }` });\n\n\t\t\tconst result = Future.fromPromise(this.vm.runInNewContext(`\n\t\t\t\tnew Promise((resolve, reject) => {\n\t\t\t\t\tFiber(() => {\n\t\t\t\t\t\tscriptTimeout(reject);\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tresolve(script[method](params))\n\t\t\t\t\t\t} catch(e) {\n\t\t\t\t\t\t\treject(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}).run();\n\t\t\t\t}).catch((error) => { throw new Error(error); });\n\t\t\t`, sandbox, {\n\t\t\t\ttimeout: 3000\n\t\t\t})).wait();\n\n\t\t\tlogger.outgoing.debug(`Script method \"${ method }\" result of the Integration \"${ integration.name }\" is:`);\n\t\t\tlogger.outgoing.debug(result);\n\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-error-running-${ method }`, error: true, errorStack: e.stack.replace(/^/gm, '  ') });\n\t\t\tlogger.outgoing.error(`Error running Script in the Integration ${ integration.name }:`);\n\t\t\tlogger.outgoing.debug(integration.scriptCompiled.replace(/^/gm, '  ')); // Only output the compiled script if debugging is enabled, so the logs don't get spammed.\n\t\t\tlogger.outgoing.error('Stack:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\treturn;\n\t\t}\n\t}\n\n\teventNameArgumentsToObject() {\n\t\tconst argObject = {\n\t\t\tevent: arguments[0]\n\t\t};\n\n\t\tswitch (argObject.event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.message = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\tconst arghhh = arguments[1];\n\t\t\t\t\targObject.user = arghhh.user;\n\t\t\t\t\targObject.room = arghhh.room;\n\t\t\t\t\targObject.message = arghhh.message;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.room = arguments[1];\n\t\t\t\t\targObject.user = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.owner = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tlogger.outgoing.warn(`An Unhandled Trigger Event was called: ${ argObject.event }`);\n\t\t\t\targObject.event = undefined;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Got the event arguments for the event: ${ argObject.event }`, argObject);\n\n\t\treturn argObject;\n\t}\n\n\tmapEventArgsToData(data, { event, message, room, owner, user }) {\n\t\tswitch (event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\n\t\t\t\tif (message.editedAt) {\n\t\t\t\t\tdata.isEdited = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\t\t\t\tdata.message = message;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.timestamp = room.ts;\n\t\t\t\tdata.user_id = owner._id;\n\t\t\t\tdata.user_name = owner.username;\n\t\t\t\tdata.owner = owner;\n\t\t\t\tdata.room = room;\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tdata.timestamp = new Date();\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tdata.timestamp = user.createdAt;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\texecuteTriggers() {\n\t\tlogger.outgoing.debug('Execute Trigger:', arguments[0]);\n\n\t\tconst argObject = this.eventNameArgumentsToObject(...arguments);\n\t\tconst { event, message, room } = argObject;\n\n\t\t//Each type of event should have an event and a room attached, otherwise we\n\t\t//wouldn't know how to handle the trigger nor would we have anywhere to send the\n\t\t//result of the integration\n\t\tif (!event) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst triggersToExecute = [];\n\n\t\tlogger.outgoing.debug('Starting search for triggers for the room:', room ? room._id : '__any');\n\t\tif (room) {\n\t\t\tswitch (room.t) {\n\t\t\t\tcase 'd':\n\t\t\t\t\tconst id = room._id.replace(message.u._id, '');\n\t\t\t\t\tconst username = _.without(room.usernames, message.u.username)[0];\n\n\t\t\t\t\tif (this.triggers[`@${ id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`@${ id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers.all_direct_messages) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_direct_messages)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (id !== username && this.triggers[`@${ username }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`@${ username }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'c':\n\t\t\t\t\tif (this.triggers.all_public_channels) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_public_channels)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers[`#${ room._id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room._id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers[`#${ room.name }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room.name }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tif (this.triggers.all_private_groups) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_private_groups)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers[`#${ room._id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room._id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers[`#${ room.name }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room.name }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (this.triggers.__any) {\n\t\t\t//For outgoing integration which don't rely on rooms.\n\t\t\tfor (const trigger of Object.values(this.triggers.__any)) {\n\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t}\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found ${ triggersToExecute.length } to iterate over and see if the match the event.`);\n\n\t\tfor (const triggerToExecute of triggersToExecute) {\n\t\t\tlogger.outgoing.debug(`Is \"${ triggerToExecute.name }\" enabled, ${ triggerToExecute.enabled }, and what is the event? ${ triggerToExecute.event }`);\n\t\t\tif (triggerToExecute.enabled === true && triggerToExecute.event === event) {\n\t\t\t\tthis.executeTrigger(triggerToExecute, argObject);\n\t\t\t}\n\t\t}\n\t}\n\n\texecuteTrigger(trigger, argObject) {\n\t\tfor (const url of trigger.urls) {\n\t\t\tthis.executeTriggerUrl(url, trigger, argObject, 0);\n\t\t}\n\t}\n\n\texecuteTriggerUrl(url, trigger, { event, message, room, owner, user }, theHistoryId, tries = 0) {\n\t\tif (!this.isTriggerEnabled(trigger)) {\n\t\t\tlogger.outgoing.warn(`The trigger \"${ trigger.name }\" is no longer enabled, stopping execution of it at try: ${ tries }`);\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Starting to execute trigger: ${ trigger.name } (${ trigger._id })`);\n\n\t\tlet word;\n\t\t//Not all triggers/events support triggerWords\n\t\tif (RocketChat.integrations.outgoingEvents[event].use.triggerWords) {\n\t\t\tif (trigger.triggerWords && trigger.triggerWords.length > 0) {\n\t\t\t\tfor (const triggerWord of trigger.triggerWords) {\n\t\t\t\t\tif (!trigger.triggerWordAnywhere && message.msg.indexOf(triggerWord) === 0) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t} else if (trigger.triggerWordAnywhere && message.msg.includes(triggerWord)) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Stop if there are triggerWords but none match\n\t\t\t\tif (!word) {\n\t\t\t\t\tlogger.outgoing.debug(`The trigger word which \"${ trigger.name }\" was expecting could not be found, not executing.`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (message && message.editedAt && !trigger.runOnEdits) {\n\t\t\tlogger.outgoing.debug(`The trigger \"${ trigger.name }\"'s run on edits is disabled and the message was edited.`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst historyId = this.updateHistory({ step: 'start-execute-trigger-url', integration: trigger, event });\n\n\t\tconst data = {\n\t\t\ttoken: trigger.token,\n\t\t\tbot: false\n\t\t};\n\n\t\tif (word) {\n\t\t\tdata.trigger_word = word;\n\t\t}\n\n\t\tthis.mapEventArgsToData(data, { trigger, event, message, room, owner, user });\n\t\tthis.updateHistory({ historyId, step: 'mapped-args-to-data', data, triggerWord: word });\n\n\t\tlogger.outgoing.info(`Will be executing the Integration \"${ trigger.name }\" to the url: ${ url }`);\n\t\tlogger.outgoing.debug(data);\n\n\t\tlet opts = {\n\t\t\tparams: {},\n\t\t\tmethod: 'POST',\n\t\t\turl,\n\t\t\tdata,\n\t\t\tauth: undefined,\n\t\t\tnpmRequestOptions: {\n\t\t\t\trejectUnauthorized: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs'),\n\t\t\t\tstrictSSL: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs')\n\t\t\t},\n\t\t\theaders: {\n\t\t\t\t'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36'\n\t\t\t}\n\t\t};\n\n\t\tif (this.hasScriptAndMethod(trigger, 'prepare_outgoing_request')) {\n\t\t\topts = this.executeScript(trigger, 'prepare_outgoing_request', { request: opts }, historyId);\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'after-maybe-ran-prepare', ranPrepareScript: true });\n\n\t\tif (!opts) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-opts', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tif (opts.message) {\n\t\t\tconst prepareMessage = this.sendMessage({ trigger, room, message: opts.message, data });\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-send-message', prepareSentMessage: prepareMessage });\n\t\t}\n\n\t\tif (!opts.url || !opts.method) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-url_or_method', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'pre-http-call', url: opts.url, httpCallData: opts.data });\n\t\tHTTP.call(opts.method, opts.url, opts, (error, result) => {\n\t\t\tif (!result) {\n\t\t\t\tlogger.outgoing.warn(`Result for the Integration ${ trigger.name } to ${ url } is empty`);\n\t\t\t} else {\n\t\t\t\tlogger.outgoing.info(`Status code for the Integration ${ trigger.name } to ${ url } is ${ result.statusCode }`);\n\t\t\t}\n\n\t\t\tthis.updateHistory({ historyId, step: 'after-http-call', httpError: error, httpResult: result });\n\n\t\t\tif (this.hasScriptAndMethod(trigger, 'process_outgoing_response')) {\n\t\t\t\tconst sandbox = {\n\t\t\t\t\trequest: opts,\n\t\t\t\t\tresponse: {\n\t\t\t\t\t\terror,\n\t\t\t\t\t\tstatus_code: result ? result.statusCode : undefined, //These values will be undefined to close issues #4175, #5762, and #5896\n\t\t\t\t\t\tcontent: result ? result.data : undefined,\n\t\t\t\t\t\tcontent_raw: result ? result.content : undefined,\n\t\t\t\t\t\theaders: result ? result.headers : {}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tconst scriptResult = this.executeScript(trigger, 'process_outgoing_response', sandbox, historyId);\n\n\t\t\t\tif (scriptResult && scriptResult.content) {\n\t\t\t\t\tconst resultMessage = this.sendMessage({ trigger, room, message: scriptResult.content, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-send-message', processSentMessage: resultMessage, finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (scriptResult === false) {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-false-result', finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// if the result contained nothing or wasn't a successful statusCode\n\t\t\tif (!result || !this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (error) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${ trigger.name }\" to ${ url } is:`);\n\t\t\t\t\tlogger.outgoing.error(error);\n\t\t\t\t}\n\n\t\t\t\tif (result) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${ trigger.name }\" to ${ url } is:`);\n\t\t\t\t\tlogger.outgoing.error(result);\n\n\t\t\t\t\tif (result.statusCode === 410) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-410', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Disabling the Integration \"${ trigger.name }\" because the status code was 401 (Gone).`);\n\t\t\t\t\t\tRocketChat.models.Integrations.update({ _id: trigger._id }, { $set: { enabled: false }});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (result.statusCode === 500) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-500', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Error \"500\" for the Integration \"${ trigger.name }\" to ${ url }.`);\n\t\t\t\t\t\tlogger.outgoing.error(result.content);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (trigger.retryFailedCalls) {\n\t\t\t\t\tif (tries < trigger.retryCount && trigger.retryDelay) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, error: true, step: `going-to-retry-${ tries + 1 }` });\n\n\t\t\t\t\t\tlet waitTime;\n\n\t\t\t\t\t\tswitch (trigger.retryDelay) {\n\t\t\t\t\t\t\tcase 'powers-of-ten':\n\t\t\t\t\t\t\t\t// Try again in 0.1s, 1s, 10s, 1m40s, 16m40s, 2h46m40s, 27h46m40s, etc\n\t\t\t\t\t\t\t\twaitTime = Math.pow(10, tries + 2);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'powers-of-two':\n\t\t\t\t\t\t\t\t// 2 seconds, 4 seconds, 8 seconds\n\t\t\t\t\t\t\t\twaitTime = Math.pow(2, tries + 1) * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'increments-of-two':\n\t\t\t\t\t\t\t\t// 2 second, 4 seconds, 6 seconds, etc\n\t\t\t\t\t\t\t\twaitTime = (tries + 1) * 2 * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tconst er = new Error('The integration\\'s retryDelay setting is invalid.');\n\t\t\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-retry-delay-is-invalid', error: true, errorStack: er.stack });\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlogger.outgoing.info(`Trying the Integration ${ trigger.name } to ${ url } again in ${ waitTime } milliseconds.`);\n\t\t\t\t\t\tMeteor.setTimeout(() => {\n\t\t\t\t\t\t\tthis.executeTriggerUrl(url, trigger, { event, message, room, owner, user }, historyId, tries + 1);\n\t\t\t\t\t\t}, waitTime);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'too-many-retries', error: true });\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-not-configured-to-retry', error: true });\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//process outgoing webhook response as a new message\n\t\t\tif (result && this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (result && result.data && (result.data.text || result.data.attachments)) {\n\t\t\t\t\tconst resultMsg = this.sendMessage({ trigger, room, message: result.data, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'url-response-sent-message', resultMessage: resultMsg, finished: true });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\treplay(integration, history) {\n\t\tif (!integration || integration.type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('integration-type-must-be-outgoing', 'The integration type to replay must be an outgoing webhook.');\n\t\t}\n\n\t\tif (!history || !history.data) {\n\t\t\tthrow new Meteor.Error('history-data-must-be-defined', 'The history data must be defined to replay an integration.');\n\t\t}\n\n\t\tconst event = history.event;\n\t\tconst message = RocketChat.models.Messages.findOneById(history.data.message_id);\n\t\tconst room = RocketChat.models.Rooms.findOneById(history.data.channel_id);\n\t\tconst user = RocketChat.models.Users.findOneById(history.data.user_id);\n\t\tlet owner;\n\n\t\tif (history.data.owner && history.data.owner._id) {\n\t\t\towner = RocketChat.models.Users.findOneById(history.data.owner._id);\n\t\t}\n\n\t\tthis.executeTriggerUrl(history.url, integration, { event, message, room, owner, user });\n\t}\n};\n","RocketChat.models.Integrations = new class Integrations extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integrations');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'webhook-incoming' && type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('invalid-type-to-find');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tdisableByUserId(userId) {\n\t\treturn this.update({ userId }, { $set: { enabled: false }}, { multi: true });\n\t}\n};\n","RocketChat.models.IntegrationHistory = new class IntegrationHistory extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integration_history');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'outgoing-webhook' || type !== 'incoming-webhook') {\n\t\t\tthrow new Meteor.Error('invalid-integration-type');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tfindByIntegrationId(id, options) {\n\t\treturn this.find({ 'integration._id': id }, options);\n\t}\n\n\tfindByIntegrationIdAndCreatedBy(id, creatorId, options) {\n\t\treturn this.find({ 'integration._id': id, 'integration._createdBy._id': creatorId }, options);\n\t}\n\n\tfindOneByIntegrationIdAndHistoryId(integrationId, historyId) {\n\t\treturn this.findOne({ 'integration._id': integrationId, _id: historyId });\n\t}\n\n\tfindByEventName(event, options) {\n\t\treturn this.find({ event }, options);\n\t}\n\n\tfindFailed(options) {\n\t\treturn this.find({ error: true }, options);\n\t}\n\n\tremoveByIntegrationId(integrationId) {\n\t\treturn this.remove({ 'integration._id': integrationId });\n\t}\n};\n","Meteor.publish('integrations', function _integrationPublication() {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.Integrations.find();\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.Integrations.find({ '_createdBy._id': this.userId });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","Meteor.publish('integrationHistory', function _integrationHistoryPublication(integrationId, limit = 25) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationId(integrationId, { sort: { _updatedAt: -1 }, limit });\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationIdAndCreatedBy(integrationId, this.userId, { sort: { _updatedAt: -1 }, limit });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","/* global Babel */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\taddIncomingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (!_.isString(integration.channel)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tif (!_.isString(integration.username) || integration.username.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'addIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (!RocketChat.authz.hasAllPermission(this.userId, 'manage-integrations', 'manage-own-integrations') && !RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(record._id, this.userId, { fields: { _id: 1 } })) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'addIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({username: integration.username});\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst token = Random.id(48);\n\n\t\tintegration.type = 'webhook-incoming';\n\t\tintegration.token = token;\n\t\tintegration.channel = channels;\n\t\tintegration.userId = user._id;\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","/* global Babel */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\tupdateIncomingIntegration(integrationId, integration) {\n\t\tif (!_.isString(integration.channel) || integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\t\t\tlet record;\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (!RocketChat.authz.hasAllPermission(this.userId, 'manage-integrations', 'manage-own-integrations') && !RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(record._id, this.userId, { fields: { _id: 1 } })) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({ username: currentIntegration.username });\n\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-post-as-user', 'Invalid Post As User', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: channels,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\tdeleteIncomingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields : { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\taddOutgoingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","Meteor.methods({\n\tupdateOutgoingIntegration(integrationId, integration) {\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tif (!integration.token || integration.token.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-token', 'Invalid token', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('invalid_integration', '[methods] updateOutgoingIntegration -> integration not found');\n\t\t}\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tevent: integration.event,\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: integration.channel,\n\t\t\t\ttargetRoom: integration.targetRoom,\n\t\t\t\timpersonateUser: integration.impersonateUser,\n\t\t\t\tusername: integration.username,\n\t\t\t\tuserId: integration.userId,\n\t\t\t\turls: integration.urls,\n\t\t\t\ttoken: integration.token,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\ttriggerWords: integration.triggerWords,\n\t\t\t\tretryFailedCalls: integration.retryFailedCalls,\n\t\t\t\tretryCount: integration.retryCount,\n\t\t\t\tretryDelay: integration.retryDelay,\n\t\t\t\ttriggerWordAnywhere: integration.triggerWordAnywhere,\n\t\t\t\trunOnEdits: integration.runOnEdits,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\treplayOutgoingIntegration({ integrationId, historyId }) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tconst history = RocketChat.models.IntegrationHistory.findOneByIntegrationIdAndHistoryId(integration._id, historyId);\n\n\t\tif (!history) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration-history', 'Invalid Integration History', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.integrations.triggerHandler.replay(integration, history);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tdeleteOutgoingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tclearIntegrationHistory(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","/* globals Meteor Restivus logger processWebhookMessage*/\n// TODO: remove globals\n\nimport Fiber from 'fibers';\nimport Future from 'fibers/future';\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport vm from 'vm';\nimport moment from 'moment';\n\nconst Api = new Restivus({\n\tenableCors: true,\n\tapiPath: 'hooks/',\n\tauth: {\n\t\tuser() {\n\t\t\tconst payloadKeys = Object.keys(this.bodyParams);\n\t\t\tconst payloadIsWrapped = (this.bodyParams && this.bodyParams.payload) && payloadKeys.length === 1;\n\t\t\tif (payloadIsWrapped && this.request.headers['content-type'] === 'application/x-www-form-urlencoded') {\n\t\t\t\ttry {\n\t\t\t\t\tthis.bodyParams = JSON.parse(this.bodyParams.payload);\n\t\t\t\t} catch ({message}) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tstatusCode: 400,\n\t\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\terror: message\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.integration = RocketChat.models.Integrations.findOne({\n\t\t\t\t_id: this.request.params.integrationId,\n\t\t\t\ttoken: decodeURIComponent(this.request.params.token)\n\t\t\t});\n\n\t\t\tif (!this.integration) {\n\t\t\t\tlogger.incoming.info('Invalid integration id', this.request.params.integrationId, 'or token', this.request.params.token);\n\n\t\t\t\treturn {\n\t\t\t\t\terror: {\n\t\t\t\t\t\tstatusCode: 404,\n\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: 'Invalid integration id or token provided.'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst user = RocketChat.models.Users.findOne({\n\t\t\t\t_id: this.integration.userId\n\t\t\t});\n\n\t\t\treturn { user };\n\t\t}\n\t}\n});\n\nconst compiledScripts = {};\nfunction buildSandbox(store = {}) {\n\tconst sandbox = {\n\t\tscriptTimeout(reject) {\n\t\t\treturn setTimeout(() => reject('timed out'), 3000);\n\t\t},\n\t\t_,\n\t\ts,\n\t\tconsole,\n\t\tmoment,\n\t\tFiber,\n\t\tPromise,\n\t\tLivechat: RocketChat.Livechat,\n\t\tStore: {\n\t\t\tset(key, val) {\n\t\t\t\treturn store[key] = val;\n\t\t\t},\n\t\t\tget(key) {\n\t\t\t\treturn store[key];\n\t\t\t}\n\t\t},\n\t\tHTTP(method, url, options) {\n\t\t\ttry {\n\t\t\t\treturn {\n\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t};\n\t\t\t} catch (error) {\n\t\t\t\treturn {\n\t\t\t\t\terror\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t};\n\n\tObject.keys(RocketChat.models).filter((k) => !k.startsWith('_')).forEach((k) => sandbox[k] = RocketChat.models[k]);\n\treturn { store, sandbox\t};\n}\n\nfunction getIntegrationScript(integration) {\n\tconst compiledScript = compiledScripts[integration._id];\n\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\treturn compiledScript.script;\n\t}\n\n\tconst script = integration.scriptCompiled;\n\tconst { sandbox, store } = buildSandbox();\n\ttry {\n\t\tlogger.incoming.info('Will evaluate script of Trigger', integration.name);\n\t\tlogger.incoming.debug(script);\n\n\t\tconst vmScript = vm.createScript(script, 'script.js');\n\t\tvmScript.runInNewContext(sandbox);\n\t\tif (sandbox.Script) {\n\t\t\tcompiledScripts[integration._id] = {\n\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\tstore,\n\t\t\t\t_updatedAt: integration._updatedAt\n\t\t\t};\n\n\t\t\treturn compiledScripts[integration._id].script;\n\t\t}\n\t} catch ({ stack }) {\n\t\tlogger.incoming.error('[Error evaluating Script in Trigger', integration.name, ':]');\n\t\tlogger.incoming.error(script.replace(/^/gm, '  '));\n\t\tlogger.incoming.error('[Stack:]');\n\t\tlogger.incoming.error(stack.replace(/^/gm, '  '));\n\t\tthrow RocketChat.API.v1.failure('error-evaluating-script');\n\t}\n\n\tif (!sandbox.Script) {\n\t\tlogger.incoming.error('[Class \"Script\" not in Trigger', integration.name, ']');\n\t\tthrow RocketChat.API.v1.failure('class-script-not-found');\n\t}\n}\n\nfunction createIntegration(options, user) {\n\tlogger.incoming.info('Add integration', options.name);\n\tlogger.incoming.debug(options);\n\n\tMeteor.runAsUser(user._id, function() {\n\t\tswitch (options['event']) {\n\t\t\tcase 'newMessageOnChannel':\n\t\t\t\tif (options.data == null) {\n\t\t\t\t\toptions.data = {};\n\t\t\t\t}\n\t\t\t\tif ((options.data.channel_name != null) && options.data.channel_name.indexOf('#') === -1) {\n\t\t\t\t\toptions.data.channel_name = `#${ options.data.channel_name }`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.channel_name,\n\t\t\t\t\ttriggerWords: options.data.trigger_words\n\t\t\t\t});\n\t\t\tcase 'newMessageToUser':\n\t\t\t\tif (options.data.username.indexOf('@') === -1) {\n\t\t\t\t\toptions.data.username = `@${ options.data.username }`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.username,\n\t\t\t\t\ttriggerWords: options.data.trigger_words\n\t\t\t\t});\n\t\t}\n\t});\n\n\treturn RocketChat.API.v1.success();\n}\n\nfunction removeIntegration(options, user) {\n\tlogger.incoming.info('Remove integration');\n\tlogger.incoming.debug(options);\n\n\tconst integrationToRemove = RocketChat.models.Integrations.findOne({\n\t\turls: options.target_url\n\t});\n\n\tMeteor.runAsUser(user._id, () => {\n\t\treturn Meteor.call('deleteOutgoingIntegration', integrationToRemove._id);\n\t});\n\n\treturn RocketChat.API.v1.success();\n}\n\nfunction executeIntegrationRest() {\n\tlogger.incoming.info('Post integration:', this.integration.name);\n\tlogger.incoming.debug('@urlParams:', this.urlParams);\n\tlogger.incoming.debug('@bodyParams:', this.bodyParams);\n\n\tif (this.integration.enabled !== true) {\n\t\treturn {\n\t\t\tstatusCode: 503,\n\t\t\tbody: 'Service Unavailable'\n\t\t};\n\t}\n\n\tconst defaultValues = {\n\t\tchannel: this.integration.channel,\n\t\talias: this.integration.alias,\n\t\tavatar: this.integration.avatar,\n\t\temoji: this.integration.emoji\n\t};\n\n\tif (this.integration.scriptEnabled && this.integration.scriptCompiled && this.integration.scriptCompiled.trim() !== '') {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = getIntegrationScript(this.integration);\n\t\t} catch (e) {\n\t\t\tlogger.incoming.warn(e);\n\t\t\treturn RocketChat.API.v1.failure(e.message);\n\t\t}\n\n\t\tthis.request.setEncoding('utf8');\n\t\tconst content_raw = this.request.read();\n\n\t\tconst request = {\n\t\t\turl: {\n\t\t\t\thash: this.request._parsedUrl.hash,\n\t\t\t\tsearch: this.request._parsedUrl.search,\n\t\t\t\tquery: this.queryParams,\n\t\t\t\tpathname: this.request._parsedUrl.pathname,\n\t\t\t\tpath: this.request._parsedUrl.path\n\t\t\t},\n\t\t\turl_raw: this.request.url,\n\t\t\turl_params: this.urlParams,\n\t\t\tcontent: this.bodyParams,\n\t\t\tcontent_raw,\n\t\t\theaders: this.request.headers,\n\t\t\tbody: this.request.body,\n\t\t\tuser: {\n\t\t\t\t_id: this.user._id,\n\t\t\t\tname: this.user.name,\n\t\t\t\tusername: this.user.username\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tconst { sandbox } = buildSandbox(compiledScripts[this.integration._id].store);\n\t\t\tsandbox.script = script;\n\t\t\tsandbox.request = request;\n\n\t\t\tconst result = Future.fromPromise(vm.runInNewContext(`\n\t\t\t\tnew Promise((resolve, reject) => {\n\t\t\t\t\tFiber(() => {\n\t\t\t\t\t\tscriptTimeout(reject);\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tresolve(script.process_incoming_request({ request: request }));\n\t\t\t\t\t\t} catch(e) {\n\t\t\t\t\t\t\treject(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}).run();\n\t\t\t\t}).catch((error) => { throw new Error(error); });\n\t\t\t`, sandbox, {\n\t\t\t\ttimeout: 3000\n\t\t\t})).wait();\n\n\t\t\tif (!result) {\n\t\t\t\tlogger.incoming.debug('[Process Incoming Request result of Trigger', this.integration.name, ':] No data');\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t} else if (result && result.error) {\n\t\t\t\treturn RocketChat.API.v1.failure(result.error);\n\t\t\t}\n\n\t\t\tthis.bodyParams = result && result.content;\n\t\t\tthis.scriptResponse = result.response;\n\t\t\tif (result.user) {\n\t\t\t\tthis.user = result.user;\n\t\t\t}\n\n\t\t\tlogger.incoming.debug('[Process Incoming Request result of Trigger', this.integration.name, ':]');\n\t\t\tlogger.incoming.debug('result', this.bodyParams);\n\t\t} catch ({stack}) {\n\t\t\tlogger.incoming.error('[Error running Script in Trigger', this.integration.name, ':]');\n\t\t\tlogger.incoming.error(this.integration.scriptCompiled.replace(/^/gm, '  '));\n\t\t\tlogger.incoming.error('[Stack:]');\n\t\t\tlogger.incoming.error(stack.replace(/^/gm, '  '));\n\t\t\treturn RocketChat.API.v1.failure('error-running-script');\n\t\t}\n\t}\n\n\t// TODO: Turn this into an option on the integrations - no body means a success\n\t// TODO: Temporary fix for https://github.com/RocketChat/Rocket.Chat/issues/7770 until the above is implemented\n\tif (!this.bodyParams || (_.isEmpty(this.bodyParams) && !this.integration.scriptEnabled)) {\n\t\t// return RocketChat.API.v1.failure('body-empty');\n\t\treturn RocketChat.API.v1.success();\n\t}\n\n\tthis.bodyParams.bot = { i: this.integration._id };\n\n\ttry {\n\t\tconst message = processWebhookMessage(this.bodyParams, this.user, defaultValues);\n\t\tif (_.isEmpty(message)) {\n\t\t\treturn RocketChat.API.v1.failure('unknown-error');\n\t\t}\n\n\t\tif (this.scriptResponse) {\n\t\t\tlogger.incoming.debug('response', this.scriptResponse);\n\t\t}\n\n\t\treturn RocketChat.API.v1.success(this.scriptResponse);\n\t} catch ({ error, message }) {\n\t\treturn RocketChat.API.v1.failure(error || message);\n\t}\n}\n\nfunction addIntegrationRest() {\n\treturn createIntegration(this.bodyParams, this.user);\n}\n\nfunction removeIntegrationRest() {\n\treturn removeIntegration(this.bodyParams, this.user);\n}\n\nfunction integrationSampleRest() {\n\tlogger.incoming.info('Sample Integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: [\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 1',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}, {\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 2',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}, {\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 3',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}\n\t\t]\n\t};\n}\n\nfunction integrationInfoRest() {\n\tlogger.incoming.info('Info integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: {\n\t\t\tsuccess: true\n\t\t}\n\t};\n}\n\nApi.addRoute(':integrationId/:userId/:token', { authRequired: true }, {\n\tpost: executeIntegrationRest,\n\tget: executeIntegrationRest\n});\n\nApi.addRoute(':integrationId/:token', { authRequired: true }, {\n\tpost: executeIntegrationRest,\n\tget: executeIntegrationRest\n});\n\nApi.addRoute('sample/:integrationId/:userId/:token', { authRequired: true }, {\n\tget: integrationSampleRest\n});\n\nApi.addRoute('sample/:integrationId/:token', { authRequired: true }, {\n\tget: integrationSampleRest\n});\n\nApi.addRoute('info/:integrationId/:userId/:token', { authRequired: true }, {\n\tget: integrationInfoRest\n});\n\nApi.addRoute('info/:integrationId/:token', { authRequired: true }, {\n\tget: integrationInfoRest\n});\n\nApi.addRoute('add/:integrationId/:userId/:token', { authRequired: true }, {\n\tpost: addIntegrationRest\n});\n\nApi.addRoute('add/:integrationId/:token', { authRequired: true }, {\n\tpost: addIntegrationRest\n});\n\nApi.addRoute('remove/:integrationId/:userId/:token', { authRequired: true }, {\n\tpost: removeIntegrationRest\n});\n\nApi.addRoute('remove/:integrationId/:token', { authRequired: true }, {\n\tpost: removeIntegrationRest\n});\n","const callbackHandler = function _callbackHandler(eventType) {\n\treturn function _wrapperFunction() {\n\t\treturn RocketChat.integrations.triggerHandler.executeTriggers(eventType, ...arguments);\n\t};\n};\n\nRocketChat.callbacks.add('afterSaveMessage', callbackHandler('sendMessage'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateChannel', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreatePrivateGroup', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateUser', callbackHandler('userCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterJoinRoom', callbackHandler('roomJoined'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterLeaveRoom', callbackHandler('roomLeft'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterRoomArchived', callbackHandler('roomArchived'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterFileUpload', callbackHandler('fileUploaded'), RocketChat.callbacks.priority.LOW);\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nthis.processWebhookMessage = function(messageObj, user, defaultValues = { channel: '', alias: '', avatar: '', emoji: '' }, mustBeJoined = false) {\n\tconst sentData = [];\n\tconst channels = [].concat(messageObj.channel || messageObj.roomId || defaultValues.channel);\n\n\tfor (const channel of channels) {\n\t\tconst channelType = channel[0];\n\n\t\tlet channelValue = channel.substr(1);\n\t\tlet room;\n\n\t\tswitch (channelType) {\n\t\t\tcase '#':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true });\n\t\t\t\tbreak;\n\t\t\tcase '@':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd' });\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tchannelValue = channelType + channelValue;\n\n\t\t\t\t//Try to find the room by id or name if they didn't include the prefix.\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true, errorOnEmpty: false });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//We didn't get a room, let's try finding direct messages\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd', tryDirectByUserIdOnly: true });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//No room, so throw an error\n\t\t\t\tthrow new Meteor.Error('invalid-channel');\n\t\t}\n\n\t\tif (mustBeJoined && !RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, user._id, { fields: { _id: 1 } })) {\n\t\t\t// throw new Meteor.Error('invalid-room', 'Invalid room provided to send a message to, must be joined.');\n\t\t\tthrow new Meteor.Error('invalid-channel'); // Throwing the generic one so people can't \"brute force\" find rooms\n\t\t}\n\n\t\tif (messageObj.attachments && !_.isArray(messageObj.attachments)) {\n\t\t\tconsole.log('Attachments should be Array, ignoring value'.red, messageObj.attachments);\n\t\t\tmessageObj.attachments = undefined;\n\t\t}\n\n\t\tconst message = {\n\t\t\talias: messageObj.username || messageObj.alias || defaultValues.alias,\n\t\t\tmsg: s.trim(messageObj.text || messageObj.msg || ''),\n\t\t\tattachments: messageObj.attachments || [],\n\t\t\tparseUrls: messageObj.parseUrls !== undefined ? messageObj.parseUrls : !messageObj.attachments,\n\t\t\tbot: messageObj.bot,\n\t\t\tgroupable: (messageObj.groupable !== undefined) ? messageObj.groupable : false\n\t\t};\n\n\t\tif (!_.isEmpty(messageObj.icon_url) || !_.isEmpty(messageObj.avatar)) {\n\t\t\tmessage.avatar = messageObj.icon_url || messageObj.avatar;\n\t\t} else if (!_.isEmpty(messageObj.icon_emoji) || !_.isEmpty(messageObj.emoji)) {\n\t\t\tmessage.emoji = messageObj.icon_emoji || messageObj.emoji;\n\t\t} else if (!_.isEmpty(defaultValues.avatar)) {\n\t\t\tmessage.avatar = defaultValues.avatar;\n\t\t} else if (!_.isEmpty(defaultValues.emoji)) {\n\t\t\tmessage.emoji = defaultValues.emoji;\n\t\t}\n\n\t\tif (_.isArray(message.attachments)) {\n\t\t\tfor (let i = 0; i < message.attachments.length; i++) {\n\t\t\t\tconst attachment = message.attachments[i];\n\t\t\t\tif (attachment.msg) {\n\t\t\t\t\tattachment.text = s.trim(attachment.msg);\n\t\t\t\t\tdelete attachment.msg;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst messageReturn = RocketChat.sendMessage(user, message, room);\n\t\tsentData.push({ channel, message: messageReturn });\n\t}\n\n\treturn sentData;\n};\n"]}