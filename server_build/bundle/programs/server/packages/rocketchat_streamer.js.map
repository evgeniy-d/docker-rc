{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:streamer/lib/ev.js","meteor://ðŸ’»app/packages/rocketchat:streamer/server/server.js"],"names":["EV","constructor","handlers","emit","event","args","forEach","handler","apply","emitWithScope","scope","on","callback","push","once","self","onetimeCallback","arguments","removeListener","index","indexOf","splice","removeAllListeners","undefined","StreamerCentral","instances","Meteor","Streamer","name","retransmit","retransmitToSelf","console","warn","subscriptions","subscriptionsByEventName","transformers","iniPublication","initMethod","_allowRead","_allowEmit","_allowWrite","allowRead","allowEmit","allowWrite","_name","check","String","subscriptionName","_retransmit","Boolean","_retransmitToSelf","eventName","fn","error","userId","isReadAllowed","call","isEmitAllowed","isWriteAllowed","addSubscription","subscription","removeSubscription","transform","applyTransformers","methodScope","tranformed","Array","isArray","stream","publish","options","Match","OneOf","useCollection","length","stop","onStop","_session","sendAdded","ready","method","unblock","connection","originalParams","_emit","methods","e","origin","broadcast","sendChanged","emitWithoutBroadcast"],"mappings":"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","file":"/packages/rocketchat_streamer.js","sourcesContent":["/* globals EV:true */\n/* exported EV */\n\nEV = class EV {\n\tconstructor() {\n\t\tthis.handlers = {};\n\t}\n\n\temit(event, ...args) {\n\t\tif (this.handlers[event]) {\n\t\t\tthis.handlers[event].forEach((handler) => handler.apply(this, args));\n\t\t}\n\t}\n\n\temitWithScope(event, scope, ...args) {\n\t\tif (this.handlers[event]) {\n\t\t\tthis.handlers[event].forEach((handler) => handler.apply(scope, args));\n\t\t}\n\t}\n\n\ton(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\tthis.handlers[event] = [];\n\t\t}\n\t\tthis.handlers[event].push(callback);\n\t}\n\n\tonce(event, callback) {\n\t\tself = this;\n\t\tself.on(event, function onetimeCallback() {\n\t\t\tcallback.apply(this, arguments);\n\t\t\tself.removeListener(event, onetimeCallback);\n\t\t});\n\t}\n\n\tremoveListener(event, callback) {\n\t\tif(this.handlers[event]) {\n\t\t\tconst index = this.handlers[event].indexOf(callback);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.handlers[event].splice(index, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\tremoveAllListeners(event) {\n\t\tthis.handlers[event] = undefined;\n\t}\n};\n","/* globals EV */\n/* eslint new-cap: false */\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, {retransmit = true, retransmitToSelf = false} = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\n\t\tsuper();\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.retransmit = retransmit;\n\t\tthis.retransmitToSelf = retransmitToSelf;\n\n\t\tthis.subscriptions = [];\n\t\tthis.subscriptionsByEventName = {};\n\t\tthis.transformers = {};\n\n\t\tthis.iniPublication();\n\t\tthis.initMethod();\n\n\t\tthis._allowRead = {};\n\t\tthis._allowEmit = {};\n\t\tthis._allowWrite = {};\n\n\t\tthis.allowRead('none');\n\t\tthis.allowEmit('all');\n\t\tthis.allowWrite('none');\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget retransmit() {\n\t\treturn this._retransmit;\n\t}\n\n\tset retransmit(retransmit) {\n\t\tcheck(retransmit, Boolean);\n\t\tthis._retransmit = retransmit;\n\t}\n\n\tget retransmitToSelf() {\n\t\treturn this._retransmitToSelf;\n\t}\n\n\tset retransmitToSelf(retransmitToSelf) {\n\t\tcheck(retransmitToSelf, Boolean);\n\t\tthis._retransmitToSelf = retransmitToSelf;\n\t}\n\n\tallowRead(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowRead[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowEmit(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowEmit[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowWrite(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowWrite[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowWrite shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tisReadAllowed(scope, eventName, args) {\n\t\tif (this._allowRead[eventName]) {\n\t\t\treturn this._allowRead[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowRead['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisEmitAllowed(scope, eventName, ...args) {\n\t\tif (this._allowEmit[eventName]) {\n\t\t\treturn this._allowEmit[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowEmit['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisWriteAllowed(scope, eventName, args) {\n\t\tif (this._allowWrite[eventName]) {\n\t\t\treturn this._allowWrite[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowWrite['__all__'].call(scope, eventName, ...args);\n\t}\n\n\taddSubscription(subscription, eventName) {\n\t\tthis.subscriptions.push(subscription);\n\n\t\tif (!this.subscriptionsByEventName[eventName]) {\n\t\t\tthis.subscriptionsByEventName[eventName] = [];\n\t\t}\n\n\t\tthis.subscriptionsByEventName[eventName].push(subscription);\n\t}\n\n\tremoveSubscription(subscription, eventName) {\n\t\tconst index = this.subscriptions.indexOf(subscription);\n\t\tif (index > -1) {\n\t\t\tthis.subscriptions.splice(index, 1);\n\t\t}\n\n\t\tif (this.subscriptionsByEventName[eventName]) {\n\t\t\tconst index = this.subscriptionsByEventName[eventName].indexOf(subscription);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.subscriptionsByEventName[eventName].splice(index, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\ttransform(eventName, fn) {\n\t\tif (typeof eventName === 'function') {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (!this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName] = [];\n\t\t}\n\n\t\tthis.transformers[eventName].push(fn);\n\t}\n\n\tapplyTransformers(methodScope, eventName, args) {\n\t\tif (this.transformers['__all__']) {\n\t\t\tthis.transformers['__all__'].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, eventName, args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, ...args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn args;\n\t}\n\n\tiniPublication() {\n\t\tconst stream = this;\n\t\tMeteor.publish(this.subscriptionName, function(eventName, options) {\n\t\t\tcheck(eventName, String);\n\t\t\tcheck(options, Match.OneOf(Boolean, {\n\t\t\t\tuseCollection: Boolean,\n\t\t\t\targs: Array,\n\t\t\t}));\n\n\t\t\tlet useCollection, args = [];\n\n\t\t\tif (typeof options === 'boolean') {\n\t\t\t\tuseCollection = options;\n\t\t\t} else {\n\t\t\t\tif (options.useCollection) {\n\t\t\t\t\tuseCollection = options.useCollection;\n\t\t\t\t}\n\n\t\t\t\tif (options.args) {\n\t\t\t\t\targs = options.args;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (eventName.length === 0) {\n\t\t\t\tthis.stop();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (stream.isReadAllowed(this, eventName, args) !== true) {\n\t\t\t\tthis.stop();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst subscription = {\n\t\t\t\tsubscription: this,\n\t\t\t\teventName: eventName\n\t\t\t};\n\n\t\t\tstream.addSubscription(subscription, eventName);\n\n\t\t\tthis.onStop(() => {\n\t\t\t\tstream.removeSubscription(subscription, eventName);\n\t\t\t});\n\n\t\t\tif (useCollection === true) {\n\t\t\t\t// Collection compatibility\n\t\t\t\tthis._session.sendAdded(stream.subscriptionName, 'id', {\n\t\t\t\t\teventName: eventName\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.ready();\n\t\t});\n\t}\n\n\tinitMethod() {\n\t\tconst stream = this;\n\t\tconst method = {};\n\n\t\tmethod[this.subscriptionName] = function(eventName, ...args) {\n\t\t\tcheck(eventName, String);\n\t\t\tcheck(args, Array);\n\n\t\t\tthis.unblock();\n\n\t\t\tif (stream.isWriteAllowed(this, eventName, args) !== true) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst methodScope = {\n\t\t\t\tuserId: this.userId,\n\t\t\t\tconnection: this.connection,\n\t\t\t\toriginalParams: args,\n\t\t\t\ttranformed: false\n\t\t\t};\n\n\t\t\targs = stream.applyTransformers(methodScope, eventName, args);\n\n\t\t\tstream.emitWithScope(eventName, methodScope, ...args);\n\n\t\t\tif (stream.retransmit === true) {\n\t\t\t\tstream._emit(eventName, args, this.connection, true);\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tMeteor.methods(method);\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t}\n\t}\n\n\t_emit(eventName, args, origin, broadcast) {\n\t\tif (broadcast === true) {\n\t\t\tMeteor.StreamerCentral.emit('broadcast', this.name, eventName, args);\n\t\t}\n\n\t\tconst subscriptions = this.subscriptionsByEventName[eventName];\n\t\tif (!Array.isArray(subscriptions)) {\n\t\t\treturn;\n\t\t}\n\n\t\tsubscriptions.forEach((subscription) => {\n\t\t\tif (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.isEmitAllowed(subscription.subscription, eventName, ...args)) {\n\t\t\t\tsubscription.subscription._session.sendChanged(this.subscriptionName, 'id', {\n\t\t\t\t\teventName: eventName,\n\t\t\t\t\targs: args\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\temit(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, true);\n\t}\n\n\temitWithoutBroadcast(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, false);\n\t}\n};\n"]}